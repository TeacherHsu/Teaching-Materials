<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆ†æ•¸çƒ˜ç„™åŠ - ç¬¬9å–®å…ƒäº’å‹•å­¸ç¿’ (AIç‰ˆ)</title>
    <!-- å¼•å…¥ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Marked.js ç”¨æ–¼è§£æ Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary: #FF9F43; /* çƒ˜ç„™æ©˜ */
            --secondary: #54a0ff; /* åº·è»’è— */
            --success: #1dd1a1;
            --error: #ff6b6b;
            --text: #2c3e50;
            --bg: #feca57;
            --white: #ffffff;
            --ai-color: #a29bfe; /* AI åŠŸèƒ½å°ˆç”¨è‰² */
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Noto Sans TC', 'Gen Jyuu Gothic', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ä»‹é¢æ¥µç°¡åŒ–èˆ‡é ‚éƒ¨å€åŸŸ */
        #game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--white);
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            height: 100%;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .score-board {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
        }

        /* å…§å®¹é¡¯ç¤ºå€ */
        #content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        /* è¦–è¦ºé·¹æ¶ - åˆ†æ•¸é¡¯ç¤º */
        .fraction {
            display: inline-block;
            text-align: center;
            vertical-align: middle;
            margin: 0 5px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }
        .fraction .top {
            display: block;
            border-bottom: 3px solid currentColor;
            padding: 0 5px;
        }
        .fraction .bottom {
            display: block;
            padding: 0 5px;
        }
        .mixed-fraction {
            display: inline-flex;
            align-items: center;
        }
        .integer {
            font-size: 2rem;
            margin-right: 5px;
            font-weight: bold;
        }

        /* æŒ‰éˆ•èˆ‡äº’å‹•å…ƒç´  */
        .btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.1s;
            margin: 10px;
            box-shadow: 0 4px 0 #2e86de;
        }
        .btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }
        
        .ai-btn {
            background: var(--ai-color);
            box-shadow: 0 4px 0 #6c5ce7;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .tts-btn {
            background: #ff9ff3;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 10px;
            box-shadow: 0 3px 0 #f368e0;
        }

        /* åº•éƒ¨å›ºå®šæ“ä½œå€ */
        footer {
            padding: 15px;
            background: #f1f2f6;
            border-top: 2px solid #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            gap: 10px;
        }

        #check-btn {
            flex: 2;
            background: var(--success);
            box-shadow: 0 4px 0 #10ac84;
        }
        
        #ai-hint-btn {
            flex: 1;
            font-size: 1.2rem;
            padding: 15px;
            display: none; /* é è¨­éš±è—ï¼Œç‰¹å®šé—œå¡é–‹å•Ÿ */
        }

        /* éŠæˆ²ç•«é¢åˆ‡æ› */
        .screen {
            display: none;
            width: 100%;
        }
        .screen.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* é—œå¡ 1: åˆ†é¡ */
        .bucket-container {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 30px;
        }
        .bucket {
            width: 30%;
            height: 150px;
            border: 3px dashed #bdc3c7;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: 0.3s;
        }
        .bucket:hover, .bucket.selected {
            background: #dfe6e9;
            border-color: var(--secondary);
        }
        .current-card {
            background: white;
            border: 3px solid var(--primary);
            padding: 20px;
            border-radius: 10px;
            margin: 20px;
            transform: scale(1.5);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* é—œå¡ 2 & 3: åœ–å½¢èˆ‡å¡«ç©º */
        .pizza-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        .pizza {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #ddd;
            position: relative;
            border: 2px solid #555;
        }
        /* ä½¿ç”¨ conic-gradient ç¹ªè£½æ‰‡å½¢ */
        .pizza-fill {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        .input-group {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-top: 10px;
        }
        .scaffold-input {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            text-align: center;
            border: 3px solid #bdc3c7;
            border-radius: 10px;
            margin: 0 5px;
        }
        .scaffold-input:focus {
            border-color: var(--secondary);
            outline: none;
            background: #f0f8ff;
        }
        
        /* é—œå¡ 4: ç›´å¼é™¤æ³• CSS Grid */
        .division-container {
            display: grid;
            grid-template-columns: auto auto auto;
            grid-template-rows: auto auto auto auto;
            gap: 5px;
            font-size: 2rem;
            margin: 20px auto;
            width: fit-content;
            align-items: center;
            justify-items: center;
        }
        
        .div-quotient {
            grid-column: 3;
            grid-row: 1;
            border-bottom: 2px solid #2c3e50;
            width: 100%;
            text-align: center;
            padding-bottom: 5px;
        }
        
        .div-divisor {
            grid-column: 1;
            grid-row: 2;
            padding-right: 10px;
            color: var(--secondary);
            font-weight: bold;
        }
        
        .div-bracket {
            grid-column: 2;
            grid-row: 2;
            font-size: 2.5rem;
            font-weight: lighter;
            transform: scaleY(1.2) translateX(5px);
        }
        
        .div-dividend {
            grid-column: 3;
            grid-row: 2;
            letter-spacing: 5px;
            padding-left: 10px;
        }
        
        .div-product {
            grid-column: 3;
            grid-row: 3;
            border-bottom: 2px solid #2c3e50;
            width: 100%;
            text-align: center;
        }
        
        .div-remainder {
            grid-column: 3;
            grid-row: 4;
            text-align: center;
            color: var(--error);
            font-weight: bold;
        }
        
        /* é‹ç®—é·¹æ¶ */
        .step-row {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            font-size: 1.4rem;
            flex-wrap: wrap;
        }
        .step-hint {
            color: #e74c3c;
            font-size: 1rem;
            margin-bottom: 5px;
            width: 100%;
        }
        .operator {
            margin: 0 10px;
            font-weight: bold;
        }

        /* å›é¥‹å½ˆçª— */
        .feedback-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            display: none;
        }
        .feedback-box {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            width: 80%;
            max-height: 80%;
            overflow-y: auto;
            animation: popIn 0.3s;
            position: relative;
        }
        .feedback-box.ai-mode {
            border: 4px solid var(--ai-color);
            background: #f3e5f5;
        }
        @keyframes popIn {
            0% { transform: scale(0.5); }
            100% { transform: scale(1); }
        }
        
        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary);
            animation: spin 1s ease infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

<div id="game-container">
    <header>
        <div>åˆ†æ•¸çƒ˜ç„™åŠ</div>
        <div class="score-board">â­ <span id="score">0</span></div>
    </header>

    <div id="content-area">
        
        <!-- é¦–é  -->
        <div id="start-screen" class="screen active">
            <h1>æ­¡è¿ä¾†åˆ°åˆ†æ•¸çƒ˜ç„™åŠï¼</h1>
            <p>æˆ‘å€‘ä¸€èµ·ä¾†åšæŠ«è–©ã€èª¿é£²æ–™ï¼Œ<br>é‚„æœ‰å­¸ç¿’åˆ†æ•¸çš„é­”æ³•å§ï¼</p>
            <div style="font-size: 5rem;">ğŸ•</div>
            <p>ä½ éœ€è¦æ‰“é–‹è²éŸ³å–” ğŸ”Š</p>
            <button class="btn" onclick="startGame()">é–‹å§‹æŒ‘æˆ°</button>
            <br>
            <button class="btn ai-btn" onclick="callAIStory()">âœ¨ è½å€‹çƒ˜ç„™æ•…äº‹</button>
        </div>

        <!-- é—œå¡ 1: åˆ†é¡å¸½ -->
        <div id="level-1-screen" class="screen">
            <h2>ç¬¬ 1 é—œï¼šåˆ†é¡å¸½</h2>
            <p>è«‹å°‡å‡ºç¾çš„åˆ†æ•¸æ”¾åˆ°æ­£ç¢ºçš„ç±ƒå­è£¡ï¼<button class="tts-btn" onclick="speak('è«‹å°‡å‡ºç¾çš„åˆ†æ•¸ï¼Œæ”¾åˆ°æ­£ç¢ºçš„ç±ƒå­è£¡')">ğŸ”Š</button></p>
            
            <div id="fraction-display" class="current-card">
                <!-- å‹•æ…‹ç”Ÿæˆåˆ†æ•¸ -->
            </div>

            <div class="bucket-container">
                <div class="bucket" onclick="checkLevel1('true')">
                    <h3>çœŸåˆ†æ•¸</h3>
                    <small>åˆ†å­ < åˆ†æ¯</small>
                </div>
                <div class="bucket" onclick="checkLevel1('improper')">
                    <h3>å‡åˆ†æ•¸</h3>
                    <small>åˆ†å­ â‰§ åˆ†æ¯</small>
                </div>
                <div class="bucket" onclick="checkLevel1('mixed')">
                    <h3>å¸¶åˆ†æ•¸</h3>
                    <small>æ•´æ•¸ + çœŸåˆ†æ•¸</small>
                </div>
            </div>
        </div>

        <!-- é—œå¡ 2: æŠ«è–©å¤§å¸« -->
        <div id="level-2-screen" class="screen">
            <h2>ç¬¬ 2 é—œï¼šæŠ«è–©å¤§å¸«</h2>
            <p>çœ‹çœ‹æ¡Œä¸Šæœ‰å¤šå°‘æŠ«è–©ï¼Ÿè«‹ç”¨<b>å‡åˆ†æ•¸</b>è¡¨ç¤ºã€‚<button class="tts-btn" onclick="speak('çœ‹çœ‹æ¡Œä¸Šæœ‰å¤šå°‘æŠ«è–©ï¼Ÿè«‹ç”¨å‡åˆ†æ•¸è¡¨ç¤º')">ğŸ”Š</button></p>
            
            <div id="pizza-display" class="pizza-container">
                <!-- å‹•æ…‹ç”ŸæˆæŠ«è–© -->
            </div>

            <div class="input-group">
                <div class="fraction">
                    <span class="top"><input type="tel" id="l2-num" class="scaffold-input" placeholder="?"></span>
                    <span class="bottom" id="l2-den-display">4</span>
                </div>
            </div>
        </div>

        <!-- é—œå¡ 3: è®Šèº«é­”æ³• I -->
        <div id="level-3-screen" class="screen">
            <h2>ç¬¬ 3 é—œï¼šè®Šèº«é­”æ³• I</h2>
            <p>æŠŠå¸¶åˆ†æ•¸è®Šæˆå‡åˆ†æ•¸ï¼<button class="tts-btn" onclick="speak('æŠŠå¸¶åˆ†æ•¸è®Šæˆå‡åˆ†æ•¸')">ğŸ”Š</button></p>
            
            <div class="step-row" style="font-size: 2rem;">
                <div id="l3-problem"></div>
                <div class="operator">=</div>
                <div class="fraction">
                    <span class="top">
                        <span id="l3-den-hint" style="font-size: 1rem; color: #7f8c8d;"></span>
                        <span class="operator">Ã—</span>
                        <span id="l3-int-hint" style="font-size: 1rem; color: #7f8c8d;"></span>
                        <span class="operator">+</span>
                        <span id="l3-num-hint" style="font-size: 1rem; color: #7f8c8d;"></span>
                    </span>
                    <span class="bottom" id="l3-den-bottom"></span>
                </div>
            </div>
             <div class="step-hint">â¬‡ï¸ å…ˆä¹˜å†åŠ ï¼Œåˆ†æ¯ä¸è®Š â¬‡ï¸</div>
            <div class="step-row">
                 <div class="operator">=</div>
                 <div class="fraction">
                    <span class="top"><input type="tel" id="l3-ans" class="scaffold-input"></span>
                    <span class="bottom" id="l3-ans-den"></span>
                </div>
            </div>
        </div>

        <!-- é—œå¡ 4: é™¤æ³•å·¥å»  -->
        <div id="level-4-screen" class="screen">
            <h2>ç¬¬ 4 é—œï¼šé™¤æ³•å·¥å» </h2>
            <p>ç”¨ç›´å¼é™¤æ³•ï¼ŒæŠŠå‡åˆ†æ•¸æ›æˆå¸¶åˆ†æ•¸ã€‚<button class="tts-btn" onclick="speak('ç”¨ç›´å¼é™¤æ³•ï¼ŒæŠŠå‡åˆ†æ•¸æ›æˆå¸¶åˆ†æ•¸')">ğŸ”Š</button></p>
            
            <div class="step-row" style="margin-bottom:0;">
                <div class="fraction" style="margin-right:20px;">
                    <span class="top" id="l4-prob-num">11</span>
                    <span class="bottom" id="l4-prob-den">4</span>
                </div>
                <span>â¡ åˆ†å­ <span style="font-size:1.5rem">Ã·</span> åˆ†æ¯</span>
            </div>

            <div class="division-container">
                <div class="div-quotient"><input type="tel" id="l4-quotient" class="scaffold-input" style="border-color:var(--success); color:var(--success)" placeholder="å•†"></div>
                <div class="div-divisor" id="l4-divisor-display">4</div>
                <div class="div-bracket">)</div>
                <div class="div-dividend" id="l4-dividend-display">11</div>
                <div class="div-product"><input type="tel" id="l4-product" class="scaffold-input" placeholder="ç©"></div>
                <div class="div-remainder"><input type="tel" id="l4-remainder" class="scaffold-input" style="border-color:var(--error); color:var(--error)" placeholder="é¤˜"></div>
            </div>

            <hr style="width:80%; border:1px dashed #ccc;">
            
            <div class="input-group">
                <span>ç­”æ¡ˆï¼š</span>
                <div class="mixed-fraction">
                    <input type="tel" id="l4-final-int" class="scaffold-input" style="border: 3px solid var(--success);" placeholder="æ•´">
                    <div class="fraction">
                        <span class="top"><input type="tel" id="l4-final-num" class="scaffold-input" style="border: 3px solid var(--error);" placeholder="åˆ†"></span>
                        <span class="bottom" id="l4-final-den">4</span>
                    </div>
                </div>
            </div>
            <div class="step-hint" style="margin-top:5px;">ğŸ’¡ æç¤ºï¼šå•†æ˜¯æ•´æ•¸ï¼Œé¤˜æ•¸æ˜¯åˆ†å­</div>
        </div>

        <!-- é—œå¡ 5 & 6: é€šç”¨æ‡‰ç”¨é¡Œç•«é¢ -->
        <div id="level-common-screen" class="screen">
            <h2 id="common-level-title">ç¬¬ ? é—œ</h2>
            <div id="common-question-text" style="text-align: left; margin-bottom: 15px; font-size: 1.1rem;"></div>
            <button class="tts-btn" style="float:right" onclick="speak(currentProblem.questionTTS)">ğŸ”Š</button>
            <hr style="width:100%; border: 1px dashed #ccc;">
            <div id="common-calculation-area"></div>
        </div>

        <!-- çµç®—ç•«é¢ -->
        <div id="end-screen" class="screen">
            <h1>ğŸ‰ æŒ‘æˆ°å®Œæˆï¼</h1>
            <h2 id="final-score-text"></h2>
            <div id="stars" style="font-size: 3rem;">â­â­â­</div>
            <p id="feedback-text">ä½ æ˜¯è¶…ç´šåˆ†æ•¸å¤§å¸«ï¼</p>
            <button class="btn" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
            <br>
            <button class="btn ai-btn" onclick="callAIStory()">âœ¨ è½å€‹ç•¢æ¥­æ•…äº‹</button>
        </div>

    </div>

    <!-- åº•éƒ¨å›ºå®šæŒ‰éˆ•å€ -->
    <footer id="footer-controls">
        <button id="check-btn" class="btn" onclick="checkAnswer()">æª¢æŸ¥ç­”æ¡ˆ</button>
        <button id="ai-hint-btn" class="btn ai-btn" onclick="callAIHint()">âœ¨ å°ç²¾éˆ</button>
    </footer>

    <!-- å›é¥‹å½ˆçª— -->
    <div id="feedback-overlay" class="feedback-overlay">
        <div class="feedback-box" id="feedback-box">
            <h2 id="fb-title"></h2>
            <div id="fb-msg" style="font-size:1.2rem; margin:10px 0;"></div>
            <div id="ai-loading" style="display:none;">
                <div class="spinner"></div>
                <p>âœ¨ å°ç²¾éˆæ­£åœ¨æ€è€ƒä¸­...</p>
            </div>
            <button class="btn" onclick="closeFeedback()">çŸ¥é“äº†</button>
        </div>
    </div>
</div>

<script>
/* --- Gemini API Configuration --- */
const apiKey = ""; // System will inject key

/* --- State Management --- */
let gameState = {
    level: 1,
    score: 0,
    mistakes: 0,
    consecutiveMistakes: 0,
    problemCount: 0,
    maxProblemsPerLevel: 3
};

let currentProblem = {};

function startGame() {
    gameState.score = 0;
    gameState.level = 1;
    gameState.problemCount = 0;
    document.getElementById('score').innerText = 0;
    nextLevel();
}

function nextLevel() {
    document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
    
    // Check Progression
    if(gameState.problemCount >= gameState.maxProblemsPerLevel) {
        gameState.level++;
        gameState.problemCount = 0;
        gameState.consecutiveMistakes = 0;
    }

    if(gameState.level > 6) { 
        document.getElementById('end-screen').classList.add('active');
        document.getElementById('check-btn').style.display = 'none';
        document.getElementById('ai-hint-btn').style.display = 'none';
        showEndScreen();
        return;
    }

    // Router
    let screenId = '';
    if (gameState.level === 5 || gameState.level === 6) {
        screenId = 'level-common-screen';
        document.getElementById('ai-hint-btn').style.display = 'inline-flex'; // Enable AI in word problems
    } else {
        screenId = `level-${gameState.level}-screen`;
        document.getElementById('ai-hint-btn').style.display = 'none';
    }

    const screenEl = document.getElementById(screenId);
    if(screenEl) {
        screenEl.classList.add('active');
        generateProblem(gameState.level);
    } else {
        console.error("Screen not found: " + screenId);
    }
}

function generateProblem(level) {
    gameState.mistakes = 0;
    document.getElementById('check-btn').style.display = 'block';
    
    switch(level) {
        case 1: generateLevel1(); break;
        case 2: generateLevel2(); break;
        case 3: generateLevel3(); break;
        case 4: generateLevel4(); break;
        case 5: generateLevel5(); break;
        case 6: generateLevel6(); break;
    }
}

/* --- AI Feature: Smart Helper --- */
async function callAIHint() {
    const box = document.getElementById('feedback-box');
    const overlay = document.getElementById('feedback-overlay');
    const title = document.getElementById('fb-title');
    const msg = document.getElementById('fb-msg');
    const loading = document.getElementById('ai-loading');
    
    overlay.style.display = 'flex';
    box.classList.add('ai-mode');
    title.innerText = "âœ¨ æ™ºæ…§å°ç²¾éˆ";
    title.style.color = "#6c5ce7";
    msg.innerHTML = "";
    loading.style.display = 'block';

    // Gather context
    const userInt = document.getElementById('common-int') ? document.getElementById('common-int').value : "æœªå¡«å¯«";
    const userNum = document.getElementById('common-num') ? document.getElementById('common-num').value : "æœªå¡«å¯«";
    
    const prompt = `
        ä½ ç¾åœ¨æ˜¯ä¸€ä½åœ‹å°æ•¸å­¸è€å¸«çš„æ™ºæ…§åŠ©æ‰‹ã€Œçƒ˜ç„™å°ç²¾éˆã€ã€‚
        
        ç›®å‰çš„é¡Œç›®æ˜¯ï¼š${currentProblem.questionTTS || "åˆ†æ•¸è¨ˆç®—é¡Œ"}
        æ­£ç¢ºç­”æ¡ˆçš„æ•´æ•¸éƒ¨åˆ†æ˜¯ï¼š${currentProblem.ansInt}
        æ­£ç¢ºç­”æ¡ˆçš„åˆ†å­éƒ¨åˆ†æ˜¯ï¼š${currentProblem.ansNum}
        
        å­¸ç”Ÿå¡«å¯«çš„æ•´æ•¸æ˜¯ï¼š${userInt}
        å­¸ç”Ÿå¡«å¯«çš„åˆ†å­æ˜¯ï¼š${userNum}
        
        è«‹æ ¹æ“šå­¸ç”Ÿçš„è¼¸å…¥ï¼Œçµ¦å‡ºä¸€å€‹æº«æŸ”ã€é¼“å‹µæ€§ä¸”å…·é«”çš„å¼•å°æç¤ºã€‚
        ä¸è¦ç›´æ¥çµ¦å‡ºç­”æ¡ˆï¼
        å¦‚æœæ˜¯åŠ æ³•ï¼Œæé†’æ•´æ•¸åŠ æ•´æ•¸ã€åˆ†æ•¸åŠ åˆ†æ•¸çš„æ¦‚å¿µã€‚
        å¦‚æœæ˜¯æ¸›æ³•ï¼Œæé†’æ˜¯å¦éœ€è¦å…ˆè™•ç†æ•´æ•¸æ¸›å¸¶åˆ†æ•¸ã€‚
        è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œèªæ°£è¦åƒæ˜¯åœ¨æ•™å°å°å­¸ç”Ÿã€‚
        é•·åº¦è«‹æ§åˆ¶åœ¨ 50 å­—ä»¥å…§ã€‚
    `;

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        
        const data = await response.json();
        const aiText = data.candidates[0].content.parts[0].text;
        
        loading.style.display = 'none';
        msg.innerHTML = marked.parse(aiText);
        
    } catch (error) {
        loading.style.display = 'none';
        msg.innerText = "å°ç²¾éˆç¡è‘—äº†... è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚";
    }
}

/* --- AI Feature: Story Mode --- */
async function callAIStory() {
    const box = document.getElementById('feedback-box');
    const overlay = document.getElementById('feedback-overlay');
    const title = document.getElementById('fb-title');
    const msg = document.getElementById('fb-msg');
    const loading = document.getElementById('ai-loading');
    
    overlay.style.display = 'flex';
    box.classList.add('ai-mode');
    title.innerText = "âœ¨ çƒ˜ç„™åŠæ•…äº‹æ™‚é–“";
    title.style.color = "#6c5ce7";
    msg.innerHTML = "";
    loading.style.display = 'block';

    const prompt = `
        è«‹è¬›ä¸€å€‹é—œæ–¼ã€Œåˆ†æ•¸ç‹åœ‹ã€æˆ–ã€Œç¥å¥‡çƒ˜ç„™åŠã€çš„çŸ­æ•…äº‹ï¼Œé•·åº¦ç´„ 100 å­—ã€‚
        æ•…äº‹è¦ç”Ÿå‹•æœ‰è¶£ï¼Œé©åˆåœ‹å°å››å¹´ç´šå­¸ç”Ÿã€‚
        å…§å®¹å¯ä»¥æåˆ°ã€ŒæŠŠæŠ«è–©åˆ‡æˆå¹¾åˆ†ä¹‹å¹¾ã€æˆ–ã€Œæ··åˆæœæ±ã€çš„æƒ…ç¯€ï¼Œè®“å­¸ç”Ÿè¦ºå¾—æ•¸å­¸å¾ˆæœ‰ç”¨ã€‚
        è«‹ç”¨ç¹é«”ä¸­æ–‡å‰µä½œã€‚
    `;

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        
        const data = await response.json();
        const aiText = data.candidates[0].content.parts[0].text;
        
        loading.style.display = 'none';
        msg.innerHTML = marked.parse(aiText);
        
    } catch (error) {
        loading.style.display = 'none';
        msg.innerText = "æ•…äº‹æ›¸é€™é ç ´æ‰äº†... è«‹ç¨å¾Œå†è©¦ã€‚";
    }
}

/* --- Level Generators --- */
function generateLevel1() {
    document.getElementById('check-btn').style.display = 'none';
    const types = ['true', 'improper', 'mixed'];
    const type = types[Math.floor(Math.random() * types.length)];
    
    let num, den, int;
    
    if (type === 'true') {
        den = Math.floor(Math.random() * 8) + 3;
        num = Math.floor(Math.random() * (den - 1)) + 1;
        document.getElementById('fraction-display').innerHTML = renderFraction(num, den);
        currentProblem = { type: 'true', answer: 'true', tts: `${den}åˆ†ä¹‹${num}` };
    } else if (type === 'improper') {
        den = Math.floor(Math.random() * 8) + 2;
        num = Math.floor(Math.random() * 10) + den;
        document.getElementById('fraction-display').innerHTML = renderFraction(num, den);
        currentProblem = { type: 'improper', answer: 'improper', tts: `${den}åˆ†ä¹‹${num}` };
    } else {
        den = Math.floor(Math.random() * 8) + 3;
        num = Math.floor(Math.random() * (den - 1)) + 1;
        int = Math.floor(Math.random() * 5) + 1;
        document.getElementById('fraction-display').innerHTML = renderMixedFraction(int, num, den);
        currentProblem = { type: 'mixed', answer: 'mixed', tts: `${int}åˆ${den}åˆ†ä¹‹${num}` };
    }
    speak(currentProblem.tts);
}

function generateLevel2() {
    const den = 4;
    const whole = Math.floor(Math.random() * 2) + 1;
    const extra = Math.floor(Math.random() * 3) + 1;
    const totalSlices = (whole * den) + extra;
    
    currentProblem = {
        num: totalSlices,
        den: den,
        answer: totalSlices,
        tts: `æœ‰${whole}å€‹å®Œæ•´çš„æŠ«è–©ï¼Œé‚„æœ‰${extra}ç‰‡ï¼Œåˆèµ·ä¾†æ˜¯å¤šå°‘å€‹å››åˆ†ä¹‹ä¸€ï¼Ÿ`
    };

    let html = '';
    for(let i=0; i<whole; i++) {
        html += `<div class="pizza" style="background: conic-gradient(#ff7675 0% 100%);"><div style="position:absolute; width:100%; height:100%; background: repeating-conic-gradient(from 0deg, transparent 0deg 88deg, #fff 88deg 90deg); border-radius:50%;"></div></div>`;
    }
    let degree = (extra / den) * 360;
    html += `<div class="pizza" style="background: conic-gradient(#ff7675 0% ${degree}deg, #dfe6e9 ${degree}deg 100%);"><div style="position:absolute; width:100%; height:100%; background: repeating-conic-gradient(from 0deg, transparent 0deg 88deg, #fff 88deg 90deg); border-radius:50%;"></div></div>`;

    document.getElementById('pizza-display').innerHTML = html;
    document.getElementById('l2-den-display').innerText = den;
    document.getElementById('l2-num').value = '';
    speak(currentProblem.tts);
}

function generateLevel3() {
    const int = Math.floor(Math.random() * 3) + 1;
    const den = Math.floor(Math.random() * 7) + 3;
    const num = Math.floor(Math.random() * (den - 1)) + 1;
    const ansNum = (int * den) + num;

    currentProblem = {
        int: int, num: num, den: den, answer: ansNum,
        tts: `æŠŠ${int}åˆ${den}åˆ†ä¹‹${num}æ›æˆå‡åˆ†æ•¸`
    };

    document.getElementById('l3-problem').innerHTML = renderMixedFraction(int, num, den);
    document.getElementById('l3-den-hint').innerText = den;
    document.getElementById('l3-int-hint').innerText = int;
    document.getElementById('l3-num-hint').innerText = num;
    document.getElementById('l3-den-bottom').innerText = den;
    document.getElementById('l3-ans-den').innerText = den;
    document.getElementById('l3-ans').value = '';
    speak(currentProblem.tts);
}

function generateLevel4() {
    const den = Math.floor(Math.random() * 6) + 3;
    const int = Math.floor(Math.random() * 3) + 1;
    const rem = Math.floor(Math.random() * (den - 1)) + 1;
    const num = (int * den) + rem;

    currentProblem = {
        num: num, den: den, quotient: int, remainder: rem, product: int * den,
        tts: `è«‹ç”¨ç›´å¼é™¤æ³•è¨ˆç®—ï¼Œ${den}åˆ†ä¹‹${num}ç­‰æ–¼å¹¾åˆå¹¾åˆ†ä¹‹å¹¾ï¼Ÿ`
    };

    document.getElementById('l4-prob-num').innerText = num;
    document.getElementById('l4-prob-den').innerText = den;
    document.getElementById('l4-divisor-display').innerText = den;
    document.getElementById('l4-dividend-display').innerText = num;
    document.getElementById('l4-final-den').innerText = den;

    ['l4-quotient', 'l4-product', 'l4-remainder', 'l4-final-int', 'l4-final-num'].forEach(id => {
        document.getElementById(id).value = '';
    });
    speak(currentProblem.tts);
}

function generateLevel5() {
    document.getElementById('common-level-title').innerText = "ç¬¬ 5 é—œï¼šå°å°åº—é•· (åŠ æ³•)";
    const den = [5, 6, 8, 10][Math.floor(Math.random() * 4)];
    const num1 = Math.floor(Math.random() * (den - 2)) + 1;
    const num2 = Math.floor(Math.random() * (den - num1)) + 1 + Math.floor(Math.random()*2); 
    const int1 = Math.floor(Math.random() * 2) + 1;
    const int2 = Math.floor(Math.random() * 2) + 1;
    
    currentProblem = {
        type: 'calc_add',
        ansInt: int1 + int2,
        ansNum: num1 + num2,
        ansDen: den,
        questionTTS: `çˆ¸çˆ¸è²·äº†${int1}åˆ${den}åˆ†ä¹‹${num1}å…¬å‡çš„ç´…èŒ¶ï¼Œå’Œ${int2}åˆ${den}åˆ†ä¹‹${num2}å…¬å‡çš„ç‰›å¥¶ï¼Œåˆèµ·ä¾†æ˜¯å¤šå°‘å…¬å‡ï¼Ÿ`
    };

    const qText = `çˆ¸çˆ¸è²·äº† ${renderMixedFraction(int1, num1, den)} å…¬å‡ç´…èŒ¶å’Œ ${renderMixedFraction(int2, num2, den)} å…¬å‡ç‰›å¥¶ï¼Œåˆèµ·ä¾†æ˜¯å¤šå°‘å…¬å‡ï¼Ÿ`;
    document.getElementById('common-question-text').innerHTML = qText;

    let html = `
        <div class="step-row">
            ${renderMixedFraction(int1, num1, den)} <span class="operator">+</span> ${renderMixedFraction(int2, num2, den)}
        </div>
        <div class="step-hint">æ•´æ•¸åŠ æ•´æ•¸ï¼Œåˆ†æ•¸åŠ åˆ†æ•¸</div>
        <div class="step-row">
            <span class="operator">=</span>
            <div class="mixed-fraction">
                <input type="tel" id="common-int" class="scaffold-input" placeholder="æ•´">
                <div class="fraction">
                    <span class="top"><input type="tel" id="common-num" class="scaffold-input" placeholder="åˆ†"></span>
                    <span class="bottom">${den}</span>
                </div>
            </div>
        </div>
    `;
    document.getElementById('common-calculation-area').innerHTML = html;
    speak(currentProblem.questionTTS);
}

function generateLevel6() {
    document.getElementById('common-level-title').innerText = "ç¬¬ 6 é—œï¼šå‰©å¤šå°‘ææ–™ (æ¸›æ³•)";
    const den = [5, 6, 8, 10][Math.floor(Math.random() * 4)];
    
    const type = Math.random() > 0.5 ? 'int_mixed' : 'mixed_mixed';
    let intA, numA, intB, numB, qText;
    
    if (type === 'int_mixed') {
        intA = Math.floor(Math.random() * 3) + 3; 
        intB = Math.floor(Math.random() * (intA - 2)) + 1; 
        numB = Math.floor(Math.random() * (den - 1)) + 1;
        
        currentProblem = {
            type: 'calc_sub',
            ansInt: intA - 1 - intB,
            ansNum: den - numB,
            ansDen: den,
            questionTTS: `æœ‰ä¸€æ¢ç¹©å­é•·${intA}å…¬å°ºï¼Œç”¨æ‰äº†${intB}åˆ${den}åˆ†ä¹‹${numB}å…¬å°ºï¼Œé‚„å‰©ä¸‹å¤šå°‘å…¬å°ºï¼Ÿ`
        };
        qText = `æœ‰ä¸€æ¢ç¹©å­é•· <span class="integer">${intA}</span> å…¬å°ºï¼Œç”¨æ‰äº† ${renderMixedFraction(intB, numB, den)} å…¬å°ºï¼Œé‚„å‰©ä¸‹å¤šå°‘å…¬å°ºï¼Ÿ`;
    } else {
        intA = Math.floor(Math.random() * 3) + 2;
        intB = Math.floor(Math.random() * (intA - 1)) + 1;
        numA = Math.floor(Math.random() * (den - 2)) + 2; 
        numB = Math.floor(Math.random() * (numA - 1)) + 1;
        
        currentProblem = {
            type: 'calc_sub',
            ansInt: intA - intB,
            ansNum: numA - numB,
            ansDen: den,
            questionTTS: `æœ‰ä¸€åŒ…éºµç²‰é‡${intA}åˆ${den}åˆ†ä¹‹${numA}å…¬æ–¤ï¼Œåšè›‹ç³•ç”¨äº†${intB}åˆ${den}åˆ†ä¹‹${numB}å…¬æ–¤ï¼Œé‚„å‰©ä¸‹å¤šå°‘å…¬æ–¤ï¼Ÿ`
        };
        qText = `æœ‰ä¸€åŒ…éºµç²‰é‡ ${renderMixedFraction(intA, numA, den)} å…¬æ–¤ï¼Œåšè›‹ç³•ç”¨äº† ${renderMixedFraction(intB, numB, den)} å…¬æ–¤ï¼Œé‚„å‰©ä¸‹å¤šå°‘å…¬æ–¤ï¼Ÿ`;
    }

    document.getElementById('common-question-text').innerHTML = qText;

    let displayA = type === 'int_mixed' ? `<span class="integer">${intA}</span>` : renderMixedFraction(intA, numA, den);
    let displayB = renderMixedFraction(intB, numB, den);

    let html = `
        <div class="step-row">
            ${displayA} <span class="operator">-</span> ${displayB}
        </div>
        <div class="step-hint">${type === 'int_mixed' ? 'æŠŠæ•´æ•¸æ›æˆå‡åˆ†æ•¸å†æ¸›' : 'æ•´æ•¸æ¸›æ•´æ•¸ï¼Œåˆ†æ•¸æ¸›åˆ†æ•¸'}</div>
        <div class="step-row">
            <span class="operator">=</span>
            <div class="mixed-fraction">
                <input type="tel" id="common-int" class="scaffold-input" placeholder="æ•´">
                <div class="fraction">
                    <span class="top"><input type="tel" id="common-num" class="scaffold-input" placeholder="åˆ†"></span>
                    <span class="bottom">${den}</span>
                </div>
            </div>
        </div>
    `;
    document.getElementById('common-calculation-area').innerHTML = html;
    speak(currentProblem.questionTTS);
}

/* --- Common Logic --- */
function checkLevel1(userChoice) {
    if (userChoice === currentProblem.answer) {
        playSound('correct');
        addScore(10);
        showFeedback(true, "ç­”å°äº†ï¼", "åˆ†é¡å¾—å¾ˆæ£’å–”ï¼");
    } else {
        let hint = "";
        if (currentProblem.type === 'true') hint = "çœŸåˆ†æ•¸çš„åˆ†å­æ¯”åˆ†æ¯å°å–”ï¼";
        else if (currentProblem.type === 'improper') hint = "å‡åˆ†æ•¸çš„åˆ†å­æ¯”åˆ†æ¯å¤§ï¼Œæˆ–ä¸€æ¨£å¤§ï¼";
        else hint = "å¸¶åˆ†æ•¸æ—é‚Šæœ‰ä¸€å€‹æ•´æ•¸å¤§äººå¸¶è‘—åˆ†æ•¸å°å­©ï¼";
        handleMistake("å“å‘€ï¼å†çœ‹æ¸…æ¥šä¸€é»", hint);
    }
}

function checkAnswer() {
    let isCorrect = false;
    let feedbackMsg = "è«‹å†ä»”ç´°æª¢æŸ¥ä¸€ä¸‹ç­”æ¡ˆå–”ï¼"; 

    if (gameState.level === 2) {
        const val = parseInt(document.getElementById('l2-num').value);
        if (val === currentProblem.answer) isCorrect = true;
        else feedbackMsg = `æ•¸æ•¸çœ‹ï¼Œå…¨éƒ¨æœ‰å¹¾å€‹ ${renderFraction(1, currentProblem.den)} ï¼Ÿ`;
    } 
    else if (gameState.level === 3) {
        const val = parseInt(document.getElementById('l3-ans').value);
        if (val === currentProblem.answer) isCorrect = true;
        else feedbackMsg = `å…¬å¼ï¼šåˆ†æ¯ Ã— æ•´æ•¸ + åˆ†å­`;
    }
    else if (gameState.level === 4) {
        const q = parseInt(document.getElementById('l4-quotient').value);
        const p = parseInt(document.getElementById('l4-product').value);
        const r = parseInt(document.getElementById('l4-remainder').value);
        const fi = parseInt(document.getElementById('l4-final-int').value);
        const fn = parseInt(document.getElementById('l4-final-num').value);

        if (q === currentProblem.quotient && p === currentProblem.product && 
            r === currentProblem.remainder && fi === currentProblem.quotient && 
            fn === currentProblem.remainder) {
            isCorrect = true;
        } else {
            feedbackMsg = "é™¤æ³•æˆ–å¡«ç©ºä½ç½®æœ‰éŒ¯å–”ï¼Œè«‹æª¢æŸ¥ï¼";
        }
    }
    else if (gameState.level === 5 || gameState.level === 6) {
        const userInt = parseInt(document.getElementById('common-int').value);
        const userNum = parseInt(document.getElementById('common-num').value);
        
        if (userInt === currentProblem.ansInt && userNum === currentProblem.ansNum) {
            isCorrect = true;
        } else {
            if (userInt !== currentProblem.ansInt) feedbackMsg = "æ•´æ•¸çš„éƒ¨åˆ†ç®—éŒ¯å›‰ï¼";
            else feedbackMsg = "åˆ†æ•¸çš„åˆ†å­ç®—éŒ¯å›‰ï¼";
        }
    }

    if (isCorrect) {
        playSound('correct');
        addScore(20);
        showFeedback(true, "å¤ªæ£’äº†ï¼", "ä½ ç®—å¾—éå¸¸æ­£ç¢ºï¼");
    } else {
        handleMistake("åŠ æ²¹ï¼", feedbackMsg);
    }
}

function handleMistake(title, msg) {
    playSound('wrong');
    gameState.mistakes++;
    gameState.consecutiveMistakes++;
    
    document.querySelectorAll('input').forEach(el => {
        el.style.backgroundColor = '#ffecec';
        setTimeout(() => el.style.backgroundColor = 'white', 500);
    });
    
    showFeedback(false, title, msg);
}

function showFeedback(success, title, msg) {
    const overlay = document.getElementById('feedback-overlay');
    const box = document.getElementById('feedback-box');
    
    box.classList.remove('ai-mode'); // Reset AI styling
    document.getElementById('fb-title').innerText = title;
    document.getElementById('fb-title').style.color = success ? varCss('--success') : varCss('--error');
    document.getElementById('fb-msg').innerHTML = msg;
    document.getElementById('ai-loading').style.display = 'none';
    
    overlay.style.display = 'flex';
}

function closeFeedback() {
    const overlay = document.getElementById('feedback-overlay');
    const title = document.getElementById('fb-title').innerText;
    
    overlay.style.display = 'none';
    
    // Logic: Check if we should advance level ONLY if the previous modal was a SUCCESS modal
    // We identify success by the title color or text content. Simple text check here:
    if (title === "å¤ªæ£’äº†ï¼" || title === "ç­”å°äº†ï¼") {
        gameState.problemCount++;
        if (gameState.problemCount >= gameState.maxProblemsPerLevel) {
            nextLevel();
        } else {
            generateProblem(gameState.level);
        }
        gameState.consecutiveMistakes = 0;
    } else {
        // It was an error or AI hint modal, do nothing or regenerate if stuck
        if (gameState.consecutiveMistakes >= 2) {
            generateProblem(gameState.level);
            gameState.consecutiveMistakes = 0;
        }
    }
}

function addScore(points) {
    gameState.score += points;
    document.getElementById('score').innerText = gameState.score;
}

function showEndScreen() {
    document.getElementById('final-score-text').innerText = `ä½ çš„ç¸½åˆ†ï¼š${gameState.score}`;
    let stars = 'â­';
    if(gameState.score > 50) stars += 'â­';
    if(gameState.score > 100) stars += 'â­';
    document.getElementById('stars').innerText = stars;
}

/* Helpers */
function renderFraction(num, den) {
    return `<div class="fraction"><span class="top">${num}</span><span class="bottom">${den}</span></div>`;
}
function renderMixedFraction(int, num, den) {
    return `<div class="mixed-fraction"><span class="integer">${int}</span>${renderFraction(num, den)}</div>`;
}
function varCss(name) { return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
function playSound(type) {} 
function speak(text) {
    let safeText = text.replace(/\//g, 'åˆ†ä¹‹').replace(/-/g, 'æ¸›').replace(/\+/g, 'åŠ ').replace(/=/g, 'ç­‰æ–¼').replace(/Ã—/g, 'ä¹˜');
    const u = new SpeechSynthesisUtterance(safeText);
    u.lang = 'zh-TW'; u.rate = 0.9;
    window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
}
</script>
</body>
</html>
