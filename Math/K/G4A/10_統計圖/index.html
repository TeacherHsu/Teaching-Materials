<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ‹å°æ•¸å­¸ï¼šçµ±è¨ˆåœ–å¤§æŒ‘æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Chosen Palette: "Energetic Learning" -->
    
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fff7ed; /* orange-50 */
            color: #1e3a8a; /* blue-900 */
            user-select: none;
            overflow-x: hidden;
        }

        /* èªéŸ³æŒ‰éˆ•æ¨£å¼ */
        .tts-btn {
            @apply flex-shrink-0 w-10 h-10 rounded-full bg-blue-100 text-blue-600 border-2 border-blue-200 flex items-center justify-center cursor-pointer transition-transform hover:scale-110 hover:bg-blue-600 hover:text-white active:scale-95 shadow-sm;
        }
        .tts-active {
            @apply bg-yellow-400 text-yellow-900 border-yellow-500 animate-pulse;
        }

        /* --- é¸é …æŒ‰éˆ•è¨­è¨ˆ (ç¾è§€ç›´è¦ºç‰ˆ) --- */
        .option-card {
            @apply w-full p-4 mb-3 bg-white rounded-2xl border-2 border-stone-200 shadow-sm cursor-pointer transition-all duration-200 flex items-center hover:border-blue-400 hover:bg-blue-50 hover:shadow-md active:scale-[0.99];
            min-height: 72px; 
        }
        
        .option-indicator {
            @apply w-8 h-8 rounded-full border-2 border-stone-300 mr-4 flex items-center justify-center flex-shrink-0 bg-white transition-colors;
        }
        
        .option-indicator::after {
            content: '';
            @apply w-4 h-4 rounded-full bg-blue-500 opacity-0 transform scale-0 transition-all duration-200;
        }

        .option-card:hover .option-indicator {
            @apply border-blue-500;
        }

        .option-card.correct {
            @apply border-green-500 bg-green-50 text-green-800 ring-2 ring-green-300 pointer-events-none;
        }
        .option-card.correct .option-indicator {
            @apply border-green-500 bg-green-500;
        }
        .option-card.correct .option-indicator::after {
            @apply bg-white opacity-100 scale-100;
            content: 'âœ“'; 
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent; 
        }

        .option-card.wrong {
            @apply border-red-500 bg-red-50 text-red-800 opacity-80 pointer-events-none;
        }
        .option-card.wrong .option-indicator {
            @apply border-red-500 bg-red-100;
        }
        .option-card.wrong .option-indicator::after {
            @apply opacity-100 scale-100;
            content: 'âœ•';
            color: #ef4444;
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
        }

        .option-card.disabled {
            @apply opacity-50 cursor-not-allowed pointer-events-none;
        }

        /* åœ–è¡¨å®¹å™¨ */
        .chart-wrapper {
            @apply relative w-full max-w-4xl h-[45vh] max-h-[400px] mx-auto bg-white rounded-2xl p-4 shadow-md border border-stone-100;
        }

        /* å‹•ç•« */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: slideIn 0.5s ease-out forwards;
        }

        @keyframes popScore {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); color: #ea580c; }
            100% { transform: scale(1); }
        }
        .score-update {
            animation: popScore 0.5s ease-out;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen pb-10">

    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-30 px-4 py-3">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-orange-500 rounded-lg flex items-center justify-center text-white text-2xl shadow-inner">ğŸ“Š</div>
                <div>
                    <h1 class="font-black text-xl text-stone-800 tracking-wide">çµ±è¨ˆåœ–å¤§æŒ‘æˆ°</h1>
                    <div class="text-xs text-stone-500 font-medium">ç¬¬ <span id="level-indicator">1</span> é—œ</div>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="hidden md:block w-32 h-3 bg-stone-200 rounded-full overflow-hidden border border-stone-300">
                    <div id="timer-bar" class="h-full bg-green-500 w-full transition-all duration-1000 linear"></div>
                </div>
                
                <div class="bg-yellow-100 px-4 py-2 rounded-xl border-2 border-yellow-300 flex items-center gap-2 shadow-sm">
                    <span class="text-xl">â­</span>
                    <span id="score-display" class="font-black text-2xl text-yellow-800 tabular-nums">0</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-6 flex flex-col items-center justify-center">
        
        <!-- éŠæˆ²å€åŸŸ -->
        <div id="game-area" class="w-full max-w-5xl fade-in hidden">
            
            <div class="flex flex-col lg:flex-row gap-6 w-full">
                
                <!-- å·¦å´ï¼šåœ–è¡¨èˆ‡æƒ…å¢ƒ -->
                <div class="w-full lg:w-2/3 space-y-4">
                    <div class="bg-white px-5 py-3 rounded-xl shadow-sm border border-blue-100 flex items-center justify-between">
                        <h2 id="chart-title" class="text-xl font-bold text-stone-800">åœ–è¡¨æ¨™é¡Œ</h2>
                        <button class="tts-btn" id="tts-chart-intro">ğŸ”Š</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>

                <!-- å³å´ï¼šäº’å‹•å•ç­” -->
                <div class="w-full lg:w-1/3 flex flex-col">
                    <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-blue-100 flex-grow flex flex-col justify-center relative overflow-hidden">
                        
                        <div class="mb-6">
                            <div class="flex items-start gap-3">
                                <span class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded shadow-sm mt-1 flex-shrink-0">å•ç­”</span>
                                <p id="question-text" class="text-xl font-bold text-stone-800 leading-relaxed">
                                    é¡Œç›®è¼‰å…¥ä¸­...
                                </p>
                                <button class="tts-btn" id="tts-question">ğŸ”Š</button>
                            </div>
                        </div>

                        <div id="options-container" class="w-full flex flex-col gap-2">
                            <!-- JSå‹•æ…‹ç”Ÿæˆ -->
                        </div>

                        <div id="feedback-area" class="hidden mt-4 pt-4 border-t-2 border-stone-100 text-center">
                            <p id="feedback-msg" class="text-lg font-bold mb-4"></p>
                            <button id="action-btn" class="w-full py-3 px-6 rounded-xl font-bold text-lg shadow-md transition-transform active:scale-95 flex items-center justify-center gap-2">
                                ä¸‹ä¸€é—œ â¡
                            </button>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- çµç®—ç•«é¢ -->
        <div id="end-screen" class="hidden w-full max-w-2xl text-center bg-white p-10 rounded-3xl shadow-xl border-4 border-yellow-300 fade-in">
            <div class="text-8xl mb-4">ğŸ†</div>
            <h2 class="text-4xl font-black text-blue-800 mb-2">æŒ‘æˆ°å®Œæˆï¼</h2>
            <p class="text-stone-600 text-xl mb-8">ä½ çš„çµ±è¨ˆåœ–èƒ½åŠ›ç­‰ç´šæ˜¯...</p>
            
            <div class="bg-yellow-50 p-6 rounded-2xl border-2 border-yellow-200 mb-8">
                <div class="text-6xl font-black text-yellow-600 mb-2" id="final-score">0</div>
                <div class="text-2xl font-bold text-yellow-800" id="final-rank">çµ±è¨ˆåœ–å¤§å¸«</div>
            </div>

            <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white text-xl font-bold py-4 px-12 rounded-full shadow-lg transition-all hover:shadow-xl hover:-translate-y-1">
                å†æ¬¡æŒ‘æˆ° (é¡Œç›®æœƒä¸ä¸€æ¨£å–”ï¼)
            </button>
        </div>

        <!-- è§€å¿µæ•™å­¸å¡ -->
        <div id="concept-card" class="hidden max-w-3xl w-full bg-white p-8 rounded-3xl shadow-2xl border-4 border-blue-100 fade-in text-center">
            <h2 id="concept-title" class="text-3xl font-black text-blue-800 mb-6">è§€å¿µæ¨™é¡Œ</h2>
            <div id="concept-content" class="text-xl text-stone-700 leading-loose mb-8 bg-blue-50 p-6 rounded-xl text-left">
                è§€å¿µå…§å®¹...
            </div>
            <button id="concept-btn" class="bg-green-500 hover:bg-green-600 text-white text-xl font-bold py-3 px-10 rounded-full shadow-md transition-transform active:scale-95">
                æˆ‘æ‡‚äº†ï¼Œé–‹å§‹æŒ‘æˆ°ï¼
            </button>
        </div>

    </main>

    <script>
        // --- æ ¸å¿ƒè®Šæ•¸ ---
        let currentLevel = 0;
        let score = 0;
        let chartInstance = null;
        let currentQuestionData = null; 
        let questionStartTime = 0;
        let isRetryMode = false; 

        const synth = window.speechSynthesis;

        // --- é—œå¡è¨­å®š (Level Configuration) ---
        const levels = [
            {
                type: 'concept',
                title: 'èªè­˜é•·æ¢åœ–',
                content: 'é•·æ¢åœ–æ˜¯ç”¨<span class="text-blue-600 font-bold">é•·æ¢çš„é«˜åº¦</span>ä¾†è¡¨ç¤ºæ•¸é‡çš„å¤šå°‘ã€‚<br>é•·æ¢è¶Šé«˜ï¼Œä»£è¡¨æ•¸é‡è¶Šå¤šï¼›é•·æ¢è¶ŠçŸ®ï¼Œä»£è¡¨æ•¸é‡è¶Šå°‘ã€‚<br>è®“æˆ‘å€‘ä¾†ç·´ç¿’çœ‹çœ‹èª°æœ€å¤šã€èª°æœ€å°‘ï¼'
            },
            {
                type: 'game',
                mode: 'bar_basic', 
                title: 'å„ç­è³‡æºå›æ”¶é‡', // ä¾†è‡ªç¿’ä½œ P.134
                questionType: 'max', 
                genFn: generateBarData 
            },
            {
                type: 'game',
                mode: 'bar_basic',
                title: 'æœ€å–œæ­¡çš„å­£ç¯€', // ä¾†è‡ªç¿’ä½œ P.144
                questionType: 'min', 
                genFn: generateBarData
            },
            {
                type: 'concept',
                title: 'èªè­˜åˆ»åº¦èˆ‡å–®ä½',
                content: 'çœ‹çµ±è¨ˆåœ–æ™‚ï¼Œè¦æ³¨æ„ç¸±è»¸(æ—é‚Šçš„ç·š)çš„åˆ»åº¦ã€‚<br>æœ‰æ™‚å€™ä¸€æ ¼ä¸æ˜¯ä»£è¡¨ 1 å–”ï¼<br>å¦‚æœ 0 åˆ° 10 åˆ†æˆ 5 æ ¼ï¼Œé‚£éº¼<span class="text-red-500 font-bold">ä¸€æ ¼å°±æ˜¯ 2</span>ã€‚'
            },
            {
                type: 'game',
                mode: 'bar_scale', 
                title: 'å‹•ç‰©åœ’å…¥åœ’äººæ•¸', // ä¾†è‡ªèª²æœ¬ P.48 (å£½å±±å‹•ç‰©åœ’)
                questionType: 'value', 
                scaleStep: 10, 
                genFn: generateBarData
            },
            {
                type: 'concept',
                title: 'èªè­˜æŠ˜ç·šåœ–',
                content: 'æŠ˜ç·šåœ–æ˜¯ç”¨<span class="text-blue-600 font-bold">ç·šçš„èµ·ä¼</span>ä¾†è¡¨ç¤ºè®ŠåŒ–ã€‚<br>ğŸ“ˆ ç·šå¾€ä¸Šçˆ¬è¡¨ç¤ºå¢åŠ ã€‚<br>ğŸ“‰ ç·šå¾€ä¸‹æ»‘è¡¨ç¤ºæ¸›å°‘ã€‚<br>é©åˆç”¨ä¾†çœ‹æ°£æº«ã€èº«é«˜é€™ç¨®æœƒè®ŠåŒ–çš„è³‡æ–™ã€‚'
            },
            {
                type: 'game',
                mode: 'line_trend', 
                title: 'ä¸€é€±æ°£æº«è®ŠåŒ–ç´€éŒ„', // ä¿®æ­£ï¼šä½¿ç”¨æ°£æº«ï¼Œç¬¦åˆå¿½é«˜å¿½ä½é‚è¼¯ (ç¿’ä½œ P.34 æ°£æº«è®ŠåŒ–)
                questionType: 'trend_up', 
                genFn: generateLineData
            },
            {
                type: 'game',
                mode: 'line_growth', 
                title: 'æ‰¿æ©çš„èº«é«˜ç´€éŒ„', // ä¿®æ­£ï¼šä½¿ç”¨èº«é«˜ï¼Œç¬¦åˆå–®èª¿éå¢ (èª²æœ¬ P.40 æ‰¿æ©èº«é«˜)
                questionType: 'diff', 
                genFn: generateGrowthData // æ–°å¢ç”Ÿæˆå™¨ï¼šåªå¢ä¸æ¸›
            },
            {
                type: 'concept',
                title: 'è¤‡é›œçµ±è¨ˆåœ–',
                content: 'æœ‰æ™‚å€™åœ–è¡¨è£¡æœƒæœ‰å…©ç¨®é¡è‰²çš„é•·æ¢æˆ–ç·šã€‚<br>é€™æ™‚å€™è¦å…ˆçœ‹ä¸Šé¢çš„<span class="bg-yellow-200 px-2 rounded">åœ–ä¾‹</span>ã€‚<br>ä¾‹å¦‚è—è‰²ä»£è¡¨ç”·ç”Ÿï¼Œç´…è‰²ä»£è¡¨å¥³ç”Ÿã€‚<br>åˆ†æ¸…æ¥šé¡è‰²æ‰ä¸æœƒçœ‹éŒ¯å–”ï¼'
            },
            {
                type: 'game',
                mode: 'complex_bar',
                title: 'åœ–æ›¸é¤¨å€Ÿæ›¸äººæ¬¡', // ä¾†è‡ªç¿’ä½œ P.34
                questionType: 'compare_group', 
                genFn: generateComplexBarData
            }
        ];

        // --- äº‚æ•¸ç”Ÿæˆå™¨ (Random Generators) ---
        function randomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // ç”Ÿæˆé•·æ¢åœ–æ•¸æ“š
        function generateBarData(config) {
            let items = [];
            if (config.title.includes('è³‡æºå›æ”¶')) {
                items = ['ç”²ç­', 'ä¹™ç­', 'ä¸™ç­', 'ä¸ç­', 'æˆŠç­'];
            } else if (config.title.includes('å­£ç¯€')) {
                items = ['æ˜¥å¤©', 'å¤å¤©', 'ç§‹å¤©', 'å†¬å¤©'];
            } else if (config.title.includes('å‹•ç‰©åœ’')) {
                items = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ'];
            } else {
                items = ['è˜‹æœ', 'é¦™è•‰', 'è¥¿ç“œ', 'è‘¡è„', 'æ©˜å­'];
            }
            
            const labels = items.slice(0, 4); // å–å‰4å€‹
            const step = config.scaleStep || 1;
            let data = [];

            // ç­–ç•¥ï¼šé«˜å°æ¯”è½å·®
            if (config.questionType === 'max' || config.questionType === 'min') {
                data = labels.map(() => randomInt(3, 7) * step);
                
                if (config.questionType === 'max') {
                    const uniqueIdx = randomInt(0, labels.length - 1);
                    data = data.map((val, idx) => {
                        if (idx === uniqueIdx) return randomInt(12, 15) * step; // é¡¯è‘—æœ€é«˜
                        return randomInt(2, 5) * step; // å…¶ä»–å£“ä½
                    });
                } 
                else if (config.questionType === 'min') {
                    const uniqueIdx = randomInt(0, labels.length - 1);
                    data = data.map((val, idx) => {
                        if (idx === uniqueIdx) return randomInt(1, 2) * step; // é¡¯è‘—æœ€ä½
                        return randomInt(8, 12) * step; // å…¶ä»–æ‹‰é«˜
                    });
                }
            } else {
                data = labels.map(() => randomInt(2, 10) * step);
            }
            
            return {
                labels: labels,
                datasets: [{
                    label: 'æ•¸é‡',
                    data: data,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)'
                    ],
                    borderColor: 'white',
                    borderWidth: 2,
                    borderRadius: 8
                }],
                stepSize: step
            };
        }

        // ç”ŸæˆæŠ˜ç·šåœ–æ•¸æ“š (æ°£æº« - å¿½é«˜å¿½ä½)
        function generateLineData(config) {
            let labels = ['é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”']; 
            let data = [];
            // ç­–ç•¥ï¼šåŠ å¤§æ³¢å‹•å¹…åº¦
            let current = randomInt(18, 22);
            data.push(current);
            
            for (let i = 1; i < labels.length; i++) {
                const change = randomInt(3, 6) * (Math.random() > 0.5 ? 1 : -1);
                let nextVal = current + change;
                if (nextVal < 10) nextVal = current + Math.abs(change);
                if (nextVal > 30) nextVal = current - Math.abs(change);
                data.push(nextVal);
                current = nextVal;
            }

            if (config.questionType === 'trend_up') {
                const peakIdx = randomInt(0, labels.length - 1);
                data[peakIdx] = 35; // çªå‡ºçš„é«˜é»
                data = data.map((v, i) => i === peakIdx ? v : Math.min(v, 28));
            }

            return {
                labels: labels,
                datasets: [{
                    label: 'æ°£æº« (Â°C)', 
                    data: data,
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    borderWidth: 4,
                    pointRadius: 8,
                    pointBackgroundColor: 'white',
                    pointBorderWidth: 3,
                    tension: 0.1,
                    fill: true
                }],
                stepSize: 2
            };
        }

        // æ–°å¢ï¼šç”Ÿæˆæˆé•·å‹æ•¸æ“š (èº«é«˜ - åªå¢ä¸æ¸›)
        function generateGrowthData(config) {
            let labels = ['7æ­²', '8æ­²', '9æ­²', '10æ­²'];
            let data = [];
            
            // èµ·å§‹èº«é«˜
            let current = randomInt(120, 125);
            data.push(current);
            
            // æ¯å¹´é•·é«˜
            for (let i = 1; i < labels.length; i++) {
                // æ¯å¹´é•· 3~6 å…¬åˆ† (å–®èª¿éå¢)
                let growth = randomInt(3, 6);
                let nextVal = current + growth;
                data.push(nextVal);
                current = nextVal;
            }

            return {
                labels: labels,
                datasets: [{
                    label: 'èº«é«˜ (å…¬åˆ†)', 
                    data: data,
                    borderColor: '#16a34a', // green
                    backgroundColor: 'rgba(22, 163, 74, 0.1)',
                    borderWidth: 4,
                    pointRadius: 8,
                    pointBackgroundColor: 'white',
                    pointBorderWidth: 3,
                    tension: 0.1,
                    fill: true
                }],
                stepSize: 2
            };
        }

        // ç”Ÿæˆè¤‡é›œåœ–æ•¸æ“š
        function generateComplexBarData(config) {
            const labels = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ'];
            let dataA, dataB;
            let maxDiff = -1;

            // ç­–ç•¥ï¼šé«˜å°æ¯”å·®è·
            let safeGuard = 0;
            do {
                safeGuard++;
                const targetIdx = randomInt(0, 3);
                dataA = [];
                dataB = [];
                
                for(let i=0; i<4; i++) {
                    if (i === targetIdx) {
                        const base = randomInt(20, 30);
                        dataA.push(base);
                        dataB.push(base + randomInt(100, 120)); // å·®è· > 100
                    } else {
                        const base = randomInt(50, 70);
                        dataA.push(base);
                        dataB.push(base + randomInt(-10, 10)); // å·®è· < 10
                    }
                }
                
                let diffs = labels.map((_, i) => Math.abs(dataA[i] - dataB[i]));
                maxDiff = Math.max(...diffs);
                
                let count = diffs.filter(d => d === maxDiff).length;
                if (count === 1) break; 
                if (safeGuard > 10) break;
            } while (true);

            return {
                labels: labels,
                datasets: [
                    { label: 'ç”·ç”Ÿ', data: dataA, backgroundColor: '#3b82f6' },
                    { label: 'å¥³ç”Ÿ', data: dataB, backgroundColor: '#ec4899' }
                ],
                stepSize: 20
            };
        }

        // --- é¡Œç›®ç”Ÿæˆé‚è¼¯ ---
        function createQuestion(levelConfig, chartData) {
            const type = levelConfig.questionType;
            let text = "";
            let correctAnswer = "";
            let options = [];
            let dataset = chartData.datasets[0].data;
            let labels = chartData.labels;

            if (type === 'max') {
                const maxVal = Math.max(...dataset);
                const idx = dataset.indexOf(maxVal);
                correctAnswer = labels[idx];
                text = `è«‹å•å“ªä¸€å€‹é …ç›®çš„æ•¸é‡<span class="text-red-600 mx-1">æœ€å¤š</span>ï¼Ÿ`;
                options = labels; 
            } 
            else if (type === 'min') {
                const minVal = Math.min(...dataset);
                const idx = dataset.indexOf(minVal);
                correctAnswer = labels[idx];
                text = `è«‹å•å“ªä¸€å€‹é …ç›®çš„æ•¸é‡<span class="text-blue-600 mx-1">æœ€å°‘</span>ï¼Ÿ`;
                options = labels;
            }
            else if (type === 'value') {
                const idx = randomInt(0, labels.length - 1);
                const label = labels[idx];
                correctAnswer = dataset[idx].toString();
                text = `è«‹å• <span class="text-blue-600 mx-1 text-2xl">${label}</span> çš„æ•¸é‡æ˜¯å¤šå°‘ï¼Ÿ`;
                
                const step = chartData.stepSize || 1;
                const val = dataset[idx];
                options = [
                    val.toString(), 
                    (val + step * 5).toString(),
                    (Math.max(0, val - step * 3)).toString(),
                    (val + step * 2).toString()
                ].sort(() => Math.random() - 0.5);
            }
            else if (type === 'trend_up') { 
                const maxVal = Math.max(...dataset);
                const idx = dataset.indexOf(maxVal);
                correctAnswer = labels[idx];
                text = `è«‹å•å“ªä¸€å¤©çš„æ°£æº«<span class="text-red-600 mx-1">æœ€é«˜</span>ï¼Ÿ`;
                options = labels;
            }
            else if (type === 'diff') { 
                // å•æˆé•·é‡ (é ­å°¾ç›¸æ¸›)
                const idx1 = 0;
                const idx2 = labels.length - 1;
                const val1 = dataset[idx1];
                const val2 = dataset[idx2];
                const diff = val2 - val1; // èº«é«˜ä¸€å®šæ˜¯é•·é«˜ (æ­£æ•¸)
                correctAnswer = diff.toString();
                text = `å¾ ${labels[idx1]} åˆ° ${labels[idx2]}ï¼Œèº«é«˜é•·é«˜äº†å¹¾å…¬åˆ†ï¼Ÿ`;
                options = [
                    diff.toString(), 
                    (diff + 5).toString(), 
                    (Math.max(1, diff - 2)).toString(), 
                    (diff + 2).toString()
                ].map(String).sort(() => Math.random() - 0.5);
            }
            else if (type === 'compare_group') {
                const dataA = chartData.datasets[0].data;
                const dataB = chartData.datasets[1].data;
                let maxDiff = -1;
                let maxDiffLabel = "";
                
                labels.forEach((label, i) => {
                    const diff = Math.abs(dataA[i] - dataB[i]);
                    if (diff > maxDiff) {
                        maxDiff = diff;
                        maxDiffLabel = label;
                    }
                });
                
                correctAnswer = maxDiffLabel;
                text = `å“ªä¸€å€‹æœˆï¼Œç”·ç”Ÿå’Œå¥³ç”Ÿçš„æ•¸é‡<span class="text-red-600 mx-1">å·®è·æœ€å¤§</span>ï¼Ÿ`;
                options = labels;
            }

            return {
                text: text,
                correct: correctAnswer,
                options: options
            };
        }

        // --- éŠæˆ²æµç¨‹æ§åˆ¶ ---

        function init() {
            const conceptBtn = document.getElementById('concept-btn');
            if(conceptBtn) conceptBtn.onclick = nextLevel;
            
            const ttsChart = document.getElementById('tts-chart-intro');
            if(ttsChart) ttsChart.onclick = () => speak(document.getElementById('chart-title').innerText);
            
            const ttsQuestion = document.getElementById('tts-question');
            if(ttsQuestion) ttsQuestion.onclick = () => speak(document.getElementById('question-text').innerText);
            
            loadLevel();
        }

        function loadLevel() {
            if (currentLevel >= levels.length) {
                showEndScreen();
                return;
            }

            const config = levels[currentLevel];
            const indicator = document.getElementById('level-indicator');
            if(indicator) indicator.innerText = currentLevel + 1;

            document.getElementById('game-area').classList.add('hidden');
            document.getElementById('concept-card').classList.add('hidden');
            document.getElementById('end-screen').classList.add('hidden');

            if (config.type === 'concept') {
                const card = document.getElementById('concept-card');
                card.classList.remove('hidden');
                document.getElementById('concept-title').innerText = config.title;
                document.getElementById('concept-content').innerHTML = config.content;
                speak(config.title + "ã€‚" + config.content.replace(/<[^>]*>/g, ""));
            } else {
                document.getElementById('game-area').classList.remove('hidden');
                setupGameRound(config);
            }
        }

        function setupGameRound(config) {
            isRetryMode = false;
            resetUI();
            
            const chartData = config.genFn(config);
            
            renderChart(chartData, config.mode);
            document.getElementById('chart-title').innerText = config.title;

            currentQuestionData = createQuestion(config, chartData);
            
            document.getElementById('question-text').innerHTML = currentQuestionData.text;
            renderOptions(currentQuestionData.options);

            startTimer();
            
            const plainText = currentQuestionData.text.replace(/<[^>]*>/g, "");
            speak(config.title + "ã€‚" + plainText);
        }

        function renderChart(data, mode) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            const chartType = (mode.includes('line')) ? 'line' : 'bar';
            
            chartInstance = new Chart(ctx, {
                type: chartType,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 1000, easing: 'easeOutQuart' },
                    plugins: {
                        legend: { display: mode === 'complex_bar', labels: { font: { size: 16 } } },
                        tooltip: { bodyFont: { size: 16 }, titleFont: { size: 16 } }
                    },
                    scales: {
                        y: {
                            beginAtZero: mode !== 'line_basic' && mode !== 'line_trend' && mode !== 'line_growth',
                            // å¦‚æœæ˜¯èº«é«˜æˆ–æ°£æº«ï¼Œä¸éœ€è¦å¾0é–‹å§‹ï¼Œå¯ä»¥è®“è®ŠåŒ–æ›´æ˜é¡¯
                            ticks: { 
                                font: { size: 14 },
                                stepSize: data.stepSize || undefined 
                            }
                        },
                        x: { ticks: { font: { size: 14 } } }
                    }
                }
            });
        }

        function renderOptions(options) {
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            
            options.forEach(opt => {
                const btn = document.createElement('div');
                btn.className = 'option-card group';
                btn.innerHTML = `
                    <div class="option-indicator"></div>
                    <span class="text-xl font-bold text-stone-700 flex-grow text-left">${opt}</span>
                `;
                btn.onclick = () => checkAnswer(opt, btn);
                container.appendChild(btn);
            });
        }

        function checkAnswer(selected, btnElement) {
            stopTimer();
            const isCorrect = (selected === currentQuestionData.correct);
            const feedbackArea = document.getElementById('feedback-area');
            const feedbackMsg = document.getElementById('feedback-msg');
            const actionBtn = document.getElementById('action-btn');
            
            document.querySelectorAll('.option-card').forEach(b => b.classList.add('disabled'));

            feedbackArea.classList.remove('hidden');

            if (isCorrect) {
                btnElement.classList.add('correct');
                
                const timeBonus = Math.floor(timeLeft * 2);
                const points = isRetryMode ? 20 : (50 + timeBonus);
                
                addScore(points);
                
                feedbackMsg.innerHTML = `ğŸ‰ <span class="text-green-600">ç­”å°äº†ï¼</span> åŠ  ${points} åˆ†ï¼`;
                feedbackMsg.className = "text-xl font-bold mb-4 text-green-600";
                
                actionBtn.innerText = "ä¸‹ä¸€é—œ â¡";
                actionBtn.className = "w-full py-3 px-6 rounded-xl font-bold text-lg shadow-md bg-green-500 hover:bg-green-600 text-white";
                actionBtn.onclick = nextLevel;
                
                speak("ç­”å°äº†ï¼å¤ªæ£’äº†ï¼");
            } else {
                btnElement.classList.add('wrong');
                
                feedbackMsg.innerHTML = `âŒ <span class="text-red-500">å“å‘€ï¼Œä¸å°å–”ï¼</span><br><span class="text-sm font-normal text-stone-500">æ­£ç¢ºç­”æ¡ˆæ˜¯ ${currentQuestionData.correct}</span>`;
                feedbackMsg.className = "text-xl font-bold mb-4 text-red-600";
                
                isRetryMode = true;
                
                actionBtn.innerText = "ğŸ”„ å†è©¦ä¸€é¡Œ (é¡Œç›®æœƒè®Šå–”)";
                actionBtn.className = "w-full py-3 px-6 rounded-xl font-bold text-lg shadow-md bg-orange-500 hover:bg-orange-600 text-white";
                actionBtn.onclick = retryLevel;
                
                speak("å“å‘€ï¼Œä¸å°å–”ã€‚æˆ‘å€‘å†ç·´ç¿’ä¸€é¡Œè©¦è©¦çœ‹ã€‚");
            }
        }

        function retryLevel() {
            const config = levels[currentLevel];
            setupGameRound(config);
        }

        function nextLevel() {
            currentLevel++;
            loadLevel();
        }

        function addScore(points) {
            score += points;
            const el = document.getElementById('score-display');
            el.innerText = score;
            el.classList.remove('score-update');
            void el.offsetWidth;
            el.classList.add('score-update');
        }

        function resetUI() {
            document.getElementById('feedback-area').classList.add('hidden');
            document.getElementById('timer-bar').style.width = '100%';
            document.getElementById('timer-bar').classList.remove('bg-red-500');
            document.getElementById('timer-bar').classList.add('bg-green-500');
        }

        let timerInterval;
        let timeLeft;
        function startTimer() {
            timeLeft = 15;
            const bar = document.getElementById('timer-bar');
            clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                timeLeft -= 0.1;
                const percent = (timeLeft / 15) * 100;
                bar.style.width = `${percent}%`;
                
                if (percent < 30) {
                    bar.classList.remove('bg-green-500');
                    bar.classList.add('bg-red-500');
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                }
            }, 100);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function speak(text) {
            if (synth.speaking) synth.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-TW';
            u.rate = 0.9;
            synth.speak(u);
        }

        function showEndScreen() {
            document.getElementById('game-area').classList.add('hidden');
            document.getElementById('concept-card').classList.add('hidden');
            const endScreen = document.getElementById('end-screen');
            endScreen.classList.remove('hidden');
            
            document.getElementById('final-score').innerText = score;
            
            let rank = "çµ±è¨ˆå°å­¸å¾’";
            if (score > 300) rank = "æ•¸æ“šæ¢éšªå®¶";
            if (score > 500) rank = "çµ±è¨ˆåœ–å¤§å¸«";
            document.getElementById('final-rank').innerText = rank;
            
            speak(`æ­å–œå®ŒæˆæŒ‘æˆ°ï¼ä½ çš„ç¸½åˆ†æ˜¯${score}åˆ†ã€‚ç²å¾—ç¨±è™Ÿï¼š${rank}`);
        }

        window.onload = init;

    </script>
</body>
</html>
