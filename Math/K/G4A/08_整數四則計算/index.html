<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•¸å­¸ç¬¬8å–®å…ƒï¼šæ•´æ•¸å››å‰‡é‹ç®—å¤§æŒ‘æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0fdf4; /* æ·ºç¶ åº•ï¼Œè­·çœ¼ */
            overflow-x: hidden;
            touch-action: manipulation;
            user-select: none;
        }

        /* éŠæˆ²å®¹å™¨ */
        .game-container {
            position: relative;
            width: 95%;
            max-width: 900px;
            margin: 20px auto;
            background: #ffffff;
            border-radius: 24px;
            box-shadow: 0 10px 0 #86efac, 0 20px 25px rgba(0,0,0,0.1);
            padding: 24px;
            min-height: 680px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
        }

        /* é ‚éƒ¨è³‡è¨Šåˆ— */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f3f4f6;
        }

        .score-board {
            background: #fffbeb;
            border: 2px solid #fcd34d;
            color: #b45309;
            padding: 0.5rem 1rem;
            border-radius: 999px;
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 0 #fcd34d;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-voice {
            background-color: #e0f2fe;
            color: #0369a1;
            border-radius: 50px;
            padding: 8px 16px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            transition: transform 0.1s;
            border: 2px solid #bae6fd;
            box-shadow: 0 4px 0 #bae6fd;
        }
        .btn-voice:active { transform: translateY(4px); box-shadow: none; }

        /* åµæ¢æ¨¡å¼äº’å‹•æ–¹å¡Š */
        .interactive-box {
            background: #fff;
            border: 3px solid #cbd5e1;
            border-radius: 16px;
            padding: 15px 25px;
            font-size: 2.2rem;
            font-weight: bold;
            color: #334155;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 6px 0 #94a3b8;
            min-width: 70px;
            margin: 8px;
        }
        .interactive-box:active { transform: translateY(6px); box-shadow: none; }
        .interactive-box.correct { background-color: #dcfce7; border-color: #22c55e; color: #15803d; box-shadow: 0 6px 0 #22c55e; pointer-events: none; }
        .interactive-box.wrong { background-color: #fee2e2; border-color: #ef4444; color: #991b1b; animation: shake 0.5s; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* é€è¡Œç®—å¼æ¨£å¼ */
        .equation-row {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.4rem; 
            font-weight: bold;
            color: #334155;
            margin-bottom: 1.2rem;
            min-height: 70px;
            width: 100%;
            flex-wrap: wrap; 
        }
        
        .eq-symbol { width: 40px; text-align: right; margin-right: 10px; color: #94a3b8; flex-shrink: 0; }
        .eq-placeholder { width: 40px; margin-right: 10px; flex-shrink: 0; }

        .highlight-calc {
            color: #ef4444;
            border-bottom: 4px solid #ef4444;
            padding-bottom: 2px;
        }
        
        .calc-result-text { color: #ef4444; }

        /* è¼¸å…¥æ¡† */
        .step-input {
            width: 130px;
            height: 65px;
            font-size: 2rem;
            text-align: center;
            border: 3px solid #3b82f6;
            border-radius: 12px;
            background: #eff6ff;
            color: #1e40af;
            outline: none;
            transition: all 0.2s;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .step-input:focus {
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
            border-color: #2563eb;
            background: #fff;
        }

        /* æ‡‰ç”¨é¡Œå¡ç‰‡å„ªåŒ– */
        .item-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            background: white;
            padding: 16px;
            border-radius: 20px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 3px solid #e2e8f0;
            min-width: 140px;
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }
        .item-card:hover { transform: translateY(-4px); border-color: #60a5fa; }
        
        .price-tag {
            background: #fee2e2;
            color: #b91c1c;
            font-weight: bold;
            padding: 4px 12px;
            border-radius: 99px;
            font-size: 1.1rem;
            margin-top: 8px;
            border: 2px solid #fecaca;
        }
        
        .qty-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: #3b82f6;
            color: white;
            font-weight: bold;
            padding: 4px 12px;
            border-bottom-left-radius: 16px;
            font-size: 0.9rem;
        }

        /* Emoji æ’åˆ— */
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2px;
            font-size: 2rem;
            margin-bottom: 8px;
            justify-items: center;
        }
        .emoji-single { font-size: 3.5rem; margin-bottom: 8px; }

        /* è¦å‰‡èˆ‡çµç®—è¦†è“‹å±¤ */
        .overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.98);
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 24px;
        }

        /* åˆ†æ•¸è·³å‹•å‹•ç•« */
        .score-popup {
            position: absolute;
            font-size: 3rem;
            font-weight: bold;
            color: #f59e0b;
            text-shadow: 2px 2px 0px #fff;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            z-index: 100;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { transform: translateY(-20px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-100px) scale(1); opacity: 0; }
        }
        
        /* éš±è—æ•¸å­—è¼¸å…¥æ¡†çš„ä¸Šä¸‹ç®­é ­ */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body>

<div class="game-container" id="app">
    
    <!-- é ‚éƒ¨è³‡è¨Šåˆ— -->
    <div class="top-bar">
        <div class="flex items-center gap-4">
            <div class="score-board" id="scoreDisplay">
                <span>â­</span>
                <span id="scoreValue">0</span>
            </div>
            <div class="flex flex-col">
                <span class="text-xs text-gray-500 font-bold">é—œå¡</span>
                <div class="text-blue-600 font-black text-xl">
                    <span id="currentLevelText">1</span> / <span id="totalLevelText">10</span>
                </div>
            </div>
        </div>
        <button onclick="toggleSound()" class="btn-voice" aria-label="èªéŸ³é–‹é—œ">
            <span class="text-lg mr-2">ğŸ”Š</span>
            <span id="soundText">èªéŸ³ï¼šé–‹</span>
        </button>
    </div>

    <!-- éŠæˆ²ä¸»èˆå° -->
    <div id="stageArea" class="flex-1 flex flex-col items-center justify-center relative z-20 min-h-[400px]">
        <div class="text-center">
            <p class="text-xl text-gray-500 mb-4 animate-pulse">æ­£åœ¨æº–å‚™æ•¸å­¸å†’éšª...</p>
        </div>
    </div>

    <!-- åº•éƒ¨æ§åˆ¶å€ (å›é¥‹è¨Šæ¯) -->
    <div id="controlArea" class="mt-4 h-24 flex items-center justify-center z-20 relative"></div>
</div>

<script>
    // --- éŠæˆ²è¨­å®š ---
    const TOTAL_LEVELS = 10;
    let levels = [];
    let currentLevelIdx = 0;
    let currentStep = 0;
    let isSoundOn = true;
    let score = 0;
    let levelStartTime = 0;
    let correctCount = 0; // ç­”å°é¡Œæ•¸çµ±è¨ˆ

    // --- åˆå§‹åŒ– ---
    window.onload = () => {
        levels = generateLevels();
        document.getElementById('totalLevelText').innerText = levels.length;
        loadLevel(0);
    };

    // --- äº‚æ•¸èˆ‡é¡Œåº«ç”Ÿæˆ ---
    function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

    function generateLevels() {
        const lvls = [];
        
        // 1-4: åµæ¢æ¨¡å¼ (è§€å¿µ)
        lvls.push(createDetectiveLevel("æ‹¬è™Ÿå…ˆç®—", "ç®—å¼è£¡æœ‰æ‹¬è™Ÿï¼Œè¦å…ˆç®—å“ªè£¡ï¼Ÿ", (a,b,c)=>[{val:a+b+c+10,type:"num"},{val:"-",type:"op"},{val:`( ${b} + ${c} )`,type:"group",isAnswer:true}]));
        lvls.push(createDetectiveLevel("æ‹¬è™Ÿå…ˆç®—", "æ‹¬è™Ÿåœ¨å‰é¢ï¼Œé‚„æ˜¯è¦å…ˆç®—æ‹¬è™Ÿå–”ï¼", (a,b,c)=>[{val:`( ${a+b} - ${b} )`,type:"group",isAnswer:true},{val:"Ã—",type:"op"},{val:c,type:"num"}]));
        lvls.push(createDetectiveLevel("å…ˆä¹˜é™¤å¾ŒåŠ æ¸›", "æ²’æœ‰æ‹¬è™Ÿï¼Œè¦å…ˆç®—ä¹˜æ³•ï¼", (a,b,c)=>[{val:a*5+10,type:"num"},{val:"+",type:"op"},{val:`${b} Ã— ${c}`,type:"group",isAnswer:true}]));
        lvls.push(createDetectiveLevel("å…ˆä¹˜é™¤å¾ŒåŠ æ¸›", "é€™æ¬¡æœ‰é™¤æ³•ï¼Œè¦å…ˆç®—å“ªè£¡ï¼Ÿ", (a,b,c)=>{const d=c*b; return[{val:d+20,type:"num"},{val:"-",type:"op"},{val:`${d} Ã· ${c}`,type:"group",isAnswer:true}]}));

        // 5-8: é€æ­¥è¨ˆç®— (Scaffold)
        lvls.push(createScaffoldLevel('mul_last'));
        lvls.push(createScaffoldLevel('div_last'));
        lvls.push(createScaffoldLevel('bracket_last'));
        lvls.push(createScaffoldLevel('bracket_first'));

        // 9-10: æ‡‰ç”¨é¡Œ (Application)
        lvls.push(createApplicationLevel('breakfast'));
        lvls.push(createApplicationLevel('stationery'));

        return lvls;
    }

    function createDetectiveLevel(concept, hint, partsGen) {
        const b = getRandomInt(3, 9), c = getRandomInt(2, 5), a = getRandomInt(10, 50);
        return { type: 'detective', title: `è§€å¿µé¡Œï¼š${concept}`, instruction: "è«‹é»é¸ç®—å¼ä¸­ï¼Œæ‡‰è©²è¦ã€Œæœ€å…ˆè¨ˆç®—ã€çš„éƒ¨åˆ†ã€‚", expression: partsGen(a, b, c), hint, voiceIntro: `è§€å¿µé¡Œï¼Œ${concept}ã€‚${hint} è«‹é»é¸æ‡‰è©²è¦æœ€å…ˆè¨ˆç®—çš„éƒ¨åˆ†ã€‚` };
    }

    function createScaffoldLevel(subType) {
        // ç°¡åŒ–é‡è¤‡ä»£ç¢¼ï¼Œä¿ç•™æ ¸å¿ƒé‚è¼¯ (åŒä¸Šä¸€ç‰ˆï¼Œç•¥ä½œå£“ç¸®)
        let steps=[], title="è¨ˆç®—é¡Œï¼šä¸€æ­¥ä¸€æ­¥ç®—", ruleVoice="";
        if(subType==='mul_last'){
            const b=getRandomInt(2,8), c=getRandomInt(3,9), prod=b*c, a=prod+getRandomInt(10,50);
            ruleVoice="ç®—å¼è£¡æœ‰ä¹˜æ³•ï¼Œè¨˜å¾—è¦å…ˆç®—ä¹˜æ³•å–”ï¼";
            steps=[
                {row1:{pre:`${a} - `,highlight:`${b} Ã— ${c}`,post:""}, row2:{pre:`${a} - `,inputAnswer:prod,post:""}, voice:`å…ˆç®—ä¹˜æ³•ã€‚${b} ä¹˜ ${c} ç­‰æ–¼å¤šå°‘ï¼Ÿ`},
                {row1:{pre:`${a} - `,highlight:`${b} Ã— ${c}`,post:""}, row2:{pre:`${a} - `,staticVal:prod,post:""}, row3:{pre:"",inputAnswer:a-prod,post:""}, voice:`ç®—å¼è®Šæˆ ${a} æ¸› ${prod}ã€‚ç­”æ¡ˆæ˜¯å¤šå°‘ï¼Ÿ`}
            ];
        } else if(subType==='div_last'){
            const c=getRandomInt(2,5), ans=getRandomInt(3,9), b=c*ans, a=getRandomInt(10,50);
            ruleVoice="ç®—å¼è£¡æœ‰é™¤æ³•ï¼Œè¦å…ˆç®—é™¤æ³•ï¼";
            steps=[
                {row1:{pre:`${a} + `,highlight:`${b} Ã· ${c}`,post:""}, row2:{pre:`${a} + `,inputAnswer:ans,post:""}, voice:`å…ˆç®—é™¤æ³•ã€‚${b} é™¤ä»¥ ${c} ç­‰æ–¼å¤šå°‘ï¼Ÿ`},
                {row1:{pre:`${a} + `,highlight:`${b} Ã· ${c}`,post:""}, row2:{pre:`${a} + `,staticVal:ans,post:""}, row3:{pre:"",inputAnswer:a+ans,post:""}, voice:`ç®—å¼è®Šæˆ ${a} åŠ  ${ans}ã€‚ç­”æ¡ˆæ˜¯å¤šå°‘ï¼Ÿ`}
            ];
        } else if(subType==='bracket_last'){
            const b=getRandomInt(5,15), c=getRandomInt(5,10), sum=b+c, a=sum+getRandomInt(10,30);
            ruleVoice="æœ‰æ‹¬è™Ÿï¼Œæ‹¬è™Ÿè£¡é¢å…ˆç®—ï¼";
            steps=[
                {row1:{pre:`${a} - `,highlight:`( ${b} + ${c} )`,post:""}, row2:{pre:`${a} - `,inputAnswer:sum,post:""}, voice:`å…ˆç®—æ‹¬è™Ÿã€‚${b} åŠ  ${c} æ˜¯å¤šå°‘ï¼Ÿ`},
                {row1:{pre:`${a} - `,highlight:`( ${b} + ${c} )`,post:""}, row2:{pre:`${a} - `,staticVal:sum,post:""}, row3:{pre:"",inputAnswer:a-sum,post:""}, voice:`æœ€å¾Œç®— ${a} æ¸› ${sum}ã€‚ç­”æ¡ˆæ˜¯å¤šå°‘ï¼Ÿ`}
            ];
        } else {
            const a=getRandomInt(10,20), b=getRandomInt(5,10), sum=a+b, c=getRandomInt(2,4);
            ruleVoice="æ‹¬è™Ÿåœ¨å‰é¢ï¼Œä¸€æ¨£å…ˆç®—æ‹¬è™Ÿï¼";
            steps=[
                {row1:{pre:"",highlight:`( ${a} + ${b} )`,post:` Ã— ${c}`}, row2:{pre:"",inputAnswer:sum,post:` Ã— ${c}`}, voice:`å…ˆç®—æ‹¬è™Ÿè£¡çš„åŠ æ³•ã€‚${a} åŠ  ${b} æ˜¯å¤šå°‘ï¼Ÿ`},
                {row1:{pre:"",highlight:`( ${a} + ${b} )`,post:` Ã— ${c}`}, row2:{pre:"",staticVal:sum,post:` Ã— ${c}`}, row3:{pre:"",inputAnswer:sum*c,post:""}, voice:`ç¾åœ¨ç®— ${sum} ä¹˜ ${c}ã€‚`}
            ];
        }
        return { type: 'scaffold_vertical', title, ruleVoice, steps };
    }

    function createApplicationLevel(theme) {
        let p1, p2, multiplier, items, story, voice, teaEmoji="", teaLabel="";
        
        if (theme === 'breakfast') {
            p1 = getRandomInt(25, 40); p2 = getRandomInt(10, 15); multiplier = getRandomInt(3, 5);
            story = `åª½åª½è²·äº† 1 ä»½è”¥æŠ“é¤… ($${p1}) å’Œ ${multiplier} æ¯ç´…èŒ¶ ($${p2})ã€‚å…±è¦ä»˜å¤šå°‘å…ƒï¼Ÿ`;
            voice = `æ‡‰ç”¨é¡Œã€‚åª½åª½è²·äº†1ä»½è”¥æŠ“é¤… ${p1}å…ƒï¼Œå’Œ ${multiplier} æ¯ç´…èŒ¶ï¼Œæ¯æ¯ ${p2}å…ƒã€‚å…±è¦ä»˜å¤šå°‘éŒ¢ï¼Ÿ`;
            
            // ç”Ÿæˆ emoji é™£åˆ—
            teaEmoji = Array(multiplier).fill("ğŸ¥¤").join("");
            
            items = [
                { name: "è”¥æŠ“é¤…", price: p1, img: "ğŸ¥", unit: "å–®åƒ¹" },
                { name: "ç´…èŒ¶", price: p2, img: teaEmoji, count: multiplier, unit: "æ¯æ¯" } 
            ];
        } else {
            p1 = getRandomInt(100, 200); p2 = getRandomInt(10, 20); multiplier = getRandomInt(4, 6);
            story = `å°æ˜è²·äº† 1 æœ¬æ›¸ ($${p1}) å’Œ ${multiplier} æåŸå­ç­† ($${p2})ã€‚å…±è¦ä»˜å¤šå°‘å…ƒï¼Ÿ`;
            voice = `æ‡‰ç”¨é¡Œã€‚è²·1æœ¬æ›¸ ${p1}å…ƒï¼Œå’Œ ${multiplier} æåŸå­ç­†ï¼Œæ¯æ ${p2}å…ƒã€‚ç¸½å…±è¦å¤šå°‘éŒ¢ï¼Ÿ`;
            
            items = [
                { name: "æ•…äº‹æ›¸", price: p1, img: "ğŸ“š", unit: "ä¸€æœ¬" },
                { name: "åŸå­ç­†", price: p2, img: Array(multiplier).fill("ğŸ–Šï¸").join(""), count: multiplier, unit: "æ¯æ" }
            ];
        }

        return {
            type: 'application_vertical',
            title: "æ‡‰ç”¨é¡Œï¼šç”Ÿæ´»å°å¹«æ‰‹", story, items, voiceIntro: voice,
            steps: [
                {
                    instruction: "åˆ—å‡ºç®—å¼", voice: "è«‹çœ‹ä¸Šé¢çš„æ¨™åƒ¹ã€‚æŠŠå…©ç¨®å•†å“çš„åƒ¹æ ¼å¡«å…¥ç®—å¼ã€‚",
                    inputs: [p1, p2], multiplier, template: `[input] + [input] Ã— ${multiplier}`
                },
                {
                    instruction: "å…ˆç®—ä¹˜æ³•", voice: `åˆ—å¼æ­£ç¢ºï¼å…ˆç®— ${multiplier} å€‹ ${items[1].name} è¦å¤šå°‘éŒ¢ï¼Ÿ`,
                    row1: {pre:`${p1} + `,highlight:`${p2} Ã— ${multiplier}`,post:""}, row2:{pre:`${p1} + `,inputAnswer:p2*multiplier,post:""}
                },
                {
                    instruction: "ç®—å‡ºç¸½é‡‘é¡", voice: "æœ€å¾ŒæŠŠå…©æ¨£æ±è¥¿çš„éŒ¢åŠ èµ·ä¾†ã€‚",
                    row1:{pre:`${p1} + `,highlight:`${p2} Ã— ${multiplier}`,post:""}, row2:{pre:`${p1} + `,staticVal:p2*multiplier,post:""}, row3:{pre:"",inputAnswer:p1+(p2*multiplier),post:""}
                }
            ],
            finalAnswer: p1 + p2 * multiplier
        };
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ï¼šè¼‰å…¥é—œå¡ ---
    function loadLevel(idx) {
        currentLevelIdx = idx;
        currentStep = 0;
        levelStartTime = Date.now(); // é–‹å§‹è¨ˆæ™‚

        document.getElementById('currentLevelText').innerText = idx + 1;
        document.getElementById('controlArea').innerHTML = ''; 
        
        if (idx >= levels.length) {
            renderSummary(); // éŠæˆ²çµæŸ
            return;
        }

        const levelData = levels[idx];
        if (levelData.type === 'detective') {
            renderDetective(levelData);
            setTimeout(() => speak(levelData.voiceIntro), 500);
        } else if (levelData.type === 'scaffold_vertical') {
            // é¡¯ç¤ºè¦å‰‡æç¤ºï¼Œé»æ“Šå¾Œé–‹å§‹
            showRuleOverlay(levelData.ruleVoice, () => {
                 renderScaffoldVertical(levelData);
                 speak(levelData.steps[0].voice);
            });
        } else if (levelData.type === 'application_vertical') {
             renderApplicationVertical(levelData);
             setTimeout(() => speak(levelData.voiceIntro), 500);
        }
    }

    function showRuleOverlay(voiceText, callback) {
        const stage = document.getElementById('stageArea');
        stage.innerHTML = `
            <div class="overlay">
                <div class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-md border-4 border-yellow-200">
                    <div class="text-6xl mb-4">ğŸ’¡</div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">é‡é»æé†’</h3>
                    <p class="text-xl text-blue-600 font-bold mb-8">æº–å‚™å¥½äº†å—ï¼Ÿ</p>
                    <button id="startBtn" class="bg-blue-500 hover:bg-blue-600 text-white text-xl font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:scale-105">
                        é–‹å§‹è§£é¡Œ
                    </button>
                </div>
            </div>
        `;
        speak(voiceText);
        document.getElementById('startBtn').onclick = callback;
    }

    // --- æ¸²æŸ“é‚è¼¯ ---
    function renderDetective(data) {
        let html = `
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-blue-700 mb-2">${data.title} <button onclick="speak('${data.instruction}')" class="text-xl ml-2">ğŸ”Š</button></h2>
                <p class="text-gray-600 text-lg">${data.instruction}</p>
            </div>
            <div class="flex flex-wrap justify-center items-center gap-4 p-8 bg-white rounded-2xl shadow-sm border-2 border-blue-100">
        `;
        data.expression.forEach((part, index) => {
            html += `<div id="box-${index}" class="interactive-box" onclick="checkDetective(${index})">${part.val}</div>`;
        });
        html += `</div>`;
        document.getElementById('stageArea').innerHTML = html;
    }

    function renderScaffoldVertical(data) {
        const stepData = data.steps[currentStep]; // currentStep 0-indexed for logic
        let html = `
            <div class="w-full max-w-lg mx-auto">
                <div class="text-center mb-4">
                    <h2 class="text-2xl font-bold text-blue-700">${data.title} <button onclick="speak('${stepData.voice}')" class="text-xl ml-2">ğŸ”Š</button></h2>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 relative overflow-hidden">
                    <div class="equation-row">
                        <div class="eq-placeholder"></div>
                        <div class="eq-content">
                            <span>${stepData.row1.pre}</span>
                            <span class="highlight-calc">${stepData.row1.highlight}</span>
                            <span>${stepData.row1.post}</span>
                        </div>
                    </div>
                    <div class="equation-row fade-in">
                        <div class="eq-symbol">=</div>
                        <div class="eq-content">
                            <span>${stepData.row2.pre}</span>
                            ${stepData.row2.inputAnswer !== undefined ? `<input type="number" id="scaffoldInput" class="step-input" placeholder="?">` : `<span class="calc-result-text text-4xl">${stepData.row2.staticVal}</span>`}
                            <span>${stepData.row2.post}</span>
                        </div>
                    </div>
                    ${stepData.row3 ? `<div class="equation-row fade-in"><div class="eq-symbol">=</div><div class="eq-content"><span>${stepData.row3.pre}</span><input type="number" id="scaffoldInput" class="step-input" placeholder="?"><span>${stepData.row3.post}</span></div></div>` : ''}
                </div>
                <div class="text-center mt-6">
                    <button onclick="checkScaffold()" class="bg-green-500 hover:bg-green-600 text-white text-xl font-bold py-3 px-10 rounded-xl shadow-lg transition transform active:scale-95">é€å‡ºç­”æ¡ˆ</button>
                </div>
            </div>`;
        document.getElementById('stageArea').innerHTML = html;
        setTimeout(()=>{const i=document.getElementById('scaffoldInput');if(i)i.focus()},200);
    }

    function renderApplicationVertical(data) {
        if(currentStep===0) currentStep=1;
        const stepData = data.steps[currentStep - 1];
        let calcHtml = '';
        
        if(currentStep===1) {
            calcHtml = `<div class="equation-row"><div class="eq-content w-full justify-center"><input type="number" id="appInput1" class="step-input" placeholder="?"><span> + </span><input type="number" id="appInput2" class="step-input" placeholder="?"><span> Ã— ${stepData.multiplier} </span></div></div>`;
        } else {
            calcHtml = `<div class="equation-row"><div class="eq-placeholder"></div><div class="eq-content"><span>${stepData.row1.pre}</span><span class="highlight-calc">${stepData.row1.highlight}</span><span>${stepData.row1.post}</span></div></div>
                <div class="equation-row fade-in"><div class="eq-symbol">=</div><div class="eq-content"><span>${stepData.row2.pre}</span>${stepData.row2.inputAnswer!==undefined?`<input type="number" id="scaffoldInput" class="step-input" placeholder="?">`:`<span class="calc-result-text text-4xl">${stepData.row2.staticVal}</span>`}<span>${stepData.row2.post}</span></div></div>
                ${stepData.row3?`<div class="equation-row fade-in"><div class="eq-symbol">=</div><div class="eq-content"><span>${stepData.row3.pre}</span><input type="number" id="scaffoldInput" class="step-input" placeholder="?"><span>${stepData.row3.post}</span></div></div>`:''}`;
        }

        let html = `
            <div class="w-full max-w-3xl mx-auto">
                <div class="text-center mb-2">
                    <h2 class="text-2xl font-bold text-blue-700">${data.title} <button onclick="speak('${stepData.voice}')" class="text-xl ml-2">ğŸ”Š</button></h2>
                </div>
                <div class="bg-orange-50 p-4 rounded-2xl border-2 border-orange-200 mb-4 shadow-sm">
                     <div class="flex justify-center gap-6 mb-3 flex-wrap">
                        ${data.items.map(item => `
                            <div class="item-card">
                                ${item.count ? `<div class="qty-badge">è²·äº†${item.count}å€‹</div>` : ''}
                                <div class="${item.img.length > 2 ? 'emoji-grid' : 'emoji-single'}">${item.img}</div>
                                <div class="font-bold text-gray-700 text-lg">${item.name}</div>
                                <div class="price-tag">${item.unit} $${item.price}</div>
                            </div>
                        `).join('')}
                    </div>
                    <p class="text-xl text-gray-800 font-bold text-center bg-white/50 p-2 rounded-lg">${data.story}</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 relative min-h-[180px]">
                    ${calcHtml}
                </div>
                <div class="text-center mt-4">
                    <button onclick="checkApplication()" class="bg-green-500 hover:bg-green-600 text-white text-xl font-bold py-3 px-10 rounded-xl shadow-lg transition transform active:scale-95">${currentStep===1?'åˆ—å¼å®Œæˆ':'é€å‡ºç­”æ¡ˆ'}</button>
                </div>
            </div>`;
        document.getElementById('stageArea').innerHTML = html;
        setTimeout(()=>{const i=document.getElementById('appInput1')||document.getElementById('scaffoldInput');if(i)i.focus()},200);
    }

    // --- åˆ¤æ–·èˆ‡è¨ˆåˆ†é‚è¼¯ ---

    function addScore(points) {
        score += points;
        // åˆ†æ•¸è·³å‹•ç‰¹æ•ˆ
        const popup = document.createElement('div');
        popup.className = 'score-popup';
        popup.innerText = `+${points}`;
        popup.style.left = '50%';
        popup.style.top = '20%';
        document.body.appendChild(popup);
        setTimeout(() => popup.remove(), 1000);
        
        // æ›´æ–° UI
        const scoreEl = document.getElementById('scoreValue');
        // ç°¡å–®çš„æ•¸å­—æ»¾å‹•æ•ˆæœ
        let current = parseInt(scoreEl.innerText);
        const step = Math.ceil((score - current) / 10);
        const timer = setInterval(() => {
            current += step;
            if (current >= score) {
                current = score;
                clearInterval(timer);
            }
            scoreEl.innerText = current;
        }, 30);
    }

    function calculatePoints() {
        const timeTaken = (Date.now() - levelStartTime) / 1000;
        let points = 100; // åŸºç¤åˆ†
        if (timeTaken < 10) points += 50; // é€Ÿåº¦çå‹µ
        else if (timeTaken < 20) points += 20;
        return points;
    }

    // åµæ¢æ¨¡å¼æª¢æŸ¥
    function checkDetective(index) {
        const levelData = levels[currentLevelIdx];
        const box = document.getElementById(`box-${index}`);
        if (levelData.expression[index].isAnswer) {
            box.classList.add('correct');
            const pts = calculatePoints();
            addScore(pts);
            showFeedback(true, `ç­”å°äº†ï¼(+${pts}åˆ†)`, null, true);
        } else {
            box.classList.add('wrong');
            setTimeout(()=>box.classList.remove('wrong'), 500);
            showFeedback(false, levelData.hint);
        }
    }

    // é€æ­¥è¨ˆç®—æª¢æŸ¥
    function checkScaffold() {
        const input = document.getElementById('scaffoldInput');
        if(!input) return;
        const userVal = parseInt(input.value);
        const levelData = levels[currentLevelIdx];
        const stepData = levelData.steps[currentStep]; // logic correction: data.steps is 0-based
        const targetAns = stepData.row3 ? stepData.row3.inputAnswer : stepData.row2.inputAnswer;

        if(userVal === targetAns) {
            const pts = calculatePoints();
            addScore(Math.floor(pts/2)); // æ­¥é©Ÿåˆ†
            if(currentStep < levelData.steps.length - 1) {
                showFeedback(true, "ç®—å°äº†ï¼æ¥è‘—ä¸‹ä¸€æ­¥ï¼", () => {
                    currentStep++;
                    renderScaffoldVertical(levelData);
                    speak(levelData.steps[currentStep].voice);
                });
            } else {
                showFeedback(true, "å¤ªå²å®³äº†ï¼æŒ‘æˆ°æˆåŠŸï¼", null, true);
            }
        } else {
            input.classList.add('border-red-500');
            setTimeout(()=>input.classList.remove('border-red-500'),500);
            showFeedback(false, "å†ç®—ç®—çœ‹å–”ï¼");
        }
    }

    // æ‡‰ç”¨é¡Œæª¢æŸ¥
    function checkApplication() {
        const levelData = levels[currentLevelIdx];
        const stepData = levelData.steps[currentStep - 1];

        if(currentStep === 1) {
            const v1 = parseInt(document.getElementById('appInput1').value);
            const v2 = parseInt(document.getElementById('appInput2').value);
            const correct = stepData.inputs;
            if(v1===correct[0] && v2===correct[1]) {
                addScore(50);
                showFeedback(true, "åˆ—å¼æ­£ç¢ºï¼", () => {
                    currentStep++;
                    renderApplicationVertical(levelData);
                    speak(levelData.steps[currentStep-1].voice);
                });
            } else {
                showFeedback(false, "æ•¸å­—å¥½åƒå¡«éŒ¯å›‰ï¼Œçœ‹ä¸Šé¢çš„åƒ¹æ ¼ã€‚");
            }
        } else {
            const input = document.getElementById('scaffoldInput');
            const userVal = parseInt(input.value);
            const targetAns = stepData.row3 ? stepData.row3.inputAnswer : stepData.row2.inputAnswer;
            if(userVal === targetAns) {
                const pts = calculatePoints();
                addScore(pts);
                if(currentStep < levelData.steps.length) {
                    showFeedback(true, "ç®—å°äº†ï¼", () => {
                        currentStep++;
                        renderApplicationVertical(levelData);
                        speak(levelData.steps[currentStep-1].voice);
                    });
                } else {
                    showFeedback(true, "å¤ªæ£’äº†ï¼å…¨éƒ¨å®Œæˆï¼", null, true);
                }
            } else {
                input.classList.add('border-red-500');
                setTimeout(()=>input.classList.remove('border-red-500'),500);
                showFeedback(false, "å†ç®—ç®—çœ‹å–”ï¼");
            }
        }
    }

    // --- å›é¥‹èˆ‡çµç®—ç³»çµ± ---

    function showFeedback(isCorrect, msg, callback, isLevelComplete = false) {
        const controlArea = document.getElementById('controlArea');
        const color = isCorrect ? 'text-green-600' : 'text-red-500';
        const icon = isCorrect ? 'ğŸ‰' : 'ğŸ’ª';
        speak((isCorrect ? "ç­”å°äº†ï¼" : "åŠ æ²¹ï¼") + msg);
        
        let btnHtml = '';
        if (isCorrect) {
            if (callback) {
                btnHtml = `<button onclick="handleNext(true)" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-2 rounded-full font-bold shadow-lg transition">ä¸‹ä¸€æ­¥</button>`;
            } else if (isLevelComplete) {
                correctCount++; // çµ±è¨ˆç­”å°
                const isLastLevel = currentLevelIdx >= levels.length - 1;
                const btnText = isLastLevel ? "çœ‹æˆç¸¾å–®" : "ä¸‹ä¸€é—œ";
                btnHtml = `<button onclick="handleNext(false)" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-2 rounded-full font-bold shadow-lg transition">${btnText}</button>`;
            }
        } else {
            btnHtml = `<button onclick="document.getElementById('controlArea').innerHTML=''" class="text-gray-500 font-bold underline hover:text-gray-700">å†è©¦ä¸€æ¬¡</button>`;
        }

        controlArea.innerHTML = `
            <div class="feedback-pop flex flex-col items-center">
                <p class="${color} text-2xl font-bold mb-2">${icon} ${msg}</p>
                ${btnHtml}
            </div>`;

        window.handleNext = (isCallback) => {
            controlArea.innerHTML = '';
            if (isCallback && callback) callback();
            else loadLevel(currentLevelIdx + 1);
        };
    }

    // æœ€çµ‚çµç®—ç•«é¢
    function renderSummary() {
        const stage = document.getElementById('stageArea');
        document.getElementById('controlArea').innerHTML = '';
        document.querySelector('.top-bar').style.display = 'none'; // éš±è—ä¸Šæ–¹è³‡è¨Š

        // æ ¹æ“šåˆ†æ•¸çµ¦è©•åƒ¹
        let title = "", comment = "", medal = "";
        if (correctCount === TOTAL_LEVELS) { title = "æ»¿åˆ†ï¼å¤ªç¥äº†ï¼"; comment = "ä½ æ˜¯æ•¸å­¸å°å¤©æ‰ï¼"; medal = "ğŸ† é‡‘ç‰Œ"; }
        else if (correctCount >= 7) { title = "å¾ˆæ£’å–”ï¼"; comment = "ç¹¼çºŒä¿æŒï¼Œä¸‹æ¬¡æŒ‘æˆ°æ»¿åˆ†ï¼"; medal = "ğŸ¥ˆ éŠ€ç‰Œ"; }
        else { title = "å®Œæˆäº†ï¼"; comment = "å¤šç·´ç¿’æœƒæ›´å²å®³å–”ï¼"; medal = "ğŸ¥‰ éŠ…ç‰Œ"; }

        stage.innerHTML = `
            <div class="flex flex-col items-center justify-center animate-bounce-in">
                <div class="text-6xl mb-4">${medal}</div>
                <h1 class="text-4xl font-black text-blue-800 mb-2">${title}</h1>
                <p class="text-xl text-gray-600 mb-8">${comment}</p>
                
                <div class="bg-white p-8 rounded-3xl shadow-xl border-4 border-yellow-300 w-full max-w-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-4">
                        <span class="text-gray-500 font-bold text-xl">ç¸½å¾—åˆ†</span>
                        <span class="text-4xl font-black text-orange-500">${score}</span>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-gray-500 font-bold text-xl">ç­”å°é¡Œæ•¸</span>
                        <span class="text-2xl font-bold text-blue-600">${correctCount} / ${TOTAL_LEVELS}</span>
                    </div>
                </div>

                <button onclick="location.reload()" class="mt-10 bg-purple-500 hover:bg-purple-600 text-white text-2xl font-bold py-4 px-12 rounded-full shadow-xl transform transition hover:scale-110">
                    å†ç©ä¸€æ¬¡
                </button>
            </div>
        `;
        speak(`æ­å–œå®Œæˆï¼ä½ ç²å¾—äº†${score}åˆ†ï¼${comment}`);
    }

    // --- å·¥å…·å‡½å¼ ---
    function toggleSound() {
        isSoundOn = !isSoundOn;
        document.getElementById('soundText').innerText = isSoundOn ? "èªéŸ³ï¼šé–‹" : "èªéŸ³ï¼šé—œ";
        if(!isSoundOn) window.speechSynthesis.cancel();
    }

    function speak(text) {
        if (!isSoundOn) return;
        window.speechSynthesis.cancel();
        let ttsText = text.replace(/Ã—/g, "ä¹˜").replace(/Ã·/g, "é™¤ä»¥").replace(/-/g, "æ¸›").replace(/\+/g, "åŠ ").replace(/\$/g, "å…ƒ");
        const u = new SpeechSynthesisUtterance(ttsText);
        u.lang = 'zh-TW';
        u.rate = 0.95; 
        u.pitch = 1.1; 
        window.speechSynthesis.speak(u);
    }
</script>
</body>
</html>
