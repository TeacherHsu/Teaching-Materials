<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸å­¸äº’å‹•è§£é¡Œï¼šå¤šä½æ•¸çš„ä¹˜èˆ‡é™¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å­—å‹è¨­å®š */
        body {
            font-family: 'Noto Sans TC', system-ui, -apple-system, sans-serif;
            background-color: #f0f9ff;
            overflow-x: hidden;
        }

        /* --- çµ‚æ¥µçµ•å°æ ¼ç·šç³»çµ± (CSS Grid) --- 
           é€™æ˜¯ä¸€å¼µéš±å½¢çš„ç²¾ç¢ºæ–¹æ ¼ç´™ï¼Œç¢ºä¿æ‰€æœ‰ä½å€¼ 100% å‚ç›´èˆ‡æ°´å¹³å°é½Š
        */
        .math-table {
            display: inline-grid;
            grid-template-columns: repeat(9, 72px); /* 9å€‹ç›´è¡Œï¼Œæ¯è¡Œ 72px å¯¬ï¼Œç¢ºä¿å®¹ç´åƒè¬ä½ */
            grid-auto-rows: 76px;                   /* æ¯åˆ—åš´æ ¼å›ºå®šé«˜åº¦ 76px */
            gap: 4px 8px;                           /* åš´æ ¼çš„è¡Œåˆ—é–“è· */
            align-items: center;
            justify-items: center;
            font-family: 'Courier New', monospace;
            font-weight: 800;
            width: max-content;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            text-align: left;
        }

        /* çµ•å°åº§æ¨™å®šç¾© (è¡Œèˆ‡åˆ—) */
        .r1 { grid-row: 1; } .r2 { grid-row: 2; } .r3 { grid-row: 3; } .r4 { grid-row: 4; }
        .r5 { grid-row: 5; } .r6 { grid-row: 6; } .r7 { grid-row: 7; } .r8 { grid-row: 8; }
        .r9 { grid-row: 9; }
        
        .c1 { grid-column: 1; } .c2 { grid-column: 2; } .c3 { grid-column: 3; }
        .c4 { grid-column: 4; } .c5 { grid-column: 5; } .c6 { grid-column: 6; }
        .c7 { grid-column: 7; } .c8 { grid-column: 8; } .c9 { grid-column: 9; }

        /* å–®ä¸€æ ¼å­çš„åŸºç¤è¨­å®š */
        .cell {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            font-size: 3.5rem; /* è¶…å¤§å­—é«” */
            line-height: 1;
            user-select: none;
            box-sizing: border-box;
            position: relative;
            color: #1e293b;
        }

        /* é¡Œç›®æ•¸å­—å­—é«” (å¸¶æœ‰ç°åº•ç™½æ¡†ï¼Œæ¨¡æ“¬é¡Œç›®å°åˆ·) */
        .num {
            background-color: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
        }

        /* ç„¡åº•è‰²çš„æ•¸å­— (ç”¨æ–¼åŠ ç¸½æˆ–éç¨‹å±•ç¤º) */
        .no-bg {
            background-color: transparent !important;
            border: none !important;
        }

        /* é‹ç®—ç¬¦è™Ÿ (+, Ã—) */
        .operator {
            font-size: 4rem;
            color: #64748b;
            font-family: sans-serif;
        }

        /* é‹ç®—åˆ†éš”ç·š (ä¹˜æ³•ã€åŠ æ¸›æ³•åº•ç·š) */
        .border-bottom-line {
            border-bottom: 6px solid #1e293b;
            align-self: end;
            width: 100%;
            height: 100%;
            margin-bottom: -5px; /* å®Œç¾å¡åœ¨å…©è¡Œä¹‹é–“ */
            z-index: 5;
        }

        /* é™¤æ³•å°ˆç”¨ç¬¦è™Ÿèˆ‡ç·šæ¢ */
        .div-top-line {
            border-top: 5px solid #1e293b !important;
            border-radius: 0 !important;
        }
        .div-bracket {
            position: absolute;
            right: -14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 5rem;
            color: #1e293b;
            font-family: sans-serif;
            font-weight: 400;
            z-index: 10;
        }

        /* åˆªé™¤ç·š (åŠƒæ‰ 0 ç”¨) */
        .strike-through {
            position: relative;
            color: #cbd5e1 !important;
        }
        .strike-through::after {
            content: '';
            position: absolute;
            width: 130%;
            height: 6px;
            background-color: #ef4444;
            transform: rotate(-45deg);
            top: 50%;
            left: -15%;
            border-radius: 3px;
            z-index: 20;
        }

        /* --- äº’å‹•æ ¼å­æ¨£å¼ --- */
        /* 1. é€²ä½æ ¼ (ä¸Šæ–¹è™›ç·šå°æ ¼) */
        .carry-slot {
            width: 48px;  
            height: 48px;
            font-size: 2rem;
            border: 3px dashed #cbd5e1;
            border-radius: 12px;
            color: #ef4444; 
            background-color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            transition: all 0.2s;
            align-self: end;
            margin-bottom: -16px; /* å¾€ä¸‹é è¿‘ä¸»è¦æ•¸å­— */
            z-index: 15;
        }

        /* 2. ä¸»è¦ç­”æ¡ˆæ ¼ (ä¸‹æ–¹å¯¦ç·šå¤§æ ¼) */
        .ans-slot {
            border: 4px dashed #94a3b8;
            border-radius: 16px;
            background-color: #ffffff;
            color: #1e293b;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        /* äº’å‹•ç‹€æ…‹ */
        .carry-slot.active:hover, .ans-slot.active:hover {
            border-color: #93c5fd;
            background-color: #eff6ff;
        }
        .carry-slot.selected, .ans-slot.selected {
            border-color: #f59e0b !important;
            background-color: #fffbeb !important;
            box-shadow: 0 0 0 6px rgba(245, 158, 11, 0.3);
            transform: scale(1.1);
            z-index: 20;
        }
        .carry-slot.filled, .ans-slot.filled {
            border-style: solid;
            border-color: #3b82f6;
            background-color: #dbeafe;
        }
        .carry-slot.correct, .ans-slot.correct {
            border-color: #22c55e !important;
            background-color: #f0fdf4 !important;
            color: #15803d;
        }
        .carry-slot.error, .ans-slot.error {
            border-color: #ef4444 !important;
            background-color: #fef2f2 !important;
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* é¸é …æŒ‰éˆ•å€ */
        .options-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 32px;
            padding: 24px;
            background: #f1f5f9;
            border-radius: 20px;
            justify-content: center;
        }
        .option-btn {
            background-color: white;
            border: 2px solid #cbd5e1;
            border-bottom-width: 6px;
            padding: 12px 32px;
            border-radius: 16px;
            font-weight: 800;
            font-size: 2.5rem;
            color: #334155;
            transition: all 0.1s;
            min-width: 90px;
            text-align: center;
        }
        .option-btn:active {
            transform: translateY(4px);
            border-bottom-width: 2px;
            margin-top: 4px;
        }

        /* æ­¥é©Ÿå®¹å™¨ */
        .step-container {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(0.8);
            transition: all 0.5s ease;
            margin-bottom: 40px;
            background: white;
            border-radius: 24px;
            padding: 32px;
            border: 3px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }
        .step-container.unlocked {
            opacity: 1;
            pointer-events: auto;
            filter: grayscale(0);
            border-color: #3b82f6;
            box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.15);
        }
        .step-container.completed {
            border-color: #22c55e;
            background-color: #f8fafc;
        }
        .step-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 32px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 16px;
        }
        .step-num {
            background: #3b82f6;
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.5rem;
        }
        .step-container.completed .step-num { background: #22c55e; }

        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(4px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-6px, 0, 0); }
            40%, 60% { transform: translate3d(6px, 0, 0); }
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 12px; height: 12px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* ç©åˆ† pop å‹•ç•« */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.08); }
            100% { transform: scale(1); }
        }
        .animate-pop { animation: pop 0.3s ease; }
    </style>
</head>

<body class="h-screen flex flex-col text-slate-800">

    <header class="bg-white shadow-md z-20 flex-none sticky top-0">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center h-20 space-x-4 overflow-x-auto custom-scrollbar">
                <div class="flex-none font-bold text-2xl text-blue-600 mr-4 flex items-center gap-2">
                    <span class="text-3xl">ğŸ§®</span>
                    <span>å–®å…ƒä¸€ï¼šå¤šä½æ•¸ä¹˜é™¤</span>
                </div>
                <div id="nav-container" class="flex space-x-3"></div>
                <div class="ml-auto flex items-center gap-4 flex-none pl-4">
                    <div class="bg-yellow-100 px-5 py-2 rounded-full border-2 border-yellow-300 flex items-center gap-2">
                        <span class="text-xl">â­ ç©åˆ†:</span>
                        <span id="score-display" class="font-bold text-yellow-700 text-2xl">0</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        <section class="md:w-1/3 bg-white border-b md:border-b-0 md:border-r border-slate-200 p-8 flex flex-col shadow-sm z-10 relative overflow-y-auto">
            <div class="flex justify-between items-start mb-6">
                <span class="bg-blue-100 text-blue-800 text-lg font-bold px-4 py-1.5 rounded-full border border-blue-200" id="problem-tag">é¡Œç›®é¡å‹</span>
                <button id="tts-btn" class="text-slate-500 hover:text-blue-600 transition-colors p-3 rounded-full hover:bg-slate-100">
                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                </button>
            </div>

            <h1 id="problem-title" class="text-3xl md:text-4xl font-extrabold mb-8 leading-relaxed text-slate-800"></h1>

            <div class="mt-auto bg-slate-50 p-6 rounded-2xl border-2 border-slate-200">
                <p class="text-lg text-slate-500 mb-3 font-bold">ğŸ’¡ å­¸ç¿’é‡é»ï¼š</p>
                <p id="problem-hint" class="text-slate-700 leading-relaxed font-bold text-xl"></p>
                
                <div class="mt-6 flex flex-col gap-3 text-lg font-bold border-t-2 pt-4 border-slate-200" id="legend-area">
                    <!-- å‹•æ…‹åœ–ä¾‹ -->
                </div>
            </div>
        </section>

        <section id="steps-area" class="flex-1 bg-slate-100 p-4 md:p-10 overflow-y-auto custom-scrollbar pb-32">
            <div id="steps-wrapper" class="max-w-5xl mx-auto">
                <!-- JS æ³¨å…¥ -->
            </div>
        </section>
    </main>

    <!-- å®Œæˆè¦–çª— -->
    <div id="completion-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-md transition-opacity duration-300">
        <div class="bg-white rounded-[2rem] shadow-2xl max-w-lg w-full p-10 text-center transform transition-all scale-100 border-4 border-yellow-300">
            <div class="w-32 h-32 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-8 shadow-inner">
                <span class="text-7xl">ğŸ‰</span>
            </div>
            <h2 class="text-4xl font-extrabold text-slate-800 mb-4">æŒ‘æˆ°æˆåŠŸï¼</h2>
            <p class="text-slate-600 mb-8 text-2xl font-bold">ä½ å®Œæˆäº†é€™ä¸€é¡Œï¼Œå¤ªæ£’äº†ï¼</p>
            <p id="score-summary" class="text-yellow-600 font-extrabold text-3xl mb-8 bg-yellow-50 py-3 rounded-xl"></p>
            <div class="flex flex-col gap-5">
                <button id="retry-btn" class="w-full py-5 px-8 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-extrabold text-2xl transition-all shadow-xl shadow-blue-200 active:scale-95">å†åšä¸€æ¬¡ ğŸ”„</button>
                <button id="close-modal-btn" class="w-full py-5 px-8 bg-white hover:bg-slate-50 text-slate-700 border-4 border-slate-200 rounded-2xl font-extrabold text-2xl transition-all active:scale-95">é—œé–‰è¦–çª— âŒ</button>
            </div>
        </div>
    </div>

    <!-- Toast æç¤º -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-white px-8 py-5 rounded-2xl shadow-2xl border-l-8 border-yellow-500 z-50 transition-all duration-300 translate-y-32 opacity-0 flex items-center gap-5 min-w-[400px] pointer-events-none">
        <span class="text-4xl">ğŸ¤”</span>
        <div>
            <p class="font-extrabold text-slate-800 text-2xl mb-1">å†æƒ³ä¸€æƒ³...</p>
            <p id="toast-message" class="text-slate-600 text-lg font-bold">é€™è£¡æœ‰å€‹å°é™·é˜±å–”ï¼</p>
        </div>
    </div>

    <script>
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioContext.state === 'suspended') audioContext.resume();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            const now = audioContext.currentTime;
            if (type === 'correct') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(500, now);
                oscillator.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
                gainNode.gain.setValueAtTime(0.4, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                oscillator.start(now);
                oscillator.stop(now + 0.5);
            } else if (type === 'error') {
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(200, now);
                oscillator.frequency.linearRampToValueAtTime(100, now + 0.2);
                gainNode.gain.setValueAtTime(0.4, now);
                gainNode.gain.linearRampToValueAtTime(0.01, now + 0.2);
                oscillator.start(now);
                oscillator.stop(now + 0.2);
            } else if (type === 'click') {
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(800, now);
                gainNode.gain.setValueAtTime(0.15, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                oscillator.start(now);
                oscillator.stop(now + 0.05);
            }
        }

        // åœ–ä¾‹æ¨¡æ¿
        const mulLegend = `
            <div class="flex items-center gap-3"><span class="w-5 h-5 rounded-md bg-blue-600 inline-block"></span>è—åº•æ¡†ï¼šè¢«ä¹˜æ•¸</div>
            <div class="flex items-center gap-3"><span class="w-5 h-5 rounded-md border-4 border-red-500 bg-red-50 inline-block"></span>ç´…é‚Šæ¡†ï¼šç›®å‰é‹ç®—çš„ä¹˜æ•¸</div>
            <div class="flex items-center gap-3"><span class="w-5 h-5 rounded-md border-4 border-dashed border-slate-400 bg-white inline-block"></span>è™›ç·šæ¡†ï¼šé€²ä½æ¨™è¨˜å€ (é»é¸å¯å¡«å¯«)</div>
        `;
        const divLegend = `
            <div class="flex items-center gap-3"><span class="w-5 h-5 rounded-md border-4 border-dashed border-slate-400 bg-white inline-block"></span>ç”±å·¦è‡³å³ä¾åºé»æ“Šå¡«å…¥é™¤æ³•ç®—å¼</div>
            <div class="flex items-center gap-3"><span class="w-5 h-5 rounded-md border-t-8 border-slate-800 bg-white inline-block"></span>é»‘è‰²ç²—ç·šï¼šè¡¨ç¤ºé™¤æ³•çš„ä¸Šæ–¹æ©«ç·š</div>
            <div class="flex items-center gap-3"><span class="w-5 h-5 rounded-md bg-red-500 inline-block"></span>ç´…è‰²æ–œç·šï¼šè¡¨ç¤ºå…©é‚ŠåŠƒæ‰ç›¸åŒæ•¸é‡çš„ 0</div>
        `;

        /* ==========================================
           åš´æ ¼çš„ CSS Grid è³‡æ–™åº«çµæ§‹ï¼š
           åˆ©ç”¨ r1~r9 (åˆ—) èˆ‡ c1~c9 (è¡Œ) çµ•å°åº§æ¨™é–å®š
           ä¿è­‰å€‹ä½æ°¸é å°é½Šå€‹ä½ï¼Œé™¤æ³•æ©«ç·šå®Œç¾å‘ˆç¾
        ========================================== */
        const problemData = [
            {
                id: 1,
                title: "è³£å‡º384å¼µå…¨ç¥¨ï¼Œå…±æ”¶å…¥å¹¾å…ƒï¼Ÿ<br>(å…¨ç¥¨ä¸€å¼µ465å…ƒ)",
                type: "ä¸‰ä½æ•¸ Ã— ä¸‰ä½æ•¸",
                isDiv: false,
                legend: mulLegend,
                steps: [
                    {
                        instruction: "æ­¥é©Ÿä¸€ï¼šå…ˆç®— 465 Ã— 4 (å€‹ä½)",
                        stepHint: "1. 4Ã—5=20ï¼Œå¯«0é€²2<br>2. 4Ã—6=24ï¼Œ24+2=26ï¼Œå¯«6é€²2<br>3. 4Ã—4=16ï¼Œ16+2=18ï¼Œå¯«18",
                        expression: `
                            <div class="math-table fill-rtl">
                                <!-- é€²ä½æ ¼ (R1) -->
                                <div class="cell slot carry-slot r1 c7" data-ans="2"></div>
                                <div class="cell slot carry-slot r1 c8" data-ans="2"></div>

                                <!-- è¢«ä¹˜æ•¸ 465 (R2) -->
                                <div class="cell num text-blue-600 r2 c7">4</div>
                                <div class="cell num text-blue-600 r2 c8">6</div>
                                <div class="cell num text-blue-600 r2 c9">5</div>

                                <!-- ä¹˜æ•¸ 384 (R3) -->
                                <div class="cell operator r3 c6">Ã—</div>
                                <div class="cell num r3 c7">3</div>
                                <div class="cell num r3 c8">8</div>
                                <div class="cell num border-4 border-red-500 bg-red-50 text-red-600 r3 c9">4</div>

                                <!-- åº•ç·š -->
                                <div class="border-bottom-line r3" style="grid-column: 6/10;"></div>

                                <!-- ç­”æ¡ˆå€ (R4) -->
                                <div class="cell slot ans-slot r4 c6" data-ans="1"></div>
                                <div class="cell slot ans-slot r4 c7" data-ans="8"></div>
                                <div class="cell slot ans-slot r4 c8" data-ans="6"></div>
                                <div class="cell slot ans-slot r4 c9" data-ans="0"></div>
                            </div>
                        `,
                        options: ["1", "8", "6", "0", "2", "4", "5"],
                        answer: ["2", "2", "1", "8", "6", "0"] 
                    },
                    {
                        instruction: "æ­¥é©ŸäºŒï¼šå†ç®— 465 Ã— 8 (å€‹å)",
                        stepHint: "é€™è¡Œæ˜¯ã€Œåä½ã€çš„ä¹˜ç©ï¼Œå¾åä½é–‹å§‹å¯«(å€‹ä½ç•™ç©º)ã€‚<br>8Ã—5=40ï¼Œå¯«0é€²4...",
                        expression: `
                            <div class="math-table fill-rtl">
                                <div class="cell slot carry-slot r1 c7" data-ans="5"></div>
                                <div class="cell slot carry-slot r1 c8" data-ans="4"></div>

                                <div class="cell num text-blue-600 r2 c7">4</div>
                                <div class="cell num text-blue-600 r2 c8">6</div>
                                <div class="cell num text-blue-600 r2 c9">5</div>

                                <div class="cell operator r3 c6">Ã—</div>
                                <div class="cell num r3 c7">3</div>
                                <div class="cell num border-4 border-red-500 bg-red-50 text-red-600 r3 c8">8</div>
                                <div class="cell num r3 c9">4</div>

                                <div class="border-bottom-line r3" style="grid-column: 6/10;"></div>

                                <div class="cell num no-bg text-slate-400 r4 c6">1</div>
                                <div class="cell num no-bg text-slate-400 r4 c7">8</div>
                                <div class="cell num no-bg text-slate-400 r4 c8">6</div>
                                <div class="cell num no-bg text-slate-400 r4 c9">0</div>

                                <div class="cell slot ans-slot r5 c5" data-ans="3"></div>
                                <div class="cell slot ans-slot r5 c6" data-ans="7"></div>
                                <div class="cell slot ans-slot r5 c7" data-ans="2"></div>
                                <div class="cell slot ans-slot r5 c8" data-ans="0"></div>
                            </div>
                        `,
                        options: ["3", "7", "2", "0", "5", "4", "9"],
                        answer: ["5", "4", "3", "7", "2", "0"]
                    },
                    {
                        instruction: "æ­¥é©Ÿä¸‰ï¼šæœ€å¾Œç®— 465 Ã— 3 (å€‹ç™¾)",
                        stepHint: "é€™æ˜¯ã€Œç™¾ä½ã€çš„ä¹˜ç©ï¼Œå¾ç™¾ä½é–‹å§‹å¯«ã€‚<br>3Ã—5=15ï¼Œå¯«5é€²1...",
                        expression: `
                            <div class="math-table fill-rtl">
                                <div class="cell slot carry-slot r1 c7" data-ans="1"></div>
                                <div class="cell slot carry-slot r1 c8" data-ans="1"></div>

                                <div class="cell num text-blue-600 r2 c7">4</div>
                                <div class="cell num text-blue-600 r2 c8">6</div>
                                <div class="cell num text-blue-600 r2 c9">5</div>

                                <div class="cell operator r3 c6">Ã—</div>
                                <div class="cell num border-4 border-red-500 bg-red-50 text-red-600 r3 c7">3</div>
                                <div class="cell num r3 c8">8</div>
                                <div class="cell num r3 c9">4</div>

                                <div class="border-bottom-line r3" style="grid-column: 6/10;"></div>

                                <div class="cell num no-bg text-slate-400 r4 c6">1</div>
                                <div class="cell num no-bg text-slate-400 r4 c7">8</div>
                                <div class="cell num no-bg text-slate-400 r4 c8">6</div>
                                <div class="cell num no-bg text-slate-400 r4 c9">0</div>

                                <div class="cell num no-bg text-slate-400 r5 c5">3</div>
                                <div class="cell num no-bg text-slate-400 r5 c6">7</div>
                                <div class="cell num no-bg text-slate-400 r5 c7">2</div>
                                <div class="cell num no-bg text-slate-400 r5 c8">0</div>

                                <div class="cell slot ans-slot r6 c4" data-ans="1"></div>
                                <div class="cell slot ans-slot r6 c5" data-ans="3"></div>
                                <div class="cell slot ans-slot r6 c6" data-ans="9"></div>
                                <div class="cell slot ans-slot r6 c7" data-ans="5"></div>
                            </div>
                        `,
                        options: ["1", "3", "9", "5", "4", "2"],
                        answer: ["1", "1", "1", "3", "9", "5"]
                    },
                    {
                        instruction: "æœ€å¾ŒåŠ ç¸½èµ·ä¾†ï¼š",
                        stepHint: "å°‡ä¸Šé¢ä¸‰å±¤çš„æ•¸å­—å‚ç›´ç›¸åŠ ï¼Œæ³¨æ„é€²ä½ã€‚",
                        expression: `
                            <div class="math-table fill-rtl">
                                <div class="cell slot carry-slot r1 c5" data-ans="1"></div>
                                <div class="cell slot carry-slot r1 c6" data-ans="1"></div>

                                <div class="cell num no-bg text-slate-400 r2 c6">1</div>
                                <div class="cell num no-bg text-slate-400 r2 c7">8</div>
                                <div class="cell num no-bg text-slate-400 r2 c8">6</div>
                                <div class="cell num no-bg text-slate-400 r2 c9">0</div>

                                <div class="cell num no-bg text-slate-400 r3 c5">3</div>
                                <div class="cell num no-bg text-slate-400 r3 c6">7</div>
                                <div class="cell num no-bg text-slate-400 r3 c7">2</div>
                                <div class="cell num no-bg text-slate-400 r3 c8">0</div>

                                <div class="cell operator r4 c3">+</div>
                                <div class="cell num no-bg text-slate-800 r4 c4">1</div>
                                <div class="cell num no-bg text-slate-800 r4 c5">3</div>
                                <div class="cell num no-bg text-slate-800 r4 c6">9</div>
                                <div class="cell num no-bg text-slate-800 r4 c7">5</div>

                                <div class="border-bottom-line r4" style="grid-column: 4/10;"></div>

                                <div class="cell slot ans-slot r5 c4" data-ans="1"></div>
                                <div class="cell slot ans-slot r5 c5" data-ans="7"></div>
                                <div class="cell slot ans-slot r5 c6" data-ans="8"></div>
                                <div class="cell slot ans-slot r5 c7" data-ans="5"></div>
                                <div class="cell slot ans-slot r5 c8" data-ans="6"></div>
                                <div class="cell slot ans-slot r5 c9" data-ans="0"></div>
                            </div>
                        `,
                        options: ["1", "7", "8", "5", "6", "0", "2", "9"],
                        answer: ["1", "1", "1", "7", "8", "5", "6", "0"]
                    }
                ]
            },
            {
                id: 2,
                title: "å¸«å‚…æ¯å¤©åš304å€‹æ³¡èŠ™ï¼Œ108å¤©å…±å¯åšå¹¾å€‹ï¼Ÿ<br>(ä¸­é–“æœ‰0çš„ä¹˜æ³•)",
                type: "ä¸­é–“æœ‰ 0",
                isDiv: false,
                legend: mulLegend,
                steps: [
                    {
                        instruction: "æ­¥é©Ÿä¸€ï¼šå…ˆç®— 304 Ã— 8",
                        stepHint: "æ³¨æ„é€²ä½ï¼š<br>8Ã—4=32 (å¯«2é€²3)<br>8Ã—0=0ï¼Œ0+3=3<br>8Ã—3=24",
                        expression: `
                            <div class="math-table fill-rtl">
                                <div class="cell slot carry-slot r1 c7" data-ans="3"></div>

                                <div class="cell num text-blue-600 r2 c6">3</div>
                                <div class="cell num text-blue-600 r2 c7">0</div>
                                <div class="cell num text-blue-600 r2 c8">4</div>

                                <div class="cell operator r3 c4">Ã—</div>
                                <div class="cell num r3 c6">1</div>
                                <div class="cell num r3 c7">0</div>
                                <div class="cell num border-4 border-red-500 bg-red-50 text-red-600 r3 c8">8</div>

                                <div class="border-bottom-line r3" style="grid-column: 5/9;"></div>

                                <div class="cell slot ans-slot r4 c5" data-ans="2"></div>
                                <div class="cell slot ans-slot r4 c6" data-ans="4"></div>
                                <div class="cell slot ans-slot r4 c7" data-ans="3"></div>
                                <div class="cell slot ans-slot r4 c8" data-ans="2"></div>
                            </div>
                        `,
                        options: ["2", "4", "3", "2", "0", "1", "8"],
                        answer: ["3", "2", "4", "3", "2"] 
                    },
                    {
                        instruction: "æ­¥é©ŸäºŒï¼šä¹˜æ•¸åä½æ˜¯0ï¼Œç›´æ¥ç®—ç™¾ä½ 304 Ã— 1",
                        stepHint: "åä½ç‚º0å¯çœç•¥ï¼Œç›´æ¥å°é½Šç™¾ä½å¯«å‡ºä¹˜ç©ã€‚",
                        expression: `
                            <div class="math-table fill-rtl">
                                <div class="cell num text-blue-600 r2 c6">3</div>
                                <div class="cell num text-blue-600 r2 c7">0</div>
                                <div class="cell num text-blue-600 r2 c8">4</div>

                                <div class="cell operator r3 c4">Ã—</div>
                                <div class="cell num border-4 border-red-500 bg-red-50 text-red-600 r3 c6">1</div>
                                <div class="cell num r3 c7">0</div>
                                <div class="cell num r3 c8">8</div>

                                <div class="border-bottom-line r3" style="grid-column: 5/9;"></div>

                                <div class="cell num no-bg text-slate-400 r4 c5">2</div>
                                <div class="cell num no-bg text-slate-400 r4 c6">4</div>
                                <div class="cell num no-bg text-slate-400 r4 c7">3</div>
                                <div class="cell num no-bg text-slate-400 r4 c8">2</div>

                                <div class="cell slot ans-slot r5 c4" data-ans="3"></div>
                                <div class="cell slot ans-slot r5 c5" data-ans="0"></div>
                                <div class="cell slot ans-slot r5 c6" data-ans="4"></div>
                            </div>
                        `,
                        options: ["3", "0", "4", "1", "2", "5"],
                        answer: ["3", "0", "4"]
                    },
                    {
                        instruction: "æœ€å¾ŒåŠ ç¸½èµ·ä¾†ï¼š",
                        stepHint: "å‚ç›´ç›¸åŠ ã€‚",
                        expression: `
                            <div class="math-table fill-rtl">
                                <div class="cell num no-bg text-slate-500 r2 c5">2</div>
                                <div class="cell num no-bg text-slate-500 r2 c6">4</div>
                                <div class="cell num no-bg text-slate-500 r2 c7">3</div>
                                <div class="cell num no-bg text-slate-500 r2 c8">2</div>

                                <div class="cell operator r3 c3">+</div>
                                <div class="cell num no-bg text-slate-800 r3 c4">3</div>
                                <div class="cell num no-bg text-slate-800 r3 c5">0</div>
                                <div class="cell num no-bg text-slate-800 r3 c6">4</div>

                                <div class="border-bottom-line r3" style="grid-column: 4/9;"></div>

                                <div class="cell slot ans-slot r4 c4" data-ans="3"></div>
                                <div class="cell slot ans-slot r4 c5" data-ans="2"></div>
                                <div class="cell slot ans-slot r4 c6" data-ans="8"></div>
                                <div class="cell slot ans-slot r4 c7" data-ans="3"></div>
                                <div class="cell slot ans-slot r4 c8" data-ans="2"></div>
                            </div>
                        `,
                        options: ["3", "2", "8", "3", "2", "0", "5"],
                        answer: ["3", "2", "8", "3", "2"]
                    }
                ]
            },
            {
                id: 3,
                title: "è€é—†æº–å‚™äº†1786å€‹é‘°åŒ™åœˆï¼Œæ¯å¤©é™é‡ç™¼é€188å€‹ï¼Œæœ€å¤šå¯ä»¥ç™¼é€å¹¾å¤©ï¼Ÿå‰©å¹¾å€‹ï¼Ÿ",
                type: "å››ä½æ•¸ Ã· ä¸‰ä½æ•¸",
                isDiv: true,
                legend: divLegend,
                steps: [
                    {
                        instruction: "æ­¥é©Ÿä¸€ï¼šä¼°å•†ä¸¦ç›¸ä¹˜",
                        stepHint: "é™¤æ³•å¾æœ€é«˜ä½é–‹å§‹çœ‹ã€‚188æ¥è¿‘200ï¼Œ178ä¸å¤ åˆ†ï¼Œçœ‹ 1786 Ã· 188ã€‚<br>å¤§ç´„ç”¨ 9 è©¦è©¦çœ‹ï¼š188 Ã— 9 = 1692ã€‚è«‹å¡«å…¥å•†èˆ‡ç›¸ä¹˜çš„çµæœã€‚",
                        expression: `
                            <div class="math-table fill-ltr">
                                <!-- R1: å•† -->
                                <div class="cell slot ans-slot border-green-500 r1 c9" data-ans="9"></div>

                                <!-- R2: é™¤æ•¸èˆ‡è¢«é™¤æ•¸ -->
                                <div class="cell num no-bg r2 c3">1</div>
                                <div class="cell num no-bg r2 c4">8</div>
                                <div class="cell num no-bg relative r2 c5">8 <span class="div-bracket">)</span></div>
                                
                                <div class="cell num no-bg div-top-line r2 c6">1</div>
                                <div class="cell num no-bg div-top-line r2 c7">7</div>
                                <div class="cell num no-bg div-top-line r2 c8">8</div>
                                <div class="cell num no-bg div-top-line r2 c9">6</div>

                                <!-- R3: æ¸›å» -->
                                <div class="cell slot ans-slot r3 c6" data-ans="1"></div>
                                <div class="cell slot ans-slot r3 c7" data-ans="6"></div>
                                <div class="cell slot ans-slot r3 c8" data-ans="9"></div>
                                <div class="cell slot ans-slot r3 c9" data-ans="2"></div>
                            </div>
                        `,
                        options: ["9", "1", "6", "2", "8", "4"],
                        answer: ["9", "1", "6", "9", "2"]
                    },
                    {
                        instruction: "æ­¥é©ŸäºŒï¼šç›¸æ¸›å¾—é¤˜æ•¸",
                        stepHint: "å°‡ 1786 æ¸›å» 1692 ç®—å‡ºå‰©ä¸‹çš„é‘°åŒ™åœˆæ•¸é‡ã€‚",
                        expression: `
                            <div class="math-table fill-ltr">
                                <!-- R1: å•† -->
                                <div class="cell num no-bg text-green-600 r1 c9">9</div>

                                <!-- R2: é™¤æ•¸èˆ‡è¢«é™¤æ•¸ -->
                                <div class="cell num no-bg r2 c3">1</div>
                                <div class="cell num no-bg r2 c4">8</div>
                                <div class="cell num no-bg relative r2 c5">8 <span class="div-bracket">)</span></div>
                                
                                <div class="cell num no-bg div-top-line r2 c6">1</div>
                                <div class="cell num no-bg div-top-line r2 c7">7</div>
                                <div class="cell num no-bg div-top-line r2 c8">8</div>
                                <div class="cell num no-bg div-top-line r2 c9">6</div>

                                <!-- R3: æ¸›å» -->
                                <div class="cell num no-bg r3 c6">1</div>
                                <div class="cell num no-bg r3 c7">6</div>
                                <div class="cell num no-bg r3 c8">9</div>
                                <div class="cell num no-bg r3 c9">2</div>

                                <!-- æ¸›æ³•åº•ç·š -->
                                <div class="border-bottom-line r3" style="grid-column: 6/10;"></div>

                                <!-- R4: é¤˜æ•¸ -->
                                <div class="cell slot ans-slot r4 c8" data-ans="9"></div>
                                <div class="cell slot ans-slot r4 c9" data-ans="4"></div>
                            </div>
                        `,
                        options: ["9", "4", "0", "1", "8"],
                        answer: ["9", "4"]
                    }
                ]
            },
            {
                id: 4,
                title: "ç­±è±æœ‰2600å…ƒï¼Œæƒ³è²·æ¯ç›’200å…ƒçš„é¤…ä¹¾ï¼Œæœ€å¤šå¯ä»¥è²·å¹¾ç›’ï¼Ÿ<br>(æœ«ä½æœ‰0çš„é™¤æ³•)",
                type: "æœ«ä½æœ‰ 0 çš„é™¤æ³•",
                isDiv: true,
                legend: divLegend,
                steps: [
                    {
                        instruction: "æ­¥é©Ÿä¸€ï¼šåŠƒæ‰ç›¸åŒæ•¸é‡çš„ 0ï¼Œå…ˆç®—åä½",
                        stepHint: "è¢«é™¤æ•¸å’Œé™¤æ•¸åŒæ™‚åŠƒæ‰å…©å€‹ 0ï¼Œè¨ˆç®—æœƒè®Šå¾—éå¸¸ç°¡å–®ï¼<br>ç­‰æ–¼æ˜¯è¨ˆç®— 26 Ã· 2ã€‚å…ˆç®—æœ€é«˜ä½ï¼š2 Ã· 2 = 1ã€‚",
                        expression: `
                            <div class="math-table fill-ltr">
                                <!-- R1: å•† -->
                                <div class="cell slot ans-slot border-green-500 r1 c6" data-ans="1"></div>

                                <!-- R2: é™¤æ•¸èˆ‡è¢«é™¤æ•¸ -->
                                <div class="cell num no-bg r2 c3">2</div>
                                <div class="cell num no-bg strike-through r2 c4">0</div>
                                <div class="cell num no-bg relative strike-through r2 c5">0 <span class="div-bracket">)</span></div>
                                
                                <div class="cell num no-bg div-top-line r2 c6">2</div>
                                <div class="cell num no-bg div-top-line r2 c7">6</div>
                                <div class="cell num no-bg div-top-line strike-through r2 c8">0</div>
                                <div class="cell num no-bg div-top-line strike-through r2 c9">0</div>

                                <!-- R3: æ¸›æ•¸ -->
                                <div class="cell slot ans-slot r3 c6" data-ans="2"></div>
                            </div>
                        `,
                        options: ["1", "2", "3", "0", "6"],
                        answer: ["1", "2"]
                    },
                    {
                        instruction: "æ­¥é©ŸäºŒï¼šå†ç®—å€‹ä½",
                        stepHint: "2æ¸›2ç­‰æ–¼0(ä¸å¯«)ï¼ŒæŠŠ 6 æ”¾ä¸‹ä¾†ï¼Œè¨ˆç®— 6 Ã· 2 = 3ã€‚",
                        expression: `
                            <div class="math-table fill-ltr">
                                <!-- R1: å•† -->
                                <div class="cell num no-bg text-green-600 r1 c6">1</div>
                                <div class="cell slot ans-slot border-green-500 r1 c7" data-ans="3"></div>

                                <!-- R2: é™¤æ•¸èˆ‡è¢«é™¤æ•¸ -->
                                <div class="cell num no-bg r2 c3">2</div>
                                <div class="cell num no-bg strike-through r2 c4">0</div>
                                <div class="cell num no-bg relative strike-through r2 c5">0 <span class="div-bracket">)</span></div>
                                
                                <div class="cell num no-bg div-top-line r2 c6">2</div>
                                <div class="cell num no-bg div-top-line r2 c7">6</div>
                                <div class="cell num no-bg div-top-line strike-through r2 c8">0</div>
                                <div class="cell num no-bg div-top-line strike-through r2 c9">0</div>

                                <!-- R3: æ¸›å» 2 -->
                                <div class="cell num no-bg r3 c6">2</div>
                                <div class="border-bottom-line r3" style="grid-column: 6/7;"></div>

                                <!-- R4: æ”¾ä¸‹ 6 -->
                                <div class="cell slot ans-slot r4 c7" data-ans="6"></div>

                                <!-- R5: æ¸›å» 6 -->
                                <div class="cell slot ans-slot r5 c7" data-ans="6"></div>
                                <div class="border-bottom-line r5" style="grid-column: 7/8;"></div>

                                <!-- R6: é¤˜æ•¸ -->
                                <div class="cell slot ans-slot r6 c7" data-ans="0"></div>
                            </div>
                        `,
                        options: ["6", "3", "0", "2"],
                        answer: ["3", "6", "6", "0"]
                    }
                ]
            }
        ];

        // ======= ç‹€æ…‹ =======
        let state = {
            currentProblemIdx: 0,
            currentStepIdx: 0,
            score: 0
        };

        // ======= åˆå§‹åŒ– =======
        window.addEventListener('load', initApp);

        function initApp() {
            renderNav();
            loadProblem(0);

            document.getElementById('tts-btn').addEventListener('click', speakProblem);
            document.getElementById('retry-btn').addEventListener('click', resetCurrentProblem);
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
        }

        function renderNav() {
            const container = document.getElementById('nav-container');
            container.innerHTML = '';
            problemData.forEach((prob, idx) => {
                const btn = document.createElement('button');
                btn.className = `px-5 py-2.5 rounded-xl font-extrabold text-xl whitespace-nowrap transition-all border-[3px] shadow-sm ${
                    idx === state.currentProblemIdx
                        ? 'bg-blue-600 text-white border-blue-700 shadow-md transform scale-105'
                        : 'bg-white text-slate-600 hover:bg-blue-50 border-slate-200 hover:border-blue-300'
                }`;
                btn.textContent = `é¡Œç›® ${idx + 1}`;
                btn.onclick = () => loadProblem(idx);
                container.appendChild(btn);
            });
        }

        function loadProblem(idx) {
            state.currentProblemIdx = idx;
            state.currentStepIdx = 0;

            renderNav();

            const problem = problemData[idx];
            document.getElementById('problem-tag').textContent = problem.type;
            document.getElementById('problem-title').innerHTML = problem.title;
            document.getElementById('legend-area').innerHTML = problem.legend;

            renderSteps();
        }

        function renderSteps() {
            const wrapper = document.getElementById('steps-wrapper');
            wrapper.innerHTML = '';

            const problem = problemData[state.currentProblemIdx];
            const currentStepData = problem.steps[state.currentStepIdx];

            const hintEl = document.getElementById('problem-hint');
            hintEl.innerHTML = currentStepData?.stepHint ? currentStepData.stepHint : "è«‹ä¾åºè¨ˆç®—ã€‚";

            for (let i = 0; i <= state.currentStepIdx && i < problem.steps.length; i++) {
                const step = problem.steps[i];
                const isCurrent = i === state.currentStepIdx;
                const isCompleted = i < state.currentStepIdx;

                const stepEl = document.createElement('div');
                stepEl.className = `step-container ${isCurrent || isCompleted ? 'unlocked' : ''} ${isCompleted ? 'completed' : ''}`;
                stepEl.id = `step-${i}`;

                const header = document.createElement('div');
                header.className = 'step-header';
                header.innerHTML = `
                    <div class="step-num">${isCompleted ? 'âœ”' : i + 1}</div>
                    <h3 class="font-extrabold text-3xl text-slate-700 tracking-wide">${step.instruction}</h3>
                `;

                const content = document.createElement('div');
                content.className = 'step-content w-full';

                const exprDiv = document.createElement('div');
                // å°‡ç½®ä¸­çš„ flex ç§»é™¤ï¼Œè®“ inline-grid èˆ‡ mx-auto ç™¼æ®ä½œç”¨ï¼Œè§£æ±ºæº¢ä½è£åˆ‡å•é¡Œ
                exprDiv.className = 'bg-white rounded-[2rem] border-4 border-slate-200 shadow-inner w-full py-10 px-4 overflow-x-auto custom-scrollbar text-center';
                exprDiv.innerHTML = step.expression;

                let optionsDiv = '';
                if (isCurrent) {
                    const uniqueOptions = [...new Set(step.options)];
                    const btnsHtml = uniqueOptions
                        .map((opt) => `<button class="option-btn hover:bg-slate-50" onclick="handleOptionClick('${opt}', this)">${opt}</button>`)
                        .join('');
                    optionsDiv = `<div class="options-grid">${btnsHtml}
                        <button class="option-btn bg-red-50 text-red-600 border-red-200 hover:bg-red-100 ml-4" onclick="checkAnswer()">æª¢æŸ¥ç­”æ¡ˆ â¤</button>
                    </div>`;
                }

                content.innerHTML = exprDiv.outerHTML + optionsDiv;
                stepEl.appendChild(header);
                stepEl.appendChild(content);
                wrapper.appendChild(stepEl);

                const slots = stepEl.querySelectorAll('.carry-slot, .ans-slot');

                if (isCurrent) {
                    slots.forEach((slot) => {
                        slot.classList.add('active');
                        slot.onclick = () => handleSlotClick(slot);
                    });
                } else if (isCompleted) {
                    slots.forEach((slot) => {
                        const ans = slot.dataset.ans;
                        if (ans != null) {
                            slot.textContent = ans;
                            slot.classList.add('correct', 'filled');
                            slot.classList.remove('active', 'selected', 'error');
                        }
                    });
                }
            }

            setTimeout(() => {
                wrapper.parentElement.scrollTo({ top: wrapper.scrollHeight, behavior: 'smooth' });
            }, 150);
        }

        function handleSlotClick(slotElement) {
            if (slotElement.textContent) {
                playSound('click');
                slotElement.textContent = '';
                slotElement.classList.remove('filled', 'error', 'correct');
                return;
            }

            const stepId = slotElement.closest('.step-container').id;
            const stepEl = document.getElementById(stepId);
            stepEl.querySelectorAll('.carry-slot, .ans-slot').forEach(s => s.classList.remove('selected'));

            playSound('click');
            slotElement.classList.add('selected');
        }

        function handleOptionClick(value, btnElement) {
            playSound('click');
            const currentStepEl = document.getElementById(`step-${state.currentStepIdx}`);

            const selectedSlot = currentStepEl.querySelector('.selected');
            if (selectedSlot) {
                selectedSlot.textContent = value;
                selectedSlot.classList.add('filled');
                selectedSlot.classList.remove('selected', 'error');
                return;
            }

            const table = currentStepEl.querySelector('.math-table');
            const isLtr = table?.classList.contains('fill-ltr');

            const ansSlots = Array.from(currentStepEl.querySelectorAll('.ans-slot'));
            const carrySlots = Array.from(currentStepEl.querySelectorAll('.carry-slot'));

            let target = null;

            if (isLtr) {
                target = ansSlots.find(s => !s.textContent);
            } else {
                target =
                    carrySlots.slice().reverse().find(s => !s.textContent) ||
                    ansSlots.slice().reverse().find(s => !s.textContent);
            }

            if (target) {
                target.textContent = value;
                target.classList.add('filled');
                target.classList.remove('error');
            }
        }

        function checkAnswer() {
            const problem = problemData[state.currentProblemIdx];
            const currentStepEl = document.getElementById(`step-${state.currentStepIdx}`);

            const allSlots = Array.from(currentStepEl.querySelectorAll('.carry-slot, .ans-slot'));
            const mainSlots = Array.from(currentStepEl.querySelectorAll('.ans-slot'));

            if (mainSlots.some(s => !s.textContent)) {
                showToast('è«‹å°‡ä¸»è¦ç­”æ¡ˆæ ¼å¡«æ»¿å–”ï¼');
                playSound('error');
                return;
            }

            let isCorrect = true;

            allSlots.forEach((slot) => {
                const correctAnswer = slot.dataset.ans;
                const userAnswer = slot.textContent.trim();

                if (slot.classList.contains('carry-slot')) {
                    if (userAnswer && userAnswer !== correctAnswer) {
                        isCorrect = false;
                        slot.classList.add('error');
                    } else if (userAnswer === correctAnswer) {
                        slot.classList.remove('error');
                        slot.classList.add('correct');
                    } else {
                        slot.classList.remove('error');
                    }
                } else {
                    if (userAnswer !== correctAnswer) {
                        isCorrect = false;
                        slot.classList.add('error');
                    } else {
                        slot.classList.remove('error');
                        slot.classList.add('correct');
                    }
                }
            });

            if (isCorrect) {
                playSound('correct');
                state.score += 20;
                updateScore();

                allSlots.forEach(s => s.classList.remove('selected'));

                if (state.currentStepIdx < problem.steps.length - 1) {
                    state.currentStepIdx++;
                    renderSteps();
                } else {
                    currentStepEl.classList.add('completed');
                    setTimeout(showCompletionModal, 500);
                }
            } else {
                showToast('ç­”æ¡ˆä¸å¤ªå°ï¼Œå†è©¦è©¦çœ‹ï¼<br>é»æ“ŠéŒ¯èª¤çš„æ•¸å­—å¯ä»¥æ¸…é™¤é‡å¡«ã€‚');
                playSound('error');
            }
        }

        function updateScore() {
            const display = document.getElementById('score-display');
            display.textContent = state.score;
            display.parentElement.classList.add('animate-pop');
            setTimeout(() => display.parentElement.classList.remove('animate-pop'), 300);
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').innerHTML = msg;
            toast.classList.remove('translate-y-32', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-32', 'opacity-0');
            }, 3500);
        }

        function speakProblem() {
            const text = document.getElementById('problem-title').innerText;
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            } else {
                showToast("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åŠŸèƒ½");
            }
        }

        function showCompletionModal() {
            const modal = document.getElementById('completion-modal');
            document.getElementById('score-summary').textContent = `ç²å¾—ç¸½ç©åˆ†ï¼š${state.score}`;
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('completion-modal').classList.add('hidden');
        }

        function resetCurrentProblem() {
            closeModal();
            loadProblem(state.currentProblemIdx);
        }
    </script>
</body>
</html>
