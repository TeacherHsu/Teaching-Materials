<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç‰¹æ•™æ•¸å­¸äº’å‹•å·¥å…·ï¼šæ¦‚æ•¸çš„é­”æ³•</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
.slot{
    display:inline-flex;
    min-width:60px;
    height:48px;
    padding:0 12px;
    border:3px dashed #cbd5e1;
    border-radius:8px;
    align-items:center;
    justify-content:center;
    font-size:24px;
    font-weight:bold;
    cursor:pointer;
    background:#f8fafc;
}
.slot.filled{border-style:solid;border-color:#3b82f6;background:#eff6ff;}
.slot.completed{border-color:#22c55e;background:#f0fdf4;color:#166534;cursor:default;}

mark {
    background-color: #fef08a;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
    color: #1e293b;
}
.mark-blue {
    background-color: #bae6fd;
}

@keyframes tada{
0%{transform:scale(1)}
10%,20%{transform:scale(.9) rotate(-3deg)}
30%,50%,70%,90%{transform:scale(1.1) rotate(3deg)}
40%,60%,80%{transform:scale(1.1) rotate(-3deg)}
100%{transform:scale(1)}
}
.animate-tada{animation:tada 1s ease;}

.toast{
position:fixed;
bottom:30px;
left:50%;
transform:translateX(-50%);
background:#111827;
color:white;
padding:12px 24px;
border-radius:12px;
opacity:0;
transition:.3s;
z-index:999;
}
.toast.show{opacity:1;}

/* éš±è—æ»¾å‹•æ¢ */
.no-scrollbar::-webkit-scrollbar {
    display: none;
}
.no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
}
</style>
</head>

<body class="bg-slate-100 text-slate-800 font-sans h-screen flex flex-col">

<header class="bg-white shadow p-4 flex flex-col md:flex-row justify-between items-center gap-4 shrink-0 z-10 relative">
    <div class="font-bold text-blue-600 flex items-center gap-2 text-xl whitespace-nowrap">
        <i class="fa-solid fa-puzzle-piece"></i> æ¦‚æ•¸é­”æ³•
    </div>
    
    <!-- å°è¦½æŒ‰éˆ•å€ -->
    <div class="flex-1 overflow-x-auto no-scrollbar flex gap-2 w-full md:w-auto" id="nav-container">
        <!-- ç”± JS ç”Ÿæˆ -->
    </div>

    <div class="flex items-center gap-4 shrink-0">
        <div class="hidden md:block w-32 bg-slate-200 rounded-full h-3 overflow-hidden">
            <div id="progress-bar" class="bg-blue-500 h-3 transition-all"></div>
        </div>
        <div class="bg-yellow-100 px-4 py-1.5 rounded-full font-bold shadow-inner whitespace-nowrap">
            â­ ç©åˆ†: <span id="score-display">0</span>
        </div>
    </div>
</header>

<main class="flex-1 overflow-hidden flex flex-col md:flex-row relative">
    <!-- å·¦å´ï¼šé¡Œç›®å€ -->
    <div class="w-full md:w-5/12 bg-indigo-50 p-6 overflow-y-auto border-b-2 md:border-b-0 md:border-r-2 border-slate-200 shrink-0">
        <div id="question-container" class="max-w-xl mx-auto"></div>
    </div>

    <!-- å³å´ï¼šä½œç­”å€ -->
    <div class="w-full md:w-7/12 bg-slate-100 p-6 overflow-y-auto">
        <div id="steps-container" class="max-w-2xl mx-auto space-y-6 pb-24"></div>
    </div>
</main>

<div id="toast" class="toast font-bold shadow-lg"></div>

<script>

/* ==============================
   ç‹€æ…‹
============================== */

let score = 0
let currentQuestionIndex = 0
let progressData = {}
let audioCtx

/* ==============================
   é¡Œåº« (åŠ å…¥æ‡‰ç”¨æ¦‚æ•¸ä¼°ç®—å…§å®¹)
============================== */

const questionsData = [
    {
        id: 'q1', title: 'ç„¡æ¢ä»¶é€²å…¥æ³•', 
        content: 'åª½åª½è¦è³¼è²· <mark>8240å…ƒ</mark> çš„æƒåœ°æ©Ÿå™¨äººï¼Œå¥¹åˆ° <mark class="mark-blue">é™æåƒå…ƒéˆ”ç¥¨</mark> çš„ææ¬¾æ©Ÿææ¬¾ï¼Œæœ€å°‘è¦æé ˜å¤šå°‘å…ƒï¼Ÿ',
        steps: [
            { instruction: '8240å…ƒä¸­çš„ 8000å…ƒï¼Œéœ€è¦å¹¾å¼µåƒå…ƒéˆ”ç¥¨ï¼Ÿ', template: 'éœ€è¦ [slot] å¼µåƒå…ƒéˆ”ç¥¨ã€‚', options: ['7', '8', '9'], answer: ['8'] },
            { instruction: 'å‰©ä¸‹çš„ 240å…ƒï¼Œå› ç‚ºææ¬¾æ©Ÿåªèƒ½é ˜åƒå…ƒï¼Œæ‰€ä»¥ä¹Ÿè¦é ˜å¹¾å¼µï¼Ÿ', template: '240å…ƒä¹Ÿéœ€è¦ [slot] å¼µåƒå…ƒéˆ”ç¥¨ã€‚', options: ['0', '1', '2'], answer: ['1'] },
            { instruction: 'ç®—ç®—çœ‹ï¼Œç¸½å…±éœ€è¦å¹¾å¼µåƒå…ƒéˆ”ç¥¨ï¼Ÿä¹Ÿå°±æ˜¯æé ˜äº†å¤šå°‘å…ƒï¼Ÿ', template: 'å…±è¦ [slot] å¼µï¼Œæ‰€ä»¥æœ€å°‘è¦æé ˜ [slot] å…ƒã€‚', options: ['8', '9', '8000', '9000'], answer: ['9', '9000'] }
        ]
    },
    {
        id: 'q2', title: 'ç„¡æ¢ä»¶æ¨å»æ³•', 
        content: 'é£Ÿå“å·¥å» æ˜¨å¤©ç”Ÿç”¢äº† <mark>5237å€‹</mark> æœå‡ã€‚æ¯ <mark class="mark-blue">100å€‹</mark> æœå‡è£æˆ1ç›’ï¼Œæœ€å¤šå¯è£æ»¿å¹¾ç›’ï¼Ÿ',
        steps: [
            { instruction: 'å…ˆçœ‹ç™¾ä½ä»¥ä¸Šçš„æ•¸å­—ã€‚5200å€‹æœå‡ï¼Œå¯ä»¥è£æ»¿å¹¾ç›’(æ¯ç›’100å€‹)ï¼Ÿ', template: '5200å€‹å¯è£æ»¿ [slot] ç›’ã€‚', options: ['5', '52', '520'], answer: ['52'] },
            { instruction: 'å‰©ä¸‹çš„ 37å€‹ æœå‡ï¼Œå¤ ä¸å¤ è£æˆ 1 ç›’ (100å€‹)ï¼Ÿ', template: '37å€‹ [slot] è£æˆ1ç›’ï¼Œæ‰€ä»¥æ¨å»ã€‚', options: ['å¤ ', 'ä¸å¤ '], answer: ['ä¸å¤ '] },
            { instruction: 'æ‰€ä»¥æœ€å¤šå¯ä»¥è£æ»¿å¹¾ç›’ï¼Ÿé€™äº›è£æ»¿çš„æœå‡ç¸½å…±æ˜¯å¹¾å€‹ï¼Ÿ', template: 'æœ€å¤šè£æ»¿ [slot] ç›’ï¼Œå…±è£äº† [slot] å€‹ã€‚', options: ['52', '53', '5200', '5300'], answer: ['52', '5200'] }
        ]
    },
    {
        id: 'q3', title: 'å››æ¨äº”å…¥æ³•', 
        content: 'å¿ å­åœ‹å°æœ‰ <mark>2167äºº</mark>ï¼Œä»æ„›åœ‹å°æœ‰ <mark>2875äºº</mark>ã€‚è«‹ç”¨ã€Œå››æ¨äº”å…¥æ³•ã€å–æ¦‚æ•¸åˆ° <mark class="mark-blue">åƒä½</mark>ã€‚',
        steps: [
            { instruction: 'å…ˆçœ‹å¿ å­åœ‹å°ã€‚2167çš„ç™¾ä½æ•¸å­—æ˜¯ 1ï¼Œæ¯” 5 å°ï¼Œæ‰€ä»¥æ¨å»ã€‚', template: 'å¿ å­åœ‹å°å¤§ç´„æ˜¯ [slot] äººã€‚', options: ['2000', '3000'], answer: ['2000'] },
            { instruction: 'æ›çœ‹ä»æ„›åœ‹å°ã€‚2875çš„ç™¾ä½æ•¸å­—æ˜¯ 8ï¼Œå¤§æ–¼ç­‰æ–¼ 5ï¼Œæ‰€ä»¥è¦é€²ä½ã€‚', template: 'ä»æ„›åœ‹å°å¤§ç´„æ˜¯ [slot] äººã€‚', options: ['2000', '3000'], answer: ['3000'] }
        ]
    },
    {
        id: 'q4', title: 'åŠ æ³•ä¼°ç®—', 
        content: 'è‡ºåŒ—æ·é‹çš„è¼‰å®¢é‡æ˜¯ <mark>67308154äººæ¬¡</mark>ï¼Œé«˜é›„æ·é‹çš„è¼‰å®¢é‡æ˜¯ <mark>5918648äººæ¬¡</mark>ã€‚è«‹å…ˆç”¨å››æ¨äº”å…¥æ³•å–æ¦‚æ•¸åˆ° <mark class="mark-blue">è¬ä½</mark>ï¼Œå†ç®—ç®—çœ‹å¤§ç´„å…±æœ‰å¹¾è¬äººæ¬¡ï¼Ÿ',
        steps: [
            { instruction: 'è‡ºåŒ—æ·é‹è¼‰å®¢é‡ã€Œ67308154ã€å–æ¦‚æ•¸åˆ°è¬ä½ã€‚åƒä½æ•¸å­—æ˜¯ 8ï¼Œè¦é€²ä½ã€‚', template: 'å¤§ç´„æ˜¯ [slot] è¬ã€‚', options: ['6730', '6731', '6732'], answer: ['6731'] },
            { instruction: 'é«˜é›„æ·é‹è¼‰å®¢é‡ã€Œ5918648ã€å–æ¦‚æ•¸åˆ°è¬ä½ã€‚åƒä½æ•¸å­—ä¹Ÿæ˜¯ 8ï¼Œè¦é€²ä½ã€‚', template: 'å¤§ç´„æ˜¯ [slot] è¬ã€‚', options: ['591', '592', '593'], answer: ['592'] },
            { instruction: 'æŠŠå…©å€‹å–å¥½æ¦‚æ•¸çš„æ•¸é‡ç›¸åŠ ï¼Œå°±æ˜¯å¤§ç´„çš„ç¸½äººæ¬¡äº†ï¼', template: '[slot] è¬ + [slot] è¬ = [slot] è¬ã€‚', options: ['6731', '591', '592', '7323', '7223'], answer: ['6731', '592', '7323'] }
        ]
    },
    {
        id: 'q5', title: 'ä¹˜æ³•ä¼°ç®—', 
        content: 'å¦®å¦®å…¨å®¶åƒåŠ æ—…éŠï¼Œåœ˜è²»æ¯äºº <mark>24888å…ƒ</mark>ï¼Œå…¨å®¶å…±æœ‰ <mark class="mark-blue">4äºº</mark>ã€‚å¤§ç´„å…±è¦å¤šå°‘å…ƒï¼Ÿè«‹å…ˆç”¨å››æ¨äº”å…¥æ³•å–æ¦‚æ•¸åˆ° <mark class="mark-blue">åƒä½</mark>ï¼Œå†ç®—ç®—çœ‹ã€‚',
        steps: [
            { instruction: 'å…ˆå°‡æ¯äººçš„åœ˜è²»ã€Œ24888ã€ç”¨å››æ¨äº”å…¥æ³•å–æ¦‚æ•¸åˆ°ã€Œåƒä½ã€ã€‚ç™¾ä½æ•¸å­—æ˜¯ 8ï¼Œè¦é€²ä½ã€‚', template: 'å¤§ç´„æ˜¯ [slot] å…ƒã€‚', options: ['24000', '24800', '25000'], answer: ['25000'] },
            { instruction: 'æ¯äººåœ˜è²»å¤§ç´„æ˜¯ 25000 å…ƒï¼Œå…¨å®¶æœ‰ 4 äººï¼ŒæŠŠå®ƒå€‘ä¹˜èµ·ä¾†ç®—ç¸½èŠ±è²»ã€‚', template: '[slot] Ã— 4 = [slot] å…ƒã€‚', options: ['24888', '25000', '100000', '90000'], answer: ['25000', '100000'] }
        ]
    },
    {
        id: 'q6', title: 'é™¤æ³•ä¼°ç®—', 
        content: 'éæ´²è±¡é‡ <mark>5063å…¬æ–¤</mark>ï¼Œå¥‡å¥‡é‡ <mark class="mark-blue">38å…¬æ–¤</mark>ã€‚éæ´²è±¡çš„é«”é‡å¤§ç´„æ˜¯å¥‡å¥‡çš„å¹¾å€ï¼Ÿè«‹å…ˆç”¨å››æ¨äº”å…¥æ³•å–æ¦‚æ•¸åˆ° <mark class="mark-blue">æœ€é«˜ä½</mark>ï¼Œå†ç®—ç®—çœ‹ã€‚',
        steps: [
            { instruction: '5063æœ€é«˜ä½æ˜¯åƒä½ï¼Œç™¾ä½æ˜¯0æ‰€ä»¥æ¨å»ï¼›38æœ€é«˜ä½æ˜¯åä½ï¼Œå€‹ä½æ˜¯8æ‰€ä»¥é€²ä½ã€‚', template: 'éæ´²è±¡ç´„ [slot] å…¬æ–¤ï¼Œå¥‡å¥‡ç´„ [slot] å…¬æ–¤ã€‚', options: ['5000', '5100', '30', '40'], answer: ['5000', '40'] },
            { instruction: 'ç”¨ä¼°ç®—å¾Œçš„é«”é‡ç›¸é™¤ï¼Œæ±‚å‡ºå€æ•¸ã€‚', template: '[slot] Ã· [slot] = [slot] å€ã€‚', options: ['5000', '40', '125', '120'], answer: ['5000', '40', '125'] }
        ]
    }
]

/* ==============================
   éŸ³æ•ˆ
============================== */

function getAudio(){
    if(!audioCtx){
        audioCtx = new (window.AudioContext||window.webkitAudioContext)()
    }
    return audioCtx
}

function playTone(freq){
    const ctx = getAudio()
    if(ctx.state === "suspended") ctx.resume()
    const osc = ctx.createOscillator()
    const gain = ctx.createGain()
    osc.frequency.value = freq
    osc.type = "sine"
    osc.connect(gain)
    gain.connect(ctx.destination)
    gain.gain.value = 0.1
    osc.start()
    osc.stop(ctx.currentTime + 0.15)
}

/* ==============================
   Toast
============================== */

function showToast(msg){
    const t = document.getElementById("toast")
    t.innerText = msg
    t.classList.add("show")
    setTimeout(() => t.classList.remove("show"), 2000)
}

/* ==============================
   åˆå§‹åŒ–
============================== */

function initData(){
    score = 0
    questionsData.forEach(q => {
        progressData[q.id] = {
            currentStep: 0,
            slots: q.steps.map(s => new Array(s.answer.length).fill(null)),
            completed: false
        }
    })
    saveData()
}

function saveData(){
    localStorage.setItem("approxGameData", JSON.stringify({
        score, progressData, currentQuestionIndex
    }))
}

function loadData(){
    const d = localStorage.getItem("approxGameData")
    if(d){
        const parsed = JSON.parse(d)
        score = parsed.score
        progressData = parsed.progressData
        currentQuestionIndex = parsed.currentQuestionIndex
    }
}

function updateScore(){
    document.getElementById("score-display").innerText = score
    updateProgressBar()
    saveData()
}

function updateProgressBar(){
    const total = questionsData.length
    const done = questionsData.filter(q => progressData[q.id]?.completed).length
    const pbar = document.getElementById("progress-bar");
    if(pbar) pbar.style.width = (done / total * 100) + "%"
}

/* ==============================
   UI Render
============================== */

function renderNavbar(){
    const nav = document.getElementById("nav-container")
    nav.innerHTML = ""
    questionsData.forEach((q, idx) => {
        const btn = document.createElement("button")
        btn.className = `px-5 py-2.5 rounded-full font-bold whitespace-nowrap transition-all flex items-center gap-2 ${
            idx === currentQuestionIndex 
            ? 'bg-blue-600 text-white shadow-md' 
            : 'bg-white text-slate-500 hover:bg-slate-100 border border-slate-200'
        }`
        const isCompleted = progressData[q.id]?.completed
        const icon = isCompleted ? 'âœ…' : `<span class="bg-blue-200 text-blue-800 text-xs w-5 h-5 flex items-center justify-center rounded-full">${idx+1}</span>`
        btn.innerHTML = `${icon} ${q.title}`
        
        btn.onclick = () => {
            currentQuestionIndex = idx
            renderNavbar()
            renderQuestion()
        }
        nav.appendChild(btn)
    })
}

function renderQuestion(){
    const q = questionsData[currentQuestionIndex]
    const p = progressData[q.id]
    
    document.getElementById("question-container").innerHTML = `
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
            <h2 class="text-2xl font-bold text-slate-800 mb-4 pr-12">ç¬¬ ${currentQuestionIndex + 1} é—œï¼š${q.title}</h2>
            <div class="text-2xl leading-relaxed text-slate-700">${q.content}</div>
        </div>
    `
    
    const stepsContainer = document.getElementById("steps-container")
    stepsContainer.innerHTML = ""

    q.steps.forEach((step, i) => {
        if(i > p.currentStep && !p.completed) return

        const card = document.createElement("div")
        const isCompleted = (i < p.currentStep || p.completed)
        card.className = `bg-white p-6 rounded-2xl shadow border-l-8 transition-all duration-500 ${isCompleted ? 'border-green-500 opacity-80' : 'border-blue-500 ring-2 ring-blue-200'}`
        card.id = `step-card-${i}`

        let template = step.template
        step.answer.forEach((ans, idx) => {
            const val = p.slots[i][idx]
            template = template.replace("[slot]",
            `<span class="slot ${val ? 'filled' : ''} ${isCompleted ? 'completed' : ''}" 
            onclick="clearSlot(${i},${idx})">${val ?? "?"}</span>`)
        })

        let options = ""
        if(i === p.currentStep && !p.completed){
            options = step.options.map(o => {
                const isUsed = p.slots[i].includes(o);
                return `
                <button onclick="fillSlot(${i},'${o}')" 
                class="px-5 py-3 border-2 border-slate-300 font-bold text-slate-700 rounded-xl m-1 hover:border-blue-400 hover:bg-blue-50 shadow-sm transition-transform active:scale-95 ${isUsed ? 'opacity-0 pointer-events-none' : ''}">
                ${o}</button>
                `
            }).join("")
            options = `<div class="mt-6 p-4 bg-slate-50 rounded-xl border border-slate-200"><div class="text-sm font-bold text-slate-500 mb-3">é»æ“Šé¸é …å¡«å…¥ï¼š</div>${options}</div>`
        }

        card.innerHTML = `
            <div class="flex items-center gap-3 mb-4">
                <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-white ${isCompleted ? 'bg-green-500' : 'bg-blue-500'}">${i + 1}</div>
                <h3 class="text-xl font-bold text-slate-700">æ­¥é©Ÿ ${i + 1}</h3>
            </div>
            <div class="text-xl text-slate-600 mb-4 leading-relaxed">${step.instruction}</div>
            <div class="text-2xl font-medium bg-blue-50/50 p-4 rounded-xl border border-blue-100 leading-loose flex flex-wrap items-center">${template}</div>
            ${options}
            ${i === p.currentStep && !p.completed ? 
            `<div class="mt-4 flex justify-end"><button onclick="checkAnswer(${i})"
            class="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-200 active:scale-95 transition-all">æª¢æŸ¥ç­”æ¡ˆ</button></div>` : ""}
        `
        stepsContainer.appendChild(card)
    })

    updateScore()
}

/* ==============================
   äº’å‹•é‚è¼¯
============================== */

function fillSlot(step, val){
    const q = questionsData[currentQuestionIndex]
    const p = progressData[q.id]
    const idx = p.slots[step].findIndex(v => v === null)
    if(idx !== -1){
        p.slots[step][idx] = val
        playTone(500)
        renderQuestion()
    }
}

function clearSlot(step, idx){
    const q = questionsData[currentQuestionIndex]
    const p = progressData[q.id]
    if(step < p.currentStep || p.completed) return
    p.slots[step][idx] = null
    renderQuestion()
}

function checkAnswer(step){
    const q = questionsData[currentQuestionIndex]
    const p = progressData[q.id]
    const correct = q.steps[step].answer
    const user = p.slots[step]

    if(user.includes(null)){
        showToast("è«‹å¡«æ»¿æ‰€æœ‰çš„ç©ºæ ¼å–”ï¼")
        playTone(200)
        return
    }

    let ok = true
    for(let i = 0; i < correct.length; i++){
        if(user[i] !== correct[i]) ok = false
    }

    if(ok){
        score += 10
        playTone(800)
        
        const card = document.getElementById(`step-card-${step}`)
        if(card) card.classList.add('animate-tada')

        setTimeout(() => {
            p.currentStep++
            if(p.currentStep >= q.steps.length){
                p.completed = true
                showToast("ğŸ‰ æ­å–œï¼æœ¬é¡Œå®Œæˆï¼")
                renderNavbar() // æ›´æ–°ä¸Šæ–¹æ‰“å‹¾åœ–ç¤º
            }
            renderQuestion()
            
            // æ»¾å‹•åˆ°æ–°çš„æ­¥é©Ÿ
            if (!p.completed) {
                setTimeout(() => {
                    const newCard = document.getElementById(`step-card-${p.currentStep}`);
                    if(newCard) newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        }, 800)
    } else {
        playTone(150)
        showToast("ç­”éŒ¯äº†ï¼Œå†æƒ³æƒ³çœ‹ï¼")
    }
}

/* ==============================
   å•Ÿå‹•
============================== */

window.addEventListener("load", () => {
    loadData()
    if(!progressData || Object.keys(progressData).length === 0){
        initData()
    }
    renderNavbar()
    renderQuestion()
})

</script>
</body>
</html>
