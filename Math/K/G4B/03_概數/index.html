<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç‰¹æ•™æ•¸å­¸äº’å‹•å·¥å…·ï¼šæ¦‚æ•¸çš„é­”æ³•</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
.slot{
  display:inline-flex;
  min-width:60px;
  height:48px;
  padding:0 12px;
  border:3px dashed #cbd5e1;
  border-radius:8px;
  align-items:center;
  justify-content:center;
  font-size:24px;
  font-weight:bold;
  cursor:pointer;
  background:#f8fafc;
}
.slot.filled{border-style:solid;border-color:#3b82f6;background:#eff6ff;}
.slot.completed{border-color:#22c55e;background:#f0fdf4;color:#166534;cursor:default;}

mark{
  background-color:#fef08a;
  padding:2px 6px;
  border-radius:4px;
  font-weight:bold;
  color:#1e293b;
}
.mark-blue{background-color:#bae6fd;}

@keyframes tada{
  0%{transform:scale(1)}
  10%,20%{transform:scale(.9) rotate(-3deg)}
  30%,50%,70%,90%{transform:scale(1.1) rotate(3deg)}
  40%,60%,80%{transform:scale(1.1) rotate(-3deg)}
  100%{transform:scale(1)}
}
.animate-tada{animation:tada 1s ease;}

.toast{
  position:fixed;
  bottom:30px;
  left:50%;
  transform:translateX(-50%);
  background:#111827;
  color:white;
  padding:12px 24px;
  border-radius:12px;
  opacity:0;
  transition:.3s;
  z-index:999;
}
.toast.show{opacity:1;}

.no-scrollbar::-webkit-scrollbar{display:none;}
.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none;}
</style>
</head>

<body class="bg-slate-100 text-slate-800 font-sans h-screen flex flex-col">

<header class="bg-white shadow p-4 flex flex-col md:flex-row justify-between items-center gap-4 shrink-0 z-10 relative">
  <div class="font-bold text-blue-600 flex items-center gap-2 text-xl whitespace-nowrap">
    <i class="fa-solid fa-puzzle-piece"></i> æ¦‚æ•¸é­”æ³•
  </div>

  <div class="flex-1 overflow-x-auto no-scrollbar flex gap-2 w-full md:w-auto" id="nav-container"></div>

  <div class="flex items-center gap-4 shrink-0">
    <div class="hidden md:block w-32 bg-slate-200 rounded-full h-3 overflow-hidden">
      <div id="progress-bar" class="bg-blue-500 h-3 transition-all"></div>
    </div>
    <div class="bg-yellow-100 px-4 py-1.5 rounded-full font-bold shadow-inner whitespace-nowrap">
      â­ ç©åˆ†: <span id="score-display">0</span>
    </div>
  </div>
</header>

<main class="flex-1 overflow-hidden flex flex-col md:flex-row relative">
  <div class="w-full md:w-5/12 bg-indigo-50 p-6 overflow-y-auto border-b-2 md:border-b-0 md:border-r-2 border-slate-200 shrink-0">
    <div id="question-container" class="max-w-xl mx-auto"></div>
  </div>

  <div class="w-full md:w-7/12 bg-slate-100 p-6 overflow-y-auto">
    <div id="steps-container" class="max-w-2xl mx-auto space-y-6 pb-24"></div>
  </div>
</main>

<div id="toast" class="toast font-bold shadow-lg"></div>

<script>
/* ==============================
   ç‹€æ…‹
============================== */
let score = 0;
let currentQuestionIndex = 0;
let progressData = {};
let audioCtx;

/* ==============================
   é¡Œåº«ï¼šæ¯æ¬¡è¼‰å…¥å‹•æ…‹ç”Ÿæˆï¼ˆé¿å…èƒŒç­”æ¡ˆï¼‰
============================== */
function randInt(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; }
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

function buildOptions(correct, pool, count=3){
  // correct: string
  // pool: array<string>
  const set = new Set([String(correct)]);
  // å…ˆç”¨ pool å¡«
  for(const p of pool){
    if(set.size >= count) break;
    set.add(String(p));
  }
  // ä¸å¤ å°±äº‚è£œ
  while(set.size < count){
    const any = String(randInt(0, 99999));
    set.add(any);
  }
  // æ‰“æ•£
  const arr = Array.from(set);
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function generateQuestions(){
  // q1 ç„¡æ¢ä»¶é€²å…¥ï¼šåƒå…ƒææ¬¾
  const price = randInt(2000, 9999);
  const needK = Math.ceil(price / 1000);
  const totalWithdraw = needK * 1000;

  // q2 ç„¡æ¢ä»¶æ¨å»ï¼š100å€‹ä¸€ç›’
  const jelly = randInt(3000, 8999);
  const boxes = Math.floor(jelly / 100);

  // q3 å››æ¨äº”å…¥åˆ°åƒä½
  const schoolA = randInt(1000, 3999);
  const schoolB = randInt(2000, 4999);
  const roundA = Math.round(schoolA / 1000) * 1000;
  const roundB = Math.round(schoolB / 1000) * 1000;

  // q4 åŠ æ³•ä¼°ç®—ï¼šå–è¬ä½ï¼ˆä»¥ã€Œè¬ã€ç‚ºå–®ä½é¡¯ç¤ºï¼‰
  const metroA = randInt(10000000, 99999999);
  const metroB = randInt(1000000, 9999999);
  const metroA_wan = Math.round(metroA / 10000);
  const metroB_wan = Math.round(metroB / 10000);
  const metroSum_wan = metroA_wan + metroB_wan;

  // q5 ä¹˜æ³•ä¼°ç®—ï¼šå–åƒä½
  const travel = randInt(20000, 49999);
  const people = randInt(3, 5);
  const travel_r = Math.round(travel / 1000) * 1000;
  const travel_total = travel_r * people;

  // q6 é™¤æ³•ä¼°ç®—ï¼šæœ€é«˜ä½ï¼ˆè±¡åƒä½ã€äººåä½ï¼‰
  const elephant = randInt(4000, 8999);
  const human = randInt(20, 59);
  const elephant_r = Math.round(elephant / 1000) * 1000;
  const human_r = Math.round(human / 10) * 10;
  const multiple = Math.round(elephant_r / human_r);

  return [
    {
      id:'q1', title:'ç„¡æ¢ä»¶é€²å…¥æ³•',
      content:`åª½åª½è¦è³¼è²· <mark>${price}å…ƒ</mark> çš„å•†å“ï¼Œå¥¹åˆ° <mark class="mark-blue">é™æåƒå…ƒéˆ”ç¥¨</mark> çš„ææ¬¾æ©Ÿææ¬¾ï¼Œæœ€å°‘è¦æé ˜å¤šå°‘å…ƒï¼Ÿ`,
      steps:[
        {
          instruction:`å› ç‚ºåªèƒ½é ˜åƒå…ƒï¼Œ${price}å…ƒéœ€è¦å¹¾å¼µåƒå…ƒéˆ”ç¥¨ï¼Ÿ`,
          template:'éœ€è¦ [slot] å¼µåƒå…ƒéˆ”ç¥¨ã€‚',
          options: buildOptions(String(needK), [needK-1, needK+1, needK+2].map(String), 3),
          answer:[String(needK)]
        },
        {
          instruction:'é‚£éº¼æœ€å°‘æœƒæé ˜åˆ°å¤šå°‘å…ƒï¼Ÿ',
          template:'æœ€å°‘è¦æé ˜ [slot] å…ƒã€‚',
          options: buildOptions(String(totalWithdraw), [totalWithdraw-1000, totalWithdraw+1000, totalWithdraw+2000].map(String), 3),
          answer:[String(totalWithdraw)]
        }
      ]
    },
    {
      id:'q2', title:'ç„¡æ¢ä»¶æ¨å»æ³•',
      content:`é£Ÿå“å·¥å» æ˜¨å¤©ç”Ÿç”¢äº† <mark>${jelly}å€‹</mark> æœå‡ã€‚æ¯ <mark class="mark-blue">100å€‹</mark> æœå‡è£æˆ1ç›’ï¼Œæœ€å¤šå¯è£æ»¿å¹¾ç›’ï¼Ÿ`,
      steps:[
        {
          instruction:`æŠŠ ${jelly} å€‹ç”¨ã€Œæ¯100å€‹ä¸€ç›’ã€ä¾†çœ‹ï¼Œæœ€å¤šè£æ»¿å¹¾ç›’ï¼Ÿ`,
          template:'æœ€å¤šå¯è£æ»¿ [slot] ç›’ã€‚',
          options: buildOptions(String(boxes), [boxes-1, boxes+1, boxes+2].map(String), 3),
          answer:[String(boxes)]
        }
      ]
    },
    {
      id:'q3', title:'å››æ¨äº”å…¥æ³•',
      content:`å¿ å­åœ‹å°æœ‰ <mark>${schoolA}äºº</mark>ï¼Œä»æ„›åœ‹å°æœ‰ <mark>${schoolB}äºº</mark>ã€‚è«‹ç”¨ã€Œå››æ¨äº”å…¥æ³•ã€å–æ¦‚æ•¸åˆ° <mark class="mark-blue">åƒä½</mark>ã€‚`,
      steps:[
        {
          instruction:`${schoolA} å–æ¦‚æ•¸åˆ°åƒä½ï¼Œå¤§ç´„æ˜¯å¤šå°‘ï¼Ÿ`,
          template:'å¿ å­åœ‹å°å¤§ç´„æ˜¯ [slot] äººã€‚',
          options: buildOptions(String(roundA), [roundA-1000, roundA+1000].map(String), 3),
          answer:[String(roundA)]
        },
        {
          instruction:`${schoolB} å–æ¦‚æ•¸åˆ°åƒä½ï¼Œå¤§ç´„æ˜¯å¤šå°‘ï¼Ÿ`,
          template:'ä»æ„›åœ‹å°å¤§ç´„æ˜¯ [slot] äººã€‚',
          options: buildOptions(String(roundB), [roundB-1000, roundB+1000].map(String), 3),
          answer:[String(roundB)]
        }
      ]
    },
    {
      id:'q4', title:'åŠ æ³•ä¼°ç®—',
      content:`è‡ºåŒ—æ·é‹çš„è¼‰å®¢é‡æ˜¯ <mark>${metroA}äººæ¬¡</mark>ï¼Œé«˜é›„æ·é‹çš„è¼‰å®¢é‡æ˜¯ <mark>${metroB}äººæ¬¡</mark>ã€‚è«‹å…ˆç”¨å››æ¨äº”å…¥æ³•å–æ¦‚æ•¸åˆ° <mark class="mark-blue">è¬ä½</mark>ï¼Œå†ç®—ç®—çœ‹å¤§ç´„å…±æœ‰å¹¾è¬äººæ¬¡ï¼Ÿ`,
      steps:[
        {
          instruction:`å…ˆæŠŠå…©å€‹æ•¸éƒ½å–åˆ°ã€Œè¬ä½ã€å¾Œå†ç›¸åŠ ã€‚`,
          template:`ç´„ [slot] è¬äººæ¬¡ã€‚`,
          options: buildOptions(String(metroSum_wan), [metroSum_wan-100, metroSum_wan+100, metroSum_wan+200].map(String), 3),
          answer:[String(metroSum_wan)]
        }
      ]
    },
    {
      id:'q5', title:'ä¹˜æ³•ä¼°ç®—',
      content:`å¦®å¦®å…¨å®¶åƒåŠ æ—…éŠï¼Œåœ˜è²»æ¯äºº <mark>${travel}å…ƒ</mark>ï¼Œå…¨å®¶å…±æœ‰ <mark class="mark-blue">${people}äºº</mark>ã€‚å¤§ç´„å…±è¦å¤šå°‘å…ƒï¼Ÿè«‹å…ˆç”¨å››æ¨äº”å…¥æ³•å–æ¦‚æ•¸åˆ° <mark class="mark-blue">åƒä½</mark>ï¼Œå†ç®—ç®—çœ‹ã€‚`,
      steps:[
        {
          instruction:`${travel} å–æ¦‚æ•¸åˆ°åƒä½ï¼Œå¤§ç´„æ˜¯å¤šå°‘ï¼Ÿ`,
          template:'æ¯äººåœ˜è²»å¤§ç´„æ˜¯ [slot] å…ƒã€‚',
          options: buildOptions(String(travel_r), [travel_r-1000, travel_r+1000].map(String), 3),
          answer:[String(travel_r)]
        },
        {
          instruction:`å†æŠŠæ¦‚æ•¸ä¹˜ä¸Š ${people} äººï¼Œä¼°ç®—ç¸½èŠ±è²»ã€‚`,
          template:`[slot] Ã— ${people} = [slot] å…ƒã€‚`,
          options: (function(){
            const a = String(travel_r);
            const b = String(travel_total);
            const distract1 = String(travel_total + 1000);
            const distract2 = String(travel_total - 1000);
            // å…©æ ¼ï¼š[slot] æ˜¯ travel_rï¼Œç¬¬äºŒæ ¼æ˜¯ travel_total
            // options ä¾›å…©æ ¼å…±ç”¨ï¼šæ··åœ¨ä¸€èµ·
            const base = [a,b,distract1,distract2];
            // å»é‡æ‰“æ•£
            const set = Array.from(new Set(base));
            for(let i=set.length-1;i>0;i--){
              const j = Math.floor(Math.random()*(i+1));
              [set[i], set[j]] = [set[j], set[i]];
            }
            return set;
          })(),
          answer:[String(travel_r), String(travel_total)]
        }
      ]
    },
    {
      id:'q6', title:'é™¤æ³•ä¼°ç®—',
      content:`éæ´²è±¡é‡ <mark>${elephant}å…¬æ–¤</mark>ï¼Œå¥‡å¥‡é‡ <mark class="mark-blue">${human}å…¬æ–¤</mark>ã€‚éæ´²è±¡çš„é«”é‡å¤§ç´„æ˜¯å¥‡å¥‡çš„å¹¾å€ï¼Ÿè«‹å…ˆç”¨å››æ¨äº”å…¥æ³•å–æ¦‚æ•¸åˆ° <mark class="mark-blue">æœ€é«˜ä½</mark>ï¼Œå†ç®—ç®—çœ‹ã€‚`,
      steps:[
        {
          instruction:`å…ˆå–æ¦‚æ•¸ï¼šéæ´²è±¡ç´„ ${elephant_r} å…¬æ–¤ï¼Œå¥‡å¥‡ç´„ ${human_r} å…¬æ–¤ã€‚å†ç›¸é™¤ä¼°ç®—å€æ•¸ã€‚`,
          template:`${elephant_r} Ã· ${human_r} â‰ˆ [slot] å€ã€‚`,
          options: buildOptions(String(multiple), [multiple-5, multiple+5, multiple+10].map(String), 3),
          answer:[String(multiple)]
        }
      ]
    }
  ];
}

let questionsData = generateQuestions();

/* ==============================
   éŸ³æ•ˆ
============================== */
function getAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  }
  return audioCtx;
}
function playTone(freq){
  const ctx = getAudio();
  if(ctx.state === "suspended") ctx.resume();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.frequency.value = freq;
  osc.type = "sine";
  osc.connect(gain);
  gain.connect(ctx.destination);
  gain.gain.value = 0.1;
  osc.start();
  osc.stop(ctx.currentTime + 0.15);
}

/* ==============================
   Toast
============================== */
function showToast(msg){
  const t = document.getElementById("toast");
  t.innerText = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2000);
}

/* ==============================
   åˆå§‹åŒ– / å­˜æª”
   - åªå­˜é€²åº¦ï¼Œä¸å­˜é¡Œç›®å…§å®¹ï¼ˆé¿å…å­¸ç”ŸèƒŒç­”æ¡ˆï¼‰
============================== */
const STORAGE_KEY = "approxGameData_v2";

function initData(){
  score = 0;
  progressData = {};
  currentQuestionIndex = 0;
  questionsData.forEach(q => {
    progressData[q.id] = {
      currentStep: 0,
      slots: q.steps.map(s => new Array(s.answer.length).fill(null)),
      completed: false
    };
  });
  saveData();
}

function saveData(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({
    score, progressData, currentQuestionIndex
  }));
}

function loadData(){
  try{
    const d = localStorage.getItem(STORAGE_KEY);
    if(!d) return;
    const parsed = JSON.parse(d);
    if(!parsed) return;
    score = Number.isFinite(parsed.score) ? parsed.score : 0;
    progressData = parsed.progressData || {};
    currentQuestionIndex = Number.isInteger(parsed.currentQuestionIndex) ? parsed.currentQuestionIndex : 0;
  }catch(e){}
}

function ensureProgressShape(){
  // é¡Œç›®æ˜¯å‹•æ…‹çš„ï¼Œä½†é—œå¡ id å›ºå®šï¼›è‹¥ç¼ºå°±è£œ
  questionsData.forEach(q => {
    if(!progressData[q.id]){
      progressData[q.id] = {
        currentStep: 0,
        slots: q.steps.map(s => new Array(s.answer.length).fill(null)),
        completed: false
      };
    }else{
      // steps é•·åº¦ä¸åŒæ™‚è£œé½Šï¼ˆä»¥ç›®å‰é¡Œç›®ç‚ºæº–ï¼‰
      const p = progressData[q.id];
      if(!Array.isArray(p.slots) || p.slots.length !== q.steps.length){
        p.currentStep = 0;
        p.completed = false;
        p.slots = q.steps.map(s => new Array(s.answer.length).fill(null));
      }else{
        // æ¯æ­¥ slots é•·åº¦ä¸åŒä¹Ÿè£œ
        q.steps.forEach((s, i) => {
          if(!Array.isArray(p.slots[i]) || p.slots[i].length !== s.answer.length){
            p.slots[i] = new Array(s.answer.length).fill(null);
          }
        });
      }
    }
  });

  currentQuestionIndex = clamp(currentQuestionIndex, 0, questionsData.length-1);
  saveData();
}

function updateScore(){
  document.getElementById("score-display").innerText = score;
  updateProgressBar();
  saveData();
}

function updateProgressBar(){
  const total = questionsData.length;
  const done = questionsData.filter(q => progressData[q.id]?.completed).length;
  const pbar = document.getElementById("progress-bar");
  if(pbar) pbar.style.width = (done / total * 100) + "%";
}

/* ==============================
   UI Render
============================== */
function renderNavbar(){
  const nav = document.getElementById("nav-container");
  nav.innerHTML = "";
  questionsData.forEach((q, idx) => {
    const btn = document.createElement("button");
    btn.className = `px-5 py-2.5 rounded-full font-bold whitespace-nowrap transition-all flex items-center gap-2 ${
      idx === currentQuestionIndex
        ? 'bg-blue-600 text-white shadow-md'
        : 'bg-white text-slate-500 hover:bg-slate-100 border border-slate-200'
    }`;

    const isCompleted = progressData[q.id]?.completed;
    const icon = isCompleted ? 'âœ…' : `<span class="bg-blue-200 text-blue-800 text-xs w-5 h-5 flex items-center justify-center rounded-full">${idx+1}</span>`;
    btn.innerHTML = `${icon} ${q.title}`;

    btn.addEventListener("click", () => {
      currentQuestionIndex = idx;
      renderNavbar();
      renderQuestion();
    });

    nav.appendChild(btn);
  });
}

function renderQuestion(){
  const q = questionsData[currentQuestionIndex];
  const p = progressData[q.id];

  document.getElementById("question-container").innerHTML = `
    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
      <div class="flex items-start justify-between gap-3">
        <h2 class="text-2xl font-bold text-slate-800 mb-4 pr-12">ç¬¬ ${currentQuestionIndex + 1} é—œï¼š${q.title}</h2>
        <button id="regen-btn"
          class="shrink-0 px-4 py-2 rounded-xl bg-indigo-100 text-indigo-700 font-bold hover:bg-indigo-200 transition"
          title="æ›ä¸€é¡Œï¼ˆæœ¬é—œæœƒé‡ç½®ï¼‰">
          ğŸ”„ æ›ä¸€é¡Œ
        </button>
      </div>
      <div class="text-2xl leading-relaxed text-slate-700">${q.content}</div>
      <div class="mt-4 text-sm font-bold text-slate-500">
        å°æé†’ï¼šé‡æ–°æ•´ç†é é¢æœƒè‡ªå‹•æ›æ–°é¡Œç›®å–”ï¼
      </div>
    </div>
  `;

  // æ›ä¸€é¡Œï¼šåªé‡ç½®ç•¶å‰é—œå¡é€²åº¦ï¼Œä¸¦é‡æ–°ç”Ÿæˆæ•´ä»½é¡Œï¼ˆç¢ºä¿çœŸæ­£æ›æ•¸å­—ï¼‰
  document.getElementById("regen-btn").addEventListener("click", () => {
    questionsData = generateQuestions();
    const curId = q.id;
    // è®“ currentQuestionIndex æŒ‡å›åŒ id çš„é‚£é—œï¼ˆä½ç½®å›ºå®šï¼‰
    currentQuestionIndex = questionsData.findIndex(x => x.id === curId);
    // é‡ç½®è©²é—œé€²åº¦
    const newQ = questionsData[currentQuestionIndex];
    progressData[newQ.id] = {
      currentStep: 0,
      slots: newQ.steps.map(s => new Array(s.answer.length).fill(null)),
      completed: false
    };
    showToast("å·²æ›æ–°é¡Œï¼æœ¬é—œå·²é‡ç½®ã€‚");
    renderNavbar();
    renderQuestion();
  });

  const stepsContainer = document.getElementById("steps-container");
  stepsContainer.innerHTML = "";

  q.steps.forEach((step, i) => {
    if(i > p.currentStep && !p.completed) return;

    const card = document.createElement("div");
    const isCompleted = (i < p.currentStep || p.completed);
    card.className = `bg-white p-6 rounded-2xl shadow border-l-8 transition-all duration-500 ${
      isCompleted ? 'border-green-500 opacity-80' : 'border-blue-500 ring-2 ring-blue-200'
    }`;
    card.id = `step-card-${i}`;

    let template = step.template;

    step.answer.forEach((_, idx) => {
      const val = p.slots[i][idx];
      template = template.replace("[slot]",
        `<span class="slot ${val ? 'filled' : ''} ${isCompleted ? 'completed' : ''}"
              data-action="clear-slot"
              data-step="${i}"
              data-idx="${idx}">${val ?? "?"}</span>`
      );
    });

    let options = "";
    if(i === p.currentStep && !p.completed){
      const optsHTML = step.options.map(o => {
        const isUsed = p.slots[i].includes(o);
        return `
          <button
            data-action="fill-slot"
            data-step="${i}"
            data-val="${encodeURIComponent(o)}"
            class="px-5 py-3 border-2 border-slate-300 font-bold text-slate-700 rounded-xl m-1 hover:border-blue-400 hover:bg-blue-50 shadow-sm transition-transform active:scale-95 ${isUsed ? 'opacity-0 pointer-events-none' : ''}">
            ${o}
          </button>
        `;
      }).join("");

      options = `
        <div class="mt-6 p-4 bg-slate-50 rounded-xl border border-slate-200">
          <div class="text-sm font-bold text-slate-500 mb-3">é»æ“Šé¸é …å¡«å…¥ï¼š</div>
          ${optsHTML}
        </div>
      `;
    }

    card.innerHTML = `
      <div class="flex items-center gap-3 mb-4">
        <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-white ${isCompleted ? 'bg-green-500' : 'bg-blue-500'}">${i + 1}</div>
        <h3 class="text-xl font-bold text-slate-700">æ­¥é©Ÿ ${i + 1}</h3>
      </div>
      <div class="text-xl text-slate-600 mb-4 leading-relaxed">${step.instruction}</div>
      <div class="text-2xl font-medium bg-blue-50/50 p-4 rounded-xl border border-blue-100 leading-loose flex flex-wrap items-center">
        ${template}
      </div>
      ${options}
      ${i === p.currentStep && !p.completed ? `
        <div class="mt-4 flex justify-end">
          <button
            data-action="check-answer"
            data-step="${i}"
            class="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-200 active:scale-95 transition-all">
            æª¢æŸ¥ç­”æ¡ˆ
          </button>
        </div>` : ""
      }
    `;
    stepsContainer.appendChild(card);
  });

  updateScore();
}

/* ==============================
   äº’å‹•ï¼šäº‹ä»¶ä»£ç†ï¼ˆé¿å… inline onclick çˆ†æ‰ï¼‰
============================== */
function fillSlot(step, val){
  const q = questionsData[currentQuestionIndex];
  const p = progressData[q.id];
  const idx = p.slots[step].findIndex(v => v === null);
  if(idx !== -1){
    p.slots[step][idx] = val;
    playTone(500);
    renderQuestion();
  }
}

function clearSlot(step, idx){
  const q = questionsData[currentQuestionIndex];
  const p = progressData[q.id];
  if(step < p.currentStep || p.completed) return;
  p.slots[step][idx] = null;
  renderQuestion();
}

function checkAnswer(step){
  const q = questionsData[currentQuestionIndex];
  const p = progressData[q.id];
  const correct = q.steps[step].answer;
  const user = p.slots[step];

  if(user.includes(null)){
    showToast("è«‹å¡«æ»¿æ‰€æœ‰çš„ç©ºæ ¼å–”ï¼");
    playTone(200);
    return;
  }

  let ok = true;
  for(let i = 0; i < correct.length; i++){
    if(user[i] !== correct[i]) ok = false;
  }

  if(ok){
    score += 10;
    playTone(800);

    const card = document.getElementById(`step-card-${step}`);
    if(card) card.classList.add('animate-tada');

    setTimeout(() => {
      p.currentStep++;
      if(p.currentStep >= q.steps.length){
        p.completed = true;
        showToast("ğŸ‰ æ­å–œï¼æœ¬é¡Œå®Œæˆï¼");
        renderNavbar();
      }
      renderQuestion();

      if(!p.completed){
        setTimeout(() => {
          const newCard = document.getElementById(`step-card-${p.currentStep}`);
          if(newCard) newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
      }
    }, 800);
  } else {
    playTone(150);
    showToast("ç­”éŒ¯äº†ï¼Œå†æƒ³æƒ³çœ‹ï¼");
  }
}

document.addEventListener("click", (e) => {
  const el = e.target.closest("[data-action]");
  if(!el) return;

  const action = el.getAttribute("data-action");
  const step = Number(el.getAttribute("data-step"));

  if(action === "fill-slot"){
    const val = decodeURIComponent(el.getAttribute("data-val") || "");
    fillSlot(step, val);
  }else if(action === "clear-slot"){
    const idx = Number(el.getAttribute("data-idx"));
    clearSlot(step, idx);
  }else if(action === "check-answer"){
    checkAnswer(step);
  }
});

/* ==============================
   å•Ÿå‹•
============================== */
window.addEventListener("load", () => {
  // æ¯æ¬¡è¼‰å…¥å…ˆç”Ÿæˆæ–°é¡Œï¼ˆçœŸæ­£é¿å…èƒŒç­”æ¡ˆï¼‰
  questionsData = generateQuestions();

  loadData();
  if(!progressData || Object.keys(progressData).length === 0){
    initData();
  }else{
    ensureProgressShape();
  }

  renderNavbar();
  renderQuestion();
});
</script>
</body>
</html>
