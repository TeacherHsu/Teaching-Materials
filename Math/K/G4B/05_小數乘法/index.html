<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å°æ•¸ä¹˜æ³•äº’å‹•è§£é¡Œå·¥å…·ï¼ˆå‹•æ…‹å‡ºé¡Œå‡ç´šç‰ˆï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }

    .math { font-size: 28px; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; flex-wrap: wrap; }
    .slot{
      min-width: 64px; height: 56px; padding: 0 12px;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius:16px; border:3px dashed #94a3b8; background:#fff;
      font-weight:900; font-size:26px; user-select:none; cursor:pointer; transition:.15s;
    }
    .slot:hover{ background:#f8fafc; border-color:#60a5fa; }
    .slot.selected{ border-style:solid; border-color:#f59e0b; background:#fffbeb; transform:scale(1.03); }
    .slot.filled{ border-style:solid; border-color:#3b82f6; background:#dbeafe; }
    .slot.correct{ border-color:#22c55e !important; background:#f0fdf4 !important; color:#166534; }
    .slot.error{ border-color:#ef4444 !important; background:#fef2f2 !important; animation: shake .45s; }

    .opt-btn{
      min-width:88px; padding:12px 20px;
      border-radius:18px; border:2px solid #cbd5e1; border-bottom-width:6px;
      background:#fff; font-weight:900; font-size:22px; transition:.1s;
    }
    .opt-btn:active{ transform:translateY(4px); border-bottom-width:2px; margin-top:4px; }

    mark{ background:#fef08a; padding:.125rem .375rem; border-radius:.35rem; font-weight:900; }

    @keyframes shake{
      10%, 90% { transform: translateX(-2px); }
      20%, 80% { transform: translateX(4px); }
      30%, 50%, 70% { transform: translateX(-6px); }
      40%, 60% { transform: translateX(6px); }
    }

    .no-scrollbar::-webkit-scrollbar{ display:none; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
  </style>
</head>

<body class="bg-sky-50 min-h-screen text-slate-800 pb-24">
  <div id="app"></div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center z-50 px-4 backdrop-blur-sm">
    <div class="bg-white w-full max-w-xl rounded-[2rem] p-8 shadow-2xl border-4 border-yellow-300">
      <div class="text-center">
        <div class="w-24 h-24 mx-auto rounded-full bg-green-100 flex items-center justify-center text-5xl mb-4">ğŸ‰</div>
        <h2 class="text-3xl font-black mb-2">å®Œæˆï¼</h2>
        <p id="modalText" class="text-slate-700 font-bold text-xl mb-6"></p>
        <div class="flex gap-3">
          <button id="btnNext" class="flex-1 py-4 rounded-2xl bg-blue-600 hover:bg-blue-700 text-white font-black text-xl">ä¸‹ä¸€é¡Œ âœ</button>
          <button id="btnClose" class="flex-1 py-4 rounded-2xl bg-white hover:bg-slate-50 border-4 border-slate-200 font-black text-xl">é—œé–‰</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Error panel -->
  <div id="errPanel" class="fixed bottom-4 left-4 right-4 hidden">
    <div class="max-w-4xl mx-auto bg-red-50 border-2 border-red-200 rounded-2xl p-4 shadow-lg">
      <div class="font-black text-red-700 mb-2 text-lg">âš ï¸ é€™é ç™¼ç”ŸéŒ¯èª¤ï¼ˆæ‰€ä»¥ä½ å¯èƒ½æœƒçœ‹åˆ°ç©ºç™½ï¼‰</div>
      <pre id="errText" class="text-red-800 whitespace-pre-wrap text-sm"></pre>
    </div>
  </div>

<script>
/* ===============================
   å·¥å…·
================================ */
const escHtml = (s) => String(s)
  .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
  .replaceAll('"','&quot;').replaceAll("'",'&#39;');

const shuf = (arr) => {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
};

/* ===============================
   TTS
================================ */
const synth = window.speechSynthesis;
function speak(text) {
  try {
    synth.cancel();
    const u = new SpeechSynthesisUtterance(String(text));
    u.lang = 'zh-TW';
    u.rate = 0.9;
    synth.speak(u);
  } catch (_) {}
}

/* ===============================
   éŸ³æ•ˆï¼ˆé¦–æ¬¡äº’å‹•å¾Œå•Ÿç”¨ï¼‰
================================ */
let audioCtx = null;
function ensureAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
}
function playSound(type) {
  if (!audioCtx) return;
  try {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    const t = audioCtx.currentTime;

    if (type === 'success') {
      osc.type = 'sine';
      osc.frequency.setValueAtTime(520, t);
      osc.frequency.setValueAtTime(660, t + 0.1);
      osc.frequency.setValueAtTime(784, t + 0.2);
      gain.gain.setValueAtTime(0.10, t);
      gain.gain.exponentialRampToValueAtTime(0.00001, t + 0.55);
      osc.start(); osc.stop(t + 0.55);
    } else if (type === 'error') {
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(300, t);
      osc.frequency.setValueAtTime(200, t + 0.2);
      gain.gain.setValueAtTime(0.10, t);
      gain.gain.exponentialRampToValueAtTime(0.00001, t + 0.35);
      osc.start(); osc.stop(t + 0.35);
    } else {
      osc.type = 'sine';
      osc.frequency.setValueAtTime(620, t);
      gain.gain.setValueAtTime(0.08, t);
      gain.gain.exponentialRampToValueAtTime(0.00001, t + 0.1);
      osc.start(); osc.stop(t + 0.1);
    }
  } catch (_) {}
}

/* ===============================
   é¡Œåº«ï¼šæ¯æ¬¡è¼‰å…¥é‡æ–°ç”Ÿæˆï¼ˆâœ… æœ¬æ¬¡å‡ç´šé‡é»ï¼‰
   - æ¯æ¬¡æ‰“é–‹é é¢ï¼šæ–°é¡Œç›®
   - åŒä¸€æ¬¡ä½œç­”ï¼šQUESTIONS å›ºå®šä¸è®Š
================================ */
function genQ1(){
  const a = (Math.floor(Math.random() * 8) + 2) / 10; // 0.2~0.9
  const b = Math.floor(Math.random() * 6) + 3;        // 3~8
  const ans1 = Math.round(a * 10);
  const ans2 = ans1 * b;
  const finalAns = (ans2 / 10).toFixed(1);

  return {
    title: "æŒ‘æˆ°ä¸€ï¼šä¸€ä½å°æ•¸",
    text: `åšä¸€å€‹å½©çƒéœ€è¦ <mark>${a}</mark> å…¬å°ºçš„å½©å¸¶ï¼Œåš <mark>${b}</mark> å€‹å½©çƒéœ€è¦å¤šé•·çš„å½©å¸¶ï¼Ÿ`,
    speechText: `åšä¸€å€‹å½©çƒéœ€è¦ ${a} å…¬å°ºçš„å½©å¸¶ï¼Œåš ${b} å€‹å½©çƒéœ€è¦å¤šé•·çš„å½©å¸¶ï¼Ÿ`,
    svg: `<svg viewBox="0 0 100 100" class="w-full max-w-[160px] mx-auto drop-shadow-md my-4"><circle cx="50" cy="50" r="35" fill="#fecaca" stroke="#ef4444" stroke-width="4"/><path d="M 50 15 Q 70 50 50 85 M 15 50 Q 50 70 85 50" stroke="#ef4444" stroke-width="4" fill="none"/></svg>`,
    steps: [
      {
        instruction: "Step 1ï¼šè«‹åˆ—å‡ºä¹˜æ³•ç®—å¼",
        speech: "ç¬¬ä¸€æ­¥ï¼šè«‹åˆ—å‡ºä¹˜æ³•ç®—å¼",
        slots: [
          { type:'slot', answer: a.toString() },
          { type:'slot', answer: 'Ã—' },
          { type:'slot', answer: b.toString() },
          { type:'text', text: ' = ?' }
        ],
        options: shuf([a.toString(), b.toString(), 'Ã—', '+', (a + 0.1).toFixed(1)]),
        hint: "æ±‚å…¨éƒ¨çš„é•·åº¦ï¼šåšä¸€å€‹éœ€è¦çš„é•·åº¦ Ã— å½©çƒæ•¸é‡ã€‚",
        remedial: [
          { q:`åš1å€‹éœ€è¦ 0.5 å…¬å°ºï¼Œåš 2 å€‹æ€éº¼åˆ—å¼ï¼Ÿ`, options: shuf([`0.5 Ã— 2`,`0.5 + 2`]), ans:`0.5 Ã— 2` },
          { q:`åš1å€‹éœ€è¦ 0.8 å…¬å°ºï¼Œåš 3 å€‹æ€éº¼åˆ—å¼ï¼Ÿ`, options: shuf([`0.8 Ã— 3`,`0.8 + 3`]), ans:`0.8 Ã— 3` }
        ]
      },
      {
        instruction: `Step 2ï¼šæƒ³æƒ³çœ‹ï¼Œ${a} æ˜¯å¹¾å€‹ 0.1ï¼Ÿ`,
        speech: `ç¬¬äºŒæ­¥ï¼šæƒ³æƒ³çœ‹ï¼Œ${a} æ˜¯å¹¾å€‹ 0.1ï¼Ÿ`,
        slots: [
          { type:'text', text: `${a} æ˜¯ ` },
          { type:'slot', answer: ans1.toString() },
          { type:'text', text: ` å€‹ 0.1` }
        ],
        options: shuf([ans1.toString(), (ans1*10).toString(), '1', a.toString()]),
        hint: "æŠŠå°æ•¸é»æ‹¿æ‰ï¼Œå°±çŸ¥é“æ˜¯å¹¾å€‹ 0.1ã€‚",
        remedial: [
          { q:`0.3 æ˜¯å¹¾å€‹ 0.1ï¼Ÿ`, options: shuf(['3','30']), ans:'3' },
          { q:`0.7 æ˜¯å¹¾å€‹ 0.1ï¼Ÿ`, options: shuf(['7','70']), ans:'7' }
        ]
      },
      {
        instruction: `Step 3ï¼šåš ${b} å€‹å½©çƒæ˜¯å¹¾å€‹ 0.1 å‘¢ï¼Ÿ`,
        speech: `ç¬¬ä¸‰æ­¥ï¼šåš ${b} å€‹å½©çƒæ˜¯å¹¾å€‹ 0.1 å‘¢ï¼Ÿ`,
        slots: [
          { type:'text', text: `${ans1} å€‹ 0.1 çš„ ${b} å€æ˜¯ ` },
          { type:'slot', answer: ans2.toString() },
          { type:'text', text: ` å€‹ 0.1` }
        ],
        options: shuf([ans2.toString(), (ans1+b).toString(), (ans2/10).toString(), '10']),
        hint: `æ•´æ•¸ä¹˜æ³•ï¼š${ans1} Ã— ${b}ã€‚`,
        remedial: [
          { q:`2 å€‹ 0.1 çš„ 3 å€æ˜¯å¹¾å€‹ 0.1ï¼Ÿ`, options: shuf(['6','5']), ans:'6' },
          { q:`4 å€‹ 0.1 çš„ 5 å€æ˜¯å¹¾å€‹ 0.1ï¼Ÿ`, options: shuf(['20','9']), ans:'20' }
        ]
      },
      {
        instruction: `Step 4ï¼šæ›ç®—æˆå°æ•¸æ˜¯å¤šå°‘å…¬å°ºï¼Ÿ`,
        speech: `ç¬¬å››æ­¥ï¼šæ›ç®—æˆå°æ•¸æ˜¯å¤šå°‘å…¬å°ºï¼Ÿ`,
        slots: [
          { type:'text', text: `${ans2} å€‹ 0.1 åˆèµ·ä¾†æ˜¯ ` },
          { type:'slot', answer: finalAns.toString() },
          { type:'text', text: ` å…¬å°º` }
        ],
        options: shuf([finalAns.toString(), ans2.toString(), (ans2*10).toString(), `0.${ans2}`]),
        hint: "å¹¾å€‹ 0.1 å°±é™¤ä»¥ 10ï¼ˆå°æ•¸é»å¾€å·¦ç§» 1 ä½ï¼‰ã€‚",
        remedial: [
          { q:`15 å€‹ 0.1 åˆèµ·ä¾†æ˜¯å¤šå°‘ï¼Ÿ`, options: shuf(['1.5','15']), ans:'1.5' },
          { q:`32 å€‹ 0.1 åˆèµ·ä¾†æ˜¯å¤šå°‘ï¼Ÿ`, options: shuf(['3.2','32']), ans:'3.2' }
        ]
      }
    ],
    finalAnswer: finalAns
  };
}

function genQ2(){
  const a_int = Math.floor(Math.random() * 9) + 1; // 1~9
  const a = a_int / 100;                            // 0.01~0.09
  const b = Math.floor(Math.random() * 5) + 4;      // 4~8
  const ans1 = a_int;
  const ans2 = ans1 * b;
  const finalAns = (ans2 / 100).toFixed(2);

  return {
    title: "æŒ‘æˆ°äºŒï¼šäºŒä½å°æ•¸",
    text: `ä¸€ç½è²“å’ªç½é ­é‡ <mark>${a.toFixed(2)}</mark> å…¬æ–¤ï¼Œè²·äº† <mark>${b}</mark> ç½ï¼Œå…±é‡å¤šå°‘å…¬æ–¤ï¼Ÿ`,
    speechText: `ä¸€ç½è²“å’ªç½é ­é‡ ${a.toFixed(2)} å…¬æ–¤ï¼Œè²·äº† ${b} ç½ï¼Œå…±é‡å¤šå°‘å…¬æ–¤ï¼Ÿ`,
    svg: `<svg viewBox="0 0 100 100" class="w-full max-w-[160px] mx-auto drop-shadow-md my-4"><rect x="20" y="30" width="60" height="50" rx="5" fill="#d1d5db" stroke="#6b7280" stroke-width="4"/><path d="M 20 45 L 80 45 M 20 60 L 80 60" stroke="#9ca3af" stroke-width="2"/><ellipse cx="50" cy="30" rx="30" ry="10" fill="#e5e7eb" stroke="#6b7280" stroke-width="4"/></svg>`,
    steps: [
      {
        instruction:"Step 1ï¼šè«‹åˆ—å‡ºä¹˜æ³•ç®—å¼",
        speech:"ç¬¬ä¸€æ­¥ï¼šè«‹åˆ—å‡ºä¹˜æ³•ç®—å¼",
        slots:[
          {type:'slot', answer:a.toFixed(2)},
          {type:'slot', answer:'Ã—'},
          {type:'slot', answer:b.toString()},
          {type:'text', text:' = ?'}
        ],
        options: shuf([a.toFixed(2), b.toString(), 'Ã—', '+', (a + 0.01).toFixed(2)]),
        hint:"æ±‚ç¸½é‡é‡ï¼šå–®ä¸€é‡é‡ Ã— æ•¸é‡ã€‚",
        remedial:[
          { q:`1ç½é‡ 0.05 å…¬æ–¤ï¼Œè²· 3 ç½æ€éº¼åˆ—å¼ï¼Ÿ`, options: shuf([`0.05 Ã— 3`,`0.05 + 3`]), ans:`0.05 Ã— 3` },
          { q:`1ç½é‡ 0.02 å…¬æ–¤ï¼Œè²· 6 ç½æ€éº¼åˆ—å¼ï¼Ÿ`, options: shuf([`0.02 Ã— 6`,`0.02 + 6`]), ans:`0.02 Ã— 6` }
        ]
      },
      {
        instruction:`Step 2ï¼š${a.toFixed(2)} æ˜¯å¹¾å€‹ 0.01ï¼Ÿ`,
        speech:`ç¬¬äºŒæ­¥ï¼š${a.toFixed(2)} æ˜¯å¹¾å€‹ 0.01ï¼Ÿ`,
        slots:[
          {type:'text', text:`${a.toFixed(2)} æ˜¯ `},
          {type:'slot', answer:ans1.toString()},
          {type:'text', text:` å€‹ 0.01`}
        ],
        options: shuf([ans1.toString(), (ans1*10).toString(), '10', a.toFixed(2)]),
        hint:"0.05 å°±æ˜¯ 5 å€‹ 0.01ã€‚",
        remedial:[
          { q:`0.04 æ˜¯å¹¾å€‹ 0.01ï¼Ÿ`, options: shuf(['4','40']), ans:'4' },
          { q:`0.09 æ˜¯å¹¾å€‹ 0.01ï¼Ÿ`, options: shuf(['9','90']), ans:'9' }
        ]
      },
      {
        instruction:`Step 3ï¼šè²· ${b} ç½æ˜¯å¹¾å€‹ 0.01ï¼Ÿ`,
        speech:`ç¬¬ä¸‰æ­¥ï¼šè²· ${b} ç½æ˜¯å¹¾å€‹ 0.01ï¼Ÿ`,
        slots:[
          {type:'text', text:`${ans1} å€‹ 0.01 çš„ ${b} å€æ˜¯ `},
          {type:'slot', answer:ans2.toString()},
          {type:'text', text:` å€‹ 0.01`}
        ],
        options: shuf([ans2.toString(), (ans1+b).toString(), (ans2*10).toString(), '100']),
        hint:`æ•´æ•¸ä¹˜æ³•ï¼š${ans1} Ã— ${b}ã€‚`,
        remedial:[
          { q:`3 å€‹ 0.01 çš„ 4 å€æ˜¯å¹¾å€‹ 0.01ï¼Ÿ`, options: shuf(['12','7']), ans:'12' },
          { q:`6 å€‹ 0.01 çš„ 5 å€æ˜¯å¹¾å€‹ 0.01ï¼Ÿ`, options: shuf(['30','11']), ans:'30' }
        ]
      },
      {
        instruction:`Step 4ï¼šæ›ç®—æˆå°æ•¸æ˜¯å¤šå°‘å…¬æ–¤ï¼Ÿ`,
        speech:`ç¬¬å››æ­¥ï¼šæ›ç®—æˆå°æ•¸æ˜¯å¤šå°‘å…¬æ–¤ï¼Ÿ`,
        slots:[
          {type:'text', text:`${ans2} å€‹ 0.01 åˆèµ·ä¾†æ˜¯ `},
          {type:'slot', answer:finalAns.toString()},
          {type:'text', text:` å…¬æ–¤`}
        ],
        options: shuf([finalAns.toString(), ans2.toString(), (ans2/10).toString(), `0.${ans2}`]),
        hint:"å¹¾å€‹ 0.01 å°±é™¤ä»¥ 100ï¼ˆå°æ•¸é»å¾€å·¦ç§» 2 ä½ï¼‰ã€‚",
        remedial:[
          { q:`25 å€‹ 0.01 åˆèµ·ä¾†æ˜¯å¤šå°‘ï¼Ÿ`, options: shuf(['0.25','2.5']), ans:'0.25' },
          { q:`48 å€‹ 0.01 åˆèµ·ä¾†æ˜¯å¤šå°‘ï¼Ÿ`, options: shuf(['0.48','4.8']), ans:'0.48' }
        ]
      }
    ],
    finalAnswer: finalAns
  };
}

function genQ3(){
  const a_int = Math.floor(Math.random() * 50) + 150; // 15.0~19.9
  const b_int = Math.floor(Math.random() * 50) + 50;  // 5.0~9.9
  const a = a_int / 10;
  const b = b_int / 10;

  // ç¢ºä¿ diff > 0ï¼ˆé¿å…ã€Œå¤§æ°´ç®¡æ¯”å°æ°´ç®¡å°‘ã€é€ æˆæ–‡å­—çŸ›ç›¾ï¼‰
  const A = Math.max(a, b);
  const B = Math.min(a, b);

  const diff = Math.round((A - B) * 10) / 10;
  const c = Math.floor(Math.random() * 4) + 2; // 2~5
  const finalAns = Math.round(diff * c * 10) / 10;

  return {
    title: "æŒ‘æˆ°ä¸‰ï¼šå…©æ­¥é©Ÿç¶œåˆ",
    text: `å¤§æ°´ç®¡æ¯åˆ†é˜æ³¨æ°´ <mark>${A.toFixed(1)}</mark> å…¬å‡ï¼Œå°æ°´ç®¡æ¯åˆ†é˜æ³¨æ°´ <mark>${B.toFixed(1)}</mark> å…¬å‡ã€‚åŒæ™‚æ³¨æ°´ <mark>${c}</mark> åˆ†é˜å¾Œï¼Œå¤§æ°´ç®¡æ¯”å°æ°´ç®¡<b>å¤š</b>æ³¨å…¥å¹¾å…¬å‡çš„æ°´ï¼Ÿ`,
    speechText: `å¤§æ°´ç®¡æ¯åˆ†é˜æ³¨æ°´ ${A.toFixed(1)} å…¬å‡ï¼Œå°æ°´ç®¡æ¯åˆ†é˜æ³¨æ°´ ${B.toFixed(1)} å…¬å‡ã€‚åŒæ™‚æ³¨æ°´ ${c} åˆ†é˜å¾Œï¼Œå¤§æ°´ç®¡æ¯”å°æ°´ç®¡å¤šæ³¨å…¥å¹¾å…¬å‡çš„æ°´ï¼Ÿ`,
    svg: `<svg viewBox="0 0 100 100" class="w-full max-w-[160px] mx-auto drop-shadow-md my-4"><path d="M 10 40 Q 50 40 50 80 M 90 60 Q 50 60 50 80" stroke="#3b82f6" stroke-width="8" fill="none" stroke-linecap="round"/><ellipse cx="50" cy="85" rx="30" ry="10" fill="#93c5fd"/><ellipse cx="50" cy="90" rx="40" ry="10" fill="none" stroke="#60a5fa" stroke-width="4"/></svg>`,
    steps: [
      {
        instruction:"Step 1ï¼šå…ˆç®—å¤§æ°´ç®¡ 1 åˆ†é˜æ¯”å°æ°´ç®¡å¤šæ³¨æ°´å¹¾å…¬å‡ï¼Ÿ",
        speech:"ç¬¬ä¸€æ­¥ï¼šå…ˆç®—å¤§æ°´ç®¡ä¸€åˆ†é˜æ¯”å°æ°´ç®¡å¤šæ³¨æ°´å¹¾å…¬å‡ï¼Ÿ",
        slots:[
          {type:'slot', answer:A.toFixed(1)},
          {type:'slot', answer:'-'},
          {type:'slot', answer:B.toFixed(1)},
          {type:'text', text:' = '},
          {type:'slot', answer:diff.toFixed(1)},
          {type:'text', text:' å…¬å‡'}
        ],
        options: shuf([A.toFixed(1), B.toFixed(1), '-', '+', diff.toFixed(1), (diff+1).toFixed(1)]),
        hint:"è¦ç®—ã€Œå¤šã€å¤šå°‘ï¼šå¤§æ°´ç®¡ âˆ’ å°æ°´ç®¡ã€‚",
        remedial:[
          { q:`å“¥å“¥æœ‰ 15.5 å…ƒï¼Œå¼Ÿå¼Ÿæœ‰ 5.2 å…ƒï¼Œå“¥å“¥æ¯”å¼Ÿå¼Ÿå¤šå¹¾å…ƒï¼Ÿ`, options: shuf([`15.5 - 5.2`,`15.5 + 5.2`]), ans:`15.5 - 5.2` },
          { q:`ç´…ç¹©é•· 8.8 å…¬å°ºï¼Œè—ç¹©é•· 3.4 å…¬å°ºï¼Œç´…ç¹©æ¯”è—ç¹©å¤šå¹¾å…¬å°ºï¼Ÿ`, options: shuf([`8.8 - 3.4`,`8.8 + 3.4`]), ans:`8.8 - 3.4` }
        ]
      },
      {
        instruction:`Step 2ï¼šå†ç®— ${c} åˆ†é˜å…±ç›¸å·®å¹¾å…¬å‡ï¼Ÿ`,
        speech:`ç¬¬äºŒæ­¥ï¼šå†ç®— ${c} åˆ†é˜å…±ç›¸å·®å¹¾å…¬å‡ï¼Ÿ`,
        slots:[
          {type:'text', text:'ç›¸å·® '},
          {type:'slot', answer:diff.toFixed(1)},
          {type:'slot', answer:'Ã—'},
          {type:'slot', answer:c.toString()},
          {type:'text', text:' = '},
          {type:'slot', answer:finalAns.toFixed(1)},
          {type:'text', text:' å…¬å‡'}
        ],
        options: shuf([diff.toFixed(1), 'Ã—', c.toString(), finalAns.toFixed(1), (finalAns+1).toFixed(1), '+']),
        hint:"æ¯åˆ†é˜ç›¸å·® Ã— åˆ†é˜æ•¸ã€‚",
        remedial:[
          { q:`æ¯åˆ†é˜å¤š 1.2 å…¬å‡ï¼Œ3 åˆ†é˜å¤šå¹¾å…¬å‡ï¼Ÿ`, options: shuf([`1.2 Ã— 3`,`1.2 + 3`]), ans:`1.2 Ã— 3` },
          { q:`æ¯åˆ†é˜å¤š 0.7 å…¬å‡ï¼Œ4 åˆ†é˜å¤šå¹¾å…¬å‡ï¼Ÿ`, options: shuf([`0.7 Ã— 4`,`0.7 + 4`]), ans:`0.7 Ã— 4` }
        ]
      }
    ],
    finalAnswer: finalAns.toFixed(1)
  };
}

function buildQuestionsOnce(){
  return [genQ1(), genQ2(), genQ3()];
}

/* ===============================
   ç‹€æ…‹ï¼ˆåˆ†æ•¸å¯ä¿ç•™ï¼Œé¡Œç›®æ¯æ¬¡é–‹å•Ÿéƒ½æ–°ï¼‰
================================ */
const LS_KEY = "dec_mul_tool_v2";
let QUESTIONS = [];
let STATE = { score: 0, qIndex: 0, stepIndex: 0 };
let selectedSlotId = null;

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      const j = JSON.parse(raw);
      STATE.score = Number(j.score || 0);
    }
  }catch(_){}
}
function saveState(){
  try{
    localStorage.setItem(LS_KEY, JSON.stringify({ score: STATE.score }));
  }catch(_){}
}

/* ===============================
   æ¸²æŸ“
================================ */
function render(){
  const app = document.getElementById("app");
  const q = QUESTIONS[STATE.qIndex];
  const step = q.steps[STATE.stepIndex];
  const progress = `${STATE.qIndex + 1}/${QUESTIONS.length}ï½œStep ${STATE.stepIndex + 1}/${q.steps.length}`;

  app.innerHTML = `
  <header class="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center gap-3">
      <div class="text-2xl font-black text-blue-600">ğŸ§® å°æ•¸ä¹˜æ³•äº’å‹•è§£é¡Œ</div>
      <div class="ml-auto flex items-center gap-3">
        <button id="btnNewSet" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-black">ğŸ” é‡æ–°å‡ºé¡Œ</button>
        <button id="btnSpeak" class="px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 font-black">ğŸ”Š é¡Œç›®æœ—è®€</button>
        <div class="px-4 py-2 rounded-full bg-yellow-100 border-2 border-yellow-300 font-black">
          â­ ç©åˆ† <span id="score">${STATE.score}</span>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pt-6 grid md:grid-cols-5 gap-6">
    <section class="md:col-span-2 bg-white rounded-[2rem] p-6 border-2 border-slate-200 shadow-sm">
      <div class="flex items-center gap-3 mb-3">
        <span class="px-3 py-1.5 rounded-full bg-blue-100 border border-blue-200 text-blue-700 font-black">${escHtml(q.title)}</span>
        <span class="text-slate-500 font-black">${escHtml(progress)}</span>
      </div>
      <div class="text-xl font-bold leading-relaxed text-slate-800">${q.text}</div>
      ${q.svg}
      <div class="mt-4 bg-slate-50 border-2 border-slate-200 rounded-2xl p-4">
        <div class="font-black text-slate-600 mb-1">ğŸ’¡ æç¤º</div>
        <div class="font-bold text-slate-700">${escHtml(step.hint)}</div>
      </div>
      <div class="mt-4 flex gap-3">
        <button id="btnResetStep" class="flex-1 py-3 rounded-2xl bg-white hover:bg-slate-50 border-2 border-slate-200 font-black">æ¸…é™¤æœ¬æ­¥</button>
        <button id="btnCheck" class="flex-1 py-3 rounded-2xl bg-blue-600 hover:bg-blue-700 text-white font-black">æª¢æŸ¥ âœ</button>
      </div>
    </section>

    <section class="md:col-span-3 bg-white rounded-[2rem] p-6 border-2 border-slate-200 shadow-sm">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 rounded-full bg-blue-600 text-white font-black flex items-center justify-center">${STATE.stepIndex + 1}</div>
        <div class="text-2xl font-black text-slate-800">${escHtml(step.instruction)}</div>
        <button id="btnSpeakStep" class="ml-auto px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 font-black">ğŸ”Š æœ—è®€æ­¥é©Ÿ</button>
      </div>

      <div class="bg-slate-50 border-2 border-slate-200 rounded-[2rem] p-6 overflow-x-auto no-scrollbar">
        <div class="math" id="mathRow">
          ${renderSlots(step.slots)}
        </div>
        <div class="text-sm text-slate-500 font-bold mt-3">ğŸ‘‰ é»æ¡†æ¡†é¸å–ï¼Œå†é»é¸ä¸‹æ–¹é¸é …å¡«å…¥ï¼›é»å·²å¡«å…§å®¹å¯æ¸…é™¤ã€‚</div>
      </div>

      <div class="mt-6">
        <div class="font-black text-slate-600 mb-3">ğŸ§© é¸é …</div>
        <div class="flex flex-wrap gap-3" id="options">
          ${step.options.map(o => `<button class="opt-btn" data-opt="${escHtml(o)}">${escHtml(o)}</button>`).join('')}
        </div>
      </div>

      <div class="mt-6">
        <details class="bg-white border-2 border-slate-200 rounded-2xl p-4">
          <summary class="font-black text-slate-700 cursor-pointer">ğŸ§¯ è£œæ•‘å°é¡Œï¼ˆç­”éŒ¯æ™‚å»ºè­°å…ˆåšé€™è£¡ï¼‰</summary>
          <div class="mt-3 space-y-4">
            ${renderRemedial(step.remedial || [])}
          </div>
        </details>
      </div>
    </section>
  </main>

  <footer class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur border-t border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <button id="btnPrevQ" class="px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 font-black">â† ä¸Šä¸€é¡Œ</button>
      <button id="btnNextQ" class="px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 font-black">ä¸‹ä¸€é¡Œ â†’</button>
      <div class="ml-auto text-slate-500 font-black">ï¼ˆå·²å•Ÿç”¨ï¼šæ¯æ¬¡é–‹å•Ÿé é¢é‡æ–°å‡ºé¡Œï¼‰</div>
    </div>
  </footer>
  `;
}

function renderSlots(slots){
  let html = '';
  let slotCounter = 0;
  for(const s of slots){
    if(s.type === 'text'){
      html += `<span class="font-black text-slate-700">${escHtml(s.text)}</span>`;
    }else{
      const id = `slot-${STATE.qIndex}-${STATE.stepIndex}-${slotCounter++}`;
      html += `<span class="slot" data-slot-id="${id}" data-answer="${escHtml(s.answer)}" aria-label="slot"></span>`;
    }
  }
  return html;
}

function renderRemedial(remedial){
  if(!remedial.length) return `<div class="text-slate-500 font-bold">ï¼ˆæ­¤æ­¥é©Ÿæ²’æœ‰è£œæ•‘é¡Œï¼‰</div>`;
  return remedial.map((r, idx) => {
    const rid = `rem-${STATE.qIndex}-${STATE.stepIndex}-${idx}`;
    return `
      <div class="bg-slate-50 border-2 border-slate-200 rounded-2xl p-4">
        <div class="font-black text-slate-800 mb-3">Q${idx+1}. ${escHtml(r.q)}</div>
        <div class="flex flex-wrap gap-3">
          ${r.options.map(opt => `<button class="opt-btn" data-rem="${rid}" data-rem-opt="${escHtml(opt)}">${escHtml(opt)}</button>`).join('')}
        </div>
        <div class="mt-3 font-bold text-slate-600 hidden" data-rem-msg="${rid}"></div>
        <div class="hidden" data-rem-ans="${rid}">${escHtml(r.ans)}</div>
      </div>
    `;
  }).join('');
}

/* ===============================
   ä½œç­”äº’å‹•
================================ */
function clearStepInputs(){
  selectedSlotId = null;
  document.querySelectorAll(".slot").forEach(s=>{
    s.textContent = "";
    s.classList.remove("selected","filled","correct","error");
  });
}

function checkStep(){
  const q = QUESTIONS[STATE.qIndex];
  const slots = Array.from(document.querySelectorAll(".slot"));
  if(!slots.length) return;

  let ok = true;

  for(const s of slots){
    if(!s.textContent.trim()){
      ok = false;
      s.classList.add("error");
    }
  }
  if(!ok){ playSound("error"); return; }

  slots.forEach(s=>{
    const ans = s.dataset.answer ?? "";
    const val = s.textContent.trim();
    if(val === ans){
      s.classList.remove("error");
      s.classList.add("correct");
    }else{
      ok = false;
      s.classList.add("error");
    }
  });

  if(ok){
    playSound("success");
    STATE.score += 20;
    saveState();

    if(STATE.stepIndex < q.steps.length - 1){
      STATE.stepIndex += 1;
      render();
    }else{
      openModal(`ä½ å®Œæˆã€Œ${q.title}ã€ï¼ç›®å‰ç¸½ç©åˆ†ï¼š${STATE.score}`);
    }
  }else{
    playSound("error");
  }
}

function openModal(text){
  const modal = document.getElementById("modal");
  document.getElementById("modalText").textContent = text;
  modal.classList.remove("hidden");
  modal.classList.add("flex");
}
function closeModal(){
  const modal = document.getElementById("modal");
  modal.classList.add("hidden");
  modal.classList.remove("flex");
}

/* âœ… é‡æ–°å‡ºé¡Œï¼ˆåŠ ç¢¼åŠŸèƒ½ï¼‰ */
function newQuestionSet(){
  // é‡æ–°ç”Ÿæˆé¡Œåº« + å›åˆ°ç¬¬ä¸€é¡Œç¬¬ä¸€æ­¥
  QUESTIONS = buildQuestionsOnce();
  STATE.qIndex = 0;
  STATE.stepIndex = 0;
  render();
}

/* ===============================
   äº‹ä»¶ä»£ç†
================================ */
document.addEventListener("click", (e)=>{
  if(!audioCtx) ensureAudio();
  const t = e.target;

  if(t.classList && t.classList.contains("slot")){
    playSound("pop");
    if(t.textContent.trim()){
      t.textContent = "";
      t.classList.remove("filled","correct","error","selected");
      return;
    }
    document.querySelectorAll(".slot").forEach(s=>s.classList.remove("selected"));
    t.classList.add("selected");
    selectedSlotId = t.dataset.slotId;
    return;
  }

  if(t.matches && t.matches(".opt-btn[data-opt]")){
    playSound("pop");
    const val = t.dataset.opt;
    const selected = document.querySelector(".slot.selected");
    const emptyFirst = Array.from(document.querySelectorAll(".slot")).find(s=>!s.textContent.trim());
    const target = selected || emptyFirst;
    if(target){
      target.textContent = val;
      target.classList.add("filled");
      target.classList.remove("selected","error");
      selectedSlotId = null;
    }
    return;
  }

  if(t.matches && t.matches(".opt-btn[data-rem]")){
    playSound("pop");
    const rid = t.dataset.rem;
    const opt = t.dataset.remOpt;
    const ans = document.querySelector(`[data-rem-ans="${rid}"]`)?.textContent ?? "";
    const msgEl = document.querySelector(`[data-rem-msg="${rid}"]`);
    if(!msgEl) return;

    msgEl.classList.remove("hidden");
    if(opt === ans){
      msgEl.textContent = "âœ… æ­£ç¢ºï¼å›åˆ°ä¸Šæ–¹å†è©¦ä¸€æ¬¡ã€‚";
      msgEl.classList.remove("text-red-600");
      msgEl.classList.add("text-green-700");
    }else{
      msgEl.textContent = "âŒ å†æƒ³æƒ³ï¼šæ˜¯è¦ç”¨å“ªå€‹é‹ç®—ï¼Ÿ";
      msgEl.classList.remove("text-green-700");
      msgEl.classList.add("text-red-600");
    }
    return;
  }

  if(t.id === "btnCheck"){ checkStep(); return; }
  if(t.id === "btnResetStep"){ clearStepInputs(); playSound("pop"); return; }

  if(t.id === "btnSpeak"){
    const q = QUESTIONS[STATE.qIndex];
    speak(q.speechText);
    return;
  }
  if(t.id === "btnSpeakStep"){
    const step = QUESTIONS[STATE.qIndex].steps[STATE.stepIndex];
    speak(step.speech);
    return;
  }

  if(t.id === "btnClose"){ closeModal(); return; }
  if(t.id === "btnNext"){
    closeModal();
    if(STATE.qIndex < QUESTIONS.length - 1){
      STATE.qIndex += 1;
      STATE.stepIndex = 0;
      render();
    }
    return;
  }

  if(t.id === "btnPrevQ"){
    if(STATE.qIndex > 0){
      STATE.qIndex -= 1;
      STATE.stepIndex = 0;
      render();
    }
    return;
  }
  if(t.id === "btnNextQ"){
    if(STATE.qIndex < QUESTIONS.length - 1){
      STATE.qIndex += 1;
      STATE.stepIndex = 0;
      render();
    }
    return;
  }

  if(t.id === "btnNewSet"){
    newQuestionSet();
    playSound("pop");
    return;
  }
});

/* ===============================
   é˜²ç™½ç•«é¢ï¼šæ•æ‰éŒ¯èª¤é¡¯ç¤º
================================ */
function showErr(err){
  const panel = document.getElementById("errPanel");
  const txt = document.getElementById("errText");
  panel.classList.remove("hidden");
  txt.textContent = String(err && err.stack ? err.stack : err);
}
window.addEventListener("error", (e)=> showErr(e.error || e.message || e));
window.addEventListener("unhandledrejection", (e)=> showErr(e.reason || e));

/* ===============================
   å•Ÿå‹•
================================ */
(function boot(){
  try{
    loadState();             // åˆ†æ•¸å¯ä¿ç•™ï¼ˆåªå­˜ scoreï¼‰
    QUESTIONS = buildQuestionsOnce(); // âœ… æ¯æ¬¡è¼‰å…¥éƒ½é‡æ–°ä½ˆé¡Œï¼ˆæœ¬æ¬¡å‡ç´šé‡é»ï¼‰
    render();
  }catch(err){
    showErr(err);
  }
})();
</script>
</body>
</html>
