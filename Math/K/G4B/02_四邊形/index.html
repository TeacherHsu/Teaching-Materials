<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>äº’å‹•å¼æ•¸å­¸è§£é¡Œå·¥å…·ï¼šå››é‚Šå½¢èˆ‡å‚ç›´å¹³è¡Œï¼ˆå‹•æ…‹å‡ºé¡Œç‰ˆï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ====== æ•¸å­¸èˆ‡ç‰¹æ®Šç‰ˆå‹ CSS ====== */
    .math { font-size: 24px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
    .fraction { display: inline-flex; flex-direction: column; align-items: center; line-height: 1.1; }
    .fraction span:first-child { border-bottom: 2px solid #000; padding: 0 4px; }
    .power { font-size: 16px; vertical-align: super; margin-left: 2px; color: #e63946; }
    .sqrt::before { content: "âˆš"; font-size: 24px; margin-right: 2px; }
    .abs::before { content: "|"; } .abs::after { content: "|"; }
    .mixed { display: inline-flex; align-items: center; gap: 2px; }

    /* ====== äº’å‹•å…ƒä»¶æ¨£å¼ ====== */
    .slot {
      display: inline-block;
      min-width: 60px;
      height: 40px;
      margin: 0 6px;
      border-bottom: 3px solid #cbd5e1;
      text-align: center;
      line-height: 38px;
      font-weight: bold;
      color: #2563eb;
      cursor: pointer;
      transition: all 0.2s ease;
      vertical-align: middle;
      background-color: #f8fafc;
      border-radius: 4px 4px 0 0;
      padding: 0 10px;
      user-select: none;
    }
    .slot.filled {
      border-bottom-color: #2563eb;
      background-color: #dbeafe;
    }
    .slot.done {
      border-bottom-color: #16a34a;
      color: #16a34a;
      background-color: #dcfce7;
      cursor: default;
    }
    .slot.error {
      border-bottom-color: #ef4444;
      background-color: #fee2e2;
      animation: shake 0.4s ease-in-out;
    }

    .option-btn {
      padding: 8px 16px;
      background-color: #f1f5f9;
      border: 2px solid #cbd5e1;
      border-radius: 9999px;
      font-size: 1.125rem;
      font-weight: 600;
      color: #334155;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      user-select: none;
    }
    .option-btn:hover:not(:disabled) {
      background-color: #e2e8f0;
      border-color: #94a3b8;
      transform: translateY(-1px);
    }
    .option-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* ====== é‡é»æ¨™è¨˜æ¨£å¼ ====== */
    mark {
      background-color: #fef08a;
      color: #1e3a8a;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: bold;
    }

    /* ====== å‹•ç•« ====== */
    @keyframes tada {
      0% { transform: scale(1); }
      10%, 20% { transform: scale(0.95) rotate(-2deg); }
      30%, 50%, 70%, 90% { transform: scale(1.05) rotate(2deg); }
      40%, 60%, 80% { transform: scale(1.05) rotate(-2deg); }
      100% { transform: scale(1) rotate(0); }
    }
    .animate-tada { animation: tada 0.8s; }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
    }

    @keyframes pop {
      0% { transform: scale(0.98); }
      40% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }
    .animate-pop { animation: pop 220ms ease-out; }

    /* ====== æ»¾å‹•æ¢ç¾åŒ– ====== */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* ====== Toast ====== */
    .toast-hidden { opacity: 0; transform: translate(-50%, 24px); pointer-events: none; }
    .toast-show { opacity: 1; transform: translate(-50%, 0); pointer-events: none; }

    /* ====== no-scrollbarï¼ˆnav tabsï¼‰ ====== */
    .no-scrollbar::-webkit-scrollbar{ display:none; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
  </style>
</head>

<body class="bg-slate-50 text-slate-800 font-sans min-h-screen flex flex-col">

  <!-- å°è¦½åˆ— -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16 gap-3">
        <div class="flex-shrink-0 flex items-center gap-2">
          <span class="text-xl font-bold text-blue-700 bg-blue-100 px-3 py-1 rounded-lg">å–®å…ƒï¼šå‚ç›´ã€å¹³è¡Œèˆ‡å››é‚Šå½¢</span>
        </div>

        <!-- å³å´ï¼šç©åˆ† + é€²åº¦ + æ•™å¸«æ¨¡å¼ -->
        <div class="flex items-center gap-3">
          <button id="teacher-toggle"
            class="px-3 py-2 rounded-xl border border-slate-200 bg-white text-slate-600 font-bold hover:bg-slate-50 transition-colors"
            title="æ•™å¸«æ¨¡å¼ï¼šå¯å¿«é€Ÿè§£é–/é‡ç½®">
            ğŸ§‘â€ğŸ« æ•™å¸«ï¼šOFF
          </button>

          <div class="flex items-center gap-2 bg-yellow-100 px-4 py-2 rounded-full border border-yellow-300 font-bold text-yellow-800 shadow-sm">
            â­ ç©åˆ†: <span id="total-score" class="text-xl">0</span>
          </div>

          <div class="flex items-center gap-2 bg-slate-50 px-3 py-2 rounded-full border border-slate-200">
            <svg width="34" height="34" viewBox="0 0 36 36" class="flex-none">
              <path
                d="M18 2.0845
                   a 15.9155 15.9155 0 0 1 0 31.831
                   a 15.9155 15.9155 0 0 1 0 -31.831"
                fill="none"
                stroke="#e2e8f0"
                stroke-width="3"
              />
              <path
                id="progress-ring"
                d="M18 2.0845
                   a 15.9155 15.9155 0 0 1 0 31.831
                   a 15.9155 15.9155 0 0 1 0 -31.831"
                fill="none"
                stroke="#3b82f6"
                stroke-width="3"
                stroke-linecap="round"
                stroke-dasharray="0, 100"
              />
            </svg>
            <div class="text-sm font-extrabold text-slate-700 leading-tight">
              <div>é€²åº¦ <span id="progress-text">0/0</span></div>
              <div class="text-[11px] text-slate-500 font-bold">å·²å®Œæˆé—œå¡</div>
            </div>
          </div>
        </div>
      </div>

      <div class="flex overflow-x-auto py-2 space-x-2 border-t no-scrollbar" id="nav-tabs"></div>
    </div>
  </header>

  <!-- å…§å®¹å€ï¼šå·¦å³åˆ†æ¬„ -->
  <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-6 flex flex-col md:flex-row gap-6">

    <!-- å·¦å´ï¼šé¡Œå¹¹èˆ‡åœ–å½¢ -->
    <section class="md:w-5/12 lg:w-1/3 flex-shrink-0">
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:sticky md:top-24">
        <div class="flex items-start justify-between mb-2 gap-2">
          <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2" id="q-title"></h2>
          <button id="tts-main-btn"
            class="p-2 bg-blue-50 text-blue-600 rounded-full hover:bg-blue-100 transition-colors"
            title="æœ—è®€é¡Œç›®">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M18.364 5.636a9 9 0 010 12.728M11 5L6 9H2v6h4l5 4V5z" />
            </svg>
          </button>
        </div>

        <div class="flex items-center justify-between mb-4">
          <div class="text-sm font-extrabold text-slate-600 bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl">
            æœ¬é—œå¡æ­¥é©Ÿï¼š<span id="step-progress">0/0</span>
          </div>

          <button id="reset-question-btn"
            class="text-sm font-extrabold text-red-600 bg-red-50 border border-red-200 px-3 py-2 rounded-xl hover:bg-red-100 transition-colors">
            é‡åšæœ¬é—œå¡
          </button>
        </div>

        <div class="text-lg leading-relaxed mb-6" id="q-text"></div>
        <div class="bg-slate-50 rounded-xl p-4 flex justify-center border border-slate-100" id="q-svg"></div>

        <!-- æ•™å¸«æ¨¡å¼å·¥å…·åˆ— -->
        <div id="teacher-tools" class="mt-5 hidden">
          <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
            <div class="text-slate-700 font-extrabold mb-3 flex items-center gap-2">ğŸ§‘â€ğŸ« æ•™å¸«å·¥å…·</div>
            <div class="flex flex-col gap-3">
              <button id="unlock-all-btn" class="w-full px-4 py-3 rounded-xl bg-blue-600 text-white font-extrabold hover:bg-blue-700 transition-colors">
                ä¸€éµè§£é–æœ¬é—œå¡æ‰€æœ‰æ­¥é©Ÿ
              </button>
              <button id="reset-all-btn" class="w-full px-4 py-3 rounded-xl bg-slate-700 text-white font-extrabold hover:bg-slate-800 transition-colors">
                é‡ç½®å…¨éƒ¨é—œå¡é€²åº¦ï¼ˆå«åˆ†æ•¸ï¼‰
              </button>
              <div class="text-xs text-slate-500 font-bold leading-relaxed">
                * æ•™å¸«å·¥å…·æœƒåŒæ­¥å¯«å…¥ç€è¦½å™¨å­˜æª”ï¼ˆlocalStorageï¼‰
              </div>
              <button id="new-set-btn" class="w-full px-4 py-3 rounded-xl bg-emerald-600 text-white font-extrabold hover:bg-emerald-700 transition-colors">
                ğŸ” ç”¢ç”Ÿä¸€å¥—æ–°é¡Œç›®ï¼ˆæœ¬æ¬¡åˆ†é ï¼‰
              </button>
              <div class="text-xs text-slate-500 font-bold leading-relaxed">
                * ç”¢ç”Ÿæ–°é¡Œç›®æœƒé‡ç½®å…¨éƒ¨é€²åº¦ï¼ˆé¿å…é¡Œåº«/å­˜æª”å°ä¸ä¸Šï¼‰
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- å³å´ï¼šæ­¥é©Ÿè§£é–å€ -->
    <section class="md:w-7/12 lg:w-2/3 flex flex-col gap-6" id="steps-container"></section>
  </main>

  <!-- å®Œæˆè¦–çª— Modal -->
  <div id="completion-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center">
    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeModal()"></div>
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full relative z-10 text-center transform scale-95 opacity-0 transition-all duration-300" id="modal-content">
      <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-10 h-10 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      <h3 class="text-3xl font-bold text-slate-800 mb-2">å¤ªæ£’äº†ï¼éé—œï¼</h3>
      <p class="text-slate-500 text-lg mb-2">ä½ å·²ç¶“å®Œç¾å­¸æœƒäº†é€™å€‹æ¦‚å¿µå–”ï¼</p>
      <p class="text-slate-700 font-extrabold text-xl mb-6">ç›®å‰ç¸½ç©åˆ†ï¼š<span id="modal-score">0</span></p>
      <div class="flex flex-col sm:flex-row gap-3 justify-center">
        <button onclick="resetCurrentQuestion()" class="px-6 py-3 bg-blue-100 text-blue-700 font-bold rounded-xl hover:bg-blue-200 transition-colors">å†åšä¸€æ¬¡</button>
        <button onclick="closeModal()" class="px-6 py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition-colors shadow-lg shadow-green-200">ç¹¼çºŒæŒ‘æˆ°</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast"
       class="fixed left-1/2 bottom-8 z-[200] bg-white border border-slate-200 shadow-2xl rounded-2xl px-5 py-4 w-[min(520px,calc(100vw-32px))] transition-all duration-300 toast-hidden">
    <div class="flex items-start gap-3">
      <div id="toast-emoji" class="text-2xl flex-none">ğŸ’¡</div>
      <div class="min-w-0">
        <div id="toast-title" class="font-extrabold text-slate-800 text-lg mb-0.5">æç¤º</div>
        <div id="toast-msg" class="text-slate-600 font-bold leading-relaxed break-words">å…§å®¹</div>
      </div>
    </div>
  </div>

  <script>
    /* ===========================
      å‹•æ…‹å‡ºé¡Œæ ¸å¿ƒï¼ˆseed + å¯é‡å»ºï¼‰
      - åŒä¸€åˆ†é  refreshï¼šç¶­æŒåŒä¸€å¥—é¡Œç›®ï¼ˆsessionStorage seedï¼‰
      - æ–°é–‹åˆ†é  / é—œæ‰é‡é–‹ï¼šæ–°çš„ seed â†’ æ–°é¡Œç›®ç‰ˆæœ¬
    =========================== */

    const STORAGE_KEY = 'quad_parallel_tool_v4';   // v4ï¼šå« seed
    const SESSION_SEED_KEY = 'quad_parallel_seed_v1';

    // --- PRNGï¼šmulberry32 ---
    function mulberry32(seed) {
      let t = seed >>> 0;
      return function() {
        t += 0x6D2B79F5;
        let r = Math.imul(t ^ (t >>> 15), 1 | t);
        r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
        return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
      };
    }

    function randInt(rng, min, max) {
      return Math.floor(rng() * (max - min + 1)) + min;
    }

    function shuffleWithRng(arr, rng) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function pick(rng, arr) {
      return arr[Math.floor(rng() * arr.length)];
    }

    function escapeForJS(str) {
      return (str || '')
        .replaceAll('\\', '\\\\')
        .replaceAll("'", "\\'")
        .replaceAll('\n', ' ')
        .replaceAll('\r', ' ');
    }

    function stripHtml(html) {
      return (html || '').replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
    }

    // === ç”¢ç”Ÿæœ¬æ¬¡ seedï¼ˆåŒä¸€åˆ†é å›ºå®šï¼›æ–°é–‹åˆ†é ä¸åŒï¼‰ ===
    function getOrCreateSessionSeed() {
      const raw = sessionStorage.getItem(SESSION_SEED_KEY);
      if (raw && /^\d+$/.test(raw)) return Number(raw);
      // ä½¿ç”¨ crypto éš¨æ©Ÿ + time æ··åˆ
      let x = Date.now() ^ (Math.floor(Math.random() * 1e9));
      try {
        const u = new Uint32Array(1);
        crypto.getRandomValues(u);
        x ^= u[0];
      } catch (_) {}
      const seed = (x >>> 0);
      sessionStorage.setItem(SESSION_SEED_KEY, String(seed));
      return seed;
    }

    // === ç”Ÿæˆé¡Œåº«ï¼ˆåŒä¸€ seed å¯é‡å»ºï¼šä¿æŒå­˜æª”ä¸€è‡´ï¼‰ ===
    function buildQuizData(seed) {
      const rng = mulberry32(seed);

      // è®“ã€Œé¡Œå¹¹ã€æœ‰å°è®ŠåŒ–ï¼ˆä¸å½±éŸ¿æ¦‚å¿µï¼Œä½†è®“å­¸ç”Ÿä¸æ˜“èƒŒæ•´å¥ï¼‰
      const lineLabelSets = [
        { a: 'ç”²ç·š', b: 'ä¹™ç·š' },
        { a: 'A ç·š', b: 'B ç·š' },
        { a: 'è—ç·š', b: 'ç¶ ç·š' }
      ];
      const L = pick(rng, lineLabelSets);

      // options æ´—ç‰Œï¼ˆæ¯æ¬¡ä¸åŒã€ŒæŒ‰éˆ•ä½ç½®ã€ï¼‰
      const sh = (opts) => shuffleWithRng(opts, rng);

      // æ³¨æ„ï¼šæœ¬å·¥å…·æ˜¯æ¦‚å¿µé¡Œï¼Œæ­£ç¢ºç­”æ¡ˆæœ¬è³ªå›ºå®š
      return [
        {
          id: 'q1',
          title: 'é—œå¡ 1ï¼šå‚ç›´',
          text: `è§€å¯Ÿä¸‹åœ–ï¼Œ${L.a}å’Œ${L.b}ç›¸äº¤ï¼Œå½¢æˆäº†ä¸€å€‹ç‰¹åˆ¥çš„å¤¾è§’ã€‚<br><br>ç•¶å…©æ¢ç›´ç·šç›¸äº¤æˆã€Œ<mark>ç›´è§’</mark>ã€æ™‚ï¼Œæˆ‘å€‘èªªé€™å…©æ¢ç›´ç·šäº’ç›¸ã€Œ<mark>å‚ç›´</mark>ã€ã€‚`,
          textVoice: `è§€å¯Ÿä¸‹åœ–ï¼Œ${L.a}å’Œ${L.b}ç›¸äº¤ã€‚ç•¶å…©æ¢ç›´ç·šç›¸äº¤æˆç›´è§’æ™‚ï¼Œæˆ‘å€‘èªªé€™å…©æ¢ç›´ç·šäº’ç›¸å‚ç›´ã€‚`,
          svg: `
            <svg viewBox="0 0 100 100" class="w-full max-w-[200px] h-auto">
              <line x1="20" y1="50" x2="80" y2="50" stroke="#3b82f6" stroke-width="4" stroke-linecap="round"/>
              <line x1="50" y1="20" x2="50" y2="80" stroke="#22c55e" stroke-width="4" stroke-linecap="round"/>
              <rect x="50" y="30" width="20" height="20" fill="none" stroke="#ef4444" stroke-width="2"/>
              <text x="85" y="55" font-size="10" font-weight="bold" fill="#3b82f6">${L.a}</text>
              <text x="45" y="15" font-size="10" font-weight="bold" fill="#22c55e">${L.b}</text>
            </svg>
          `,
          steps: [
            {
              subQs: [
                { type: 'main', instruction: `å…©æ¢ç›´ç·šç›¸äº¤å½¢æˆçš„å¤¾è§’æ˜¯ __ åº¦ï¼Œæˆ‘å€‘ç¨±é€™å€‹è§’ç‚º __ è§’ã€‚`, options: sh(['90','180','ç›´','å¹³']), answers: ['90','ç›´'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šçœ‹åˆ°æ­£æ–¹å½¢çš„ç´…è‰²è¨˜è™Ÿï¼Œä»£è¡¨é€™æ˜¯90åº¦çš„ç›´è§’å–”ï¼', instruction: 'ä¸€å€‹ç›´è§’çš„åº¦æ•¸æ˜¯ __ åº¦ã€‚', options: sh(['90','45','180']), answers: ['90'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼š90åº¦å°±å«åšã€Œç›´ã€è§’ã€‚', instruction: 'çœ‹åˆ°åœ–ä¸Šæœ‰æ–¹å½¢çš„ç´…ç·šç¬¦è™Ÿã€Œâ–¡ã€ï¼Œä»£è¡¨é€™å€‹è§’æ˜¯ __ è§’ã€‚', options: sh(['ç›´','éŠ³','éˆ']), answers: ['ç›´'] }
              ]
            },
            {
              subQs: [
                { type: 'main', instruction: `å› ç‚º${L.a}å’Œ${L.b}ç›¸äº¤æˆç›´è§’ï¼Œæ‰€ä»¥${L.a}å’Œ${L.b}äº’ç›¸ __ ã€‚`, options: sh(['å‚ç›´','å¹³è¡Œ','äº¤å‰']), answers: ['å‚ç›´'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šç›¸äº¤æˆç›´è§’å°±æ˜¯äº’ç›¸å‚ç›´ï¼', instruction: 'ç›´è§’ç›¸äº¤çš„å…©æ¢ç·šï¼Œç¨±ç‚ºäº’ç›¸ __ ã€‚', options: sh(['å‚ç›´','å¹³è¡Œ','åˆ†é–‹']), answers: ['å‚ç›´'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šè¦ç¢ºèªå‚ç›´ï¼Œå¤¾è§’å¿…é ˆæ˜¯90åº¦ã€‚', instruction: 'å¦‚æœå…©æ¢ç·šäº’ç›¸å‚ç›´ï¼Œå®ƒå€‘çš„å¤¾è§’ä¸€å®šæ˜¯ __ åº¦ã€‚', options: sh(['90','180','360']), answers: ['90'] }
              ]
            }
          ]
        },
        {
          id: 'q2',
          title: 'é—œå¡ 2ï¼šå¹³è¡Œèˆ‡è·é›¢',
          text: 'è§€å¯Ÿä¸‹åœ–ï¼Œè—ç·šå’Œç¶ ç·šåŒæ™‚å’Œç´…ç·šäº’ç›¸<mark>å‚ç›´</mark>ã€‚<br><br>åœ¨åŒä¸€å¹³é¢ä¸Šï¼Œç•¶å…©æ¢ç›´ç·šåŒæ™‚å‚ç›´æ–¼å¦ä¸€æ¢ç›´ç·šæ™‚ï¼Œæˆ‘å€‘èªªé€™å…©æ¢ç›´ç·šäº’ç›¸ã€Œ<mark>å¹³è¡Œ</mark>ã€ã€‚å’Œå…©æ¢å¹³è¡Œç·šå‚ç›´çš„ç·šæ®µï¼Œç¨±ç‚ºå¹³è¡Œç·šé–“çš„ã€Œ<mark>è·é›¢</mark>ã€ã€‚',
          textVoice: 'è§€å¯Ÿä¸‹åœ–ï¼Œè—ç·šå’Œç¶ ç·šåŒæ™‚å’Œç´…ç·šäº’ç›¸å‚ç›´ã€‚åœ¨åŒä¸€å¹³é¢ä¸Šï¼Œç•¶å…©æ¢ç›´ç·šåŒæ™‚å‚ç›´æ–¼å¦ä¸€æ¢ç›´ç·šæ™‚ï¼Œæˆ‘å€‘èªªé€™å…©æ¢ç›´ç·šäº’ç›¸å¹³è¡Œã€‚å’Œå…©æ¢å¹³è¡Œç·šå‚ç›´çš„ç·šæ®µï¼Œç¨±ç‚ºå¹³è¡Œç·šé–“çš„è·é›¢ã€‚',
          svg: `
            <svg viewBox="0 0 100 100" class="w-full max-w-[200px] h-auto">
              <line x1="10" y1="30" x2="90" y2="30" stroke="#3b82f6" stroke-width="4" stroke-linecap="round"/>
              <line x1="10" y1="70" x2="90" y2="70" stroke="#22c55e" stroke-width="4" stroke-linecap="round"/>
              <line x1="30" y1="30" x2="30" y2="70" stroke="#ef4444" stroke-width="4" stroke-linecap="round" stroke-dasharray="2,2"/>
              <line x1="70" y1="30" x2="70" y2="70" stroke="#ef4444" stroke-width="4" stroke-linecap="round" stroke-dasharray="2,2"/>
              <polyline points="30,40 40,40 40,30" fill="none" stroke="#ef4444" stroke-width="2"/>
              <polyline points="30,60 40,60 40,70" fill="none" stroke="#ef4444" stroke-width="2"/>
              <text x="95" y="35" font-size="10" font-weight="bold" fill="#3b82f6">è—ç·š</text>
              <text x="95" y="75" font-size="10" font-weight="bold" fill="#22c55e">ç¶ ç·š</text>
            </svg>
          `,
          steps: [
            {
              subQs: [
                { type: 'main', instruction: 'ç•¶è—ç·šå’Œç¶ ç·šéƒ½å’ŒåŒä¸€æ¢ç´…ç·šäº’ç›¸å‚ç›´æ™‚ï¼Œè—ç·šå’Œç¶ ç·šæœƒäº’ç›¸ __ ã€‚', options: sh(['å‚ç›´','å¹³è¡Œ','äº¤å‰']), answers: ['å¹³è¡Œ'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šå…©æ¢ç›´ç·šæ°¸é ä¸ç›¸äº¤ï¼Œåƒç«è»Šéµè»Œä¸€æ¨£ï¼Œç¨±ç‚ºå¹³è¡Œã€‚', instruction: 'å…©æ¢ç›´ç·šæ°¸é ä¸ç›¸äº¤ï¼Œæ–¹å‘ä¸€è‡´ï¼Œç¨±ç‚ºäº’ç›¸ __ ã€‚', options: sh(['å¹³è¡Œ','å‚ç›´']), answers: ['å¹³è¡Œ'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šè—ç·šå’Œç¶ ç·šéƒ½æœ‰ç¢°åˆ°ç´…ç·šä¸¦å½¢æˆç›´è§’ï¼Œæ‰€ä»¥å®ƒå€‘å¹³è¡Œã€‚', instruction: 'åŒæ™‚å’Œç¬¬ä¸‰æ¢ç·šå‚ç›´çš„å…©æ¢ç·šï¼Œå½¼æ­¤ä¹‹é–“äº’ç›¸ __ ã€‚', options: sh(['å¹³è¡Œ','å½æ›²']), answers: ['å¹³è¡Œ'] }
              ]
            },
            {
              subQs: [
                { type: 'main', instruction: 'å’Œå…©æ¢å¹³è¡Œç·šäº’ç›¸å‚ç›´çš„ç·šæ®µï¼Œç¨±ç‚ºå¹³è¡Œç·šé–“çš„ __ ï¼Œä¸”å¹³è¡Œç·šé–“çš„è·é›¢è™•è™• __ ã€‚', options: sh(['è·é›¢','é•·åº¦','ç›¸ç­‰','ä¸ç›¸ç­‰']), answers: ['è·é›¢','ç›¸ç­‰'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šå¹³è¡Œç·šå°±åƒç«è»Šéµè»Œï¼Œè»Œé“ä¸­é–“çš„å¯¬åº¦åˆ°è™•éƒ½ä¸€æ¨£é•·ã€‚', instruction: 'å…©æ¢å¹³è¡Œç·šä¹‹é–“çš„è·é›¢è™•è™• __ ã€‚', options: sh(['ç›¸ç­‰','ä¸ç›¸ç­‰']), answers: ['ç›¸ç­‰'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šå…©ç·šä¹‹é–“çš„å‚ç›´é•·åº¦å°±å«åšè·é›¢ã€‚', instruction: 'å…©æ¢å¹³è¡Œç·šä¹‹é–“ï¼Œå‚ç›´é€£èµ·ä¾†çš„é€™æ®µé•·åº¦å«åš __ ã€‚', options: sh(['è·é›¢','é‡é‡','é¢ç©']), answers: ['è·é›¢'] }
              ]
            }
          ]
        },
        {
          id: 'q3',
          title: 'é—œå¡ 3ï¼šé•·æ–¹å½¢èˆ‡æ­£æ–¹å½¢',
          text: 'è§€å¯Ÿä¸‹åœ–ã€‚<br><br>å››é‚Šå½¢æœ‰ 4 å€‹è§’éƒ½æ˜¯ç›´è§’ï¼Œå…©é›™å°é‚Šä¸€æ¨£é•·ï¼Œå«åšã€Œ<mark>é•·æ–¹å½¢</mark>ã€ã€‚<br>å¦‚æœ <mark>4 æ¢é‚Šéƒ½ä¸€æ¨£é•·</mark>ï¼Œå°±å«åšã€Œ<mark>æ­£æ–¹å½¢</mark>ã€ã€‚',
          textVoice: 'è§€å¯Ÿä¸‹åœ–ã€‚å››é‚Šå½¢æœ‰å››å€‹è§’éƒ½æ˜¯ç›´è§’ï¼Œå…©é›™å°é‚Šä¸€æ¨£é•·ï¼Œå«åšé•·æ–¹å½¢ã€‚å¦‚æœå››æ¢é‚Šéƒ½ä¸€æ¨£é•·ï¼Œå°±å«åšæ­£æ–¹å½¢ã€‚',
          svg: `
            <svg viewBox="0 0 200 100" class="w-full max-w-[300px] h-auto">
              <rect x="10" y="30" width="70" height="40" fill="#e0f2fe" stroke="#3b82f6" stroke-width="3"/>
              <polyline points="10,30 20,30 20,40 10,40" fill="none" stroke="#ef4444" stroke-width="2"/>
              <rect x="110" y="20" width="60" height="60" fill="#fef08a" stroke="#eab308" stroke-width="3"/>
              <polyline points="110,20 120,20 120,30 110,30" fill="none" stroke="#ef4444" stroke-width="2"/>
              <text x="35" y="85" font-size="12" font-weight="bold" fill="#3b82f6">é•·æ–¹å½¢</text>
              <text x="125" y="95" font-size="12" font-weight="bold" fill="#eab308">æ­£æ–¹å½¢</text>
            </svg>
          `,
          steps: [
            {
              subQs: [
                { type: 'main', instruction: 'é•·æ–¹å½¢æœ‰ 4 å€‹è§’éƒ½æ˜¯ __ è§’ï¼Œè€Œä¸”å®ƒçš„å…©é›™å°é‚Šåˆ†åˆ¥ __ é•·ã€‚', options: sh(['ç›´','å¹³','ä¸€æ¨£','ä¸ä¸€æ¨£']), answers: ['ç›´','ä¸€æ¨£'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šé•·æ–¹å½¢çš„è§’éƒ½æœ‰ç´…è‰²çš„æ–¹å½¢è¨˜è™Ÿå–”ã€‚', instruction: 'é•·æ–¹å½¢çš„ 4 å€‹è§’éƒ½æ˜¯ __ è§’ã€‚', options: sh(['ç›´','éŠ³','éˆ']), answers: ['ç›´'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šä¸Šé‚Š=ä¸‹é‚Šï¼Œå·¦é‚Š=å³é‚Šã€‚', instruction: 'é•·æ–¹å½¢çš„ä¸Šä¸‹å…©æ¢å°é‚Š __ é•·ã€‚', options: sh(['ä¸€æ¨£','ä¸ä¸€æ¨£']), answers: ['ä¸€æ¨£'] }
              ]
            },
            {
              subQs: [
                { type: 'main', instruction: 'å¦‚æœä¸€å€‹å››é‚Šå½¢ 4 å€‹è§’éƒ½æ˜¯ç›´è§’ï¼Œè€Œä¸” 4 æ¢é‚Šéƒ½ __ é•·ï¼Œå«åš __ ã€‚', options: sh(['ä¸€æ¨£','ä¸ä¸€æ¨£','é•·æ–¹å½¢','æ­£æ–¹å½¢']), answers: ['ä¸€æ¨£','æ­£æ–¹å½¢'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šæ­£æ–¹å½¢æ¯ä¸€æ¢é‚Šé•·åº¦éƒ½ç›¸åŒã€‚', instruction: 'æ­£æ–¹å½¢çš„ 4 æ¢é‚Šéƒ½ __ é•·ã€‚', options: sh(['ä¸€æ¨£','ä¸ä¸€æ¨£']), answers: ['ä¸€æ¨£'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šå››é‚Šç­‰é•·ä¸”éƒ½æ˜¯ç›´è§’ã€‚', instruction: 'å››æ¢é‚Šéƒ½ç­‰é•·ä¸”éƒ½æ˜¯ç›´è§’çš„åœ–å½¢å«åš __ ã€‚', options: sh(['æ­£æ–¹å½¢','é•·æ–¹å½¢']), answers: ['æ­£æ–¹å½¢'] }
              ]
            }
          ]
        },
        {
          id: 'q4',
          title: 'é—œå¡ 4ï¼šè±å½¢èˆ‡å¹³è¡Œå››é‚Šå½¢',
          text: 'è§€å¯Ÿä¸‹åœ–ã€‚<br><br><mark>4 æ¢é‚Šéƒ½ä¸€æ¨£é•·</mark>çš„å››é‚Šå½¢ï¼Œå«åšã€Œ<mark>è±å½¢</mark>ã€ã€‚<br><mark>å…©é›™å°é‚Šåˆ†åˆ¥äº’ç›¸å¹³è¡Œ</mark>çš„å››é‚Šå½¢ï¼Œå«åšã€Œ<mark>å¹³è¡Œå››é‚Šå½¢</mark>ã€ã€‚',
          textVoice: 'è§€å¯Ÿä¸‹åœ–ã€‚å››æ¢é‚Šéƒ½ä¸€æ¨£é•·çš„å››é‚Šå½¢ï¼Œå«åšè±å½¢ã€‚å…©é›™å°é‚Šåˆ†åˆ¥äº’ç›¸å¹³è¡Œçš„å››é‚Šå½¢ï¼Œå«åšå¹³è¡Œå››é‚Šå½¢ã€‚',
          svg: `
            <svg viewBox="0 0 200 100" class="w-full max-w-[300px] h-auto">
              <polygon points="50,10 80,50 50,90 20,50" fill="#d8b4fe" stroke="#0ea5e9" stroke-width="3" stroke-linejoin="round"/>
              <text x="35" y="95" font-size="12" font-weight="bold" fill="#0ea5e9">è±å½¢</text>
              <polygon points="120,20 180,20 160,70 100,70" fill="#bbf7d0" stroke="#16a34a" stroke-width="3" stroke-linejoin="round"/>
              <text x="110" y="90" font-size="12" font-weight="bold" fill="#16a34a">å¹³è¡Œå››é‚Šå½¢</text>
            </svg>
          `,
          steps: [
            {
              subQs: [
                { type: 'main', instruction: '4 æ¢é‚Šéƒ½ä¸€æ¨£é•·çš„åœ–å½¢å«åš __ ï¼Œå®ƒçš„å…©é›™å°è§’åˆ†åˆ¥ __ ã€‚', options: sh(['è±å½¢','æ­£æ–¹å½¢','ä¸€æ¨£å¤§','ä¸ä¸€æ¨£å¤§']), answers: ['è±å½¢','ä¸€æ¨£å¤§'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šè±å½¢=å››é‚Šç­‰é•·ã€‚', instruction: '4 æ¢é‚Šéƒ½ __ é•·çš„å››é‚Šå½¢ï¼Œå«åšè±å½¢ã€‚', options: sh(['ä¸€æ¨£','ä¸ä¸€æ¨£']), answers: ['ä¸€æ¨£'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šè±å½¢çš„å°è§’ç›¸ç­‰ã€‚', instruction: 'è±å½¢çš„å…©é›™å°è§’æœƒåˆ†åˆ¥ __ ã€‚', options: sh(['ä¸€æ¨£å¤§','ä¸ä¸€æ¨£å¤§']), answers: ['ä¸€æ¨£å¤§'] }
              ]
            },
            {
              subQs: [
                { type: 'main', instruction: 'å…©é›™å°é‚Šåˆ†åˆ¥äº’ç›¸å¹³è¡Œçš„åœ–å½¢å« __ ï¼Œå®ƒçš„å…©é›™å°è§’åˆ†åˆ¥ __ ã€‚', options: sh(['å¹³è¡Œå››é‚Šå½¢','æ¢¯å½¢','ä¸€æ¨£å¤§','ä¸ä¸€æ¨£å¤§']), answers: ['å¹³è¡Œå››é‚Šå½¢','ä¸€æ¨£å¤§'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šä¸Šä¸‹äº’ç›¸å¹³è¡Œï¼Œå·¦å³ä¹Ÿäº’ç›¸å¹³è¡Œã€‚', instruction: 'å…©é›™å°é‚Šåˆ†åˆ¥äº’ç›¸å¹³è¡Œçš„åœ–å½¢å« __ ã€‚', options: sh(['å¹³è¡Œå››é‚Šå½¢','è±å½¢']), answers: ['å¹³è¡Œå››é‚Šå½¢'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šå¹³è¡Œå››é‚Šå½¢çš„å°è§’ç›¸ç­‰ã€‚', instruction: 'å¹³è¡Œå››é‚Šå½¢ä¸­ï¼Œç›¸å°çš„å…©å€‹è§’æœƒ __ ã€‚', options: sh(['ä¸€æ¨£å¤§','ä¸ä¸€æ¨£å¤§']), answers: ['ä¸€æ¨£å¤§'] }
              ]
            }
          ]
        },
        {
          id: 'q5',
          title: 'é—œå¡ 5ï¼šæ¢¯å½¢èˆ‡å››é‚Šå½¢è¦ç´ ',
          text: '<mark>åªæœ‰ä¸€é›™</mark>å°é‚Šäº’ç›¸å¹³è¡Œçš„å››é‚Šå½¢å«åšã€Œ<mark>æ¢¯å½¢</mark>ã€ã€‚<br><br>å››é‚Šå½¢ä¸­ï¼Œç›¸å°çš„é‚Šç¨±ç‚ºã€Œ<mark>å°é‚Š</mark>ã€ï¼Œç›¸å°çš„è§’ç¨±ç‚ºã€Œ<mark>å°è§’</mark>ã€ï¼Œç›¸å°é ‚é»çš„é€£ç·šç¨±ç‚ºã€Œ<mark>å°è§’ç·š</mark>ã€ã€‚',
          textVoice: 'åªæœ‰ä¸€é›™å°é‚Šäº’ç›¸å¹³è¡Œçš„å››é‚Šå½¢å«åšæ¢¯å½¢ã€‚å››é‚Šå½¢ä¸­ï¼Œç›¸å°çš„é‚Šç¨±ç‚ºå°é‚Šï¼Œç›¸å°çš„è§’ç¨±ç‚ºå°è§’ï¼Œç›¸å°é ‚é»çš„é€£ç·šç¨±ç‚ºå°è§’ç·šã€‚',
          svg: `
            <svg viewBox="0 0 200 100" class="w-full max-w-[300px] h-auto">
              <polygon points="60,20 140,20 160,80 40,80" fill="#fed7aa" stroke="#ea580c" stroke-width="3" stroke-linejoin="round"/>
              <line x1="60" y1="20" x2="160" y2="80" stroke="#ea580c" stroke-width="2" stroke-dasharray="4"/>
              <line x1="140" y1="20" x2="40" y2="80" stroke="#ea580c" stroke-width="2" stroke-dasharray="4"/>
              <text x="80" y="95" font-size="12" font-weight="bold" fill="#ea580c">æ¢¯å½¢èˆ‡å°è§’ç·š</text>
            </svg>
          `,
          steps: [
            {
              subQs: [
                { type: 'main', instruction: '__ å°é‚Šäº’ç›¸å¹³è¡Œçš„å››é‚Šå½¢ï¼Œå«åš __ ã€‚', options: sh(['åªæœ‰ä¸€é›™','å…©é›™','æ¢¯å½¢','è±å½¢']), answers: ['åªæœ‰ä¸€é›™','æ¢¯å½¢'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šæ¢¯å½¢åªæœ‰ä¸€é›™å¹³è¡Œã€‚', instruction: 'æ¢¯å½¢æ˜¯ __ å°é‚Šäº’ç›¸å¹³è¡Œçš„å››é‚Šå½¢ã€‚', options: sh(['åªæœ‰ä¸€é›™','å…©é›™']), answers: ['åªæœ‰ä¸€é›™'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šåªæœ‰ä¸€é›™å¹³è¡Œçš„å››é‚Šå½¢ã€‚', instruction: 'åªæœ‰ä¸€é›™å°é‚Šäº’ç›¸å¹³è¡Œçš„å«åš __ ã€‚', options: sh(['æ¢¯å½¢','æ­£æ–¹å½¢']), answers: ['æ¢¯å½¢'] }
              ]
            },
            {
              subQs: [
                { type: 'main', instruction: 'å››é‚Šå½¢ä¸­ï¼Œç›¸å°é ‚é»çš„é€£ç·šç¨±ç‚º __ ã€‚æ¯ä¸€å€‹å››é‚Šå½¢æœ€å¤šéƒ½èƒ½ç•«å‡º __ æ¢å°è§’ç·šã€‚', options: sh(['å°è§’ç·š','å°é‚Š','2','4']), answers: ['å°è§’ç·š','2'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šæŠŠå°è§’é€£èµ·ä¾†å°±æ˜¯å°è§’ç·šã€‚', instruction: 'åœ–ä¸­é€£æ¥å°è§’çš„è™›ç·šå«åš __ ã€‚', options: sh(['å°è§’ç·š','é„°é‚Š']), answers: ['å°è§’ç·š'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šå››é‚Šå½¢æœ€å¤šå…©æ¢å°è§’ç·šã€‚', instruction: 'ä¸€å€‹å››é‚Šå½¢æœ€å¤šå¯ä»¥ç•«å‡º __ æ¢å°è§’ç·šã€‚', options: sh(['2','4','8']), answers: ['2'] }
              ]
            }
          ]
        },
        {
          id: 'q6',
          title: 'é—œå¡ 6ï¼šåˆ†å‰²å››é‚Šå½¢',
          text: 'è§€å¯Ÿä¸‹åœ–ï¼Œå¦‚æœæˆ‘å€‘æ²¿è‘—å››é‚Šå½¢çš„ã€Œ<mark>å°è§’ç·š</mark>ã€å‰ªé–‹ï¼Œæœƒç™¼ç”Ÿä»€éº¼äº‹å‘¢ï¼Ÿ<br><br>æœ‰äº›å››é‚Šå½¢æ²¿è‘—å°è§’ç·šå‰ªé–‹å¾Œï¼Œå¯ä»¥åˆ†æˆå…©å€‹ã€Œ<mark>å…¨ç­‰</mark>ã€ï¼ˆå½¢ç‹€ã€å¤§å°å®Œå…¨ä¸€æ¨£ï¼‰çš„ä¸‰è§’å½¢å–”ï¼',
          textVoice: 'è§€å¯Ÿä¸‹åœ–ï¼Œå¦‚æœæˆ‘å€‘æ²¿è‘—å››é‚Šå½¢çš„å°è§’ç·šå‰ªé–‹ï¼Œæœƒç™¼ç”Ÿä»€éº¼äº‹å‘¢ï¼Ÿæœ‰äº›å››é‚Šå½¢æ²¿è‘—å°è§’ç·šå‰ªé–‹å¾Œï¼Œå¯ä»¥åˆ†æˆå…©å€‹å…¨ç­‰çš„ä¸‰è§’å½¢ã€‚',
          svg: `
            <svg viewBox="0 0 200 100" class="w-full max-w-[300px] h-auto">
              <polygon points="40,20 140,20 110,80 10,80" fill="#e0f2fe" stroke="#3b82f6" stroke-width="3" stroke-linejoin="round"/>
              <line x1="140" y1="20" x2="10" y2="80" stroke="#ef4444" stroke-width="3" stroke-dasharray="5,5"/>
              <text x="65" y="45" font-size="14" font-weight="bold" fill="#3b82f6">ç”²</text>
              <text x="85" y="70" font-size="14" font-weight="bold" fill="#3b82f6">ä¹™</text>
              <text x="100" y="48" font-size="12" font-weight="bold" fill="#ef4444" transform="rotate(24 100,48)">å°è§’ç·š</text>
            </svg>
          `,
          steps: [
            {
              subQs: [
                { type: 'main', instruction: 'æ²¿è‘—å¹³è¡Œå››é‚Šå½¢çš„å°è§’ç·šå‰ªé–‹ï¼Œå¯ä»¥å‰ªæˆ __ å€‹ä¸‰è§’å½¢ã€‚é€™å…©å€‹ä¸‰è§’å½¢çš„å½¢ç‹€å’Œå¤§å°å®Œå…¨ä¸€æ¨£ï¼Œç¨±ç‚º __ åœ–å½¢ã€‚', options: sh(['2','3','å…¨ç­‰','ä¸å…¨ç­‰']), answers: ['2','å…¨ç­‰'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šå°è§’ç·šæŠŠå››é‚Šå½¢åˆ‡æˆå…©åŠã€‚', instruction: 'ä¸€æ¢å°è§’ç·šå¯ä»¥æŠŠå¹³è¡Œå››é‚Šå½¢åˆ‡æˆ __ å€‹ä¸‰è§’å½¢ã€‚', options: sh(['2','3','4']), answers: ['2'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šå½¢ç‹€å’Œå¤§å°éƒ½å®Œå…¨ä¸€æ¨£å«ã€Œå…¨ç­‰ã€ã€‚', instruction: 'åˆ‡é–‹çš„å…©å€‹ä¸‰è§’å½¢å½¢ç‹€å’Œå¤§å°éƒ½ä¸€æ¨£ï¼Œç¨±ç‚º __ åœ–å½¢ã€‚', options: sh(['å…¨ç­‰','ä¸å…¨ç­‰']), answers: ['å…¨ç­‰'] }
              ]
            },
            {
              subQs: [
                { type: 'main', instruction: 'é™¤äº†å¹³è¡Œå››é‚Šå½¢ï¼Œé•·æ–¹å½¢ã€æ­£æ–¹å½¢å’Œè±å½¢ __ å‰ªæˆå…©å€‹å…¨ç­‰ä¸‰è§’å½¢ï¼›ä½†æ˜¯æ¢¯å½¢ __ å‰ªæˆå…©å€‹å…¨ç­‰ä¸‰è§’å½¢ã€‚', options: sh(['å¯ä»¥','ä¸å¯ä»¥']), answers: ['å¯ä»¥','ä¸å¯ä»¥'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šæ­£æ–¹å½¢/é•·æ–¹å½¢æ²¿å°è§’ç·šå¯åˆ†æˆå…©å€‹å…¨ç­‰ä¸‰è§’å½¢ã€‚', instruction: 'æ­£æ–¹å½¢æˆ–é•·æ–¹å½¢æ²¿è‘—å°è§’ç·šå‰ªé–‹ï¼Œ__ å‰ªæˆå…©å€‹å…¨ç­‰ä¸‰è§’å½¢ã€‚', options: sh(['å¯ä»¥','ä¸å¯ä»¥']), answers: ['å¯ä»¥'] },
                { type: 'remedial', hintMsg: 'æç¤ºï¼šæ¢¯å½¢ä¸Šä¸‹åº•ä¸ç­‰é•·ï¼Œåˆ‡é–‹ä¸æœƒå…¨ç­‰ã€‚', instruction: 'æ¢¯å½¢æ²¿è‘—å°è§’ç·šå‰ªé–‹ï¼Œ__ å‰ªæˆå…©å€‹å…¨ç­‰çš„ä¸‰è§’å½¢ã€‚', options: sh(['å¯ä»¥','ä¸å¯ä»¥']), answers: ['ä¸å¯ä»¥'] }
              ]
            }
          ]
        }
      ];
    }

    /* ===========================
      å…¨åŸŸç‹€æ…‹
    =========================== */
    let sessionSeed = getOrCreateSessionSeed();
    let quizData = buildQuizData(sessionSeed);

    let currentQ = 0;
    let totalScore = 0;
    let gameState = [];
    let teacherMode = false;

    /* ===========================
      localStorageï¼šå­˜å–ï¼ˆå« seedï¼‰
    =========================== */
    function saveState() {
      try {
        const payload = {
          v: 4,
          seed: sessionSeed,
          currentQ,
          totalScore,
          teacherMode,
          gameState
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      } catch (e) {}
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const parsed = JSON.parse(raw);
        if (!parsed || parsed.v !== 4) return false;

        // ç”¨å­˜æª” seed é‡å»ºé¡Œåº«ï¼Œé¿å…é¸é …æ´—ç‰Œé€ æˆ optIdx/optionsUsed éŒ¯ä½
        if (typeof parsed.seed !== 'number') return false;
        sessionSeed = parsed.seed >>> 0;
        sessionStorage.setItem(SESSION_SEED_KEY, String(sessionSeed));
        quizData = buildQuizData(sessionSeed);

        if (!Array.isArray(parsed.gameState) || parsed.gameState.length !== quizData.length) return false;

        currentQ = Number.isInteger(parsed.currentQ) ? parsed.currentQ : 0;
        totalScore = Number.isFinite(parsed.totalScore) ? parsed.totalScore : 0;
        teacherMode = !!parsed.teacherMode;
        gameState = parsed.gameState;

        return true;
      } catch (e) {
        return false;
      }
    }

    function initGameState() {
      gameState = quizData.map(q => ({
        id: q.id,
        completed: false,
        steps: q.steps.map((step, sIdx) => ({
          status: sIdx === 0 ? 'active' : 'locked',
          failedMain: false,
          activeSubQIndex: 0,
          subQs: step.subQs.map(sq => ({
            slots: new Array(sq.answers.length).fill(null),
            optionsUsed: new Array(sq.options.length).fill(false),
            status: 'locked'
          }))
        }))
      }));

      gameState.forEach(q => {
        q.steps[0].subQs[0].status = 'active';
      });

      saveState();
    }

    /* ===========================
      Toast
    =========================== */
    let toastTimer = null;
    function showToast({ title='æç¤º', msg='', type='info' } = {}) {
      const toast = document.getElementById('toast');
      const emoji = document.getElementById('toast-emoji');
      const t = document.getElementById('toast-title');
      const m = document.getElementById('toast-msg');

      const map = {
        info: { e: 'ğŸ’¡', title },
        success: { e: 'âœ…', title },
        error: { e: 'âš ï¸', title },
      };
      const preset = map[type] || map.info;

      emoji.textContent = preset.e;
      t.textContent = preset.title || 'æç¤º';
      m.innerHTML = msg;

      toast.classList.remove('toast-hidden');
      toast.classList.add('toast-show');

      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        toast.classList.remove('toast-show');
        toast.classList.add('toast-hidden');
      }, 2600);
    }

    /* ===========================
      æ¸²æŸ“
    =========================== */
    function renderApp() {
      renderNav();
      renderLeftPanel();
      renderRightPanel();
      renderHeaderStats();
      saveState();
    }

    function renderHeaderStats() {
      document.getElementById('total-score').innerText = totalScore;

      const doneCount = gameState.filter(q => q.completed).length;
      const totalCount = quizData.length;
      document.getElementById('progress-text').innerText = `${doneCount}/${totalCount}`;

      const pct = totalCount === 0 ? 0 : Math.round((doneCount / totalCount) * 100);
      document.getElementById('progress-ring').setAttribute('stroke-dasharray', `${pct}, 100`);

      const qState = gameState[currentQ];
      const stepTotal = qState.steps.length;
      const stepDone = qState.steps.filter(s => s.status === 'done').length;
      document.getElementById('step-progress').innerText = `${stepDone}/${stepTotal}`;

      const teacherBtn = document.getElementById('teacher-toggle');
      teacherBtn.textContent = `ğŸ§‘â€ğŸ« æ•™å¸«ï¼š${teacherMode ? 'ON' : 'OFF'}`;
      teacherBtn.classList.toggle('bg-blue-600', teacherMode);
      teacherBtn.classList.toggle('text-white', teacherMode);
      teacherBtn.classList.toggle('border-blue-700', teacherMode);

      document.getElementById('teacher-tools').classList.toggle('hidden', !teacherMode);
    }

    function renderNav() {
      const nav = document.getElementById('nav-tabs');
      nav.innerHTML = quizData.map((q, idx) => {
        const isCurrent = idx === currentQ;
        const isDone = gameState[idx].completed;
        return `
          <button onclick="switchTab(${idx})"
            class="px-5 py-2 whitespace-nowrap rounded-t-xl font-bold transition-colors border-b-4
            ${isCurrent ? 'bg-blue-50 text-blue-700 border-blue-600' : 'bg-white text-slate-500 hover:bg-slate-50 border-transparent'}">
            ${q.title} ${isDone ? 'âœ”' : ''}
          </button>
        `;
      }).join('');
    }

    function switchTab(idx) {
      currentQ = idx;
      renderApp();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function renderLeftPanel() {
      const q = quizData[currentQ];
      document.getElementById('q-title').innerText = q.title;
      document.getElementById('q-text').innerHTML = q.text;
      document.getElementById('q-svg').innerHTML = q.svg;
    }

    // âœ… ä¿®æ­£ï¼šrender ä¸åœ¨æ¸²æŸ“éšæ®µã€Œå·å·æ”¹ç‹€æ…‹ã€
    function renderRightPanel() {
      const container = document.getElementById('steps-container');
      const qState = gameState[currentQ];

      container.innerHTML = qState.steps.map((stepState, sIdx) => {
        const isLocked = !teacherMode && stepState.status === 'locked';
        const isDone = stepState.status === 'done';

        let stepHTML = `
          <div class="bg-white rounded-2xl shadow-sm border-2 ${isLocked ? 'border-slate-100 opacity-60' : isDone ? 'border-green-200 bg-green-50/30' : 'border-blue-200 shadow-md'} p-5 transition-all"
               id="step-${currentQ}-${sIdx}">
            <div class="flex items-center justify-between mb-4 border-b pb-2 gap-3">
              <div class="flex items-center">
                <h3 class="text-xl font-bold ${isDone ? 'text-green-700' : 'text-blue-800'}">æ­¥é©Ÿ ${sIdx + 1}</h3>
                ${isDone ? '<span class="text-green-600 font-bold ml-3 text-lg flex items-center gap-1"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>å®Œæˆ</span>' : ''}
              </div>
              ${teacherMode ? `
                <button class="px-4 py-2 rounded-xl bg-slate-100 border border-slate-200 text-slate-700 font-extrabold hover:bg-slate-200 transition-colors"
                        onclick="teacherMarkStepDone(${sIdx})">
                  âœ… æ•™å¸«ï¼šæ¨™è¨˜æœ¬æ­¥å®Œæˆ
                </button>
              ` : ''}
            </div>

            <div class="space-y-6">
        `;

        if (isLocked) {
          stepHTML += `
            <div class="flex items-center gap-3 text-slate-400 font-bold text-lg p-4 bg-slate-50 rounded-xl">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
              </svg>
              è«‹å…ˆå®Œæˆä¸Šä¸€å€‹æ­¥é©Ÿè§£é–
            </div>`;
        } else {
          stepState.subQs.forEach((subQState, subIdx) => {
            const visible = teacherMode ? (subIdx === 0 ? true : (subQState.status !== 'locked')) : (subQState.status !== 'locked');
            if (visible) {
              stepHTML += renderSubQuestion(sIdx, subIdx, subQState);
            }
          });

          if (teacherMode) {
            // è‹¥æ•™å¸«æ¨¡å¼ä½†ä¸»é¡Œè¢«é–ï¼ˆæ¥µç«¯ç‹€æ³ï¼‰ï¼Œä»é¡¯ç¤ºä¸»é¡Œ
            if (stepState.subQs.length && stepState.subQs[0].status === 'locked') {
              stepHTML += renderSubQuestion(sIdx, 0, stepState.subQs[0]);
            }
          }
        }

        stepHTML += `</div></div>`;
        return stepHTML;
      }).join('');
    }

    function renderSubQuestion(sIdx, subIdx, subQState) {
      const data = quizData[currentQ].steps[sIdx].subQs[subIdx];
      const isMain = data.type === 'main';
      const isDone = subQState.status === 'done';

      let instHTML = data.instruction;

      data.answers.forEach((_, slotIdx) => {
        const slotData = subQState.slots[slotIdx];
        let slotContent = '';
        let slotClass = 'slot';

        if (slotData) {
          slotContent = slotData.val;
          slotClass += ' filled';
        }
        if (isDone) slotClass += ' done';

        const slotHTML =
          `<span class="${slotClass}" ${!isDone ? `onclick="clearSlot(${sIdx}, ${subIdx}, ${slotIdx})"` : ''} id="slot-${currentQ}-${sIdx}-${subIdx}-${slotIdx}">${slotContent}</span>`;

        instHTML = instHTML.replace(/__/, slotHTML);
      });

      let html = `
        <div class="sub-q relative p-4 rounded-xl ${!isMain ? 'bg-orange-50/50 border border-orange-100' : ''}"
             id="subq-${currentQ}-${sIdx}-${subIdx}">
          ${!isMain ? `
            <div class="text-orange-600 font-bold text-sm mb-2 flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              è€å¸«çš„å°æç¤ºï¼š${data.hintMsg || ''}
            </div>
          ` : ''}

          <div class="flex items-start gap-2 mb-4">
            <button onclick="playTTS('${escapeForJS(data.instruction.replace(/__/g, 'ç©ºæ ¼'))}')"
                    class="mt-1 flex-shrink-0 p-1.5 bg-slate-100 text-slate-500 rounded-full hover:bg-blue-100 hover:text-blue-600 transition-colors"
                    title="æœ—è®€é¡Œç›®">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M15.536 8.464a5 5 0 010 7.072M18.364 5.636a9 9 0 010 12.728M11 5L6 9H2v6h4l5 4V5z"></path>
              </svg>
            </button>
            <div class="text-xl leading-loose font-medium">${instHTML}</div>
          </div>
      `;

      html += `
        <div id="err-${currentQ}-${sIdx}-${subIdx}"
             class="text-red-500 font-bold text-lg mb-3 hidden flex items-center gap-2">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          å†æƒ³æƒ³çœ‹ï¼è«‹ä¿®æ”¹éŒ¯èª¤çš„ç©ºæ ¼ã€‚
        </div>
      `;

      if (!isDone) {
        html += `
          <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 mb-4">
            <div class="text-sm font-bold text-slate-400 mb-2">é»æ“ŠæŒ‰éˆ•å¡«å…¥ç©ºæ ¼ï¼š</div>
            <div class="flex flex-wrap gap-3">
              ${data.options.map((opt, optIdx) => `
                <button class="option-btn"
                        ${subQState.optionsUsed[optIdx] ? 'disabled' : ''}
                        onclick="selectOption(${sIdx}, ${subIdx}, ${optIdx})">${opt}</button>
              `).join('')}
            </div>
          </div>

          <button onclick="checkAnswer(${sIdx}, ${subIdx})"
                  class="w-full md:w-auto px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white text-xl font-bold rounded-xl transition-all shadow-md shadow-blue-200 hover:shadow-lg flex items-center justify-center gap-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            æª¢æŸ¥ç­”æ¡ˆ
          </button>
        `;
      }

      html += `</div>`;
      return html;
    }

    /* ===========================
      äº’å‹•é‚è¼¯
    =========================== */
    function selectOption(sIdx, subIdx, optIdx) {
      const qState = gameState[currentQ];
      const subQState = qState.steps[sIdx].subQs[subIdx];
      const data = quizData[currentQ].steps[sIdx].subQs[subIdx];

      const emptySlotIdx = subQState.slots.findIndex(s => s === null);
      if (emptySlotIdx !== -1) {
        subQState.slots[emptySlotIdx] = { optIdx, val: data.options[optIdx] };
        subQState.optionsUsed[optIdx] = true;
        playPopSound();
        renderApp();
      } else {
        showToast({ title: 'å·²å¡«æ»¿', msg: 'ç©ºæ ¼éƒ½å·²ç¶“å¡«å¥½äº†å–”ï½å¯ä»¥æŒ‰ã€Œæª¢æŸ¥ç­”æ¡ˆã€', type: 'info' });
      }
    }

    function clearSlot(sIdx, subIdx, slotIdx) {
      const qState = gameState[currentQ];
      const subQState = qState.steps[sIdx].subQs[subIdx];

      const slotData = subQState.slots[slotIdx];
      if (slotData) {
        subQState.optionsUsed[slotData.optIdx] = false;
        subQState.slots[slotIdx] = null;

        const err = document.getElementById(`err-${currentQ}-${sIdx}-${subIdx}`);
        if (err) err.classList.add('hidden');

        renderApp();
      }
    }

    function checkAnswer(sIdx, subIdx) {
      const qState = gameState[currentQ];
      const stepState = qState.steps[sIdx];
      const subQState = stepState.subQs[subIdx];
      const data = quizData[currentQ].steps[sIdx].subQs[subIdx];

      if (subQState.slots.includes(null)) {
        playTTS("è«‹å¡«æ»¿æ‰€æœ‰ç©ºæ ¼å†æª¢æŸ¥");
        showToast({ title: 'é‚„æ²’å¡«å®Œ', msg: 'è«‹å…ˆæŠŠæ‰€æœ‰ç©ºæ ¼éƒ½å¡«æ»¿å†æª¢æŸ¥å–”ï¼', type: 'error' });
        return;
      }

      let isCorrect = true;
      subQState.slots.forEach((sData, idx) => {
        const el = document.getElementById(`slot-${currentQ}-${sIdx}-${subIdx}-${idx}`);
        if (sData.val !== data.answers[idx]) {
          isCorrect = false;
          if (el) {
            el.classList.add('error');
            setTimeout(() => el.classList.remove('error'), 400);
          }
        }
      });

      const errEl = document.getElementById(`err-${currentQ}-${sIdx}-${subIdx}`);

      if (isCorrect) {
        if (errEl) errEl.classList.add('hidden');
        playSuccessSound();
        subQState.status = 'done';

        const subQEl = document.getElementById(`subq-${currentQ}-${sIdx}-${subIdx}`);
        if (subQEl) subQEl.classList.add('animate-tada');

        if (subIdx === 0) {
          totalScore += stepState.failedMain ? 50 : 100;
        } else {
          totalScore += 50;
        }

        showToast({ title: 'ç­”å°äº†ï¼', msg: 'åšå¾—å¾ˆå¥½ï¼Œç¹¼çºŒä¸‹ä¸€æ­¥ï½', type: 'success' });

        if (subIdx === 0) {
          if (stepState.failedMain && stepState.subQs.length > 1) {
            stepState.activeSubQIndex = 1;
            stepState.subQs[1].status = 'active';
          } else {
            unlockNextStep(sIdx);
          }
        } else if (subIdx === 1) {
          if (stepState.subQs.length > 2) {
            stepState.activeSubQIndex = 2;
            stepState.subQs[2].status = 'active';
          } else {
            unlockNextStep(sIdx);
          }
        } else if (subIdx === 2) {
          unlockNextStep(sIdx);
        }

        setTimeout(renderApp, 520);
      } else {
        playErrorSound();
        if (errEl) errEl.classList.remove('hidden');
        playTTS("å†æƒ³æƒ³çœ‹");
        showToast({ title: 'å†æƒ³æƒ³çœ‹', msg: 'æœ‰ä¸€å…©æ ¼ä¸å¤ªå°ï½é»é¸ç©ºæ ¼å¯æ¸…é™¤é‡å¡«ã€‚', type: 'error' });

        if (subIdx === 0) {
          stepState.failedMain = true;
        }
        saveState();
      }
    }

    function unlockNextStep(currentSIdx) {
      const qState = gameState[currentQ];
      qState.steps[currentSIdx].status = 'done';

      if (currentSIdx + 1 < qState.steps.length) {
        qState.steps[currentSIdx + 1].status = 'active';
        qState.steps[currentSIdx + 1].subQs[0].status = 'active';

        setTimeout(() => {
          const nextStepEl = document.getElementById(`step-${currentQ}-${currentSIdx + 1}`);
          if (nextStepEl) nextStepEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 120);
      } else {
        qState.completed = true;
        setTimeout(() => showCompletionModal(), 520);
      }
    }

    /* ===========================
      æ•™å¸«æ¨¡å¼
    =========================== */
    function teacherMarkStepDone(sIdx) {
      const qState = gameState[currentQ];
      const stepState = qState.steps[sIdx];

      stepState.subQs.forEach((subQState, subIdx) => {
        const data = quizData[currentQ].steps[sIdx].subQs[subIdx];
        subQState.slots = data.answers.map(a => ({ optIdx: 0, val: a }));
        subQState.optionsUsed = new Array(data.options.length).fill(false);
        subQState.status = 'done';
      });

      unlockNextStep(sIdx);
      showToast({ title: 'æ•™å¸«æ“ä½œå®Œæˆ', msg: `å·²æ¨™è¨˜ã€Œæ­¥é©Ÿ ${sIdx + 1}ã€å®Œæˆä¸¦è§£é–ä¸‹ä¸€æ­¥ã€‚`, type: 'info' });
      renderApp();
    }

    function unlockAllStepsInCurrentQuestion() {
      const qState = gameState[currentQ];

      qState.steps.forEach((stepState, sIdx) => {
        stepState.status = 'done';
        stepState.failedMain = false;
        stepState.activeSubQIndex = 0;

        stepState.subQs.forEach((subQState, subIdx) => {
          const data = quizData[currentQ].steps[sIdx].subQs[subIdx];
          subQState.slots = data.answers.map(a => ({ optIdx: 0, val: a }));
          subQState.optionsUsed = new Array(data.options.length).fill(false);
          subQState.status = 'done';
        });
      });

      qState.completed = true;
      showToast({ title: 'å·²è§£é–å®Œæˆ', msg: 'æœ¬é—œå¡æ‰€æœ‰æ­¥é©Ÿå·²è¨­ç‚ºå®Œæˆï¼ˆä¸åŠ åˆ†ï¼‰ã€‚', type: 'success' });
      renderApp();
    }

    function resetAllProgress() {
      totalScore = 0;
      currentQ = 0;
      initGameState();
      showToast({ title: 'å·²é‡ç½®', msg: 'å…¨éƒ¨é—œå¡é€²åº¦èˆ‡åˆ†æ•¸å·²æ¸…ç©ºã€‚', type: 'info' });
      renderApp();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ğŸ” ç”¢ç”Ÿæ–°é¡Œç›®ï¼ˆæœ¬åˆ†é ï¼‰
    function newQuestionSetThisTab() {
      // ç”¢ç”Ÿæ–° seedï¼Œé‡å»ºé¡Œåº«ï¼Œä¸¦æ¸…ç©ºé€²åº¦ï¼ˆé¿å…é¡Œåº«/å­˜æª”éŒ¯ä½ï¼‰
      sessionStorage.removeItem(SESSION_SEED_KEY);
      sessionSeed = getOrCreateSessionSeed();
      quizData = buildQuizData(sessionSeed);

      // æ¸…ç©ºèˆŠå­˜æª”
      localStorage.removeItem(STORAGE_KEY);

      totalScore = 0;
      currentQ = 0;
      teacherMode = true; // æ•™å¸«æŒ‰å¾—åˆ°é€™é¡†éˆ•ï¼Œé€šå¸¸æ˜¯è€å¸«æ“ä½œï¼Œé †ä¾¿ä¿æŒ ON
      initGameState();
      showToast({ title: 'å·²ç”¢ç”Ÿæ–°é¡Œç›®', msg: 'æœ¬æ¬¡åˆ†é å·²æ›æˆæ–°é¡Œç›®ç‰ˆæœ¬ï¼ˆé¸é …/æ¨™ç±¤æœƒä¸åŒï¼‰ã€‚', type: 'success' });
      renderApp();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    /* ===========================
      TTS & éŸ³æ•ˆ
    =========================== */
    let synth = window.speechSynthesis;
    function playTTS(text) {
      if (!('speechSynthesis' in window)) {
        showToast({ title: 'ä¸æ”¯æ´èªéŸ³', msg: 'æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³æœ—è®€åŠŸèƒ½ã€‚', type: 'error' });
        return;
      }
      if (synth) {
        synth.cancel();
        const utterThis = new SpeechSynthesisUtterance(text);
        utterThis.lang = 'zh-TW';
        utterThis.rate = 0.9;
        synth.speak(utterThis);
      }
    }

    let audioCtx;
    function getAudioCtx() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      return audioCtx;
    }

    function playTone(freq, type, duration, vol = 0.1) {
      const ctx = getAudioCtx();
      if (ctx.state === 'suspended') ctx.resume();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = type;
      osc.frequency.setValueAtTime(freq, ctx.currentTime);
      gain.gain.setValueAtTime(vol, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime + duration);
    }

    function playPopSound() { playTone(420, 'sine', 0.09, 0.18); }
    function playSuccessSound() {
      playTone(650, 'sine', 0.10, 0.20);
      setTimeout(() => playTone(900, 'sine', 0.14, 0.20), 90);
      setTimeout(() => playTone(1250, 'sine', 0.26, 0.20), 220);
    }
    function playErrorSound() {
      playTone(320, 'square', 0.14, 0.10);
      setTimeout(() => playTone(260, 'square', 0.24, 0.10), 140);
    }

    /* ===========================
      Modal
    =========================== */
    function showCompletionModal() {
      const modal = document.getElementById('completion-modal');
      const content = document.getElementById('modal-content');
      document.getElementById('modal-score').innerText = totalScore;

      modal.classList.remove('hidden');
      void modal.offsetWidth;
      content.classList.remove('scale-95', 'opacity-0');
      content.classList.add('scale-100', 'opacity-100');

      playSuccessSound();
      playTTS("å¤ªæ£’äº†ï¼éé—œï¼");
      saveState();
      renderHeaderStats();
    }

    function closeModal() {
      const modal = document.getElementById('completion-modal');
      const content = document.getElementById('modal-content');
      content.classList.remove('scale-100', 'opacity-100');
      content.classList.add('scale-95', 'opacity-0');
      setTimeout(() => modal.classList.add('hidden'), 300);
      renderNav();
      saveState();
    }

    function resetCurrentQuestion() {
      const q = quizData[currentQ];
      gameState[currentQ] = {
        id: q.id,
        completed: false,
        steps: q.steps.map((step, sIdx) => ({
          status: sIdx === 0 ? 'active' : 'locked',
          failedMain: false,
          activeSubQIndex: 0,
          subQs: step.subQs.map(sq => ({
            slots: new Array(sq.answers.length).fill(null),
            optionsUsed: new Array(sq.options.length).fill(false),
            status: 'locked'
          }))
        }))
      };
      gameState[currentQ].steps[0].subQs[0].status = 'active';
      closeModal();
      showToast({ title: 'å·²é‡ç½®', msg: 'æœ¬é—œå¡å·²å›åˆ°ç¬¬ä¸€æ­¥ï¼Œé‡æ–°æŒ‘æˆ°å§ï¼', type: 'info' });
      renderApp();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    /* ===========================
      ç¶å®šæŒ‰éˆ•äº‹ä»¶
    =========================== */
    function bindUIEvents() {
      document.getElementById('tts-main-btn').addEventListener('click', () => {
        const q = quizData[currentQ];
        playTTS(q.textVoice || stripHtml(q.text));
      });

      document.getElementById('reset-question-btn').addEventListener('click', () => {
        resetCurrentQuestion();
      });

      document.getElementById('teacher-toggle').addEventListener('click', () => {
        teacherMode = !teacherMode;
        showToast({
          title: 'æ•™å¸«æ¨¡å¼',
          msg: teacherMode ? 'å·²é–‹å•Ÿï¼šå¯è§£é–/é‡ç½®/å¿«é€Ÿæ¨™è¨˜å®Œæˆã€‚' : 'å·²é—œé–‰ï¼šå›åˆ°ä¸€èˆ¬å­¸ç”Ÿæ¨¡å¼ã€‚',
          type: teacherMode ? 'success' : 'info'
        });
        renderApp();
      });

      document.getElementById('unlock-all-btn').addEventListener('click', () => {
        if (!teacherMode) return;
        unlockAllStepsInCurrentQuestion();
      });

      document.getElementById('reset-all-btn').addEventListener('click', () => {
        if (!teacherMode) return;
        resetAllProgress();
      });

      document.getElementById('new-set-btn').addEventListener('click', () => {
        if (!teacherMode) return;
        newQuestionSetThisTab();
      });
    }

    /* ===========================
      å•Ÿå‹•
    =========================== */
    window.addEventListener('load', () => {
      // å˜—è©¦è®€æª”ï¼ˆå« seedï¼‰ï¼Œè®€ä¸åˆ°å°±ç”¨æœ¬åˆ†é  seed å»ºæ–°é¡Œåº«
      const ok = loadState();
      if (!ok) {
        // ä½¿ç”¨ sessionSeed ç”Ÿæˆé¡Œåº« + åˆå§‹åŒ–é€²åº¦
        quizData = buildQuizData(sessionSeed);
        initGameState();
      }

      bindUIEvents();
      renderApp();

      showToast({
        title: 'å·²è¼‰å…¥',
        msg: ok
          ? 'å·²å¾ä¸Šæ¬¡é€²åº¦ç¹¼çºŒï¼ˆé¡Œç›®ç‰ˆæœ¬ä¸€è‡´ï¼‰ã€‚'
          : 'å·²å»ºç«‹æ–°çš„ä¸€å¥—é¡Œç›®ï¼ˆåŒåˆ†é åˆ·æ–°ä¸è®Šï¼Œæ–°é–‹åˆ†é æœƒä¸åŒï¼‰ã€‚',
        type: 'info'
      });
    });
  </script>
</body>
</html>
