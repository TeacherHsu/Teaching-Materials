<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸é‡è¦å¾‹å¤§æŒ‘æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0fdf4;
            color: #1f2937;
        }

        /* Slot Styles */
        .slot {
            display: inline-block;
            min-width: 80px;
            height: 48px;
            padding: 0 12px;
            border: 3px dashed #9ca3af;
            text-align: center;
            line-height: 42px;
            cursor: pointer;
            border-radius: 12px;
            margin: 0 6px;
            vertical-align: middle;
            font-weight: bold;
            font-size: 1.125rem;
            transition: all 0.2s;
            background-color: #f9fafb;
        }
        .slot:hover:not(.filled):not(.completed) {
            border-color: #60a5fa;
            background-color: #eff6ff;
        }
        .slot.filled {
            border: 3px solid #3b82f6;
            background-color: #eff6ff;
            color: #1d4ed8;
            border-style: solid;
        }
        .slot.completed {
            border: 3px solid #10b981;
            background-color: #ecfdf5;
            color: #047857;
            cursor: default;
        }

        /* Option Buttons */
        .option-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .option-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .option-btn:active:not(:disabled) {
            transform: translateY(0);
        }
        .option-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: scale(0.95);
        }

        /* Animations */
        @keyframes tada {
            0% { transform: scale(1); }
            10%, 20% { transform: scale(0.9) rotate(-3deg); }
            30%, 50%, 70%, 90% { transform: scale(1.1) rotate(3deg); }
            40%, 60%, 80% { transform: scale(1.1) rotate(-3deg); }
            100% { transform: scale(1); }
        }
        .animate-tada {
            animation: tada 0.8s ease-in-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .step-container {
            animation: slideIn 0.5s ease-out forwards;
        }

        /* Custom Scrollbar for Navbar */
        .hide-scrollbar::-webkit-scrollbar {
            height: 6px;
        }
        .hide-scrollbar::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 4px;
        }
        .hide-scrollbar::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 4px;
        }

        /* Mark Styling */
        mark {
            background-color: #fef08a;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
            color: #b45309;
        }

        /* Floating Score Animation */
        .score-float {
            position: absolute;
            animation: floatUp 1.5s ease-out forwards;
            font-weight: 900;
            color: #eab308;
            pointer-events: none;
            z-index: 100;
            font-size: 1.5rem;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
        }
    </style>
</head>
<body>

    <!-- Top Navigation Bar -->
    <nav class="bg-white shadow-md p-4 sticky top-0 z-50 flex items-center gap-4 overflow-x-auto hide-scrollbar">
        <div class="font-black text-2xl text-green-700 whitespace-nowrap px-4 border-r-2 border-gray-200">
            æ•¸é‡è¦å¾‹å¤§æŒ‘æˆ°
        </div>
        <div id="nav-buttons" class="flex gap-3">
            <!-- Buttons dynamically injected -->
        </div>
        <div class="ml-auto font-bold text-xl text-yellow-600 whitespace-nowrap px-4 bg-yellow-50 rounded-full py-1 border border-yellow-200 relative">
            ç¸½ç©åˆ†: <span id="global-score">0</span> ğŸ†
            <div id="score-anim-container" class="absolute inset-0"></div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto p-4 md:p-8 flex flex-col md:flex-row gap-8 items-start relative">
        
        <!-- Left Column: Question Context -->
        <div class="w-full md:w-1/3 bg-white rounded-2xl shadow-xl border-t-8 border-green-500 p-6 md:sticky md:top-24 flex-shrink-0">
            <div class="flex items-center justify-between mb-4">
                <h2 id="q-title" class="text-2xl font-bold text-gray-800">é¡Œç›®æ¨™é¡Œ</h2>
                <button onclick="speakCurrentQuestion()" class="text-blue-500 hover:bg-blue-100 p-2 rounded-full transition" title="æœ—è®€é¡Œç›®">
                    ğŸ”Š
                </button>
            </div>
            <div id="q-content" class="text-lg leading-relaxed text-gray-700 font-medium">
                <!-- Question content injected here -->
            </div>
            <div class="mt-6 p-4 bg-blue-50 rounded-xl border border-blue-100 hidden" id="q-concept">
                <h3 class="font-bold text-blue-800 mb-1 flex items-center gap-2">
                    ğŸ’¡ å­¸ç¿’é‡é»
                </h3>
                <p id="q-concept-text" class="text-blue-700 text-sm leading-relaxed">æŒ‰ç…§æ­¥é©Ÿä¸€æ­¥ä¸€æ­¥è§£é–‹è¬é¡Œï¼Œåªè¦ä»”ç´°è§€å¯Ÿï¼Œå°±èƒ½ç™¼ç¾è¦å¾‹çš„å¥§ç§˜å–”ï¼</p>
            </div>
        </div>

        <!-- Right Column: Step-by-Step Interactive Area -->
        <div class="w-full md:w-2/3 flex flex-col gap-6 pb-20" id="steps-panel">
            <!-- Steps injected here -->
        </div>

    </div>

    <!-- Completion Modal -->
    <div id="completion-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[100] backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full mx-4 shadow-2xl text-center transform transition-all animate-tada">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <h2 class="text-3xl font-black text-green-600 mb-2 flex justify-center items-center gap-2">
                å¤ªæ£’äº†ï¼
                <button onclick="speak('å¤ªæ£’äº†ï¼ä½ å·²ç¶“å®Œæˆé€™å€‹é¡Œç›®äº†ï¼')" class="text-blue-500 hover:bg-green-100 p-2 rounded-full transition text-xl bg-green-50 shadow-sm" title="æœ—è®€éé—œæç¤º">ğŸ”Š</button>
            </h2>
            <p class="text-lg text-gray-600 mb-2 font-medium">ä½ å·²ç¶“å®Œæˆé€™å€‹é¡Œç›®äº†ï¼</p>
            <p class="text-md text-gray-500 mb-6">æœ¬é—œç²å¾—ç©åˆ†ï¼š<span id="modal-score" class="text-yellow-600 font-bold text-3xl block mt-2"></span></p>
            <div class="flex flex-col gap-3">
                <button onclick="nextQuestion()" id="btn-next-q" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl transition text-lg shadow-lg shadow-green-200">
                    ä¸‹ä¸€é—œ â¡
                </button>
                <button onclick="resetCurrentQuestion()" class="w-full bg-blue-100 hover:bg-blue-200 text-blue-700 font-bold py-3 px-6 rounded-xl transition text-lg">
                    å†æŒ‘æˆ°ä¸€æ¬¡ â†º
                </button>
                <button onclick="closeModal()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-3 px-6 rounded-xl transition text-lg">
                    é—œé–‰è¦–çª— âœ–
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Data Structure & Generators ---
        function shuffle(array) {
            return array.sort(() => Math.random() - 0.5);
        }

        const levelGenerators = [
            // ç¬¬ 1 é—œï¼šåœ–å½¢çš„è¦å¾‹ï¼ˆéš¨æ©ŸæŠ½å–åœ–å½¢æ–¹å‘èˆ‡é †åºï¼‰
            function() {
                const corners = [
                    { name: 'å³ä¸‹', x: 52, y: 52 },
                    { name: 'å·¦ä¸‹', x: 2, y: 52 },
                    { name: 'å³ä¸Š', x: 52, y: 2 },
                    { name: 'å·¦ä¸Š', x: 2, y: 2 }
                ];
                const shuffled = shuffle([...corners]);
                const A = shuffled[0];
                const B = shuffled[1];
                
                const makeSvg = (x, y) => `
                    <svg width="60" height="60" viewBox="0 0 100 100" class="bg-white border-4 border-gray-400 rounded-xl shadow-md flex-shrink-0 md:w-20 md:h-20">
                        <line x1="50" y1="0" x2="50" y2="100" stroke="#d1d5db" stroke-width="4" />
                        <line x1="0" y1="50" x2="100" y2="50" stroke="#d1d5db" stroke-width="4" />
                        <rect x="${x}" y="${y}" width="46" height="46" fill="#a855f7" rx="4" />
                    </svg>`;

                const restOptions = corners.filter(c => c.name !== A.name && c.name !== B.name).map(c => c.name);
                const options = shuffle([B.name, B.name, restOptions[0], restOptions[1]]);

                return {
                    id: 1, title: "ç¬¬ 1 é—œï¼šåœ–å½¢çš„è¦å¾‹",
                    concept: "æœ‰è¦å¾‹çš„åœ–å½¢é€šå¸¸æœƒä»¥ã€Œå¹¾çµ„ã€ç‚ºä¸€å€‹å¾ªç’°ã€‚è«‹ä»”ç´°è§€å¯Ÿé‡è¤‡å‡ºç¾çš„éƒ¨åˆ†åœ¨å“ªå€‹ä½ç½®ï¼",
                    content: `
                        <p class="mb-4 text-gray-800">æˆ‘å€‘å¸¸å°‡ç£ç£šæœ‰è¦å¾‹çš„é‹ªæ’åœ¨ç‰†å£ä¸Šã€‚è«‹è§€å¯Ÿä¸‹åˆ— <mark>ç´«è‰²æ–¹å¡Š</mark> ç§»å‹•çš„é †åºï¼š</p>
                        <div class="bg-blue-50 p-4 md:p-6 rounded-2xl flex flex-col items-center mb-6 border-2 border-blue-100 shadow-inner">
                            <div class="flex items-center justify-between w-full max-w-lg overflow-x-auto pb-2 gap-2">
                                <div class="flex flex-col items-center gap-2">
                                    <div class="w-6 h-6 md:w-8 md:h-8 rounded-full bg-blue-200 text-blue-800 font-black flex items-center justify-center shadow-sm text-sm md:text-base">1</div>
                                    ${makeSvg(A.x, A.y)}
                                    <div class="text-xs md:text-sm font-bold text-gray-600 bg-white px-2 py-1 rounded shadow-sm border border-gray-200">${A.name}</div>
                                </div>
                                <span class="text-2xl md:text-3xl text-gray-400 font-black mb-6">â¡</span>
                                <div class="flex flex-col items-center gap-2">
                                    <div class="w-6 h-6 md:w-8 md:h-8 rounded-full bg-blue-200 text-blue-800 font-black flex items-center justify-center shadow-sm text-sm md:text-base">2</div>
                                    ${makeSvg(B.x, B.y)}
                                    <div class="text-xs md:text-sm font-bold text-gray-400 bg-gray-50 px-2 py-1 rounded border border-gray-200 border-dashed">?</div>
                                </div>
                                <span class="text-2xl md:text-3xl text-gray-400 font-black mb-6">â¡</span>
                                <div class="flex flex-col items-center gap-2">
                                    <div class="w-6 h-6 md:w-8 md:h-8 rounded-full bg-blue-200 text-blue-800 font-black flex items-center justify-center shadow-sm text-sm md:text-base">3</div>
                                    ${makeSvg(A.x, A.y)}
                                    <div class="text-xs md:text-sm font-bold text-gray-600 bg-white px-2 py-1 rounded shadow-sm border border-gray-200">${A.name}</div>
                                </div>
                                <span class="text-2xl md:text-3xl text-blue-400 font-black mb-6 animate-pulse">â¡</span>
                                <div class="flex flex-col items-center gap-2">
                                    <div class="w-6 h-6 md:w-8 md:h-8 rounded-full bg-yellow-300 text-yellow-800 font-black flex items-center justify-center shadow-sm text-sm md:text-base">4</div>
                                    <svg width="60" height="60" viewBox="0 0 100 100" class="bg-yellow-50 border-4 border-yellow-500 border-dashed rounded-xl shadow-md flex-shrink-0 md:w-20 md:h-20">
                                        <line x1="50" y1="0" x2="50" y2="100" stroke="#fde047" stroke-width="4" />
                                        <line x1="0" y1="50" x2="100" y2="50" stroke="#fde047" stroke-width="4" />
                                        <text x="50" y="75" font-size="50" font-weight="900" fill="#eab308" text-anchor="middle">?</text>
                                    </svg>
                                    <div class="text-xs md:text-sm font-bold text-yellow-600 bg-yellow-100 px-2 py-1 rounded border border-yellow-300">?</div>
                                </div>
                            </div>
                            <div class="mt-4 text-blue-800 font-bold bg-white px-4 py-2 rounded-lg shadow-sm border border-blue-100 text-sm md:text-base text-center">
                                ğŸ’¡ è«‹è§€å¯Ÿ 1è™Ÿ åˆ° 2è™Ÿï¼Œå†å¾ 3è™Ÿ çŒœçŒœçœ‹ 4è™Ÿ çš„ä½ç½®ï¼
                            </div>
                        </div>`,
                    steps: [
                        {
                            instruction: "ç¬¬ä¸€æ­¥ï¼šè§€å¯Ÿä¸Šé¢é€™æ’ç£ç£šï¼Œç´«è‰²æ–¹å¡Šçš„ä½ç½®è¦å¾‹æ˜¯ä»€éº¼ï¼Ÿ",
                            template: `è¦å¾‹æ˜¯ï¼š${A.name}ã€[slot]ã€${A.name}ã€[slot]ã€‚`,
                            options: options, answers: [B.name, B.name],
                            remediation: {
                                errorMsg: "å“å‘€ï¼æ–¹å‘å¥½åƒçœ‹éŒ¯å›‰ã€‚", hint: "è«‹ä»”ç´°çœ‹ç¬¬ 2 å¡Šç£ç£šçš„ç´«è‰²æ–¹å¡Šï¼Œå®ƒä½åœ¨æ ¼å­çš„ã€Œå·¦é‚Šã€é‚„æ˜¯ã€Œå³é‚Šã€ï¼Ÿã€Œä¸Šé¢ã€é‚„æ˜¯ã€Œä¸‹é¢ã€å‘¢ï¼Ÿ",
                                practice: [{ q: "å¦‚æœåœ–æ¡ˆè¦å¾‹æ˜¯ã€Œä¸Šã€ä¸‹ã€ä¸Šã€ä¸‹ã€ï¼Œä¸‹ä¸€å€‹æ˜¯ä»€éº¼æ–¹å‘ï¼Ÿ", opts: ["ä¸Š", "ä¸‹", "å·¦", "å³"], a: "ä¸Š" }, { q: "å¦‚æœé¡è‰²è¦å¾‹æ˜¯ã€Œç´…ã€è—ã€ç´…ã€è—ã€ï¼Œä¸‹ä¸€å€‹æ˜¯ä»€éº¼é¡è‰²ï¼Ÿ", opts: ["ç´…", "è—", "é»ƒ", "ç¶ "], a: "ç´…" }]
                            }
                        }
                    ]
                };
            },
            // ç¬¬ 2 é—œï¼šæ•¸å­—è¡¨æ ¼çš„è¦å¾‹ï¼ˆéš¨æ©Ÿè¡Œæ•¸ 4~6ï¼‰
            function() {
                const cols = Math.floor(Math.random() * 3) + 4; // 4 to 6
                let tableHTML = `<table class="w-full text-center border-collapse border border-gray-300 bg-white mb-4">`;
                for(let r=0; r<3; r++) {
                    tableHTML += `<tr class="${r%2===0?'bg-gray-100':''} ">`;
                    for(let c=1; c<=cols; c++) {
                        const val = r*cols + c;
                        tableHTML += `<td class="border p-2 ${c === cols ? 'font-bold text-blue-600' : ''}">${val}</td>`;
                    }
                    tableHTML += `</tr>`;
                }
                tableHTML += `</table>`;
                
                const opts1 = shuffle([cols.toString(), (cols-1).toString(), (cols+1).toString(), (cols+2).toString()]);
                const opts2 = shuffle([cols.toString(), (cols-1).toString(), (cols+1).toString(), (cols+2).toString()]);

                return {
                    id: 2, title: "ç¬¬ 2 é—œï¼šæ•¸å­—è¡¨æ ¼çš„è¦å¾‹",
                    concept: "åœ¨é€£çºŒæ•¸å­—çš„è¡¨æ ¼ä¸­ï¼Œæ¯ä¸€åˆ—çš„æ•¸é‡å›ºå®šæ™‚ï¼Œæœ€å³é‚Šé‚£è¡Œé€šå¸¸æœƒæ˜¯è©²æ•¸é‡çš„ã€Œå€æ•¸ã€ã€‚",
                    content: `<p class="mb-4">å°‡ 1 åˆ° ${cols*3} æŒ‰ç…§é †åºå¡«å…¥è¡¨æ ¼ä¸­ï¼Œè§€å¯Ÿæœ‰ä»€éº¼è¦å¾‹ï¼š</p>${tableHTML}`,
                    steps: [
                        {
                            instruction: "ç¬¬ä¸€æ­¥ï¼šç®—ç®—çœ‹ï¼Œè¡¨æ ¼ä¸­ã€Œæ¯ä¸€æ©«åˆ—ã€å…±æœ‰å¹¾å€‹æ•¸å­—ï¼Ÿ",
                            template: "æ¯ä¸€åˆ—éƒ½æœ‰ [slot] å€‹æ•¸å­—ã€‚", options: opts1, answers: [cols.toString()],
                            remediation: {
                                errorMsg: "æ•¸é‡çš„è§€å¯Ÿä¸å°å–”ï¼", hint: `è«‹å¾æœ€å·¦é‚Šçš„ 1 é–‹å§‹å¾€å³æ•¸åˆ° ${cols}ï¼Œç¸½å…±ç¶“éäº†å¹¾å€‹æ ¼å­å‘¢ï¼Ÿ`,
                                practice: [{ q: `å¾ 1 æ•¸åˆ° ${cols}ï¼Œç¸½å…±æœ‰å¹¾å€‹æ•¸å­—ï¼Ÿ`, opts: [`${cols-1}å€‹`, `${cols}å€‹`, `${cols+1}å€‹`], a: `${cols}å€‹` }, { q: "å¦‚æœä¸€åˆ—æ’ 3 å€‹è˜‹æœï¼Œé€™åˆ—ç¸½å…±æœ‰å¹¾å€‹è˜‹æœï¼Ÿ", opts: ["2å€‹", "3å€‹", "4å€‹"], a: "3å€‹" }]
                            }
                        },
                        {
                            instruction: `ç¬¬äºŒæ­¥ï¼šè§€å¯Ÿæœ€å³é‚Šç›´è¡Œï¼ˆ${cols}, ${cols*2}, ${cols*3}ï¼‰ï¼Œå®ƒå€‘æ˜¯ä»€éº¼æ•¸å­—çš„å€æ•¸ï¼Ÿ`,
                            template: "æœ€å¾Œä¸€è¡Œçš„æ•¸å­—éƒ½æ˜¯ [slot] çš„å€æ•¸ã€‚", options: opts2, answers: [cols.toString()],
                            remediation: {
                                errorMsg: "å€æ•¸æ‰¾éŒ¯å›‰ï¼", hint: `${cols}çš„å€æ•¸æœ‰ ${cols}, ${cols*2}, ${cols*3}...ï¼Œä»”ç´°çœ‹çœ‹æœ€å¾Œä¸€è¡Œçš„æ•¸å­—æ˜¯ä¸æ˜¯éƒ½ç¬¦åˆå‘¢ï¼Ÿ`,
                                practice: [{ q: `è«‹å• ${cols*2} æ˜¯èª°çš„å€æ•¸ï¼Ÿ`, opts: [(cols-1).toString(), cols.toString(), (cols+1).toString()], a: cols.toString() }, { q: `è«‹å• ${cols*3} æ˜¯èª°çš„å€æ•¸ï¼Ÿ`, opts: [(cols-2).toString(), cols.toString(), (cols+2).toString()], a: cols.toString() }]
                            }
                        }
                    ]
                };
            },
            // ç¬¬ 3 é—œï¼šæœˆæ›†çš„è¦å¾‹ï¼ˆéš¨æ©Ÿæœˆä»½ã€æ—¥æœŸèˆ‡æ¨ç®—æ–¹å‘ï¼‰
            function() {
                const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                const startIdx = Math.floor(Math.random() * 5) + 1; // 1 to 5
                const dir = Math.random() > 0.5 ? 1 : -1;
                const targetIdx = startIdx + dir;
                const date = Math.floor(Math.random() * 15) + 10;
                const targetDate = date + dir;
                const month = Math.floor(Math.random() * 12) + 1;
                const dirText = dir === 1 ? 'éš”å¤©' : 'æ˜¨å¤©';

                let tableHTML = `<table class="w-full text-center border-collapse border border-gray-300 bg-white mb-4 shadow-sm"><tr class="bg-yellow-100">`;
                for(let i=0; i<7; i++) tableHTML += `<th class="border p-2 ${i===0||i===6?'text-red-500':''} ${i===startIdx||i===targetIdx?'font-bold text-blue-800':''}">${dayNames[i]}</th>`;
                tableHTML += `</tr><tr>`;
                for(let i=0; i<7; i++) tableHTML += `<td class="border p-2 text-gray-300 bg-gray-50">...</td>`;
                tableHTML += `</tr><tr>`;
                for(let i=0; i<7; i++) {
                    if (i === startIdx) tableHTML += `<td class="border p-3 text-xl font-black text-gray-800 bg-blue-50 border-2 border-blue-200">${date}</td>`;
                    else if (i === targetIdx) tableHTML += `<td class="border p-3 text-xl font-black text-blue-600 border-2 border-blue-400 border-dashed animate-pulse">${targetDate}</td>`;
                    else tableHTML += `<td class="border p-2 text-gray-300 bg-gray-50">...</td>`;
                }
                tableHTML += `</tr></table>`;

                const opts3 = shuffle([dayNames[targetIdx], dayNames[(targetIdx+1)%7], dayNames[(targetIdx+2)%7], dayNames[(targetIdx+6)%7]]);

                return {
                    id: 3, title: "ç¬¬ 3 é—œï¼šæœˆæ›†çš„è¦å¾‹",
                    concept: "æœˆæ›†ä¸­ã€Œå·¦å³ã€ç›¸é„°çš„æ—¥å­ç›¸å·® 1 å¤©ï¼Œã€Œä¸Šä¸‹ã€ç›¸é„°çš„æ—¥å­ç›¸å·® 7 å¤©ï¼ˆä¸€æ˜ŸæœŸï¼‰ã€‚",
                    content: `
                        <p class="mb-4 text-gray-800">æœˆæ›†ä¸­è—è‘—å¥½ç©çš„æ•¸å­—è¦å¾‹ï¼è«‹å…ˆè§€å¯Ÿé€™å¡Š <mark>ä¹¾æ·¨çš„æœˆæ›†</mark> ç¢ç‰‡ï¼š</p>
                        <div class="bg-blue-50 p-6 rounded-2xl flex justify-center items-center mb-8 border-2 border-blue-200 shadow-inner mt-8">
                            <div class="relative w-48 h-48 md:w-56 md:h-56">
                                <div class="absolute top-0 left-0 w-16 h-16 md:w-20 md:h-20 bg-white border-4 border-gray-400 rounded-xl flex items-center justify-center text-2xl md:text-3xl font-black shadow-md z-10 text-gray-700">8</div>
                                <div class="absolute top-0 right-0 w-16 h-16 md:w-20 md:h-20 bg-white border-4 border-gray-400 rounded-xl flex items-center justify-center text-2xl md:text-3xl font-black shadow-md z-10 text-gray-700">9</div>
                                <div class="absolute bottom-0 left-0 w-16 h-16 md:w-20 md:h-20 bg-white border-4 border-gray-400 rounded-xl flex items-center justify-center text-2xl md:text-3xl font-black shadow-md z-10 text-gray-700">15</div>
                                <div class="absolute bottom-0 right-0 w-16 h-16 md:w-20 md:h-20 bg-white border-4 border-gray-400 rounded-xl flex items-center justify-center text-2xl md:text-3xl font-black shadow-md z-10 text-gray-700">16</div>
                                <svg class="absolute top-6 left-16 md:top-8 md:left-20 w-16 md:w-16 h-4 text-blue-500 z-0" fill="none" stroke="currentColor" viewBox="0 0 100 20" preserveAspectRatio="none"><line x1="0" y1="10" x2="80" y2="10" stroke-width="8" stroke-dasharray="8,8" /><polygon points="80,0 100,10 80,20" fill="currentColor" stroke="none" /></svg>
                                <div class="absolute -top-4 left-1/2 transform -translate-x-1/2 bg-blue-100 text-blue-800 text-sm font-bold px-3 py-1 rounded-full border border-blue-200 shadow-sm z-20 whitespace-nowrap">å·¦å³å·® 1 å¤©</div>
                                <svg class="absolute top-16 left-6 md:top-20 md:left-8 w-4 h-16 md:h-16 text-green-500 z-0" fill="none" stroke="currentColor" viewBox="0 0 20 100" preserveAspectRatio="none"><line x1="10" y1="0" x2="10" y2="80" stroke-width="8" stroke-dasharray="8,8" /><polygon points="0,80 10,100 20,80" fill="currentColor" stroke="none" /></svg>
                                <div class="absolute top-1/2 -left-4 transform -translate-y-1/2 -translate-x-full bg-green-100 text-green-800 text-sm font-bold px-3 py-1 rounded-full border border-green-200 shadow-sm z-20 whitespace-nowrap">ä¸Šä¸‹å·® 7 å¤©</div>
                            </div>
                        </div>
                        <p class="mb-4 text-gray-800">æ¥è‘—ï¼Œé€™æ˜¯ä¸€å¼µè¢«å¼„é«’çš„ <mark>${month}æœˆ</mark> æœˆæ›†ã€‚å¦‚æœ ${month}æœˆ${date}æ—¥ æ˜¯æ˜ŸæœŸ${dayNames[startIdx]}ï¼Œè«‹é‹ç”¨è¦å¾‹æ‰¾å‡º<mark>${dirText}</mark>çš„æ˜ŸæœŸï¼</p>
                        ${tableHTML}
                    `,
                    steps: [
                        {
                            instruction: "ç¬¬ä¸€æ­¥ï¼šåœ¨æœˆæ›†ä¸Šï¼Œå·¦å³ç›¸é„°ï¼ˆæ˜¨å¤©èˆ‡ä»Šå¤©ï¼‰çš„æ—¥å­ï¼Œç›¸å·®å¹¾å¤©ï¼Ÿ",
                            template: "å·¦å³å…©é‚Šçš„æ•¸å­—ç›¸å·® [slot] å¤©ã€‚", options: ["1", "5", "7", "30"], answers: ["1"],
                            remediation: { errorMsg: "å¤©æ•¸ç›¸å·®ç®—éŒ¯å›‰ï¼", hint: "å·¦å³ç›¸é„°çš„æ—¥å­ï¼Œæ—¥æœŸåªæœƒç›¸å·®ã€Œ1ã€å¤©å–”ï¼", practice: [{ q: "3è™Ÿçš„æ˜å¤©æ˜¯å¹¾è™Ÿï¼Ÿ", opts: ["2è™Ÿ", "4è™Ÿ", "10è™Ÿ"], a: "4è™Ÿ" }, { q: "15è™Ÿçš„æ˜¨å¤©æ˜¯å¹¾è™Ÿï¼Ÿ", opts: ["14è™Ÿ", "16è™Ÿ", "20è™Ÿ"], a: "14è™Ÿ" }] }
                        },
                        {
                            instruction: "ç¬¬äºŒæ­¥ï¼šåœ¨æœˆæ›†ä¸Šï¼Œä¸Šä¸‹ç›¸é„°ï¼ˆä¸Šé€±èˆ‡é€™é€±ï¼‰çš„æ—¥å­ï¼Œç›¸å·®å¹¾å¤©ï¼Ÿ",
                            template: "ä¸Šä¸‹å…©æ’çš„æ•¸å­—ç›¸å·® [slot] å¤©ã€‚", options: ["1", "5", "7", "30"], answers: ["7"],
                            remediation: { errorMsg: "å¤©æ•¸ç›¸å·®ç®—éŒ¯å›‰ï¼", hint: "ä¸€å€‹æ˜ŸæœŸæœ‰ 7 å¤©ï¼Œæ‰€ä»¥åŒä¸€å€‹æ˜ŸæœŸå¹¾çš„æ—¥æœŸï¼Œä¸Šä¸‹æœƒå‰›å¥½ç›¸å·® 7 å–”ï¼", practice: [{ q: "8è™Ÿçš„ä¸‹å€‹æ˜ŸæœŸåŒä¸€å¤©æ˜¯å¹¾è™Ÿï¼Ÿ", opts: ["9è™Ÿ", "15è™Ÿ", "20è™Ÿ"], a: "15è™Ÿ" }, { q: "20è™Ÿçš„ä¸Šå€‹æ˜ŸæœŸåŒä¸€å¤©æ˜¯å¹¾è™Ÿï¼Ÿ", opts: ["13è™Ÿ", "19è™Ÿ", "27è™Ÿ"], a: "13è™Ÿ" }] }
                        },
                        {
                            instruction: `ç¬¬ä¸‰æ­¥ï¼šå¦‚æœ ${month}æœˆ${date}æ—¥æ˜¯æ˜ŸæœŸ${dayNames[startIdx]}ï¼Œé‚£ç›¸å·®ä¸€å¤©çš„ ${month}æœˆ${targetDate}æ—¥ æ˜¯æ˜ŸæœŸå¹¾ï¼Ÿ`,
                            template: `${month}æœˆ${targetDate}æ—¥æ˜¯åœ¨ æ˜ŸæœŸ[slot]ã€‚`, options: opts3, answers: [dayNames[targetIdx]],
                            remediation: { errorMsg: "æ˜ŸæœŸæ¨ç®—éŒ¯èª¤å›‰ï¼", hint: `æ˜ŸæœŸ${dayNames[startIdx]}çš„${dirText}ï¼Œå°±æ˜¯æ˜ŸæœŸ${dayNames[targetIdx]}å–”ï¼`, practice: [{ q: "æ˜ŸæœŸä¸€çš„éš”å¤©æ˜¯æ˜ŸæœŸå¹¾ï¼Ÿ", opts: ["æ˜ŸæœŸäºŒ", "æ˜ŸæœŸä¸‰"], a: "æ˜ŸæœŸäºŒ" }, { q: "æ˜ŸæœŸäº”çš„æ˜¨å¤©æ˜¯æ˜ŸæœŸå¹¾ï¼Ÿ", opts: ["æ˜ŸæœŸå››", "æ˜ŸæœŸå…­"], a: "æ˜ŸæœŸå››" }] }
                        }
                    ]
                };
            },
            // ç¬¬ 4 é—œï¼šç«è»Šåº§ä½çš„è¦å¾‹ï¼ˆéš¨æ©ŸæŒ‡å®šé çª—æˆ–é èµ°é“çš„é›™è™Ÿåº§ä½ï¼‰
            function() {
                const isWindow = Math.random() > 0.5;
                const base = Math.floor(Math.random() * 6) + 4; // 4 to 9
                const seat = isWindow ? (base * 4 + 2) : (base * 4);
                const ansLoc = isWindow ? 'çª—æˆ¶' : 'èµ°é“';
                const tmpl = isWindow ? `${seat} é™¤ä»¥ 4 é¤˜æ•¸æ˜¯ 2ï¼Œæ‰€ä»¥æ˜¯é  [slot] ã€‚` : `${seat} é™¤ä»¥ 4 æ²’æœ‰é¤˜æ•¸ï¼Œæ‰€ä»¥æ˜¯é  [slot] ã€‚`;
                
                return {
                    id: 4, title: "ç¬¬ 4 é—œï¼šç«è»Šåº§ä½çš„è¦å¾‹",
                    concept: "åº§ä½è¦å¾‹ç¶“å¸¸èˆ‡ã€Œé™¤æ³•èˆ‡é¤˜æ•¸ã€æœ‰é—œã€‚è‹¥æ¯ 4 å€‹åº§ä½ä¸€æ’ï¼Œå¯ä»¥åˆ©ç”¨ã€Œé™¤ä»¥ 4 çš„é¤˜æ•¸ã€ä¾†åˆ¤æ–·ä½ç½®ï¼",
                    content: `
                        <p class="mb-4 text-gray-800">ç«è»Šåº§ä½è™Ÿç¢¼æ¯ <mark>4å€‹æ•¸å­—ä¸€åˆ—</mark>ã€‚è«‹è§€å¯Ÿã€Œé›™è™Ÿã€çš„åº§ä½æ’åˆ—ï¼š</p>
                        <div class="bg-gray-100 p-6 rounded-2xl flex flex-col items-center mb-6">
                            <div class="flex items-stretch w-full max-w-sm justify-center bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-200">
                                <div class="flex flex-col gap-3 py-2 pr-4 md:pr-6 border-r-2 border-gray-100">
                                    <div class="text-xs font-bold text-gray-400 text-center mb-2">å–®è™Ÿå€</div>
                                    <div class="flex gap-2"><div class="w-12 h-12 bg-gray-50 rounded-md flex items-center justify-center text-gray-400 font-bold border border-gray-100">1</div><div class="w-12 h-12 bg-gray-50 rounded-md flex items-center justify-center text-gray-400 font-bold border border-gray-100">3</div></div>
                                    <div class="flex gap-2"><div class="w-12 h-12 bg-gray-50 rounded-md flex items-center justify-center text-gray-400 font-bold border border-gray-100">5</div><div class="w-12 h-12 bg-gray-50 rounded-md flex items-center justify-center text-gray-400 font-bold border border-gray-100">7</div></div>
                                    <div class="flex gap-2"><div class="w-12 h-12 bg-gray-50 rounded-md flex items-center justify-center text-gray-400 font-bold border border-gray-100">9</div><div class="w-12 h-12 bg-gray-50 rounded-md flex items-center justify-center text-gray-400 font-bold border border-gray-100">11</div></div>
                                </div>
                                <div class="flex items-center justify-center px-2 md:px-4"><span class="text-gray-400 font-bold tracking-widest" style="writing-mode: vertical-rl;">èµ°é“</span></div>
                                <div class="flex flex-col gap-3 py-2 pl-4 md:pl-6 border-l-2 border-gray-100">
                                    <div class="text-xs font-bold text-blue-600 text-center mb-2">é›™è™Ÿå€</div>
                                    <div class="flex gap-2"><div class="w-12 h-12 bg-blue-100 border-2 border-blue-500 rounded-md flex items-center justify-center text-blue-700 font-black text-xl shadow-sm">4</div><div class="w-12 h-12 bg-gray-50 rounded-md flex items-center justify-center text-gray-400 font-bold border border-gray-100">2</div></div>
                                    <div class="flex gap-2"><div class="w-12 h-12 bg-blue-100 border-2 border-blue-500 rounded-md flex items-center justify-center text-blue-700 font-black text-xl shadow-sm">8</div><div class="w-12 h-12 bg-gray-50 rounded-md flex items-center justify-center text-gray-400 font-bold border border-gray-100">6</div></div>
                                    <div class="flex gap-2"><div class="w-12 h-12 bg-blue-100 border-2 border-blue-500 rounded-md flex items-center justify-center text-blue-700 font-black text-xl shadow-sm">12</div><div class="w-12 h-12 bg-gray-50 rounded-md flex items-center justify-center text-gray-400 font-bold border border-gray-100">10</div></div>
                                </div>
                            </div>
                            <div class="mt-5 text-gray-700 font-bold text-center">
                                æ³¨æ„çœ‹ <mark class="bg-blue-100 text-blue-800">4, 8, 12...</mark> éƒ½åœ¨é èµ°é“çš„ä½ç½®å–”ï¼
                            </div>
                        </div>
                    `,
                    steps: [
                        {
                            instruction: "ç¬¬ä¸€æ­¥ï¼šè§€å¯Ÿ 4, 8, 12 é€™äº›è™Ÿç¢¼ï¼Œå®ƒå€‘éƒ½æ˜¯èª°çš„å€æ•¸ï¼Ÿ",
                            template: "é›™è™Ÿé èµ°é“çš„åº§ä½è™Ÿç¢¼éƒ½æ˜¯ [slot] çš„å€æ•¸ã€‚", options: ["2", "3", "4", "5"], answers: ["4"],
                            remediation: { errorMsg: "å€æ•¸è§€å¯Ÿæœ‰èª¤å–”ï¼", hint: "4, 8, 12 éƒ½èƒ½è¢« 4 æ•´é™¤ï¼ˆé™¤ä»¥ 4 æ²’æœ‰é¤˜æ•¸ï¼‰ï¼Œæ‰€ä»¥å®ƒå€‘éƒ½æ˜¯ 4 çš„å€æ•¸ã€‚", practice: [{ q: "è«‹å• 8 æ˜¯èª°çš„å€æ•¸ï¼Ÿ", opts: ["3", "4", "5"], a: "4" }, { q: "è«‹å• 16 æ˜¯èª°çš„å€æ•¸ï¼Ÿ", opts: ["4", "5", "6"], a: "4" }] }
                        },
                        {
                            instruction: `ç¬¬äºŒæ­¥ï¼šè© å®‰çš„åº§ä½æ˜¯ ${seat} è™Ÿï¼Œåˆ¤æ–·å¥¹æ˜¯é çª—æˆ¶é‚„æ˜¯é èµ°é“ï¼Ÿ`,
                            template: tmpl, options: ["çª—æˆ¶", "èµ°é“", "è»Šé–€", "å»æ‰€"], answers: [ansLoc],
                            remediation: { errorMsg: "åº§ä½ä½ç½®åˆ¤æ–·éŒ¯å›‰ï¼", hint: "æˆ‘å€‘ç™¼ç¾ã€Œæ²’æœ‰é¤˜æ•¸(4çš„å€æ•¸)ã€çš„æ˜¯ã€Œèµ°é“ã€ï¼Œè€Œã€Œé¤˜æ•¸æ˜¯2ã€çš„æ˜¯ã€Œé çª—æˆ¶ã€å–”ï¼", practice: [{ q: "20 é™¤ä»¥ 4 æ²’æœ‰é¤˜æ•¸ï¼Œè«‹å• 20 è™Ÿé å“ªè£¡ï¼Ÿ", opts: ["çª—æˆ¶", "èµ°é“"], a: "èµ°é“" }, { q: "30 é™¤ä»¥ 4 é¤˜æ•¸æ˜¯ 2ï¼Œè«‹å• 30 è™Ÿé å“ªè£¡ï¼Ÿ", opts: ["çª—æˆ¶", "èµ°é“"], a: "çª—æˆ¶" }] }
                        }
                    ]
                };
            },
            // ç¬¬ 5 é—œï¼šå¥‡å¶æ•¸çš„é‹ç®—è¦å¾‹ï¼ˆéš¨æ©Ÿç”¢ç”Ÿå¤§æ•¸å­—é‹ç®—ï¼‰
            function() {
                const op1IsAdd = Math.random() > 0.5;
                const t1_odd1 = Math.random() > 0.5;
                const t1_odd2 = Math.random() > 0.5;
                const num1 = Math.floor(Math.random()*80000)+10000;
                const num2 = Math.floor(Math.random()*80000)+10000;
                const finalNum1 = (num1 % 2 === (t1_odd1 ? 1 : 0)) ? num1 : num1 + 1;
                const finalNum2 = (num2 % 2 === (t1_odd2 ? 1 : 0)) ? num2 : num2 + 1;
                
                const n1Type = t1_odd1 ? "å¥‡æ•¸" : "å¶æ•¸";
                const n2Type = t1_odd2 ? "å¥‡æ•¸" : "å¶æ•¸";
                const res1Odd = op1IsAdd ? (t1_odd1 !== t1_odd2) : (t1_odd1 !== t1_odd2);
                const res1Type = res1Odd ? "å¥‡æ•¸" : "å¶æ•¸";
                
                const t2_odd1 = Math.random() > 0.5;
                const t2_odd2 = Math.random() > 0.5;
                const num3 = Math.floor(Math.random()*800)+100;
                const num4 = Math.floor(Math.random()*800)+100;
                const finalNum3 = (num3 % 2 === (t2_odd1 ? 1 : 0)) ? num3 : num3 + 1;
                const finalNum4 = (num4 % 2 === (t2_odd2 ? 1 : 0)) ? num4 : num4 + 1;
                
                const n3Type = t2_odd1 ? "å¥‡æ•¸" : "å¶æ•¸";
                const n4Type = t2_odd2 ? "å¥‡æ•¸" : "å¶æ•¸";
                const res2Odd = t2_odd1 && t2_odd2;
                const res2Type = res2Odd ? "å¥‡æ•¸" : "å¶æ•¸";
                
                const op1Sign = op1IsAdd ? '+' : '-';
                const op1Name = op1IsAdd ? 'åŠ æ³•' : 'æ¸›æ³•';
                const ex1 = op1IsAdd ? (t1_odd1&&t1_odd2?"3 + 5 = 8":(!t1_odd1&&!t1_odd2?"2 + 4 = 6":t1_odd1?"3 + 2 = 5":"2 + 3 = 5")) : (t1_odd1&&t1_odd2?"5 - 3 = 2":(!t1_odd1&&!t1_odd2?"6 - 2 = 4":t1_odd1?"5 - 2 = 3":"6 - 3 = 3"));
                const ex2 = (t2_odd1&&t2_odd2)?"3 Ã— 3 = 9":((!t2_odd1&&!t2_odd2)?"2 Ã— 2 = 4":(t2_odd1?"3 Ã— 2 = 6":"2 Ã— 3 = 6"));

                return {
                    id: 5, title: "ç¬¬ 5 é—œï¼šå¥‡å¶æ•¸çš„é‹ç®—è¦å¾‹",
                    concept: "åˆ¤æ–·åŠ æ¸›ä¹˜é™¤çš„çµæœæ˜¯å¥‡æ•¸æˆ–å¶æ•¸æ™‚ï¼Œåªè¦çœ‹æ•¸å­—çš„ã€Œå€‹ä½æ•¸ã€ï¼Œä¸¦èˆ‰ç°¡å–®çš„ä¾‹å­ï¼ˆä¾‹å¦‚ï¼š3+2=5ï¼‰å°±èƒ½å¿«é€Ÿåˆ¤æ–·ï¼",
                    content: `<p class="mb-4">è«‹è§€å¯Ÿç®—å¼ï¼š<mark>${finalNum1} ${op1Sign} ${finalNum2}</mark> åŠ <mark>${finalNum3} Ã— ${finalNum4}</mark>ï¼Œåˆ¤æ–·çµæœæ˜¯å¥‡æ•¸é‚„æ˜¯å¶æ•¸ã€‚</p>`,
                    steps: [
                        {
                            instruction: `ç¬¬ä¸€æ­¥ï¼šåˆ¤æ–· ${finalNum1} å’Œ ${finalNum2} åˆ†åˆ¥æ˜¯å¥‡æ•¸é‚„æ˜¯å¶æ•¸ï¼Ÿ`,
                            template: `${finalNum1} çš„å€‹ä½æ•¸æ˜¯ ${finalNum1%10}ï¼Œå®ƒæ˜¯ [slot]ï¼›${finalNum2} çš„å€‹ä½æ•¸æ˜¯ ${finalNum2%10}ï¼Œå®ƒæ˜¯ [slot]ã€‚`,
                            options: ["å¥‡æ•¸", "å¶æ•¸", "å¥‡æ•¸", "å¶æ•¸"], answers: [n1Type, n2Type],
                            remediation: { errorMsg: "å¥‡å¶æ•¸åˆ¤æ–·éŒ¯å›‰ï¼", hint: "çœ‹æ•¸å­—çš„ã€Œå€‹ä½æ•¸ã€ã€‚1,3,5,7,9 æ˜¯å¥‡æ•¸ï¼›0,2,4,6,8 æ˜¯å¶æ•¸ã€‚", practice: [{ q: "è«‹å• 135 æ˜¯å¥‡æ•¸é‚„æ˜¯å¶æ•¸ï¼Ÿ", opts: ["å¥‡æ•¸", "å¶æ•¸"], a: "å¥‡æ•¸" }, { q: "è«‹å• 42 æ˜¯å¥‡æ•¸é‚„æ˜¯å¶æ•¸ï¼Ÿ", opts: ["å¥‡æ•¸", "å¶æ•¸"], a: "å¶æ•¸" }] }
                        },
                        {
                            instruction: `ç¬¬äºŒæ­¥ï¼šæ ¹æ“š${op1Name}è¦å¾‹ï¼Œ${n1Type} ${op1Sign} ${n2Type} çš„çµæœæ˜¯ä»€éº¼ï¼Ÿ`,
                            template: `${n1Type} ${op1Sign} ${n2Type} = [slot]ã€‚ï¼ˆæƒ³ä¸€æƒ³ ${ex1}ï¼‰`,
                            options: ["å¥‡æ•¸", "å¶æ•¸"], answers: [res1Type],
                            remediation: { errorMsg: `${op1Name}è¦å¾‹è¨˜éŒ¯å›‰ï¼`, hint: `${n1Type}${op1Name}${n2Type}ï¼Œçµæœæœƒæ˜¯${res1Type}ï¼å¯ä»¥è‡ªå·±èˆ‰å€‹ä¾‹å­ï¼š${ex1}ã€‚`, practice: [{ q: `5(å¥‡æ•¸) ${op1Sign} 4(å¶æ•¸) çš„çµæœæ˜¯å¥‡æ•¸é‚„æ˜¯å¶æ•¸ï¼Ÿ`, opts: ["å¥‡æ•¸", "å¶æ•¸"], a: "å¥‡æ•¸" }, { q: `6(å¶æ•¸) ${op1Sign} 2(å¶æ•¸) çš„çµæœæ˜¯å¥‡æ•¸é‚„æ˜¯å¶æ•¸ï¼Ÿ`, opts: ["å¥‡æ•¸", "å¶æ•¸"], a: "å¶æ•¸" }] }
                        },
                        {
                            instruction: `ç¬¬ä¸‰æ­¥ï¼šæ ¹æ“šä¹˜æ³•è¦å¾‹ï¼Œ${finalNum3}(${n3Type[0]}) Ã— ${finalNum4}(${n4Type[0]}) çš„çµæœæ˜¯ä»€éº¼ï¼Ÿ`,
                            template: `${n3Type} Ã— ${n4Type} = [slot]ã€‚ï¼ˆæƒ³ä¸€æƒ³ ${ex2}ï¼‰`,
                            options: ["å¥‡æ•¸", "å¶æ•¸"], answers: [res2Type],
                            remediation: { errorMsg: "ä¹˜æ³•è¦å¾‹è¨˜éŒ¯å›‰ï¼", hint: `${n3Type}ä¹˜ä»¥${n4Type}ï¼Œçµæœæœƒæ˜¯${res2Type}ï¼å¯ä»¥èˆ‰å€‹ä¾‹å­ï¼š${ex2}ã€‚`, practice: [{ q: "5(å¥‡æ•¸) Ã— 5(å¥‡æ•¸) çš„çµæœæ˜¯å¥‡æ•¸é‚„æ˜¯å¶æ•¸ï¼Ÿ", opts: ["å¥‡æ•¸", "å¶æ•¸"], a: "å¥‡æ•¸" }, { q: "7(å¥‡æ•¸) Ã— 4(å¶æ•¸) çš„çµæœæ˜¯å¥‡æ•¸é‚„æ˜¯å¶æ•¸ï¼Ÿ", opts: ["å¥‡æ•¸", "å¶æ•¸"], a: "å¶æ•¸" }] }
                        }
                    ]
                };
            }
        ];

        let quizData = [];

        // --- Global State ---
        let currentQuestionIndex = 0;
        let activeStepIndex = 0;
        let globalScore = 0;
        let currentQuestionScore = 0;
        let stepStartTime = Date.now();
        
        // Track remediation status: { stepIdx: { p1Passed: bool, p2Passed: bool, triggered: bool } }
        let remediationState = {};

        // --- Initialization ---
        window.onload = () => {
            // åˆå§‹æ™‚ç”Ÿæˆæ‰€æœ‰é—œå¡çš„äº‚æ•¸é¡Œç›®
            quizData = levelGenerators.map(gen => gen());
            renderNavbar();
            loadQuestion(0);
        };

        // --- TTS Helper ---
        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                // ç§»é™¤ HTML æ¨™ç±¤å¾Œæœ—è®€
                const cleanText = text.replace(/<[^>]*>?/gm, '').replace(/\[slot\]/g, "ç©ºæ ¼");
                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.lang = 'zh-TW';
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            }
        }

        function speakCurrentQuestion() {
            const q = quizData[currentQuestionIndex];
            speak(q.title + "ã€‚" + q.content);
        }

        // --- Render UI ---
        function renderNavbar() {
            const navContainer = document.getElementById('nav-buttons');
            navContainer.innerHTML = '';
            
            quizData.forEach((q, idx) => {
                const btn = document.createElement('button');
                btn.className = `px-5 py-2 rounded-full font-bold transition whitespace-nowrap ${idx === currentQuestionIndex ? 'bg-green-600 text-white shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-green-100 hover:text-green-700'}`;
                btn.innerText = `é—œå¡ ${idx + 1}`;
                btn.onclick = () => loadQuestion(idx);
                navContainer.appendChild(btn);
            });
        }

        function loadQuestion(index) {
            currentQuestionIndex = index;
            activeStepIndex = 0;
            currentQuestionScore = 0;
            remediationState = {};
            stepStartTime = Date.now();
            
            // æ¯æ¬¡è¼‰å…¥é—œå¡æ™‚ï¼Œè‡ªå‹•é‡æ–°æŠ½å–åƒæ•¸ç”¢ç”Ÿæ–°é¡Œç›®
            quizData[currentQuestionIndex] = levelGenerators[currentQuestionIndex]();
            
            renderNavbar();
            
            const q = quizData[currentQuestionIndex];
            document.getElementById('q-title').innerText = q.title;
            document.getElementById('q-content').innerHTML = q.content;
            document.getElementById('q-concept').classList.remove('hidden');
            document.getElementById('q-concept-text').innerText = q.concept;

            const stepsPanel = document.getElementById('steps-panel');
            stepsPanel.innerHTML = '';

            // æ¸²æŸ“æ‰€æœ‰æ­¥é©Ÿï¼Œä½†é è¨­éš±è—é™¤äº†ç¬¬ä¸€æ­¥ä»¥å¤–çš„
            q.steps.forEach((step, sIdx) => {
                const stepEl = createStepElement(q, sIdx);
                stepsPanel.appendChild(stepEl);
                if (sIdx > 0) stepEl.classList.add('hidden');
            });
            
            // å–æ¶ˆæ­¤è™•çš„ speakCurrentQuestion(); ç¢ºä¿ç”±å­¸ç”Ÿä¸»å‹•é»é¸æ‰ç™¼è²
        }

        function createStepElement(question, sIdx) {
            const step = question.steps[sIdx];
            const div = document.createElement('div');
            div.className = "step-container bg-white rounded-2xl shadow-md border border-gray-100 p-6";
            div.id = `step-container-${sIdx}`;

            // æ›¿æ› Template è®Šæˆ HTML slot
            let templateHtml = step.template;
            let slotIndex = 0;
            while(templateHtml.includes('[slot]')) {
                templateHtml = templateHtml.replace('[slot]', `<span class="slot" id="slot-${sIdx}-${slotIndex}" data-step="${sIdx}" data-idx="${slotIndex}" onclick="handleSlotClick(${sIdx}, ${slotIndex})"></span>`);
                slotIndex++;
            }

            div.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-blue-800 flex items-center gap-2">
                        <span class="bg-blue-100 text-blue-700 w-8 h-8 rounded-full flex items-center justify-center">${sIdx + 1}</span>
                        ${step.instruction}
                    </h3>
                    <div class="flex items-center gap-2">
                        <button onclick="speak('${step.instruction}')" class="text-blue-500 hover:bg-blue-100 w-10 h-10 rounded-full transition flex items-center justify-center" title="æœ—è®€æ­¥é©Ÿ">
                            ğŸ”Š
                        </button>
                        <span id="step-status-${sIdx}" class="text-green-600 font-bold hidden flex items-center gap-1 bg-green-50 px-3 py-1 rounded-full border border-green-200">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg> å®Œæˆ
                        </span>
                    </div>
                </div>
                
                <div class="text-2xl font-bold text-center my-8 text-gray-800 flex items-center justify-center flex-wrap gap-2">
                    ${templateHtml}
                </div>

                <div id="options-container-${sIdx}" class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <p class="text-sm font-bold text-gray-500 mb-3 uppercase tracking-wider">é»æ“Šä¸‹æ–¹é¸é …å¡«å…¥ï¼š</p>
                    <div class="flex flex-wrap gap-3 mb-4">
                        ${step.options.map((opt, oIdx) => `
                            <button id="opt-${sIdx}-${oIdx}" class="option-btn bg-white border-2 border-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:border-blue-500 hover:text-blue-600 flex items-center gap-2 shadow-sm" onclick="handleOptionClick(${sIdx}, ${oIdx}, '${opt}')">
                                ${opt} <span class="text-xs text-blue-400 hover:text-blue-600 ml-1" onclick="event.stopPropagation(); speak('${opt}')">ğŸ”Š</span>
                            </button>
                        `).join('')}
                    </div>
                    <button id="check-btn-${sIdx}" onclick="checkAnswer(${sIdx})" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition text-lg shadow-md flex items-center justify-center gap-2">
                        æª¢æŸ¥ç­”æ¡ˆ
                    </button>
                </div>

                <!-- éŒ¯èª¤è£œæ•‘å€åŸŸ (é è¨­éš±è—) -->
                <div id="remediation-area-${sIdx}" class="hidden mt-6 bg-red-50 border-2 border-red-200 rounded-xl p-5 shadow-inner">
                    <div class="flex items-start gap-3">
                        <div class="text-red-500 mt-1 bg-white rounded-full p-1 shadow-sm">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-red-800 text-lg mb-1 flex items-center gap-2" id="rem-error-msg-${sIdx}">
                                ${step.remediation.errorMsg}
                                <button onclick="speak('${step.remediation.errorMsg} è«‹çœ‹ä¸€ä¸‹ä¸‹æ–¹çš„å­¸ç¿’é‡é»ï¼Œä¸¦å®Œæˆå°æ¸¬é©—ï¼')" class="text-blue-500 hover:bg-red-100 p-1 rounded-full text-sm bg-white shadow-sm" title="æœ—è®€éŒ¯èª¤æç¤º">ğŸ”Š</button>
                            </h4>
                            <div class="bg-white rounded-lg p-3 border border-red-100 mb-4 mt-2">
                                <p class="text-red-700 font-bold flex items-center gap-2">
                                    ğŸ’¡ å­¸ç¿’é‡é»æé†’ï¼š
                                    <button onclick="speak('${step.remediation.hint}')" class="text-blue-500 hover:bg-red-100 p-1 rounded-full"><i class="fas fa-volume-up"></i>ğŸ”Š</button>
                                </p>
                                <p class="text-gray-700 mt-1">${step.remediation.hint}</p>
                            </div>
                            
                            <p class="font-bold text-red-800 mb-3 border-b border-red-200 pb-2">âœï¸ è«‹å…ˆå®Œæˆä»¥ä¸‹ 2 é¡Œå°æ¸¬é©—ï¼Œæ‰èƒ½å†æ¬¡æª¢æŸ¥ç­”æ¡ˆå–”ï¼š</p>
                            <div class="space-y-4">
                                ${step.remediation.practice.map((p, pIdx) => `
                                    <div id="prac-box-${sIdx}-${pIdx}" class="bg-white p-4 rounded-lg border-2 border-red-200 shadow-sm transition-colors">
                                        <p class="font-bold text-gray-800 flex items-center gap-2">
                                            Q${pIdx+1}: ${p.q}
                                            <button onclick="speak('${p.q}')" class="text-blue-500 hover:bg-gray-100 p-1 rounded-full text-sm">ğŸ”Š</button>
                                        </p>
                                        <div class="mt-3 flex gap-3">
                                            ${p.opts.map((opt, oIdx) => `
                                                <button onclick="checkPractice(${sIdx}, ${pIdx}, '${opt}')" class="px-4 py-2 bg-gray-50 hover:bg-blue-100 hover:text-blue-700 text-gray-700 font-bold rounded-lg border border-gray-300 transition">
                                                    ${opt}
                                                </button>
                                            `).join('')}
                                        </div>
                                        <div id="prac-msg-${sIdx}-${pIdx}" class="mt-2 text-sm font-bold"></div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            return div;
        }

        // --- Interaction Logic ---
        function handleOptionClick(sIdx, oIdx, text) {
            const step = quizData[currentQuestionIndex].steps[sIdx];
            for (let i = 0; i < step.answers.length; i++) {
                const slot = document.getElementById(`slot-${sIdx}-${i}`);
                if (!slot.classList.contains('filled')) {
                    slot.innerText = text;
                    slot.classList.add('filled');
                    slot.dataset.sourceOpt = oIdx;
                    
                    const optBtn = document.getElementById(`opt-${sIdx}-${oIdx}`);
                    optBtn.disabled = true;
                    optBtn.classList.add('disabled');
                    break;
                }
            }
        }

        function handleSlotClick(sIdx, slotIdx) {
            const slot = document.getElementById(`slot-${sIdx}-${slotIdx}`);
            if (slot.classList.contains('completed')) return;
            
            if (slot.classList.contains('filled')) {
                const oIdx = slot.dataset.sourceOpt;
                const optBtn = document.getElementById(`opt-${sIdx}-${oIdx}`);
                optBtn.disabled = false;
                optBtn.classList.remove('disabled');
                
                slot.innerText = '';
                slot.classList.remove('filled');
                delete slot.dataset.sourceOpt;
            }
        }

        // --- Validation & Progression ---
        function checkAnswer(sIdx) {
            const step = quizData[currentQuestionIndex].steps[sIdx];
            let allFilled = true;
            let allCorrect = true;

            for (let i = 0; i < step.answers.length; i++) {
                const slot = document.getElementById(`slot-${sIdx}-${i}`);
                if (!slot.classList.contains('filled')) {
                    allFilled = false;
                    break;
                }
                if (slot.innerText !== step.answers[i]) {
                    allCorrect = false;
                }
            }

            if (!allFilled) {
                alert("è«‹é»æ“Šä¸‹æ–¹é¸é …ï¼Œå°‡æ‰€æœ‰ç©ºæ ¼å¡«æ»¿å–”ï¼");
                // å–æ¶ˆè‡ªå‹•éŒ¯èª¤ç™¼éŸ³ï¼Œæ”¹ç”¨é è¨­ Alert è™•ç†
                return;
            }

            if (!remediationState[sIdx]) {
                remediationState[sIdx] = { triggered: false, p1: false, p2: false };
            }

            if (allCorrect) {
                handleStepSuccess(sIdx);
            } else {
                handleStepFailure(sIdx);
            }
        }

        function animateScoreFloat(points) {
            const container = document.getElementById('score-anim-container');
            const floatEl = document.createElement('div');
            floatEl.className = 'score-float';
            floatEl.innerText = `+${points}`;
            floatEl.style.left = '50%';
            floatEl.style.top = '100%';
            container.appendChild(floatEl);
            setTimeout(() => floatEl.remove(), 1500);
        }

        function handleStepSuccess(sIdx) {
            const step = quizData[currentQuestionIndex].steps[sIdx];
            const stepContainer = document.getElementById(`step-container-${sIdx}`);
            
            // --- ç©åˆ†è¨ˆç®—é‚è¼¯ (Time & Accuracy based) ---
            let timeTakenSec = Math.floor((Date.now() - stepStartTime) / 1000);
            let baseScore = remediationState[sIdx].triggered ? 40 : 100; // æœ‰éŒ¯éé™åŸºç¤åˆ†
            let timePenalty = Math.min(Math.floor(timeTakenSec / 2) * 2, 30); // æ¯2ç§’æ‰£2åˆ†ï¼Œæœ€å¤šæ‰£30åˆ†
            let pointsEarned = Math.max(baseScore - timePenalty, 10); // ä¿åº•è‡³å°‘ 10 åˆ†

            currentQuestionScore += pointsEarned;
            globalScore += pointsEarned;
            document.getElementById('global-score').innerText = globalScore;
            animateScoreFloat(pointsEarned);

            // UI æ›´æ–°
            stepContainer.classList.add('border-green-400');
            stepContainer.classList.add('animate-tada');
            
            for (let i = 0; i < step.answers.length; i++) {
                const slot = document.getElementById(`slot-${sIdx}-${i}`);
                slot.classList.add('completed');
            }

            document.getElementById(`options-container-${sIdx}`).classList.add('hidden');
            document.getElementById(`step-status-${sIdx}`).classList.remove('hidden');
            document.getElementById(`remediation-area-${sIdx}`).classList.add('hidden');

            // å–æ¶ˆæ­¤è™•è‡ªå‹•ç™¼éŸ³

            if (sIdx + 1 < quizData[currentQuestionIndex].steps.length) {
                setTimeout(() => {
                    activeStepIndex = sIdx + 1;
                    const nextStep = document.getElementById(`step-container-${activeStepIndex}`);
                    nextStep.classList.remove('hidden');
                    nextStep.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    stepStartTime = Date.now(); // Reset timer for next step
                }, 1000);
            } else {
                setTimeout(() => {
                    showCompletionModal();
                }, 1000);
            }
        }

        function handleStepFailure(sIdx) {
            remediationState[sIdx].triggered = true;
            
            // å–æ¶ˆè‡ªå‹•ç™¼éŸ³ï¼Œä½¿ç”¨è€…å¯ä»¥é€éæ–°å¢çš„å–‡å­æŒ‰éˆ•è½å–
            
            const remArea = document.getElementById(`remediation-area-${sIdx}`);
            remArea.classList.remove('hidden');
            remArea.scrollIntoView({ behavior: 'smooth', block: 'center' });

            const checkBtn = document.getElementById(`check-btn-${sIdx}`);
            checkBtn.disabled = true;
            checkBtn.className = "w-full mt-2 bg-gray-400 text-white font-bold py-3 px-6 rounded-xl cursor-not-allowed text-lg";
            checkBtn.innerText = "ğŸ”’ è«‹å…ˆå®Œæˆå°æ¸¬é©—è§£é–";
        }

        // --- Practice Logic ---
        function checkPractice(sIdx, pIdx, selectedOpt) {
            const step = quizData[currentQuestionIndex].steps[sIdx];
            const p = step.remediation.practice[pIdx];
            const msgDiv = document.getElementById(`prac-msg-${sIdx}-${pIdx}`);
            const boxDiv = document.getElementById(`prac-box-${sIdx}-${pIdx}`);

            if (selectedOpt === p.a) {
                msgDiv.innerHTML = `<span class="text-green-600 flex items-center gap-1"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg> ç­”å°äº†ï¼</span>`;
                boxDiv.classList.replace('border-red-200', 'border-green-400');
                boxDiv.classList.add('bg-green-50');
                
                if (pIdx === 0) remediationState[sIdx].p1 = true;
                if (pIdx === 1) remediationState[sIdx].p2 = true;

                if (remediationState[sIdx].p1 && remediationState[sIdx].p2) {
                    const checkBtn = document.getElementById(`check-btn-${sIdx}`);
                    checkBtn.disabled = false;
                    checkBtn.className = "w-full mt-4 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-xl transition text-lg shadow-md flex items-center justify-center gap-2 animate-pulse";
                    checkBtn.innerText = "ğŸ’¡ æ¸¬é©—é€šéï¼é»æ“Šå†æ¬¡æª¢æŸ¥ç­”æ¡ˆ";
                    
                    // é‡ç½®æ­¤æ­¥é©Ÿçš„è¨ˆæ™‚å™¨ï¼Œé¼“å‹µä»–é¦¬ä¸Šå¡«å¯«
                    stepStartTime = Date.now();
                }
            } else {
                msgDiv.innerHTML = `<span class="text-red-500">âœ– ä¸å°å–”ï¼Œè«‹é‡æ–°æ€è€ƒã€‚</span>`;
            }
            // å–æ¶ˆå°æ¸¬é©—è‡ªå‹•ç™¼éŸ³å›é¥‹
        }

        // --- Modal Logic ---
        function showCompletionModal() {
            document.getElementById('modal-score').innerText = `+ ${currentQuestionScore} åˆ†`;
            
            const btnNext = document.getElementById('btn-next-q');
            if (currentQuestionIndex + 1 < quizData.length) {
                btnNext.style.display = 'block';
            } else {
                btnNext.style.display = 'none'; // Reached the end
                document.getElementById('modal-score').innerText = `ç¸½ç©åˆ†ï¼š${globalScore} åˆ†`;
            }

            document.getElementById('completion-modal').classList.remove('hidden');
            document.getElementById('completion-modal').classList.add('flex');
            
            // å–æ¶ˆéé—œè¦–çª—çš„è‡ªå‹•ç™¼éŸ³
        }

        function closeModal() {
            document.getElementById('completion-modal').classList.add('hidden');
            document.getElementById('completion-modal').classList.remove('flex');
        }

        function nextQuestion() {
            closeModal();
            loadQuestion(currentQuestionIndex + 1);
        }

        function resetCurrentQuestion() {
            closeModal();
            // Subtract the score earned in this session
            globalScore -= currentQuestionScore;
            document.getElementById('global-score').innerText = globalScore;
            
            // é‡æ–°æŒ‘æˆ°æ™‚ï¼Œäº‚æ•¸æŠ½æ–°é¡Œå†è¼‰å…¥
            loadQuestion(currentQuestionIndex);
        }

    </script>
</body>
</html>
