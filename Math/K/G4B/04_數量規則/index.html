<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>數量規律大挑戰（穩定升級版）</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: 'Noto Sans TC', sans-serif; background:#f0fdf4; }
.slot{
display:inline-block;min-width:80px;height:48px;padding:0 12px;
border:3px dashed #9ca3af;text-align:center;line-height:42px;
border-radius:12px;margin:0 6px;font-weight:bold;font-size:1.125rem;
background:#f9fafb;cursor:pointer;transition:.2s;
}
.slot.filled{border:3px solid #3b82f6;background:#eff6ff;color:#1d4ed8;}
.slot.completed{border:3px solid #10b981;background:#ecfdf5;color:#047857;cursor:default;}
.option-btn{transition:.2s;}
.option-btn:hover:not(:disabled){transform:translateY(-2px);}
.option-btn:disabled{opacity:.4;cursor:not-allowed;}
.score-float{position:absolute;animation:floatUp 1.5s ease-out forwards;
font-weight:900;color:#eab308;font-size:1.5rem;pointer-events:none;}
@keyframes floatUp{
0%{opacity:1;transform:translateY(0)}
100%{opacity:0;transform:translateY(-50px)}
}
</style>
</head>
<body>

<nav class="bg-white shadow p-4 flex items-center gap-4 overflow-x-auto">
<div class="font-black text-2xl text-green-700 px-4">數量規律大挑戰</div>
<div id="nav-buttons" class="flex gap-3"></div>
<div class="ml-auto font-bold text-xl text-yellow-600 relative">
總積分: <span id="global-score">0</span>
<div id="score-anim-container" class="absolute inset-0"></div>
</div>
</nav>

<div class="container mx-auto p-6 flex flex-col md:flex-row gap-8">

<div class="w-full md:w-1/3 bg-white p-6 rounded-xl shadow">
<h2 id="q-title" class="text-2xl font-bold mb-4"></h2>
<div id="q-content" class="text-lg"></div>
<div class="mt-4 bg-blue-50 p-3 rounded">
<p id="q-concept-text" class="text-sm text-blue-700"></p>
</div>
</div>

<div id="steps-panel" class="w-full md:w-2/3 flex flex-col gap-6"></div>

</div>

<script>

/* ============================
   安全亂數洗牌 (Fisher–Yates)
============================ */
function shuffle(arr){
const a=[...arr];
for(let i=a.length-1;i>0;i--){
const j=Math.floor(Math.random()*(i+1));
[a[i],a[j]]=[a[j],a[i]];
}
return a;
}

/* ============================
   題庫產生器 (保留你的)
============================ */

const levelGenerators = [
function(){
return{
id:1,
title:"第 1 關：圖形的規律",
concept:"觀察重複出現的模式",
content:"紫色方塊位置重複出現。",
steps:[
{
instruction:"規律是 左上、右上、左上、[slot]",
template:"左上、右上、左上、[slot]",
options:["左上","右上","左下","右下"],
answers:["右上"],
remediation:{
errorMsg:"方向看錯囉",
hint:"觀察第2格的位置",
practice:[
{q:"上、下、上、？",opts:["上","下"],a:"下"},
{q:"紅、藍、紅、？",opts:["紅","藍"],a:"藍"}
]
}
}
]
}
}
];

/* ============================
   全域狀態
============================ */

let quizData=[];
let currentQuestionIndex=0;
let activeStepIndex=0;
let globalScore=0;
let currentQuestionScore=0;
let remediationState={};

const STORAGE_KEY="pattern_game_score";

/* ============================
   初始化
============================ */

window.addEventListener("load",()=>{
const saved=localStorage.getItem(STORAGE_KEY);
if(saved) globalScore=parseInt(saved);
document.getElementById("global-score").innerText=globalScore;
quizData=levelGenerators.map(g=>g());
renderNavbar();
loadQuestion(0);
});

/* ============================
   Navbar
============================ */

function renderNavbar(){
const nav=document.getElementById("nav-buttons");
nav.innerHTML="";
quizData.forEach((q,i)=>{
const btn=document.createElement("button");
btn.className="px-4 py-2 bg-gray-100 rounded-full font-bold";
btn.innerText=`關卡 ${i+1}`;
btn.dataset.index=i;
nav.appendChild(btn);
});
}

/* ============================
   載入關卡
============================ */

function loadQuestion(idx){
currentQuestionIndex=idx;
activeStepIndex=0;
currentQuestionScore=0;
remediationState={};
quizData[idx]=levelGenerators[idx]();

const q=quizData[idx];
document.getElementById("q-title").innerText=q.title;
document.getElementById("q-content").innerHTML=q.content;
document.getElementById("q-concept-text").innerText=q.concept;

const panel=document.getElementById("steps-panel");
panel.innerHTML="";
q.steps.forEach((step,sIdx)=>{
panel.appendChild(createStep(step,sIdx));
});
}

/* ============================
   建立步驟（無 inline onclick）
============================ */

function createStep(step,sIdx){
const div=document.createElement("div");
div.className="bg-white p-6 rounded-xl shadow";

let template=step.template;
let slotIndex=0;
while(template.includes("[slot]")){
template=template.replace("[slot]",
`<span class="slot" data-step="${sIdx}" data-idx="${slotIndex}"></span>`);
slotIndex++;
}

div.innerHTML=`
<h3 class="font-bold mb-4">${step.instruction}</h3>
<div class="text-xl mb-6">${template}</div>
<div class="flex flex-wrap gap-3 mb-4">
${step.options.map((opt,i)=>
`<button class="option-btn px-4 py-2 bg-gray-100 rounded-lg"
data-step="${sIdx}" data-opt="${i}" data-text="${opt}">
${opt}
</button>`).join("")}
</div>
<button class="check-btn bg-blue-600 text-white px-6 py-2 rounded-lg"
data-step="${sIdx}">
檢查答案
</button>
<div class="rem-area hidden mt-4 text-red-600 font-bold"></div>
`;
return div;
}

/* ============================
   事件代理（核心升級）
============================ */

document.addEventListener("click",function(e){

// 選項
if(e.target.matches(".option-btn")){
const step=parseInt(e.target.dataset.step);
const text=e.target.dataset.text;
const slots=document.querySelectorAll(`.slot[data-step='${step}']`);
for(const s of slots){
if(!s.classList.contains("filled")){
s.innerText=text;
s.classList.add("filled");
break;
}
}
}

// slot 清除
if(e.target.matches(".slot")){
if(e.target.classList.contains("completed")) return;
e.target.innerText="";
e.target.classList.remove("filled");
}

// 檢查
if(e.target.matches(".check-btn")){
const step=parseInt(e.target.dataset.step);
checkAnswer(step);
}

});

/* ============================
   檢查答案
============================ */

function checkAnswer(stepIdx){
const step=quizData[currentQuestionIndex].steps[stepIdx];
const slots=document.querySelectorAll(`.slot[data-step='${stepIdx}']`);
let correct=true;
slots.forEach((s,i)=>{
if(s.innerText!==step.answers[i]) correct=false;
});
if(correct){
handleSuccess(stepIdx);
}else{
handleFail(stepIdx);
}
}

function handleSuccess(stepIdx){
const slots=document.querySelectorAll(`.slot[data-step='${stepIdx}']`);
slots.forEach(s=>s.classList.add("completed"));
currentQuestionScore+=100;
globalScore+=100;
localStorage.setItem(STORAGE_KEY,globalScore);
document.getElementById("global-score").innerText=globalScore;
}

function handleFail(stepIdx){
const rem=document.querySelectorAll(".rem-area")[stepIdx];
rem.classList.remove("hidden");
rem.innerText="請重新觀察規律，再試一次！";
}

</script>
</body>
</html>
