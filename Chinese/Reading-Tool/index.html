<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>國小課文點讀小幫手</title>
    
    <!-- 1. 引入 Tailwind CSS (美化介面) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 引入 React 和 Babel (讓瀏覽器看懂程式碼) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. 引入 Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 4. 設定中文字體 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">

    <!-- 5. 引入 pinyin-pro 自動注音庫 -->
    <script src="https://unpkg.com/pinyin-pro@3.18.2/dist/index.js"></script>

    <!-- 6. 注入自定義 CSS (直式注音核心) -->
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F7F9F9; color: #5D6D7E; }
        
        /* 隱藏卷軸但可滾動 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 注音字體：標楷體 */
        .zhuyin-font {
            font-family: 'BiauKai', 'DFKai-SB', 'Kaiti TC', 'Songti TC', serif;
            line-height: 1;
            color: #6B7280;
        }

        /* 動畫 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-in; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- 7. 應用程式主邏輯 -->
    <script type="text/babel">
        // 為了在單一 HTML 運作，我們使用 React 全域變數
        const { useState, useEffect } = React;
        
        // --- 手動注音字典 (優先權最高) ---
        const ZHUYIN_MAP = {
            '一': 'ㄧ', '二': 'ㄦˋ', '三': 'ㄙㄢ', '四': 'ㄙˋ', '五': 'ㄨˇ',
            '你': 'ㄋㄧˇ', '我': 'ㄨㄛˇ', '他': 'ㄊㄚ',
            '在': 'ㄗㄞˋ', '左': 'ㄗㄨㄛˇ', '右': 'ㄧㄡˋ',
            '起': 'ㄑㄧˇ', '走': 'ㄗㄡˇ',
            '和': 'ㄏㄢˋ', '跟': 'ㄍㄣ',
            '向': 'ㄒㄧㄤˋ', '前': 'ㄑㄧㄢˊ', '後': 'ㄏㄡˋ',
            '手': 'ㄕㄡˇ', '的': '˙ㄉㄜ',
            '天': 'ㄊㄧㄢ', '氣': 'ㄑㄧˋ', '真': 'ㄓㄣ', '好': 'ㄏㄠˇ',
            '大': 'ㄉㄚˋ', '家': 'ㄐㄧㄚ', '來': 'ㄌㄞˊ', 
            '上': 'ㄕㄤˋ', '學': 'ㄒㄩㄝˊ', '校': 'ㄒㄧㄠˋ',
            '老': 'ㄌㄠˇ', '師': 'ㄕ', '早': 'ㄗㄠˇ', '安': 'ㄢ',
            '小': 'ㄒㄧㄠˇ', '朋': 'ㄆㄥˊ', '友': 'ㄧㄡˇ', '們': '˙ㄇㄣ',
            '讀': 'ㄉㄨˊ', '書': 'ㄕㄨ', '寫': 'ㄒㄧㄝˇ', '字': 'ㄗˋ',
            '快': 'ㄎㄨㄞˋ', '樂': 'ㄌㄜˋ', '習': 'ㄒㄧˊ',
            '樹': 'ㄕㄨˋ', '花': 'ㄏㄨㄚ', '草': 'ㄘㄠˇ', '紅': 'ㄏㄨㄥˊ',
            '這': 'ㄓㄜˋ', '是': 'ㄕˋ', '個': '˙ㄍㄜ',
            '測': 'ㄘㄜˋ', '試': 'ㄕˋ', '課': 'ㄎㄜˋ', '文': 'ㄨㄣˊ',
            '風': 'ㄈㄥ', '爸': 'ㄅㄚˋ', '媽': 'ㄇㄚ', '捕': 'ㄅㄨˇ',
            '魚': 'ㄩˊ', '去': 'ㄑㄩˋ', '為': 'ㄨㄟˋ', '什': 'ㄕㄣˊ',
            '麼': '˙ㄇㄜ', '還': 'ㄏㄞˊ', '不': 'ㄅㄨˋ', '回': 'ㄏㄨㄟˊ'
        };

        // --- 拼音 -> 注音（Bopomofo）轉換邏輯 ---
        const TONE_MAP = { 1: '', 2: 'ˊ', 3: 'ˇ', 4: 'ˋ', 5: '˙', 0: '' };
        
        const INITIAL_MAP = {
            b:'ㄅ', p:'ㄆ', m:'ㄇ', f:'ㄈ',
            d:'ㄉ', t:'ㄊ', n:'ㄋ', l:'ㄌ',
            g:'ㄍ', k:'ㄎ', h:'ㄏ',
            j:'ㄐ', q:'ㄑ', x:'ㄒ',
            zh:'ㄓ', ch:'ㄔ', sh:'ㄕ', r:'ㄖ',
            z:'ㄗ', c:'ㄘ', s:'ㄙ',
            '':''
        };

        // 移除可能導致錯誤的 key，統一使用 v 代表 ü
        const FINAL_MAP = {
            a:'ㄚ', o:'ㄛ', e:'ㄜ', ai:'ㄞ', ei:'ㄟ', ao:'ㄠ', ou:'ㄡ',
            an:'ㄢ', en:'ㄣ', ang:'ㄤ', eng:'ㄥ', er:'ㄦ',
            i:'ㄧ', ia:'ㄧㄚ', ie:'ㄧㄝ', iao:'ㄧㄠ', iu:'ㄧㄡ',
            ian:'ㄧㄢ', in:'ㄧㄣ', iang:'ㄧㄤ', ing:'ㄧㄥ', iong:'ㄩㄥ',
            u:'ㄨ', ua:'ㄨㄚ', uo:'ㄨㄛ', uai:'ㄨㄞ', ui:'ㄨㄟ',
            uan:'ㄨㄢ', un:'ㄨㄣ', uang:'ㄨㄤ', ong:'ㄨㄥ',
            v:'ㄩ', ve:'ㄩㄝ', van:'ㄩㄢ', vn:'ㄩㄣ'
        };

        function pinyinSyllableToZhuyin(pyNum) {
            if (!pyNum) return '';
            const m = String(pyNum).match(/^([a-züv]+)([1-5])$/i);
            let base = pyNum;
            let tone = 0;
            if (m) {
                base = m[1].toLowerCase();
                tone = parseInt(m[2], 10);
            } else {
                base = String(pyNum).toLowerCase();
            }
            base = base.replace('ü', 'v');

            let initial = '';
            let final = base;
            const try2 = base.slice(0,2);
            if (['zh','ch','sh'].includes(try2)) {
                initial = try2;
                final = base.slice(2);
            } else {
                const try1 = base.slice(0,1);
                if (INITIAL_MAP.hasOwnProperty(try1)) {
                    initial = try1;
                    final = base.slice(1);
                }
            }

            if (initial === 'y') { initial = ''; }
            if (initial === 'w') { initial = ''; }
            if (['j','q','x'].includes(initial) && final.startsWith('u')) {
                final = 'v' + final.slice(1);
            }

            const zInitial = INITIAL_MAP[initial] ?? '';
            const zFinal = FINAL_MAP[final] ?? '';
            
            if (!zFinal && !zInitial) return '';

            const toneMark = TONE_MAP[tone] ?? '';
            if (toneMark === '˙') return `˙${zInitial}${zFinal}`;
            return `${zInitial}${zFinal}${toneMark}`;
        }

        // --- 核心組件 ---
        function App() {
            const [text, setText] = useState("一二一，你在左。\n一二一，我在右。\n一二一二，|一起走|。\n你和我，|一起向前走|。");
            const [overrides, setOverrides] = useState({});
            const [parsedData, setParsedData] = useState([]);
            
            const [showZhuyin, setShowZhuyin] = useState(true);
            const [mode, setMode] = useState('edit'); 
            const [correctionMode, setCorrectionMode] = useState(false);
            const [speechRate, setSpeechRate] = useState(0.75); 
            // 新增: 字型縮放比例 (預設 1.0)
            const [zoom, setZoom] = useState(1.0); 

            const [readUnit, setReadUnit] = useState('char'); 
            const [activeRange, setActiveRange] = useState(null); 
            const [wordRanges, setWordRanges] = useState([]);

            const [voices, setVoices] = useState([]);
            const [selectedVoice, setSelectedVoice] = useState(null);

            const [editingIndex, setEditingIndex] = useState(null);
            const [tempZhuyin, setTempZhuyin] = useState("");
            const [tempPhoneChar, setTempPhoneChar] = useState("");

            const [shareUrl, setShareUrl] = useState(null);
            const [copySuccess, setCopySuccess] = useState(false);

            // 1. 載入語音
            useEffect(() => {
                if (!window.speechSynthesis) return;
                const loadVoices = () => {
                    const list = window.speechSynthesis.getVoices();
                    const zhVoices = list.filter(v => v.lang.indexOf('zh') !== -1);
                    setVoices(zhVoices);
                    if (zhVoices.length > 0) {
                        const tw = zhVoices.find(v => v.lang === 'zh-TW' || v.lang === 'zh_TW');
                        setSelectedVoice(prev => {
                            if (prev && zhVoices.find(v => v.name === prev.name)) return prev;
                            return tw || zhVoices[0];
                        });
                    } else {
                        setVoices([]);
                        setSelectedVoice(null);
                    }
                };
                loadVoices();
                window.speechSynthesis.onvoiceschanged = loadVoices;
                return () => { window.speechSynthesis.onvoiceschanged = null; }
            }, []);

            // 2. 初始化與讀取網址參數
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const lessonContent = params.get('content'); 
                if (lessonContent) {
                    try {
                        const decoded = decodeURIComponent(escape(atob(lessonContent)));
                        try {
                            const payload = JSON.parse(decoded);
                            if (typeof payload === 'object' && payload !== null) {
                                setText(payload.text ?? "");
                                setOverrides(payload.overrides ?? {});
                            } else {
                                setText(decoded); 
                            }
                        } catch (e) {
                            setText(decoded); 
                        }
                        setMode('read');
                    } catch(e) { console.error(e); }
                }
                if (window.lucide) window.lucide.createIcons();
            }, []);

            // 3. 解析文本 (效能優化版)
            useEffect(() => {
                parseText(text);
                setWordRanges(buildWordRanges(text));
                setTimeout(() => { if (window.lucide) window.lucide.createIcons(); }, 100);
            }, [text, overrides]);

            // 4. 更新 Icons
            useEffect(() => {
                setTimeout(() => { if (window.lucide) window.lucide.createIcons(); }, 100);
            }, [mode, showZhuyin, correctionMode, shareUrl, editingIndex, speechRate, voices, readUnit, zoom]);

            const getZhuyin = (char) => {
                if (ZHUYIN_MAP[char]) return ZHUYIN_MAP[char];
                if (window.pinyinPro && /[\u4e00-\u9fff]/.test(char)) {
                    const { pinyin } = window.pinyinPro;
                    const arr = pinyin(char, { toneType: 'num', type: 'array' });
                    const py = Array.isArray(arr) ? arr[0] : '';
                    return pinyinSyllableToZhuyin(py);
                }
                return '';
            };

            const parseText = (inputText) => {
                let pinyinArr = [];
                if (window.pinyinPro) {
                    try {
                        const { pinyin } = window.pinyinPro;
                        pinyinArr = pinyin(inputText, {
                            toneType: 'num',
                            type: 'array'
                        });
                    } catch(e) { console.error("Pinyin error:", e); }
                }

                const chars = inputText.split('');
                const data = chars.map((char, idx) => {
                    const ov = overrides[idx];
                    
                    let autoZhuyin = '';
                    if (ov?.zhuyin) {
                        autoZhuyin = ov.zhuyin;
                    } else if (ZHUYIN_MAP[char]) {
                        autoZhuyin = ZHUYIN_MAP[char];
                    } else if (/[\u4e00-\u9fff]/.test(char)) { 
                        const py = (pinyinArr && pinyinArr[idx]) ? pinyinArr[idx] : '';
                        autoZhuyin = pinyinSyllableToZhuyin(py);
                    }

                    return {
                        char,
                        zhuyin: autoZhuyin,
                        phoneChar: ov?.phoneChar ?? ''
                    };
                });
                setParsedData(data);
            };

            const buildWordRanges = (inputText) => {
                const ranges = [];
                const chars = inputText.split('');
                let i = 0;
                while (i < chars.length) {
                    if (chars[i] === '|') {
                        const startBar = i;
                        let j = i + 1;
                        while (j < chars.length && chars[j] !== '|') j++;
                        if (j < chars.length && chars[j] === '|') {
                            ranges.push({ s: startBar + 1, e: j - 1 });
                            i = j + 1;
                            continue;
                        }
                    }
                    i++;
                }
                return ranges;
            };

            const handleTextChange = (e) => {
                setText(e.target.value);
                setOverrides({}); 
                setShareUrl(null);
            };

            const cycleSpeed = () => {
                setSpeechRate(prev => {
                    if (prev === 0.25) return 0.5; // 極慢 -> 慢
                    if (prev === 0.5) return 0.75;
                    if (prev === 0.75) return 1.0;
                    if (prev === 1.0) return 1.2; 
                    return 0.25; // 循環回 0.25
                });
            };

            // 新增: 調整字體大小
            const adjustZoom = (delta) => {
                setZoom(prev => {
                    const newZoom = parseFloat((prev + delta).toFixed(1));
                    if (newZoom < 0.8) return 0.8;
                    if (newZoom > 1.6) return 1.6;
                    return newZoom;
                });
            };

            const playSound = (textToSpeak, range = null) => {
                if (!window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                    utterance.lang = selectedVoice.lang;
                } else {
                    utterance.lang = 'zh-TW'; 
                }
                utterance.rate = speechRate;
                utterance.onstart = () => setActiveRange(range);
                utterance.onend = () => setActiveRange(null);
                utterance.onerror = () => setActiveRange(null);
                window.speechSynthesis.speak(utterance);
            };

            const buildSpeakText = (range) => {
                if (!range) return text.split('|').join('');

                const chars = text.split('');
                const out = [];

                for (let i = range.s; i <= range.e; i++) {
                    const c = chars[i];
                    if (c === '|') continue; 
                    const ov = overrides[i];
                    out.push(ov?.phoneChar || c);
                }
                return out.join('');
            };

            const saveLesson = () => {
                try {
                    const payload = { text, overrides };
                    const jsonString = JSON.stringify(payload);
                    const base64 = btoa(unescape(encodeURIComponent(jsonString)));
                    const encodedParam = encodeURIComponent(base64);
                    const baseUrl = window.location.href.split('?')[0].split('#')[0];
                    const url = `${baseUrl}?content=${encodedParam}`;
                    setShareUrl(url);
                } catch (e) {
                    console.error("Link Gen Error:", e);
                    alert("連結產生失敗（內容可能過長）。");
                }
            };

            const copyToClipboard = async () => {
                if (!shareUrl) return;
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(shareUrl);
                        setCopySuccess(true);
                    } else {
                        throw new Error("Clipboard API not supported");
                    }
                } catch (err) {
                    const textarea = document.createElement('textarea');
                    textarea.value = shareUrl;
                    textarea.style.position = 'fixed'; 
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        const successful = document.execCommand('copy');
                        if (successful) setCopySuccess(true);
                        else alert("複製失敗");
                    } catch (e) { alert("複製失敗"); }
                    document.body.removeChild(textarea);
                }
                setTimeout(() => setCopySuccess(false), 2000);
            };

            const openEditModal = (index, item) => {
                setEditingIndex(index);
                setTempZhuyin(item.zhuyin);
                setTempPhoneChar(item.phoneChar || "");
            };

            const saveSingleZhuyin = () => {
                if (editingIndex !== null) {
                    setOverrides(prev => ({
                        ...prev,
                        [editingIndex]: { zhuyin: tempZhuyin, phoneChar: tempPhoneChar }
                    }));
                    setEditingIndex(null);
                }
            };

            const isSentenceBreak = (c) => /[。！？\n]/.test(c);
            const getSentenceRange = (idx) => {
                const chars = text.split('');
                let s = idx, e = idx;
                while (s > 0 && !isSentenceBreak(chars[s - 1])) s--;
                while (e < chars.length - 1 && !isSentenceBreak(chars[e])) e++;
                return { s, e };
            };

            const getWordRange = (idx) => {
                const hit = wordRanges.find(r => idx >= r.s && idx <= r.e);
                if (hit) return { s: hit.s, e: hit.e };
                const chars = text.split('');
                const isWordBreak = (c) => /[，。、；：？！\n\s]/.test(c) || c === '|';
                let s = idx, e = idx;
                while (s > 0 && !isWordBreak(chars[s - 1])) s--;
                while (e < chars.length - 1 && !isWordBreak(chars[e + 1])) e++;
                return { s, e };
            };

            const CharBlock = ({ item, index }) => {
                const { char, zhuyin, phoneChar } = item;
                const isActive = activeRange && index >= activeRange.s && index <= activeRange.e;
                
                if (char === '|') return null;
                if (char === '\n') return <div className="w-full h-8 basis-full"></div>;
                
                const isPunctuation = /[，。、；：？！「」『』\(\)（）\s]/.test(char);

                const handleClick = (e) => {
                    if (correctionMode && !isPunctuation) {
                        openEditModal(index, item);
                        return;
                    }
                    if (isPunctuation) return;

                    if (readUnit === 'sent') {
                        const range = getSentenceRange(index);
                        const speak = buildSpeakText(range);
                        playSound(speak, range);
                        return;
                    }

                    if (readUnit === 'word') {
                        const range = getWordRange(index);
                        const speak = buildSpeakText(range);
                        playSound(speak, range);
                        return;
                    }

                    if (e.shiftKey) {
                        const { s, e: end } = getSentenceRange(index);
                        const sentence = buildSpeakText({ s, e: end });
                        playSound(sentence, { s, e: end });
                    } else {
                        playSound(phoneChar || char, { s: index, e: index });
                    }
                };

                return (
                    <div 
                        className={`inline-flex items-center justify-center m-1 p-1 rounded-lg transition-all duration-200 relative
                        ${isPunctuation ? 'pointer-events-none' : 'cursor-pointer hover:bg-teal-50 hover:-translate-y-0.5'}
                        ${correctionMode && !isPunctuation ? 'ring-2 ring-dashed ring-amber-300 bg-amber-50' : ''}
                        ${isActive ? 'bg-teal-100 ring-2 ring-teal-300 transform scale-110 z-10' : ''}`}
                        onClick={handleClick}
                        title={!isPunctuation ? "點擊朗讀" : ""}
                    >
                        {/* 修正：字型大小改為動態 style */}
                        <span className="hanzi leading-none text-slate-700" style={{fontSize: `${2.5 * zoom}rem`}}>{char}</span>
                        {showZhuyin && !isPunctuation && zhuyin && (
                            <ZhuyinDisplay zhuyin={zhuyin} zoom={zoom} />
                        )}
                    </div>
                );
            };

            const ZhuyinDisplay = ({ zhuyin, zoom }) => {
                if (!zhuyin) return null;
                const tones = ['ˊ', 'ˇ', 'ˋ', '˙'];
                let symbols = zhuyin;
                let toneChar = '';
                let isNeutral = false;

                if (zhuyin.startsWith('˙')) {
                    isNeutral = true;
                    symbols = zhuyin.substring(1);
                    toneChar = '˙';
                } else {
                    const last = zhuyin.slice(-1);
                    if (tones.includes(last) && last !== '˙') {
                        toneChar = last;
                        symbols = zhuyin.slice(0, -1);
                    }
                }

                // 修正：注音大小改為動態 style
                const symbolSize = `${0.8 * zoom}rem`;
                const neutralSize = `${0.6 * zoom}rem`;
                const neutralMargin = `${-0.2 * zoom}rem`;

                return (
                    <div className="flex flex-col items-center justify-center h-full ml-2 select-none">
                        {isNeutral && <span className="zhuyin-font" style={{fontSize: neutralSize, marginBottom: neutralMargin}}>{toneChar}</span>}
                        <div className="flex items-center">
                            <div className="flex flex-col items-center leading-none">
                                {symbols.split('').map((c, i) => (
                                    <span key={i} className="zhuyin-font my-[1px]" style={{fontSize: symbolSize}}>{c}</span>
                                ))}
                            </div>
                            {!isNeutral && toneChar && (
                                <span className="zhuyin-font ml-1 self-center" style={{fontSize: symbolSize}}>{toneChar}</span>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen pb-20">
                    <nav className="bg-white shadow-sm border-b border-gray-100 sticky top-0 z-10">
                        <div className="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2 cursor-pointer" onClick={() => {
                                window.history.pushState({}, '', window.location.pathname);
                                setMode('edit');
                                setShareUrl(null);
                                setCorrectionMode(false);
                                setActiveRange(null);
                            }}>
                                <div className="bg-teal-200 p-2 rounded-lg text-white">
                                    <i data-lucide="book-open" width="20"></i>
                                </div>
                                <h1 className="font-bold text-lg text-slate-700 tracking-wide hidden sm:block">
                                    國語課文<span className="text-teal-400">點讀小幫手</span>
                                </h1>
                            </div>

                            <div className="flex items-center gap-2 sm:gap-3">
                                <div className="hidden md:flex items-center gap-1 bg-slate-100 rounded-full p-1 mr-2">
                                    {[
                                        ['char','字'],
                                        ['word','詞'],
                                        ['sent','句'],
                                    ].map(([key,label]) => (
                                        <button
                                            key={key}
                                            onClick={() => setReadUnit(key)}
                                            className={`px-3 py-1 rounded-full text-xs font-medium transition-all
                                                ${readUnit===key ? 'bg-white shadow text-teal-600' : 'text-slate-400 hover:text-slate-600'}`}
                                        >
                                            {label}
                                        </button>
                                    ))}
                                </div>
                                
                                <select 
                                    className="md:hidden bg-slate-100 text-xs rounded-lg px-2 py-1.5 border-none outline-none text-slate-600"
                                    value={readUnit}
                                    onChange={(e) => setReadUnit(e.target.value)}
                                >
                                    <option value="char">讀字</option>
                                    <option value="word">讀詞</option>
                                    <option value="sent">讀句</option>
                                </select>

                                {/* 1.2x 語速已加入 cycleSpeed */}
                                <button 
                                    onClick={cycleSpeed}
                                    className="flex items-center gap-1 px-2 py-1.5 sm:px-3 rounded-full bg-slate-100 hover:bg-slate-200 transition-colors"
                                >
                                    <span className="text-xs text-slate-500 font-mono w-6 text-center">{speechRate}x</span>
                                </button>

                                {/* 新增：字體縮放按鈕 */}
                                <div className="flex items-center bg-slate-100 rounded-full px-2 py-1 gap-2">
                                    <button onClick={() => adjustZoom(-0.1)} className="text-slate-500 hover:text-teal-600" title="縮小">
                                        <span className="text-xs font-bold">A-</span>
                                    </button>
                                    <button onClick={() => adjustZoom(0.1)} className="text-slate-500 hover:text-teal-600" title="放大">
                                        <span className="text-sm font-bold">A+</span>
                                    </button>
                                </div>

                                {/* 語音選單移到右側或隱藏，避免擁擠 */}
                                {voices.length > 0 && (
                                    <select
                                        value={selectedVoice?.name || ""}
                                        onChange={e => {
                                            const v = voices.find(voice => voice.name === e.target.value);
                                            setSelectedVoice(v);
                                        }}
                                        className="hidden lg:block max-w-[100px] px-2 py-1.5 rounded-lg bg-slate-100 text-xs text-slate-600 border-none outline-none truncate"
                                    >
                                        {voices.map(v => (
                                            <option key={v.name} value={v.name}>
                                                {v.name.replace(/Google |Microsoft |Apple /g, '')}
                                            </option>
                                        ))}
                                    </select>
                                )}

                                <button 
                                    onClick={() => setShowZhuyin(!showZhuyin)}
                                    className="flex items-center gap-2 px-2 py-1.5 sm:px-3 rounded-full bg-slate-100 hover:bg-slate-200 transition-colors text-sm font-medium"
                                    title="切換注音顯示"
                                >
                                    {showZhuyin ? 
                                        <i data-lucide="toggle-right" className="text-teal-400" width="24"></i> : 
                                        <i data-lucide="toggle-left" className="text-slate-400" width="24"></i>
                                    }
                                </button>

                                {mode === 'read' && (
                                    <button 
                                        onClick={() => setCorrectionMode(!correctionMode)}
                                        className={`flex items-center gap-2 px-2 py-1.5 sm:px-3 rounded-full transition-colors text-sm font-medium border ${correctionMode ? 'bg-amber-100 text-amber-700 border-amber-300' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'}`}
                                    >
                                        <i data-lucide="settings" width="14"></i>
                                        <span className="hidden sm:inline">{correctionMode ? '完成' : '校正'}</span>
                                    </button>
                                )}
                                
                                {mode === 'read' && !correctionMode && (
                                    <button onClick={() => { setMode('edit'); setShareUrl(null); }} className="p-2 rounded-full hover:bg-slate-100 text-slate-500">
                                        <i data-lucide="edit-3" width="20"></i>
                                    </button>
                                )}
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-4xl mx-auto px-4 py-8">
                        {mode === 'read' && voices.length === 0 && (
                            <div className="mb-6 p-4 bg-rose-50 border border-rose-200 rounded-xl text-sm text-rose-700 flex items-start gap-3">
                                <i data-lucide="alert-triangle" className="shrink-0 mt-0.5" width="18"></i>
                                <div>
                                    <p className="font-bold">⚠️ 裝置目前沒有可用的中文語音</p>
                                    <p className="mt-1">請嘗試以下排除步驟：</p>
                                    <ul className="list-disc pl-5 mt-1 space-y-1 text-xs">
                                        <li>請確認瀏覽器不是無痕模式</li>
                                        <li>請檢查裝置設定是否已下載中文語音包</li>
                                        <li>請確認裝置音量未靜音</li>
                                    </ul>
                                </div>
                            </div>
                        )}

                        {mode === 'edit' && (
                            <div className="mb-8 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 fade-in">
                                <h2 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                                    <i data-lucide="edit-3" width="18" className="text-teal-400"></i> 輸入課文
                                </h2>
                                <div className="mb-2 text-xs text-slate-400 bg-slate-50 p-2 rounded">
                                    提示：可用 <code className="bg-slate-200 px-1 rounded text-slate-600">|</code> 符號標記詞塊，例如：<code>|一起走|</code>，系統將自動以此為單位朗讀。
                                </div>
                                <textarea
                                    value={text}
                                    onChange={handleTextChange}
                                    className="w-full h-40 p-4 rounded-xl bg-slate-50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-teal-200 text-lg text-slate-700"
                                    placeholder="請在此貼上課文..."
                                ></textarea>
                                <div className="mt-4 flex justify-end gap-3">
                                    <button onClick={() => setMode('read')} className="px-5 py-2 rounded-xl text-slate-500 hover:bg-slate-100 font-medium text-sm">預覽</button>
                                    <button onClick={saveLesson} className="flex items-center gap-2 px-6 py-2 rounded-xl bg-teal-400 hover:bg-teal-500 text-white font-medium shadow-sm">
                                        <i data-lucide="share-2" width="16"></i> 產生連結
                                    </button>
                                </div>
                                <p className="mt-2 text-[10px] text-slate-400 text-right">此連結包含全文內容與校正設定，請勿分享含個資文本。</p>
                                <p className="text-[10px] text-slate-400 text-right">注音為系統自動產生，若與課堂教學不同，請使用【校正】調整。</p>

                                {shareUrl && (
                                    <div className="mt-6 p-4 bg-teal-50 border border-teal-100 rounded-xl flex flex-col sm:flex-row items-center gap-3 animate-pulse-once">
                                        <div className="flex-1 w-full overflow-hidden">
                                            <p className="text-sm font-bold text-teal-600 mb-1">連結已產生！</p>
                                            <div className="bg-white/50 border border-teal-200 rounded px-2 py-1 text-xs text-slate-500 truncate">{shareUrl}</div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={copyToClipboard} className="px-3 py-1.5 rounded-lg bg-white border border-slate-200 text-sm flex items-center gap-1">
                                                {copySuccess ? '已複製' : '複製'}
                                            </button>
                                            <a href={shareUrl} target="_self" className="px-3 py-1.5 rounded-lg bg-teal-500 text-white text-sm flex items-center gap-1">
                                                開啟
                                            </a>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        <div className={`relative bg-white min-h-[50vh] rounded-[2rem] shadow-sm p-8 sm:p-12 border border-slate-100 flex flex-wrap content-start items-center justify-center gap-y-6 ${mode === 'edit' ? 'hidden' : 'block fade-in'} ${correctionMode ? 'ring-4 ring-amber-100' : ''}`}>
                             {correctionMode && (
                                <div className="absolute -top-12 left-0 right-0 flex justify-center">
                                    <div className="bg-amber-100 text-amber-800 text-sm px-4 py-1.5 rounded-full shadow-sm font-medium animate-bounce z-20">
                                        校正模式：點擊文字修改注音或發音
                                    </div>
                                </div>
                            )}
                            
                            {parsedData.map((item, index) => (
                                <CharBlock key={index} item={item} index={index} />
                            ))}
                        </div>

                         {mode === 'read' && !correctionMode && (
                            <div className="mt-8 text-center text-sm text-slate-400 space-y-1">
                                <p>目前模式：<span className="font-bold text-teal-500">
                                    {readUnit === 'char' ? '讀字' : readUnit === 'word' ? '讀詞' : '讀句'}
                                </span></p>
                                {readUnit === 'word' && <p className="text-xs text-slate-300">提示：老師可用 | | 標記重點詞彙</p>}
                            </div>
                        )}
                    </main>

                    {/* Edit Modal */}
                    {editingIndex !== null && (
                        <div className="fixed inset-0 bg-black/20 flex items-center justify-center z-50 backdrop-blur-sm p-4">
                            <div className="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 fade-in">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold text-slate-700">修改注音與發音</h3>
                                    <button onClick={() => setEditingIndex(null)} className="text-slate-400 hover:text-slate-600">
                                        <i data-lucide="x" width="20"></i>
                                    </button>
                                </div>
                                <div className="flex justify-center mb-6">
                                    <span className="text-5xl font-serif text-slate-700 bg-slate-50 p-4 rounded-xl border border-slate-100">
                                        {parsedData[editingIndex].char}
                                    </span>
                                </div>
                                <div className="space-y-4 mb-6">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-400 mb-1">注音符號</label>
                                        <input type="text" value={tempZhuyin} onChange={e => setTempZhuyin(e.target.value)} className="w-full text-center text-xl p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-200 outline-none" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-400 mb-1">發音借代 (選填)</label>
                                        <input type="text" value={tempPhoneChar} onChange={e => setTempPhoneChar(e.target.value)} className="w-full text-center text-lg p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-200 outline-none" placeholder="輸入同音字 (如:義)" />
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setEditingIndex(null)} className="flex-1 py-2.5 rounded-xl border border-slate-200 text-slate-600">取消</button>
                                    <button onClick={saveSingleZhuyin} className="flex-1 py-2.5 rounded-xl bg-teal-400 text-white shadow-sm">確認修改</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <footer className="max-w-4xl mx-auto px-4 py-6 text-center text-slate-400 text-xs mt-auto">
                        <p>© 2025 國小課文點讀小幫手 | 僅供教育學習使用</p>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
